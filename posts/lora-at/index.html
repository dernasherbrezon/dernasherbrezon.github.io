<!DOCTYPE html>
<html lang='ru' dir='auto'><head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='История С момента моей последней статьи про LoRa прошло слишком много времени. За это время у меня появился проект lora-at, про который я бы хотел написать в этой статье. И начну я, пожалуй, с истории о том, как он появился.
Изначально я планировал создать небольшую прошивку для приёма сигналов со спутников по протоколу LoRa. За основу я взял tinyGS, которая делала почти всё, что мне было нужно. tinyGS позволял составлять расписание пролётов спутников, принимать пакеты со спутников и пересылать их на центральный сервер.'>
<meta name='theme-color' content='#ffcd00'>

<meta property='og:title' content='lora-at • dernasherbrezon'>
<meta property='og:description' content='История С момента моей последней статьи про LoRa прошло слишком много времени. За это время у меня появился проект lora-at, про который я бы хотел написать в этой статье. И начну я, пожалуй, с истории о том, как он появился.
Изначально я планировал создать небольшую прошивку для приёма сигналов со спутников по протоколу LoRa. За основу я взял tinyGS, которая делала почти всё, что мне было нужно. tinyGS позволял составлять расписание пролётов спутников, принимать пакеты со спутников и пересылать их на центральный сервер.'>
<meta property='og:url' content='https://dernasherbrezon.com/posts/lora-at/'>
<meta property='og:site_name' content='dernasherbrezon'>
<meta property='og:type' content='article'><meta property='article:section' content='posts'><meta property='article:tag' content='lora'><meta property='article:tag' content='lora-at'><meta property='article:tag' content='esp32'><meta property='article:tag' content='esp-idf'><meta property='article:published_time' content='2023-11-05T22:25:18&#43;01:00'/><meta property='article:modified_time' content='2023-11-05T22:25:18&#43;01:00'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@dernasherbrezon'>

<meta name="generator" content="Hugo 0.124.0">

  <title>lora-at • dernasherbrezon</title>
  <link rel='canonical' href='https://dernasherbrezon.com/posts/lora-at/'>
  
    <link href="https://dernasherbrezon.com/posts/lora-at/index.xml" rel="alternate" type="application/rss+xml" title="dernasherbrezon" />
  
  <link rel='alternate' hreflang='ru' href='https://dernasherbrezon.com/posts/lora-at/'><link rel='alternate' hreflang='x-default' href='https://dernasherbrezon.com/posts/lora-at/'><link rel='alternate' hreflang='en' href='https://dernasherbrezon.com/en/posts/lora-at/'>
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.ab98e12b.css'><link rel='stylesheet' href='/css/custom.1.css'><style>
:root{--color-accent:#ffcd00;}
</style>

  <meta name="telegram:channel" content="@dernasherbrezonChannel">
<link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
</head>
<body class='page type-posts has-sidebar'>

  <div class='site'><div id='sidebar' class='sidebar'>
  <a class='screen-reader-text' href='#main-menu'></a>

  <div class='container'><section class='widget widget-about sep-after'>
  <header>
    
    <div class='logo'>
      <a href='/'>
        <img src='/img/logo.jpeg'>
      </a>
    </div>
    
    <h2 class='title site-title '>
      <a href='/'>
      dernasherbrezon
      </a>
    </h2>
    <div class='desc'>
    Блог о программировании на Java
    </div>
  </header>

</section>
<section class='widget widget-sidebar_menu sep-after'><nav id='sidebar-menu' class='menu sidebar-menu' aria-label=''>
    <div class='container'>
      <ul><li class='item has-current'>
  <a href='/posts/'>Все записи</a></li><li class='item'>
  <a href='/products/'>Гаджеты</a></li><li class='item'>
  <a href='/%D0%BE%D0%B1-%D0%B0%D0%B2%D1%82%D0%BE%D1%80%D0%B5/'>Об авторе</a></li><li class='item'>
  <a href='/%D0%BF%D0%BE%D0%B4%D0%B4%D0%B5%D1%80%D0%B6%D0%B0%D1%82%D1%8C/'>Поддержать</a></li></ul>
    </div>
  </nav>

</section><section class='widget widget-taxonomy_cloud sep-after'>
  <header>
    <h4 class='title widget-title'>Тэги</h4>
  </header>

  <div class='container list-container'>
  <ul class='list taxonomy-cloud'><li>
        <a href='/tags/abbreviated-jpeg/' style='font-size:1.0204081632653061em'>abbreviated jpeg</a>
      </li><li>
        <a href='/tags/acme/' style='font-size:1em'>Acme</a>
      </li><li>
        <a href='/tags/api/' style='font-size:1.0612244897959184em'>api</a>
      </li><li>
        <a href='/tags/apt/' style='font-size:1.0612244897959184em'>Apt</a>
      </li><li>
        <a href='/tags/awgn/' style='font-size:1em'>Awgn</a>
      </li><li>
        <a href='/tags/bash/' style='font-size:1.0204081632653061em'>bash</a>
      </li><li>
        <a href='/tags/ber/' style='font-size:1.1020408163265305em'>ber</a>
      </li><li>
        <a href='/tags/bluetooth/' style='font-size:1.0204081632653061em'>Bluetooth</a>
      </li><li>
        <a href='/tags/bpsk/' style='font-size:1.0204081632653061em'>bpsk</a>
      </li><li>
        <a href='/tags/c/' style='font-size:1.4489795918367347em'>C</a>
      </li><li>
        <a href='/tags/deb/' style='font-size:1.0816326530612246em'>Deb</a>
      </li><li>
        <a href='/tags/docker/' style='font-size:1em'>Docker</a>
      </li><li>
        <a href='/tags/dsp/' style='font-size:1.1224489795918366em'>dsp</a>
      </li><li>
        <a href='/tags/eclipse/' style='font-size:1em'>Eclipse</a>
      </li><li>
        <a href='/tags/embedded/' style='font-size:1.163265306122449em'>embedded</a>
      </li><li>
        <a href='/tags/esp-idf/' style='font-size:1.0408163265306123em'>Esp-Idf</a>
      </li><li>
        <a href='/tags/esp32/' style='font-size:1.2040816326530612em'>Esp32</a>
      </li><li>
        <a href='/tags/flot/' style='font-size:1em'>Flot</a>
      </li><li>
        <a href='/tags/fluent-bit/' style='font-size:1em'>Fluent-Bit</a>
      </li><li>
        <a href='/tags/fsk/' style='font-size:1.0816326530612246em'>fsk</a>
      </li><li>
        <a href='/tags/gc/' style='font-size:1em'>Gc</a>
      </li><li>
        <a href='/tags/gdal/' style='font-size:1.0408163265306123em'>gdal</a>
      </li><li>
        <a href='/tags/georeferencing/' style='font-size:1.0612244897959184em'>georeferencing</a>
      </li><li>
        <a href='/tags/geotiff/' style='font-size:1.0612244897959184em'>geotiff</a>
      </li><li>
        <a href='/tags/gnuradio/' style='font-size:1.0612244897959184em'>gnuradio</a>
      </li><li>
        <a href='/tags/hibernate/' style='font-size:1em'>Hibernate</a>
      </li><li>
        <a href='/tags/hugo/' style='font-size:1.0204081632653061em'>Hugo</a>
      </li><li>
        <a href='/tags/j2ee/' style='font-size:1.0204081632653061em'>j2ee</a>
      </li><li>
        <a href='/tags/java/' style='font-size:2em'>Java</a>
      </li><li>
        <a href='/tags/javafx/' style='font-size:1em'>javafx</a>
      </li><li>
        <a href='/tags/javascript/' style='font-size:1.0816326530612246em'>javascript</a>
      </li><li>
        <a href='/tags/jetty/' style='font-size:1.0408163265306123em'>jetty</a>
      </li><li>
        <a href='/tags/jmeter/' style='font-size:1em'>Jmeter</a>
      </li><li>
        <a href='/tags/jpeg/' style='font-size:1.1020408163265305em'>jpeg</a>
      </li><li>
        <a href='/tags/jpoint/' style='font-size:1em'>jpoint</a>
      </li><li>
        <a href='/tags/jquery/' style='font-size:1em'>Jquery</a>
      </li><li>
        <a href='/tags/jsp/' style='font-size:1.0612244897959184em'>jsp</a>
      </li><li>
        <a href='/tags/jstl/' style='font-size:1.0408163265306123em'>jstl</a>
      </li><li>
        <a href='/tags/junit/' style='font-size:1.0408163265306123em'>Junit</a>
      </li><li>
        <a href='/tags/letsencrypt/' style='font-size:1em'>Letsencrypt</a>
      </li><li>
        <a href='/tags/log4j/' style='font-size:1em'>log4j</a>
      </li><li>
        <a href='/tags/lora/' style='font-size:1.163265306122449em'>Lora</a>
      </li><li>
        <a href='/tags/lora-at/' style='font-size:1.0816326530612246em'>Lora-At</a>
      </li><li>
        <a href='/tags/lrpt/' style='font-size:1.0408163265306123em'>lrpt</a>
      </li><li>
        <a href='/tags/matlab/' style='font-size:1.0204081632653061em'>Matlab</a>
      </li><li>
        <a href='/tags/maven/' style='font-size:1.1020408163265305em'>maven</a>
      </li><li>
        <a href='/tags/memory/' style='font-size:1.0204081632653061em'>memory</a>
      </li><li>
        <a href='/tags/meteor-m/' style='font-size:1.0816326530612246em'>meteor-m</a>
      </li><li>
        <a href='/tags/mobitex/' style='font-size:1em'>mobitex</a>
      </li><li>
        <a href='/tags/monitoring/' style='font-size:1.1020408163265305em'>monitoring</a>
      </li><li>
        <a href='/tags/open-source/' style='font-size:1.0408163265306123em'>Open Source</a>
      </li><li>
        <a href='/tags/openapi/' style='font-size:1.0204081632653061em'>openapi</a>
      </li><li>
        <a href='/tags/opencl/' style='font-size:1.0408163265306123em'>Opencl</a>
      </li><li>
        <a href='/tags/openstack/' style='font-size:1em'>Openstack</a>
      </li><li>
        <a href='/tags/openstack-swift/' style='font-size:1em'>Openstack Swift</a>
      </li><li>
        <a href='/tags/orekit/' style='font-size:1.0204081632653061em'>orekit</a>
      </li><li>
        <a href='/tags/pipe/' style='font-size:1em'>Pipe</a>
      </li><li>
        <a href='/tags/plutosdr/' style='font-size:1.0204081632653061em'>Plutosdr</a>
      </li><li>
        <a href='/tags/prometheus/' style='font-size:1.0204081632653061em'>prometheus</a>
      </li><li>
        <a href='/tags/r2cloud/' style='font-size:1.0816326530612246em'>r2cloud</a>
      </li><li>
        <a href='/tags/r2lora/' style='font-size:1.0612244897959184em'>R2lora</a>
      </li><li>
        <a href='/tags/r2weather/' style='font-size:1.0408163265306123em'>R2weather</a>
      </li><li>
        <a href='/tags/radio/' style='font-size:1.2448979591836735em'>Радио</a>
      </li><li>
        <a href='/tags/raspberrypi/' style='font-size:1.4489795918367347em'>raspberrypi</a>
      </li><li>
        <a href='/tags/refactoring/' style='font-size:1em'>Refactoring</a>
      </li><li>
        <a href='/tags/rest/' style='font-size:1.0204081632653061em'>Rest</a>
      </li><li>
        <a href='/tags/rrd/' style='font-size:1.0204081632653061em'>rrd</a>
      </li><li>
        <a href='/tags/rtl_power/' style='font-size:1.0204081632653061em'>rtl_power</a>
      </li><li>
        <a href='/tags/rtlsdr/' style='font-size:1.2448979591836735em'>rtlsdr</a>
      </li><li>
        <a href='/tags/rtlspectrum/' style='font-size:1.0408163265306123em'>rtlSpectrum</a>
      </li><li>
        <a href='/tags/s3/' style='font-size:1em'>S3</a>
      </li><li>
        <a href='/tags/satnogs/' style='font-size:1.0408163265306123em'>Satnogs</a>
      </li><li>
        <a href='/tags/sdr-modem/' style='font-size:1.0612244897959184em'>Sdr-Modem</a>
      </li><li>
        <a href='/tags/sdr-server/' style='font-size:1em'>Sdr-Server</a>
      </li><li>
        <a href='/tags/security/' style='font-size:1.0204081632653061em'>Security</a>
      </li><li>
        <a href='/tags/selectel/' style='font-size:1em'>Selectel</a>
      </li><li>
        <a href='/tags/simd/' style='font-size:1.1020408163265305em'>SIMD</a>
      </li><li>
        <a href='/tags/sonarcube/' style='font-size:1.0408163265306123em'>Sonarcube</a>
      </li><li>
        <a href='/tags/spring/' style='font-size:1.0408163265306123em'>Spring</a>
      </li><li>
        <a href='/tags/sqnr/' style='font-size:1em'>Sqnr</a>
      </li><li>
        <a href='/tags/ssdv/' style='font-size:1.0204081632653061em'>Ssdv</a>
      </li><li>
        <a href='/tags/string/' style='font-size:1.0204081632653061em'>String</a>
      </li><li>
        <a href='/tags/sx127x/' style='font-size:1.163265306122449em'>Sx127x</a>
      </li><li>
        <a href='/tags/systemd/' style='font-size:1em'>Systemd</a>
      </li><li>
        <a href='/tags/testing/' style='font-size:1.0408163265306123em'>Testing</a>
      </li><li>
        <a href='/tags/travis-ci/' style='font-size:1.0204081632653061em'>Travis-Ci</a>
      </li><li>
        <a href='/tags/ubuntu/' style='font-size:1.0816326530612246em'>ubuntu</a>
      </li><li>
        <a href='/tags/valgrind/' style='font-size:1.0408163265306123em'>Valgrind</a>
      </li><li>
        <a href='/tags/validator/' style='font-size:1em'>Validator</a>
      </li><li>
        <a href='/tags/vuejs/' style='font-size:1.0408163265306123em'>vuejs</a>
      </li><li>
        <a href='/tags/yourkit/' style='font-size:1em'>Yourkit</a>
      </li><li>
        <a href='/tags/%D0%B0%D0%B4%D0%BC%D0%B8%D0%BD%D0%B8%D1%81%D1%82%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5/' style='font-size:1.3265306122448979em'>администрирование</a>
      </li><li>
        <a href='/tags/%D0%B4%D0%B7%D0%B7/' style='font-size:1.0816326530612246em'>ДЗЗ</a>
      </li><li>
        <a href='/tags/%D0%B4%D0%B8%D0%B7%D0%B0%D0%B9%D0%BD/' style='font-size:1.0816326530612246em'>дизайн</a>
      </li><li>
        <a href='/tags/%D0%B8%D0%B4%D0%B5%D0%B8/' style='font-size:1em'>Идеи</a>
      </li><li>
        <a href='/tags/%D0%BA%D0%BE%D1%81%D0%BC%D0%BE%D0%BD%D0%B0%D0%B2%D1%82%D0%B8%D0%BA%D0%B0/' style='font-size:1.0408163265306123em'>космонавтика</a>
      </li><li>
        <a href='/tags/%D0%BA%D1%83%D0%B1%D1%81%D0%B0%D1%82/' style='font-size:1.0408163265306123em'>кубсат</a>
      </li><li>
        <a href='/tags/%D0%BF%D0%B5%D1%80%D0%B5%D0%B2%D0%BE%D0%B4/' style='font-size:1.0204081632653061em'>перевод</a>
      </li><li>
        <a href='/tags/%D0%BF%D0%BE%D0%B2%D0%BE%D1%80%D0%BE%D1%82%D0%BD%D0%BE%D0%B5-%D1%83%D1%81%D1%82%D1%80%D0%BE%D0%B9%D1%81%D1%82%D0%B2%D0%BE/' style='font-size:1.1020408163265305em'>поворотное устройство</a>
      </li><li>
        <a href='/tags/%D0%BF%D1%80%D0%BE%D0%B8%D0%B7%D0%B2%D0%BE%D0%B4%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D0%BE%D1%81%D1%82%D1%8C/' style='font-size:1.346938775510204em'>производительность</a>
      </li><li>
        <a href='/tags/%D1%80%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B0/' style='font-size:1.0612244897959184em'>Разработка</a>
      </li><li>
        <a href='/tags/%D1%81%D0%BF%D0%B5%D1%86%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F/' style='font-size:1em'>Спецификация</a>
      </li><li>
        <a href='/tags/%D1%81%D0%BF%D1%83%D1%82%D0%BD%D0%B8%D0%BA%D0%B8/' style='font-size:1.4285714285714286em'>спутники</a>
      </li><li>
        <a href='/tags/%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5/' style='font-size:1.2653061224489797em'>Тестирование</a>
      </li><li>
        <a href='/tags/%D1%84%D0%B8%D0%BB%D1%8C%D1%82%D1%80%D1%8B/' style='font-size:1.0408163265306123em'>фильтры</a>
      </li></ul>
</div>


</section>
</div>

  <div class='sidebar-overlay'></div>
</div><div class='main'><nav id='main-menu' class='menu main-menu' aria-label=''>
  <div class='container'>
    <a class='screen-reader-text' href='#content'></a>

<button id='sidebar-toggler' class='sidebar-toggler' aria-controls='sidebar'>
  <span class='screen-reader-text'></span>
  <span class='open'><svg
  class="icon"
  xmlns="http://www.w3.org/2000/svg"
  viewbox="0 0 24 24"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  aria-hidden="true"
><line x1="3" y1="12" x2="21" y2="12" />
<line x1="3" y1="6" x2="21" y2="6" />
<line x1="3" y1="18" x2="21" y2="18" />
</svg>
</span>
  <span class='close'><svg
  class="icon"
  xmlns="http://www.w3.org/2000/svg"
  viewbox="0 0 24 24"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  aria-hidden="true"
><line x1="18" y1="6" x2="6" y2="18" />
<line x1="6" y1="6" x2="18" y2="18" />
</svg>
</span>
</button>
    <ul><li class='item current'>
        <a aria-current='page' href='/posts/'>Все записи</a>
      </li><li class='item'>
        <a href='/products/'>Гаджеты</a>
      </li><li class='item'>
        <a href='/%D0%BE%D0%B1-%D0%B0%D0%B2%D1%82%D0%BE%D1%80%D0%B5/'>Об авторе</a>
      </li><li class='item'>
        <a href='/%D0%BF%D0%BE%D0%B4%D0%B4%D0%B5%D1%80%D0%B6%D0%B0%D1%82%D1%8C/'>Поддержать</a>
      </li></ul>
  </div>
</nav><div class='header-widgets'>
        <div class='container'></div>
      </div>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>dernasherbrezon</p><p class='desc site-desc'>Блог о программировании на Java</p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='ru' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>lora-at</h1>
      

    </div>
    <div class='entry-meta'>
  <span class='posted-on'><svg
  class="icon"
  xmlns="http://www.w3.org/2000/svg"
  viewbox="0 0 24 24"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  aria-hidden="true"
><rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
<line x1="16" y1="2" x2="16" y2="6" />
<line x1="8" y1="2" x2="8" y2="6" />
<line x1="3" y1="10" x2="21" y2="10" />
</svg>
<span class='screen-reader-text'> </span>
  <time class='entry-date' datetime='2023-11-05T22:25:18&#43;01:00'>05 Nov 2023</time>
</span>

  
  

</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  <h2 id="история">История</h2>
<p>С момента моей последней статьи про LoRa прошло слишком много времени. За это время у меня появился проект <a href="https://github.com/dernasherbrezon/lora-at">lora-at</a>, про который я бы хотел написать в этой статье. И начну я, пожалуй, с истории о том, как он появился.</p>
<p>Изначально я планировал создать небольшую прошивку для приёма сигналов со спутников по протоколу LoRa. За основу я взял <a href="https://github.com/G4lile0/tinyGS">tinyGS</a>, которая делала почти всё, что мне было нужно. tinyGS позволял составлять расписание пролётов спутников, принимать пакеты со спутников и пересылать их на центральный сервер. Мне же нужно было что-то более легковесное и не интегрированное ни с какими серверами. Достаточно было, чтобы трансивер можно было контролировать с помощью REST API и получать данные по HTTP. В итоге у меня получилось создать проект <a href="https://github.com/dernasherbrezon/r2lora">r2lora</a>. Он оказался <a href="https://dernasherbrezon.com/posts/smart-usb-meter-a3-b/">более энергоэффективный</a>, чем tinyGS, и поддерживал <a href="https://dernasherbrezon.com/posts/fota-for-r2lora/">обновления по воздуху</a>.</p>
<p>Однако, после нескольких полевых испытаний, стало понятно, что использование REST API и веб сервера - не самая лучшая идея. Во-первых, необходимо поднимать Wi-Fi точку доступа. А для этого нужен либо роутер, либо Raspberry PI в режиме точки доступа. Роутер нельзя запустить в поле без аккумулятора на 12В. Raspberry PI же не всегда может работать в режиме точки доступа. Иногда хочется принести его домой, подключить к домашней сети и отправить все полученные данные в <a href="https://leosatdata.com">leosatdata.com</a>. Все эти проблемы решаемы, но как по мне, результат будет выглядеть громоздко для такой простой задачи, как передать несколько байтов с одного устройства на другое.</p>
<p>Именно тогда мне и пришла идея контролировать LoRa трансивер через UART интерфейс. Он используется для того, чтобы залить новую прошивку на устройство и посмотреть логи. Так почему бы не использовать его и для передачи команд?</p>
<h2 id="дизайн">Дизайн</h2>
<p>Сейчас я заканчиваю работу над второй версией проекта. Первая была написана на C++, использовала множество идей r2lora и, в принципе, справлялась со своей задачей. Однако, в ней было и несколько достаточно неприятных моментов. Во-первых, она использовала библиотеку RadioLib, которая <a href="https://dernasherbrezon.com/posts/sx127x/">не поддерживала</a> правильный выход из спящего режима. Во-вторых, код был написан с помощью <a href="https://github.com/espressif/arduino-esp32">Arduino фреймворка портированного на ESP32</a>. Этот фреймворк достаточно простой и рассчитан на новичков. С его помощью можно относительно быстро на коленке сделать работающий прототип, но мне хотелось использовать всю мощь ESP32. Например, типичный обработчик Arduino выглядит так:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loop</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (lora<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">isReceivingData</span>()) {
</span></span><span style="display:flex;"><span>    LoRaFrame <span style="color:#f92672">*</span>frame <span style="color:#f92672">=</span> lora<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">loop</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (frame <span style="color:#f92672">!=</span> NULL) {
</span></span><span style="display:flex;"><span>      client<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">sendData</span>(frame);
</span></span><span style="display:flex;"><span>      handler<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">addFrame</span>(frame);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>Непонятно зачем делать бесконечный цикл, если в ESP32 есть FreeRTOS, которая позволяет с помощью прерываний и тасков обрабатывать асинхронные события. В-третьих, С++. Долгая компиляция, мешанина из концепций, интерфейсов, системных и вспомогательных библиотек - всё это не даёт уверенности в написанном коде.</p>
<p>Мне же хотелось:</p>
<ul>
<li>C</li>
<li>Как можно более низких API и абстракций ESP32</li>
<li>Собственной <a href="https://github.com/dernasherbrezon/sx127x">библиотеки sx127x</a></li>
<li>Прерываний и обработчиков в отдельных тасках FreeRTOS</li>
</ul>
<p>Из функциональных требований осталось:</p>
<ul>
<li>Поддержка AT команд через UART интерфейс. Они должны контролировать каждый аспект системы</li>
<li>Хранение конфигурации во флеш памяти</li>
<li>Поддержка режима глубокого сна и <a href="https://dernasherbrezon.com/posts/ble-server-java/">интеграция через Bluetooth</a></li>
<li>Поддержка LoRa и FSK модуляций</li>
<li>Отправка и получение данных в пакетном режиме. Максимальный размер пакета 255 байт</li>
</ul>
<p>Дизайн принципиально не отличается от r2lora:</p>
<div>


	<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="-0.5 -0.5 441 441"><defs/><g><path d="M 200 20 L 220 20 L 220 140 L 353.63 140" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 358.88 140 L 351.88 143.5 L 353.63 140 L 351.88 136.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/><rect x="120" y="0" width="80" height="40" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 20px; margin-left: 121px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">at_config</div></div></div></foreignObject><text x="160" y="24" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">at_config</text></switch></g><rect x="360" y="120" width="80" height="40" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 140px; margin-left: 361px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">at_handler</div></div></div></foreignObject><text x="400" y="144" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">at_handler</text></switch></g><path d="M 200 100 L 220 100 L 220 140 L 353.63 140" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 358.88 140 L 351.88 143.5 L 353.63 140 L 351.88 136.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/><rect x="120" y="80" width="80" height="40" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 100px; margin-left: 121px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">at_timer</div></div></div></foreignObject><text x="160" y="104" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">at_timer</text></switch></g><path d="M 200 180 L 220 180 L 220 140 L 353.63 140" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 358.88 140 L 351.88 143.5 L 353.63 140 L 351.88 136.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/><rect x="120" y="160" width="80" height="40" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 180px; margin-left: 121px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">at_util</div></div></div></foreignObject><text x="160" y="184" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">at_util</text></switch></g><path d="M 320 260 L 340 260 L 340 140 L 353.63 140" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 358.88 140 L 351.88 143.5 L 353.63 140 L 351.88 136.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/><rect x="240" y="240" width="80" height="40" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 260px; margin-left: 241px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">ble_client</div></div></div></foreignObject><text x="280" y="264" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">ble_client</text></switch></g><rect x="120" y="400" width="80" height="40" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 420px; margin-left: 121px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">deep_sleep</div></div></div></foreignObject><text x="160" y="424" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">deep_sleep</text></switch></g><path d="M 200 340 L 340 340 L 340 140 L 353.63 140" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 358.88 140 L 351.88 143.5 L 353.63 140 L 351.88 136.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/><rect x="120" y="320" width="80" height="40" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 340px; margin-left: 121px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">display</div></div></div></foreignObject><text x="160" y="344" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">display</text></switch></g><path d="M 200 260 L 233.63 260" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 238.88 260 L 231.88 263.5 L 233.63 260 L 231.88 256.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/><path d="M 200 250 L 220 250 L 220 140 L 353.63 140" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 358.88 140 L 351.88 143.5 L 353.63 140 L 351.88 136.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/><rect x="120" y="240" width="80" height="40" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 260px; margin-left: 121px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">sx127x_util</div></div></div></foreignObject><text x="160" y="264" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">sx127x_util</text></switch></g><path d="M 80 260 L 113.63 260" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 118.88 260 L 111.88 263.5 L 113.63 260 L 111.88 256.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/><rect x="0" y="240" width="80" height="40" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 260px; margin-left: 1px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">sx127x</div></div></div></foreignObject><text x="40" y="264" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">sx127x</text></switch></g><path d="M 80 340 L 113.63 340" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 118.88 340 L 111.88 343.5 L 113.63 340 L 111.88 336.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/><rect x="0" y="320" width="80" height="40" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 340px; margin-left: 1px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">ssd1306</div></div></div></foreignObject><text x="40" y="344" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">ssd1306</text></switch></g></g><switch><g requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"/><a transform="translate(0,-5)" xlink:href="https://www.drawio.com/doc/faq/svg-export-text-problems" target="_blank"><text text-anchor="middle" font-size="10px" x="50%" y="100%">Text is not SVG - cannot display</text></a></switch></svg>

</div>
<p>Каждая подсистема должна быть в отдельном компоненте и все вместе они должны контролироваться at_handler - обработчиком AT команд.</p>
<p>А вот при выборе фреймворка я решил остановится на <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/get-started/">ESP-IDF</a>. В конце-концов - это официально поддерживаемая среда для разработки под ESP32. А значит все остальные библиотеки и фреймворки основаны на ней. А значит она достаточно низкоуровневая.</p>
<h2 id="esp-idf">ESP-IDF</h2>
<p>Моя основная претензия к PlatformIO и <a href="https://github.com/espressif/arduino-esp32">arduino-esp32</a> заключается в том, что они добавляют не всегда удачные уровни абстрации. Это позволяет быстро собрать нужный прототип, но, зачастую, в ущерб общей структуре проекта и поддерживаемости. Например, LoRa чип подключен по SPI шине. Её, наверное, нужно инициализировать, послать команду на чип, получить ответ и обработать. Если где-то случается проблема, то очень важно понимать в какой момент. И, читая достаточно низкоуровневый код, это легко понять. Однако, типичный пример кода для arduino-esp32:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>LoRa.begin(<span style="color:#ae81ff">915E6</span>)) {
</span></span><span style="display:flex;"><span>  Serial.println(<span style="color:#e6db74">&#34;Starting LoRa failed!&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Что это? Конструктор? Синглетон? Где инициализация SPI шины? Какие пины используются? Зато инициализация чипа одной строчкой.</p>
<p>Как оказалось, несмотря на то, что ESP-IDF достаточно низкоуровневый, у него вполне понятные абстракции и очень знакомые инструменты работы. Этот фреймворк определяет то, как должен проект собираться, как тестироваться, API к внутренним системам ESP32, где и как брать зависимости - в общем всё, что нужно для разработки. На официальном сайте есть <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/get-started/index.html#ide">интеграции с Eclipse и VSCode</a>, но я решил попробовать <a href="https://www.jetbrains.com/clion/">CLion</a>. Благо он у меня уже куплен и используется для разработки других проектов на Си. С какого-то времени CLion поддерживает инициализацию с помощью environment file. Это единственное, что мне нужно было сконфигурировать. Каждый раз, когда проект нужно собрать CLion запускает стандартый скрипт export.sh и получает всю информацию о том, какой используется компилятор, где брать разные исходники и заголовочные файлы и тд.</p>
<p><img src="/posts/lora-at/img/1.png"></p>
<p>Из неочевидных преимуществ: CLion позволяет загружать проект на удалённый хост и там его компилировать. VSCode тоже может, но для этого ему нужен Python и NodeJS последней версии. И то, и другое ужасно тормозят на RaspberryPI. У CLion такой проблемы нет. Видимо у него очень легковесная работа с удалёнными хостами.</p>
<p><img src="/posts/lora-at/img/3.png"></p>
<h3 id="управление-зависимостями">Управление зависимостями</h3>
<p>Работа с зависимостями в ESP-IDF очень похожа на NodeJS. Они скачиваются в виде исходного кода в специальную папку и компилируются при сборке проекта. Добавить зависимость можно с помощью команды:</p>
<pre tabindex="0"><code>idf.py add-dependency dernasherbrezon/sx127x
</code></pre><p>После этого появляется папка <del>node_modules</del> managed_components с необходимыми зависимостями.</p>
<p>В lora-at используется только две внешние зависимости:</p>
<ul>
<li><a href="https://github.com/dernasherbrezon/sx127x/tree/main">dernasherbrezon/sx127x</a> - для работы с LoRa чипом</li>
<li><a href="https://github.com/espressif/esp-bsp/tree/master/components/ssd1306">espressif/ssd1306</a> - для работы с OLED экраном</li>
</ul>
<p>Помимо внешних, можно подключать компоненты самого фреймворка или свои собственные. Делается это с помощью CMakeLists.txt:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>idf_component_register(<span style="color:#e6db74">SRCS</span> <span style="color:#e6db74">&#34;ble_client.c&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">INCLUDE_DIRS</span> <span style="color:#e6db74">&#34;.&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">REQUIRES</span> <span style="color:#e6db74">bt</span> <span style="color:#e6db74">nvs_flash</span> <span style="color:#e6db74">sx127x_util</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>После того, как зависимости объявлены, их можно использовать в проекте:</p>
<pre tabindex="0"><code>#include &lt;nvs_flash.h&gt;
</code></pre><p>Это немного отличается от подхода PlatformIO, где прямо сразу можно подключать заголовочный файл, а IDE сама найдёт нужные зависимости и подключит. Я сторонник всего явного, поэтому подход ESP-IDF мне больше импонирует.</p>
<p>Компоненты самого фреймворка, которые мне пришлось использовать:</p>
<ul>
<li>bt - для работы с Bluetooth</li>
<li>nvs_flash - для работы с флеш памятью. Там lora-at хранит конфигурацию и загружает её оттуда после перезагрузки</li>
<li>driver - для работы с SPI шиной, по которой управляется чип sx127x. Там же лежит драйвер для работы с GPIO</li>
</ul>
<h3 id="структура-проекта">Структура проекта</h3>
<p>Структура проекта очень похожа на PlatformIO, где каждый модуль выделяется в отдельный компонент. Каждый из них отдельно компилируется и конфигурируется.</p>
<p><img src="/posts/lora-at/img/4.png"></p>
<p>Все они добавляются как зависимости в центральный <code>main</code> компонент, который содержит точку входа:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">app_main</span>(<span style="color:#66d9ef">void</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// do the stuff
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h3 id="конфигурация">Конфигурация</h3>
<p>Конфигурировать проект можно двумя способами:</p>
<ul>
<li>с помощью AT команд. Подходит для опций, которые могут меняться время от времени</li>
<li>с помощью KConfig. Статическая конфигурация на этапе компиляции</li>
</ul>
<p>Если с AT всё ясно, то вот KConfig - достаточно мощная система, которой не было в PlatformIO. Для того, чтобы добавить свою конфигурацию, необходимо создать файл KConfig в специальном формате. Я не буду останавливаться на его структуре, тем более, что в официальной документации всё <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/kconfig.html">очень подробно описано</a>. После того, как файл создан, можно запускать сам конфигуратор, используя команду:</p>
<pre tabindex="0"><code>idf.py menuconfig
</code></pre><p>В результате работы появится интерфейс, очень похожий на конфигуратор ядра Linux:</p>
<p><img src="/posts/lora-at/img/5.png"></p>
<p>Когда я запустил его в первый раз, то был крайне удивлён. Если поисследовать доступные опции, то становится понятно, что конфигурировать можно абсолютно всё: от размера партиций, до Bluetooth стека. Этот конфигуратор подцепляет не только конфигурацию приложения, но и самого фреймворка. И в целом это логично - ведь приложение компилируется вместе с фреймворком и потом заливается на устройство одним бинарником.</p>
<p>Ещё одна вещь, которая меня приятно удивила - это очень хорошая документация! Если выбрать опцию и нажать <code>?</code>, то появится полное описание: зачем она нужна, какие варианты выбора существуют и так далее. Такой основательный подход крайне заразителен, поэтому для lora-at я тоже добавил максимально подробное описание каждого параметра.</p>
<p><img src="/posts/lora-at/img/6.png"></p>
<p>После того, как конфигуратор отработает, в корне проекта появится файл sdkconfig, содержащий конфигурацию.</p>
<pre tabindex="0"><code>...
CONFIG_MIN_FREQUENCY=25000000
CONFIG_MAX_FREQUENCY=1700000000
...
</code></pre><p>При компиляции он преобразуется в sdkconfig.h, который можно использовать в любом компоненте.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#define CONFIG_MIN_FREQUENCY 25000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define CONFIG_MAX_FREQUENCY 1700000000
</span></span></span></code></pre></div><p>В PlatformIO есть достаточно удобная функциональность <a href="https://docs.platformio.org/en/latest/projectconf/sections/env/index.html">по конфигурированию различных сред</a>. В r2lora она использовалась для быстрой сборки под конкретную плату. ESP32 и sx127x могут быть по-разному распаяны на разных платах. Это приводит к тому, что номера GPIO пинов немного не совпадают. Я заранее создал конфигурацию пинов для наиболее часто используемых плат и назначил каждой плате свою &ldquo;среду&rdquo;. При компиляции достаточно было указать нужную среду под которую собирается прошивка.</p>
<p>В ESP-IDF я сделал нечто похожее. Фреймворк позволяет заранее создать различные настройки по-умолчанию в виде sdkconfig-файлов. Например, я создал: <code>sdkconfig.ttgo-lora32-v2</code>, <code>sdkconfig.ttgo-lora32-v1</code> и тд. В них я переопределил пины для соответствующих плат. Использовать их можно при сборке в следующем виде:</p>
<pre tabindex="0"><code>SDKCONFIG_DEFAULTS=&#34;sdkconfig.ttgo-lora32-v2&#34; idf.py build
</code></pre><p>Если нужна более сложная конфигурация, то можно передать несколько файлов. Но для lora-at этого оказалось вполне достаточно.</p>
<h2 id="реализация">Реализация</h2>
<p>Большинство компонентов, которые были в r2cloud пришлось значительно переписать. В итоге они стали занимать больше места и делать много низкоуровневой инициализации. Если раньше получить данные с флеш памяти можно было так:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>Preferences preferences;
</span></span><span style="display:flex;"><span>preferences.begin(<span style="color:#e6db74">&#34;lora-at&#34;</span>, true);
</span></span><span style="display:flex;"><span>size_t chip_index <span style="color:#f92672">=</span> preferences.getUChar(<span style="color:#e6db74">&#34;chip_index&#34;</span>);
</span></span><span style="display:flex;"><span>preferences.end();
</span></span></code></pre></div><p>То сейчас:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">nvs_handle_t</span> out_handle;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">esp_err_t</span> err <span style="color:#f92672">=</span> <span style="color:#a6e22e">nvs_open</span>(<span style="color:#e6db74">&#34;lora-at&#34;</span>, NVS_READONLY, <span style="color:#f92672">&amp;</span>out_handle);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>( err <span style="color:#f92672">==</span> ESP_ERR_NVS_NOT_FOUND ) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> EPS_OK;
</span></span><span style="display:flex;"><span>} 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>( err <span style="color:#f92672">!=</span> ESP_OK ) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> err;
</span></span><span style="display:flex;"><span>} 
</span></span><span style="display:flex;"><span>err <span style="color:#f92672">=</span> <span style="color:#a6e22e">nvs_get_u64</span>(out_handle, <span style="color:#e6db74">&#34;period&#34;</span>, <span style="color:#f92672">&amp;</span>result<span style="color:#f92672">-&gt;</span>deep_sleep_period_micros);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>( err <span style="color:#f92672">!=</span> ESP_OK <span style="color:#f92672">&amp;&amp;</span> err <span style="color:#f92672">!=</span> ESP_ERR_NVS_NOT_FOUND ) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> err;
</span></span><span style="display:flex;"><span>} 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">nvs_close</span>(out_handle);
</span></span></code></pre></div><p>Код выглядит более сложным, но на самом деле это не так. Просто появляется обработка ошибок и явный вызов функций nvs. В примере же на С++ непонятно, что такое <code>Preferences</code>. Зачем nvs нужно было переименовывать? Почему названия классов нельзя было сделать близкими к C API? Почему типы фиксированной длины вроде uint32_t они почему-то решили переименовать в UInt?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#66d9ef">uint32_t</span> <span style="color:#a6e22e">getUInt</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> key, <span style="color:#66d9ef">uint32_t</span> defaultValue <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>);
</span></span></code></pre></div><p>В то время, как оригинальный API вполне лаконичен:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">esp_err_t</span> <span style="color:#a6e22e">nvs_get_u32</span>(<span style="color:#66d9ef">nvs_handle_t</span> handle, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> key, <span style="color:#66d9ef">uint32_t</span><span style="color:#f92672">*</span> out_value);
</span></span></code></pre></div><p>Так много вопросов, и так мало ответов.</p>
<p>Несмотря на то, что С API более лаконичный, с некоторыми компонентами пришлось повозиться. В основном из-за того, что я не понимал как работает та или иная технология, а С++ API умело скрывал её от меня.</p>
<h3 id="bluetooth">Bluetooth</h3>
<p>Наверное, самый сложный компонент, который мне пришлось написать. Изначально я открыл обучающую статью по ESP32 Bluetooth и начал реализовывать нужные функции. Однако, в какой-то момент я наткнулся на комментарий <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-guides/bluetooth.html">в документации</a>: &ldquo;Если Вам нужно только взаимодействие по протоколу BLE, то лучше взять NimBLE. Он более легковесен и занимает меньше кода, по сравнению с Bluedroid&rdquo;. Что ж. Пришлось разбираться, что такое NimBLE и чем он отличается от Bluedroid.</p>
<p>Оказывается, Bluedroid - это полноценная реализация как &ldquo;классического&rdquo; Bluetooth, так и Bluetooth Low Energy (BLE). И, поскольку, он поддерживает оба режима, то его API более сложный. NimBLE реализует только BLE, и поэтому более легковесный. В ESP-IDF есть поддержка обеих реализаций и можно выбрать нужную на этапе конфигурации. Делается это с помощью sdkconfig:</p>
<pre tabindex="0"><code>CONFIG_BT_ENABLED=y
CONFIG_BT_NIMBLE_ENABLED=y
CONFIG_BT_CONTROLLER_ENABLED=y
</code></pre><p>Сам же API мне не показался легче. Оба построены на callback, когда для каждой операции передаётся функция-обработчик, которая потом асинхронно вызывается в отдельном таске FreeRTOS. Иронично, но для lora-at асинхронность не особо нужна, так как все команды должны гарантированно завершиться прежде, чем устройство перейдёт в спящий режим. Типичный код выглядит следующим образом:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">ble_client_disc_svc_fn</span>(<span style="color:#75715e">/* some arguments */</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>( error<span style="color:#f92672">-&gt;</span>status <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> ) {
</span></span><span style="display:flex;"><span>      client<span style="color:#f92672">-&gt;</span>semaphore_result <span style="color:#f92672">=</span> ESP_OK;
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>  	 <span style="color:#75715e">// handle error properly
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      client<span style="color:#f92672">-&gt;</span>semaphore_result <span style="color:#f92672">=</span> ESP_ERR_TIMEOUT;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">xSemaphoreGive</span>(client<span style="color:#f92672">-&gt;</span>semaphore);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">esp_err_t</span> <span style="color:#a6e22e">ble_client_find_service</span>(<span style="color:#75715e">/* some arguments */</span>) {
</span></span><span style="display:flex;"><span>  client<span style="color:#f92672">-&gt;</span>semaphore_result <span style="color:#f92672">=</span> ESP_FAIL;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">esp_err_t</span> code <span style="color:#f92672">=</span> <span style="color:#a6e22e">ble_gattc_disc_svc_by_uuid</span>(conn_handle, remote_svc_uuid, ble_client_disc_svc_fn, client);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>( code <span style="color:#f92672">!=</span> ESP_OK ) {
</span></span><span style="display:flex;"><span>  	<span style="color:#66d9ef">return</span> code;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">WAIT_FOR_SEMAPHORE</span>(<span style="color:#e6db74">&#34;...&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> client<span style="color:#f92672">-&gt;</span>semaphore_result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="uart">UART</h3>
<p>Вторым по сложности компонентом стало чтение команд из UART. Если раньше можно было в цикле читать по одному символу:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>size_t AtHandler<span style="color:#f92672">::</span>read_line(Stream <span style="color:#f92672">*</span>in) {
</span></span><span style="display:flex;"><span>  size_t result <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (in<span style="color:#f92672">-&gt;</span>available() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> inByte <span style="color:#f92672">=</span> in<span style="color:#f92672">-&gt;</span>read();
</span></span><span style="display:flex;"><span>    result<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// if char is \n, then return result
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>То работа через прерывания требует чуть более сложного кода. Во-первых, нужно инициализировать одну из четырёх UART шин:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">uart_config_t</span> uart_config <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    .baud_rate <span style="color:#f92672">=</span> CONFIG_AT_UART_BAUD_RATE,
</span></span><span style="display:flex;"><span>    .data_bits <span style="color:#f92672">=</span> UART_DATA_8_BITS,
</span></span><span style="display:flex;"><span>    .parity <span style="color:#f92672">=</span> UART_PARITY_DISABLE,
</span></span><span style="display:flex;"><span>    .stop_bits <span style="color:#f92672">=</span> UART_STOP_BITS_1,
</span></span><span style="display:flex;"><span>    .flow_ctrl <span style="color:#f92672">=</span> UART_HW_FLOWCTRL_DISABLE,
</span></span><span style="display:flex;"><span>    .source_clk <span style="color:#f92672">=</span> UART_SCLK_DEFAULT,
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">uart_driver_install</span>(result<span style="color:#f92672">-&gt;</span>uart_port_num, CONFIG_AT_UART_BUFFER_LENGTH <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>, CONFIG_AT_UART_BUFFER_LENGTH <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">20</span>, <span style="color:#f92672">&amp;</span>result<span style="color:#f92672">-&gt;</span>uart_queue, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">uart_param_config</span>(result<span style="color:#f92672">-&gt;</span>uart_port_num, <span style="color:#f92672">&amp;</span>uart_config);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">uart_set_pin</span>(result<span style="color:#f92672">-&gt;</span>uart_port_num, CONFIG_AT_UART_TX_PIN, CONFIG_AT_UART_RX_PIN, UART_PIN_NO_CHANGE, UART_PIN_NO_CHANGE);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">uart_enable_pattern_det_baud_intr</span>(result<span style="color:#f92672">-&gt;</span>uart_port_num, <span style="color:#e6db74">&#39;\n&#39;</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">9</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">uart_pattern_queue_reset</span>(result<span style="color:#f92672">-&gt;</span>uart_port_num, <span style="color:#ae81ff">20</span>);
</span></span></code></pre></div><p>Во-вторых, нужно инициализировать FreeRTOS таск и начать читать данные из uart_queue:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">uart_at_handler_process</span>(<span style="color:#66d9ef">uart_at_handler_t</span> <span style="color:#f92672">*</span>handler) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">xQueueReceive</span>(handler<span style="color:#f92672">-&gt;</span>uart_queue, (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>) <span style="color:#f92672">&amp;</span>event, (TickType_t) portMAX_DELAY)) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">switch</span> (event.type) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> UART_DATA:
</span></span><span style="display:flex;"><span>        	<span style="color:#75715e">// handle using uart_read_bytes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">case</span> UART_PATTERN_DET:
</span></span><span style="display:flex;"><span>         <span style="color:#75715e">// handle using uart_read_bytes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">case</span> UART_FIFO_OVF:
</span></span><span style="display:flex;"><span>         <span style="color:#75715e">// handle
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">case</span> UART_BUFFER_FULL:
</span></span><span style="display:flex;"><span>         <span style="color:#75715e">// handle
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// determine if data contains new line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (found) {
</span></span><span style="display:flex;"><span>	  <span style="color:#75715e">// call at handler
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	}
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">xTaskCreate</span>(uart_at_handler_process, <span style="color:#e6db74">&#34;uart_rx_task&#34;</span>, <span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span>, handler, configMAX_PRIORITIES, NULL);
</span></span></code></pre></div><p>Ручной контроль заставил задуматься о том, как работает UART на низком уровне, узнать, что существует целых 4 шины и написать более эффективный код. В качестве побочного бонуса, я смог переконфигурировать UART на другие GPIO, а само устройство запитать от <a href="https://en.wikipedia.org/wiki/JST_connector">JST коннектора</a>. Это позволило делать подключить <a href="https://www.nordicsemi.com/Products/Development-hardware/Power-Profiler-Kit-2">Power Profiler Kit II</a> и измерить потребление энергии. Весь процесс занял минут 10. Из них 5 минут я искал USB-to-UART кабель и 3 минуты выбирал какие лучше пины использовать.</p>
<h2 id="результаты">Результаты</h2>
<p>Вторая версия работает просто замечательно! Сравнивать производительность С и С++ кода, наверное, бессмысленно, скорее потому, что это не так важно в мире микроконтроллеров. А вот потребление энергии будет очень интересно посмотреть. Но об этом в следующей статье. А пока всего лишь сравнение размера прошивок:</p>
<pre tabindex="0"><code>$ ls -lh ./build/lora-at.bin 
-rw-r--r-- 1 pi pi 665K Nov  5 22:09 ./build/lora-at.bin
</code></pre><p>И С++ версия:</p>
<pre tabindex="0"><code>$ ls -lh .pio/build/ttgo-lora32-v2/firmware.bin
-rw-r--r-- 1 pi pi 1.1M Nov  9 20:39 .pio/build/ttgo-lora32-v2/firmware.bin
</code></pre><p>Версия на С почти в 2 раза меньше!</p>

</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'><div class='tags'><svg
  class="icon"
  xmlns="http://www.w3.org/2000/svg"
  viewbox="0 0 24 24"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  aria-hidden="true"
><path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z" />
<line x1="7" y1="7" x2="7" y2="7" />
</svg>
<span class='screen-reader-text'>tags: </span><a class='tag' href='/tags/lora/'>Lora</a>, <a class='tag' href='/tags/lora-at/'>Lora-At</a>, <a class='tag' href='/tags/esp32/'>Esp32</a>, <a class='tag' href='/tags/esp-idf/'>Esp-Idf</a></div>

  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/posts/bayer-filter/'>
        <span aria-hidden='true'><svg
  class="icon"
  xmlns="http://www.w3.org/2000/svg"
  viewbox="0 0 24 24"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  aria-hidden="true"
><line x1="20" y1="12" x2="4" y2="12" />
<polyline points="10 18 4 12 10 6" />
</svg>
 </span>
        <span class='screen-reader-text'>: </span>Практическое применение фильтра Байера</a>
    </div><div class='next-entry sep-before'>
      <a href='/posts/testing-in-esp-idf/'>
        <span class='screen-reader-text'>: </span>Тестирование в ESP-IDF<span aria-hidden='true'> <svg
  class="icon"
  xmlns="http://www.w3.org/2000/svg"
  viewbox="0 0 24 24"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  aria-hidden="true"
><line x1="4" y1="12" x2="20" y2="12" />
<polyline points="14 6 20 12 14 18" />
</svg>
</span>
      </a>
    </div></div>
</nav>


<section id='comments' class='comments'>
  <div class='container sep-before'>
    <div class='comments-area'><script>
  var remark_config = {
    host: "https://remark42.dernasherbrezon.com", 
    site_id: '9134',
    locale: 'ru',
    components: ['embed'] 
                          
                          
                          
                          
                          
  };

  (function(c) {
    for(var i = 0; i < c.length; i++){
      var d = document, s = d.createElement('script');
      s.src = remark_config.host + '/web/' +c[i] +'.js';
      s.defer = true;
      (d.head || d.body).appendChild(s);
    }
  })(remark_config.components || ['embed']);
</script>
<div id="remark42"></div>
</div>
  </div>
</section>

      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><section class='widget widget-social_menu sep-after'><nav aria-label=''>
    <ul><li>
        <a href='https://github.com/dernasherbrezon' target='_blank' rel='noopener me'>
          <span class='screen-reader-text'></span><svg
  class="icon"
  xmlns="http://www.w3.org/2000/svg"
  viewbox="0 0 24 24"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  aria-hidden="true"
><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" />
</svg>
</a>
      </li><li>
        <a href='https://twitter.com/dernasherbrezon' target='_blank' rel='noopener me'>
          <span class='screen-reader-text'></span><svg
  class="icon"
  xmlns="http://www.w3.org/2000/svg"
  viewbox="0 0 24 24"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  aria-hidden="true"
><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z" />
</svg>
</a>
      </li><li>
        <a href='mailto:dernasherbrezon@gmail.com' target='_blank' rel='noopener me'>
          <span class='screen-reader-text'></span><svg
  class="icon"
  xmlns="http://www.w3.org/2000/svg"
  viewbox="0 0 24 24"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  aria-hidden="true"
><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
<polyline points="22,6 12,13 2,6" />
</svg>
</a>
      </li><li>
        <a href='https://t.me/dernasherbrezonChannel' target='_blank' rel='noopener me'>
          <span class='screen-reader-text'></span><svg
  class="icon"
  xmlns="http://www.w3.org/2000/svg"
  viewbox="0 0 24 24"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  aria-hidden="true"
><path d="M23.91 3.79L20.3 20.84c-.25 1.21-.98 1.5-2 .94l-5.5-4.07-2.66 2.57c-.3.3-.55.56-1.1.56-.72 0-.6-.27-.84-.95L6.3 13.7l-5.45-1.7c-1.18-.35-1.19-1.16.26-1.75l21.26-8.2c.97-.43 1.9.24 1.53 1.73z" />
</svg>
</a>
      </li></ul>
  </nav>
</section><div class='copyright'>
  <p><a href="https://creativecommons.org/licenses/by-nc-nd/3.0/">CC BY-NC-ND 3.0</a> &copy; 2017-2025 dernasherbrezon </p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__assets_js_src="/assets/js/"</script>

<script src='/assets/js/main.c3bcf2df.js'></script>
</body>

</html>

