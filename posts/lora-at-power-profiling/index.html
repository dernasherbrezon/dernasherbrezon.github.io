<!DOCTYPE html>
<html lang='ru' dir='auto'><head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='Как следует разобравшись с тем, как работает Power Profiler Kit 2 (PPK2), я решил протестировать разные режимы работы. На самом деле lora-at - не такое уж и простое приложение. В нём есть работа с bluetooth и чипом sx127x, обработка команд с UART шины и режим глубокого сна. Есть, где развернуться.
Методология измерений Перед тем как начинать что-то измерять, необходимо определиться с тем, как это будет измеряться.
Во-первых, я собираюсь использовать PPK2 по-максимуму.'>
<meta name='theme-color' content='#ffcd00'>

<meta property='og:title' content='Тестирование потребления энергии в lora-at • dernasherbrezon'>
<meta property='og:description' content='Как следует разобравшись с тем, как работает Power Profiler Kit 2 (PPK2), я решил протестировать разные режимы работы. На самом деле lora-at - не такое уж и простое приложение. В нём есть работа с bluetooth и чипом sx127x, обработка команд с UART шины и режим глубокого сна. Есть, где развернуться.
Методология измерений Перед тем как начинать что-то измерять, необходимо определиться с тем, как это будет измеряться.
Во-первых, я собираюсь использовать PPK2 по-максимуму.'>
<meta property='og:url' content='https://dernasherbrezon.com/posts/lora-at-power-profiling/'>
<meta property='og:site_name' content='dernasherbrezon'>
<meta property='og:type' content='article'><meta property='article:section' content='posts'><meta property='article:tag' content='lora'><meta property='article:tag' content='lora-at'><meta property='article:tag' content='esp32'><meta property='article:tag' content='esp-idf'><meta property='article:tag' content='PPK2'><meta property='article:published_time' content='2023-11-25T23:28:18&#43;01:00'/><meta property='article:modified_time' content='2023-11-25T23:28:18&#43;01:00'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@dernasherbrezon'>

<meta name="generator" content="Hugo 0.124.0">

  <title>Тестирование потребления энергии в lora-at • dernasherbrezon</title>
  <link rel='canonical' href='https://dernasherbrezon.com/posts/lora-at-power-profiling/'>
  
    <link href="https://dernasherbrezon.com/posts/lora-at-power-profiling/index.xml" rel="alternate" type="application/rss+xml" title="dernasherbrezon" />
  
  <link rel='alternate' hreflang='ru' href='https://dernasherbrezon.com/posts/lora-at-power-profiling/'><link rel='alternate' hreflang='x-default' href='https://dernasherbrezon.com/posts/lora-at-power-profiling/'><link rel='alternate' hreflang='en' href='https://dernasherbrezon.com/en/posts/lora-at-power-profiling/'>
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.ab98e12b.css'><link rel='stylesheet' href='/css/custom.1.css'><style>
:root{--color-accent:#ffcd00;}
</style>

  <meta name="telegram:channel" content="@dernasherbrezonChannel">
<link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><script src="/js/chart.min.js"></script>
</head>
<body class='page type-posts has-sidebar'>

  <div class='site'><div id='sidebar' class='sidebar'>
  <a class='screen-reader-text' href='#main-menu'></a>

  <div class='container'><section class='widget widget-about sep-after'>
  <header>
    
    <div class='logo'>
      <a href='/'>
        <img src='/img/logo.jpeg'>
      </a>
    </div>
    
    <h2 class='title site-title '>
      <a href='/'>
      dernasherbrezon
      </a>
    </h2>
    <div class='desc'>
    Блог о программировании на Java
    </div>
  </header>

</section>
<section class='widget widget-sidebar_menu sep-after'><nav id='sidebar-menu' class='menu sidebar-menu' aria-label=''>
    <div class='container'>
      <ul><li class='item has-current'>
  <a href='/posts/'>Все записи</a></li><li class='item'>
  <a href='/%D0%BE%D0%B1-%D0%B0%D0%B2%D1%82%D0%BE%D1%80%D0%B5/'>Об авторе</a></li><li class='item'>
  <a href='/%D0%BF%D0%BE%D0%B4%D0%B4%D0%B5%D1%80%D0%B6%D0%B0%D1%82%D1%8C/'>Поддержать</a></li></ul>
    </div>
  </nav>

</section><section class='widget widget-taxonomy_cloud sep-after'>
  <header>
    <h4 class='title widget-title'>Тэги</h4>
  </header>

  <div class='container list-container'>
  <ul class='list taxonomy-cloud'><li>
        <a href='/tags/abbreviated-jpeg/' style='font-size:1.0204081632653061em'>abbreviated jpeg</a>
      </li><li>
        <a href='/tags/acme/' style='font-size:1em'>Acme</a>
      </li><li>
        <a href='/tags/api/' style='font-size:1.0612244897959184em'>api</a>
      </li><li>
        <a href='/tags/apt/' style='font-size:1.0612244897959184em'>Apt</a>
      </li><li>
        <a href='/tags/awgn/' style='font-size:1em'>Awgn</a>
      </li><li>
        <a href='/tags/bash/' style='font-size:1.0204081632653061em'>bash</a>
      </li><li>
        <a href='/tags/ber/' style='font-size:1.1020408163265305em'>ber</a>
      </li><li>
        <a href='/tags/bluetooth/' style='font-size:1.0204081632653061em'>Bluetooth</a>
      </li><li>
        <a href='/tags/bpsk/' style='font-size:1.0204081632653061em'>bpsk</a>
      </li><li>
        <a href='/tags/c/' style='font-size:1.4489795918367347em'>C</a>
      </li><li>
        <a href='/tags/deb/' style='font-size:1.0816326530612246em'>Deb</a>
      </li><li>
        <a href='/tags/docker/' style='font-size:1em'>Docker</a>
      </li><li>
        <a href='/tags/dsp/' style='font-size:1.1224489795918366em'>dsp</a>
      </li><li>
        <a href='/tags/eclipse/' style='font-size:1em'>Eclipse</a>
      </li><li>
        <a href='/tags/embedded/' style='font-size:1.1428571428571428em'>embedded</a>
      </li><li>
        <a href='/tags/esp-idf/' style='font-size:1.0408163265306123em'>Esp-Idf</a>
      </li><li>
        <a href='/tags/esp32/' style='font-size:1.2040816326530612em'>Esp32</a>
      </li><li>
        <a href='/tags/flot/' style='font-size:1em'>Flot</a>
      </li><li>
        <a href='/tags/fsk/' style='font-size:1.0816326530612246em'>fsk</a>
      </li><li>
        <a href='/tags/gc/' style='font-size:1em'>Gc</a>
      </li><li>
        <a href='/tags/gdal/' style='font-size:1.0408163265306123em'>gdal</a>
      </li><li>
        <a href='/tags/georeferencing/' style='font-size:1.0612244897959184em'>georeferencing</a>
      </li><li>
        <a href='/tags/geotiff/' style='font-size:1.0612244897959184em'>geotiff</a>
      </li><li>
        <a href='/tags/gnuradio/' style='font-size:1.0612244897959184em'>gnuradio</a>
      </li><li>
        <a href='/tags/hibernate/' style='font-size:1em'>Hibernate</a>
      </li><li>
        <a href='/tags/j2ee/' style='font-size:1.0204081632653061em'>j2ee</a>
      </li><li>
        <a href='/tags/java/' style='font-size:2em'>Java</a>
      </li><li>
        <a href='/tags/javafx/' style='font-size:1em'>javafx</a>
      </li><li>
        <a href='/tags/javascript/' style='font-size:1.0816326530612246em'>javascript</a>
      </li><li>
        <a href='/tags/jetty/' style='font-size:1.0408163265306123em'>jetty</a>
      </li><li>
        <a href='/tags/jmeter/' style='font-size:1em'>Jmeter</a>
      </li><li>
        <a href='/tags/jpeg/' style='font-size:1.1020408163265305em'>jpeg</a>
      </li><li>
        <a href='/tags/jpoint/' style='font-size:1em'>jpoint</a>
      </li><li>
        <a href='/tags/jquery/' style='font-size:1em'>Jquery</a>
      </li><li>
        <a href='/tags/jsp/' style='font-size:1.0612244897959184em'>jsp</a>
      </li><li>
        <a href='/tags/jstl/' style='font-size:1.0408163265306123em'>jstl</a>
      </li><li>
        <a href='/tags/junit/' style='font-size:1.0408163265306123em'>Junit</a>
      </li><li>
        <a href='/tags/letsencrypt/' style='font-size:1em'>Letsencrypt</a>
      </li><li>
        <a href='/tags/log4j/' style='font-size:1em'>log4j</a>
      </li><li>
        <a href='/tags/lora/' style='font-size:1.163265306122449em'>Lora</a>
      </li><li>
        <a href='/tags/lora-at/' style='font-size:1.0816326530612246em'>Lora-At</a>
      </li><li>
        <a href='/tags/lrpt/' style='font-size:1.0408163265306123em'>lrpt</a>
      </li><li>
        <a href='/tags/matlab/' style='font-size:1.0204081632653061em'>Matlab</a>
      </li><li>
        <a href='/tags/maven/' style='font-size:1.1020408163265305em'>maven</a>
      </li><li>
        <a href='/tags/memory/' style='font-size:1.0204081632653061em'>memory</a>
      </li><li>
        <a href='/tags/meteor-m/' style='font-size:1.0816326530612246em'>meteor-m</a>
      </li><li>
        <a href='/tags/mobitex/' style='font-size:1em'>mobitex</a>
      </li><li>
        <a href='/tags/monitoring/' style='font-size:1.1020408163265305em'>monitoring</a>
      </li><li>
        <a href='/tags/open-source/' style='font-size:1.0408163265306123em'>Open Source</a>
      </li><li>
        <a href='/tags/openapi/' style='font-size:1.0204081632653061em'>openapi</a>
      </li><li>
        <a href='/tags/opencl/' style='font-size:1.0408163265306123em'>Opencl</a>
      </li><li>
        <a href='/tags/openstack/' style='font-size:1em'>Openstack</a>
      </li><li>
        <a href='/tags/openstack-swift/' style='font-size:1em'>Openstack Swift</a>
      </li><li>
        <a href='/tags/orekit/' style='font-size:1.0204081632653061em'>orekit</a>
      </li><li>
        <a href='/tags/pipe/' style='font-size:1em'>Pipe</a>
      </li><li>
        <a href='/tags/plutosdr/' style='font-size:1.0204081632653061em'>Plutosdr</a>
      </li><li>
        <a href='/tags/ppk2/' style='font-size:1.0204081632653061em'>PPK2</a>
      </li><li>
        <a href='/tags/prometheus/' style='font-size:1.0204081632653061em'>prometheus</a>
      </li><li>
        <a href='/tags/r2cloud/' style='font-size:1.0816326530612246em'>r2cloud</a>
      </li><li>
        <a href='/tags/r2lora/' style='font-size:1.0612244897959184em'>R2lora</a>
      </li><li>
        <a href='/tags/r2weather/' style='font-size:1.0408163265306123em'>R2weather</a>
      </li><li>
        <a href='/tags/radio/' style='font-size:1.2448979591836735em'>Радио</a>
      </li><li>
        <a href='/tags/raspberrypi/' style='font-size:1.4489795918367347em'>raspberrypi</a>
      </li><li>
        <a href='/tags/refactoring/' style='font-size:1em'>Refactoring</a>
      </li><li>
        <a href='/tags/rest/' style='font-size:1.0204081632653061em'>Rest</a>
      </li><li>
        <a href='/tags/rrd/' style='font-size:1.0204081632653061em'>rrd</a>
      </li><li>
        <a href='/tags/rtl_power/' style='font-size:1.0204081632653061em'>rtl_power</a>
      </li><li>
        <a href='/tags/rtlsdr/' style='font-size:1.2448979591836735em'>rtlsdr</a>
      </li><li>
        <a href='/tags/rtlspectrum/' style='font-size:1.0408163265306123em'>rtlSpectrum</a>
      </li><li>
        <a href='/tags/s3/' style='font-size:1em'>S3</a>
      </li><li>
        <a href='/tags/satnogs/' style='font-size:1.0408163265306123em'>Satnogs</a>
      </li><li>
        <a href='/tags/sdr-modem/' style='font-size:1.0612244897959184em'>Sdr-Modem</a>
      </li><li>
        <a href='/tags/sdr-server/' style='font-size:1em'>Sdr-Server</a>
      </li><li>
        <a href='/tags/security/' style='font-size:1.0204081632653061em'>Security</a>
      </li><li>
        <a href='/tags/selectel/' style='font-size:1em'>Selectel</a>
      </li><li>
        <a href='/tags/simd/' style='font-size:1.1020408163265305em'>SIMD</a>
      </li><li>
        <a href='/tags/sonarcube/' style='font-size:1.0408163265306123em'>Sonarcube</a>
      </li><li>
        <a href='/tags/spring/' style='font-size:1.0408163265306123em'>Spring</a>
      </li><li>
        <a href='/tags/sqnr/' style='font-size:1em'>Sqnr</a>
      </li><li>
        <a href='/tags/ssdv/' style='font-size:1.0204081632653061em'>Ssdv</a>
      </li><li>
        <a href='/tags/string/' style='font-size:1.0204081632653061em'>String</a>
      </li><li>
        <a href='/tags/sx127x/' style='font-size:1.1020408163265305em'>Sx127x</a>
      </li><li>
        <a href='/tags/systemd/' style='font-size:1em'>Systemd</a>
      </li><li>
        <a href='/tags/testing/' style='font-size:1.0408163265306123em'>Testing</a>
      </li><li>
        <a href='/tags/travis-ci/' style='font-size:1.0204081632653061em'>Travis-Ci</a>
      </li><li>
        <a href='/tags/ubuntu/' style='font-size:1.0816326530612246em'>ubuntu</a>
      </li><li>
        <a href='/tags/valgrind/' style='font-size:1.0408163265306123em'>Valgrind</a>
      </li><li>
        <a href='/tags/validator/' style='font-size:1em'>Validator</a>
      </li><li>
        <a href='/tags/vuejs/' style='font-size:1.0408163265306123em'>vuejs</a>
      </li><li>
        <a href='/tags/yourkit/' style='font-size:1em'>Yourkit</a>
      </li><li>
        <a href='/tags/%D0%B0%D0%B4%D0%BC%D0%B8%D0%BD%D0%B8%D1%81%D1%82%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5/' style='font-size:1.3061224489795917em'>администрирование</a>
      </li><li>
        <a href='/tags/%D0%B4%D0%B7%D0%B7/' style='font-size:1.0816326530612246em'>ДЗЗ</a>
      </li><li>
        <a href='/tags/%D0%B4%D0%B8%D0%B7%D0%B0%D0%B9%D0%BD/' style='font-size:1.0816326530612246em'>дизайн</a>
      </li><li>
        <a href='/tags/%D0%B8%D0%B4%D0%B5%D0%B8/' style='font-size:1em'>Идеи</a>
      </li><li>
        <a href='/tags/%D0%BA%D0%BE%D1%81%D0%BC%D0%BE%D0%BD%D0%B0%D0%B2%D1%82%D0%B8%D0%BA%D0%B0/' style='font-size:1.0408163265306123em'>космонавтика</a>
      </li><li>
        <a href='/tags/%D0%BA%D1%83%D0%B1%D1%81%D0%B0%D1%82/' style='font-size:1.0408163265306123em'>кубсат</a>
      </li><li>
        <a href='/tags/%D0%BF%D0%B5%D1%80%D0%B5%D0%B2%D0%BE%D0%B4/' style='font-size:1.0204081632653061em'>перевод</a>
      </li><li>
        <a href='/tags/%D0%BF%D0%BE%D0%B2%D0%BE%D1%80%D0%BE%D1%82%D0%BD%D0%BE%D0%B5-%D1%83%D1%81%D1%82%D1%80%D0%BE%D0%B9%D1%81%D1%82%D0%B2%D0%BE/' style='font-size:1.0612244897959184em'>поворотное устройство</a>
      </li><li>
        <a href='/tags/%D0%BF%D1%80%D0%BE%D0%B8%D0%B7%D0%B2%D0%BE%D0%B4%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D0%BE%D1%81%D1%82%D1%8C/' style='font-size:1.346938775510204em'>производительность</a>
      </li><li>
        <a href='/tags/%D1%80%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B0/' style='font-size:1.0612244897959184em'>Разработка</a>
      </li><li>
        <a href='/tags/%D1%81%D0%BF%D0%B5%D1%86%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F/' style='font-size:1em'>Спецификация</a>
      </li><li>
        <a href='/tags/%D1%81%D0%BF%D1%83%D1%82%D0%BD%D0%B8%D0%BA%D0%B8/' style='font-size:1.3877551020408163em'>спутники</a>
      </li><li>
        <a href='/tags/%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5/' style='font-size:1.2653061224489797em'>Тестирование</a>
      </li><li>
        <a href='/tags/%D1%84%D0%B8%D0%BB%D1%8C%D1%82%D1%80%D1%8B/' style='font-size:1.0408163265306123em'>фильтры</a>
      </li></ul>
</div>


</section>
</div>

  <div class='sidebar-overlay'></div>
</div><div class='main'><nav id='main-menu' class='menu main-menu' aria-label=''>
  <div class='container'>
    <a class='screen-reader-text' href='#content'></a>

<button id='sidebar-toggler' class='sidebar-toggler' aria-controls='sidebar'>
  <span class='screen-reader-text'></span>
  <span class='open'><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
  <line x1="3" y1="12" x2="21" y2="12" />
  <line x1="3" y1="6" x2="21" y2="6" />
  <line x1="3" y1="18" x2="21" y2="18" />

</svg>
</span>
  <span class='close'><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
  <line x1="18" y1="6" x2="6" y2="18" />
  <line x1="6" y1="6" x2="18" y2="18" />

</svg>
</span>
</button>
    <ul><li class='item current'>
        <a aria-current='page' href='/posts/'>Все записи</a>
      </li><li class='item'>
        <a href='/%D0%BE%D0%B1-%D0%B0%D0%B2%D1%82%D0%BE%D1%80%D0%B5/'>Об авторе</a>
      </li><li class='item'>
        <a href='/%D0%BF%D0%BE%D0%B4%D0%B4%D0%B5%D1%80%D0%B6%D0%B0%D1%82%D1%8C/'>Поддержать</a>
      </li></ul>
  </div>
</nav><div class='header-widgets'>
        <div class='container'></div>
      </div>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>dernasherbrezon</p><p class='desc site-desc'>Блог о программировании на Java</p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='ru' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>Тестирование потребления энергии в lora-at</h1>
      

    </div>
    <div class='entry-meta'>
  <span class='posted-on'><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>

</svg>
<span class='screen-reader-text'> </span>
  <time class='entry-date' datetime='2023-11-25T23:28:18&#43;01:00'>25 Nov 2023</time>
</span>

  
  

</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  <p>Как следует разобравшись с тем, <a href="https://dernasherbrezon.com/posts/power-profiler-kit2/">как работает Power Profiler Kit 2 (PPK2)</a>, я решил протестировать разные режимы работы. На самом деле <a href="https://github.com/dernasherbrezon/lora-at">lora-at</a> - не такое уж и простое приложение. В нём есть работа с bluetooth и чипом sx127x, обработка команд с UART шины и режим глубокого сна. Есть, где развернуться.</p>
<h2 id="методология-измерений">Методология измерений</h2>
<p>Перед тем как начинать что-то измерять, необходимо определиться с тем, как это будет измеряться.</p>
<p><strong>Во-первых</strong>, я собираюсь <a href="https://dernasherbrezon.com/posts/power-profiler-kit2/">использовать PPK2</a> по-максимуму. Некоторые тесты требует десятки измерений и делать их вручную не имеет смысла. Я написал небольшой скрипт, который позволял отправлять разные AT команды на устройство, а потом выбирать данные из .CSV файла и группировать нужным образом. Так вот, чтобы понять когда началось измерение, а когда закончилось, я использовал встроенный логический анализатор.</p>
<p><strong>Во-вторых</strong>, некоторые процессы протекают быстро и потребляют много энергии, а некоторые - медленно и потребляют мало энергии. Сравнивать среднее потребление тока в таком случае некорректно. Там, где имеет смысл сравнивать такие процессы, я сравнивал величину заряда. Она измеряется в кулонах. Кулон (Кл) — это величина заряда, прошедшего через сечение проводника при силе тока 1 А за время 1 с. PPK2 интегрирует график по времени и может очень быстро отображать потраченный заряд за выбранный интервал. Прям чувствуется атмосфера лабы по физике.</p>
<p><strong>В-третьих</strong>, параметров, которые могут влиять на потребление энергии, очень много. Для этого я фиксировал одни и менял другие. Такой подход позволил хоть как-то сравнивать и анализировать результаты. Например, для всех тестов я использовал <a href="https://heltec.org/project/wifi-lora-32/">Heltec LoRa 32 v2</a>, который работал на частоте 80Мгц.</p>
<p><strong>В-четвёртых</strong>, PPK2 сэмплирует со скоростью 100Кгц, что генерирует достаточно большое количество данных. Все эти точки невозможно отобразить на графике, поэтому я брал среднее за некоторый интервал. Это не влияет на результирующее значение потраченного заряда, но немного сглаживает сам график.</p>
<p><strong>В-пятых</strong>, измеряется потребление энергии всей платы, а не конкретных компонент.</p>
<h2 id="sx127x">sx127x</h2>
<p>Начать, пожалуй, лучше всего с самого основного - чипа sx127x. Он поддерживает разные типы модуляции, приём и передачу данных, их скорость, усилители мощности и многое другое. Я решил померить лишь те, которые теоретически могут повлиять на потребление энергии. И даже после этого, тестов оказалось приличное количество.</p>
<h4 id="получение-данных">Получение данных</h4>
<p>Для тестирования приёмника, я настроил второй модуль, который отправляет короткое сообщение:</p>
<pre tabindex="0"><code>AT+LORATX=CAFE,433200012,125000,9,5,18,10,8,4,0,0,1,0
</code></pre><p>А измеряемый модуль принимает:</p>
<pre tabindex="0"><code>AT+LORARX=433200012,125000,9,5,18,10,8,4,0,0,1,0
</code></pre><p>После чего, то же самое для FSK модуляции:</p>
<pre tabindex="0"><code>AT+FSKTX=CAFE,433200012,4800,5000,4,12AD,0,2,1,4,0,0
</code></pre><p>И приём:</p>
<pre tabindex="0"><code>AT+FSKRX=433200012,4800,5000,4,12AD,0,2,1,4,5000,20000
</code></pre><p>В итоге получился следующий график:</p>
































<canvas id="fskVsLora" width="400" height="200"></canvas>
<div class='align-center' style="margin-bottom: 1.5em">
<small>
	<a class="downloadChart" data-canvasid="fskVsLora" download="fskVsLora.png" href="" title="Сравнение FSK и LoRa">Скачать</a>
</small>
</div>
<script>

function csvJSON(csv){
  var result = [];
  var headers=csv[0];
  for(var i=1;i<csv.length;i++){
      var obj = {};
      for(var j=0;j<headers.length;j++){
          obj[headers[j]] = parseFloat(csv[i][j]);
      }
      result.push(obj);
  }
  return result; 
}


	
	


var xAxisKey = 'time';
fskVsLoraData.forEach(function(e, index) {
	e.time = '' + e.time;
});var fskVsLoraCtx = document.getElementById('fskVsLora').getContext('2d');
const fskVsLoraChart = new Chart(fskVsLoraCtx, {
    type: 'line',
    data: {
        datasets: [{
        	label: 'LoRa',
            data: fskVsLoraData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'lora2bytes'
            },
            borderColor: '#7fc35e',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#7fc35e',
            fill: true,
            borderWidth: 2,tension: 0.2
        },{
            label: 'FSK',
            data: fskVsLoraData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'fsk2bytes'
            },
            borderColor: '#ffcd00',
            backgroundColor: 'rgba(255, 205, 0, 0.1)',
            pointBackgroundColor: '#ffcd00',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        }]
    },
    options: {
    	stacked: false,
    	elements: {
    		point: {
    		      radius: 0,
    		      hitRadius: 10,
    		      hoverRadius: 4,
    		      hoverBorderWidth: 3
    		}	
    	},
        animation: {
            duration: 0
        },
        interaction: {
            intersect: false,
            mode: 'index',
        },
        scales: {x: {
                title: {
                    display: true,
                    text: 'Время'
                },
                ticks: {
                    
                    callback: function(value, index, ticks) {
                    	
                        return this.getLabelForValue(value) + ' мс';
                    }}
        	},y: {
                beginAtZero: true,
                position: 'left',title: {
                    display: true,
                    text: 'Ток'
                },
                ticks: {
                    callback: function(value, index, ticks) {
                        return value + ' мA';
                    }}
            }},
        plugins: {
            title: {
                display: true,
                text: 'Сравнение FSK и LoRa',
                font: {
                	size: 16
                }
            },
            legend: {
                display: false
            },
            tooltip: {
            	position: 'nearest',
            	callbacks: {title: function(context) {
                        return context[0].label + ' мс';
            		},label: function(context) {
            			let label = context.dataset.label || '';

                        if (label) {
                            label += ': ';
                        }
                        
                        var unit = "мA";if (context.parsed.y !== null) {
                        	label += context.parsed.y + ' ' + unit;
                        }
                        
                        return label;
            		}
            	}
            }
        }
    }
});
</script><noscript>
	<img src="/static/img/lora-at-power-profiling/fskVsLora.png">
</noscript>
<p>На нём видно, что:</p>
<ul>
<li>LoRa гораздо быстрее обрабатывает сообщение: <strong>13.6</strong>мс против <strong>19</strong>мс</li>
<li>Более энергоэффектиное. За счёт скорости обработки общее потребление <strong>511</strong>мкКл против <strong>775</strong>мкКл</li>
<li>Пиковое потребление чуть ниже</li>
</ul>
<p>На самом деле такое сравнение некорректно. Потребление энергии напрямую зависит от скорости передачи данных. Чем выше скорость, тем быстрее обрабатывается сообщение и меньше тратится энергии.</p>
<h4 id="cad-режим">CAD режим</h4>
<p>В sx127x есть специальный режим, который называется CAD (Channel Activity Detection). Он используется для оптимизации энергопотребления приёмника. Идея заключается в следующем:</p>
<ul>
<li>приёмник включается на полную мощность на определённое время</li>
<li>после чего переходит в режим пониженного энергопотребления и пытается проанализировать полученный сигнал</li>
<li>если обнаружена преамбула пакета, то чип генерирует прерывание и можно переключаться в обычным режим приёма</li>
<li>если преамбула не обнаружена, то чип выжидает некоторое время в режиме низкого энергопотребления и возвращается к шагу 1</li>
</ul>
<p>Диаграмма выглядит следующим образом:</p>
<div>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="-0.5 -0.5 460 202"><defs/><g><path d="M 40 40 L 80 40 L 80 0 L 400 0" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 40 120 L 360 120 L 360 80 L 400 80" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 40 200 L 80 200 L 80 160 L 200 160 L 200 180 L 360 180 L 360 200 L 400 200" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 360 180 L 400 180" fill="none" stroke="rgb(0, 0, 0)" stroke-width="2" stroke-miterlimit="10" stroke-dasharray="2 6" pointer-events="stroke"/><path d="M 200 160 L 400 160" fill="none" stroke="rgb(0, 0, 0)" stroke-width="2" stroke-miterlimit="10" stroke-dasharray="2 6" pointer-events="stroke"/><rect x="0" y="160" width="80" height="40" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 180px; margin-left: 1px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><font style="font-size: 10px;">Consumption</font></div></div></div></foreignObject><text x="40" y="184" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">Consumption</text></switch></g><rect x="0" y="80" width="80" height="40" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 100px; margin-left: 1px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><font style="font-size: 10px;">CadDone</font></div></div></div></foreignObject><text x="40" y="104" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">CadDone</text></switch></g><rect x="0" y="0" width="80" height="40" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 20px; margin-left: 1px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><font style="font-size: 10px;">NSS</font></div></div></div></foreignObject><text x="40" y="24" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">NSS</text></switch></g><path d="M 86.37 80 L 353.63 80" fill="none" stroke="#6c8ebf" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 81.12 80 L 88.12 76.5 L 86.37 80 L 88.12 83.5 Z" fill="#6c8ebf" stroke="#6c8ebf" stroke-miterlimit="10" pointer-events="all"/><path d="M 358.88 80 L 351.88 83.5 L 353.63 80 L 351.88 76.5 Z" fill="#6c8ebf" stroke="#6c8ebf" stroke-miterlimit="10" pointer-events="all"/><rect x="80" y="60" width="280" height="20" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 278px; height: 1px; padding-top: 70px; margin-left: 81px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 10px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">CAD duration</div></div></div></foreignObject><text x="220" y="73" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="10px" text-anchor="middle">CAD duration</text></switch></g><path d="M 86.37 180 L 193.63 180" fill="none" stroke="#6c8ebf" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 81.12 180 L 88.12 176.5 L 86.37 180 L 88.12 183.5 Z" fill="#6c8ebf" stroke="#6c8ebf" stroke-miterlimit="10" pointer-events="all"/><path d="M 198.88 180 L 191.88 183.5 L 193.63 180 L 191.88 176.5 Z" fill="#6c8ebf" stroke="#6c8ebf" stroke-miterlimit="10" pointer-events="all"/><rect x="90" y="166" width="100" height="10" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 98px; height: 1px; padding-top: 171px; margin-left: 91px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 10px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">Time in RX mode</div></div></div></foreignObject><text x="140" y="174" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="10px" text-anchor="middle">Time in RX mode</text></switch></g><rect x="400" y="172.5" width="60" height="15" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 58px; height: 1px; padding-top: 180px; margin-left: 401px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><font style="font-size: 10px;">IDDC_L</font></div></div></div></foreignObject><text x="430" y="184" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">IDDC_L</text></switch></g><rect x="400" y="151" width="60" height="15" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 58px; height: 1px; padding-top: 159px; margin-left: 401px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><font style="font-size: 10px;">IDDR_L</font></div></div></div></foreignObject><text x="430" y="162" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">IDDR_L</text></switch></g></g><switch><g requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"/><a transform="translate(0,-5)" xlink:href="https://www.drawio.com/doc/faq/svg-export-text-problems" target="_blank"><text text-anchor="middle" font-size="10px" x="50%" y="100%">Text is not SVG - cannot display</text></a></switch></svg>
</div>
<p>При этом, согласно спецификации, потребление может уменьшаться чуть ли не в два раза:</p>
<table>
<thead>
  <tr>
    <th>Bandwidth (kHz)</th>
    <th>Full Rx, IDDR_L (mA)</th>
    <th>Processing, IDDC_L (mA)</th>
  </tr>	
</thead>
<tbody>
  <tr>
    <td>7.8 to 41.7</td>
    <td>11</td>
    <td>5.2</td>
  </tr>	
  <tr>
    <td>62.5</td>
    <td>11</td>
    <td>5.6</td>
  </tr>	
  <tr>
    <td>125</td>
    <td>11.5</td>
    <td>6</td>
  </tr>	
  <tr>
    <td>250</td>
    <td>12.4</td>
    <td>6.8</td>
  </tr>	
  <tr>
    <td>500</td>
    <td>13.8</td>
    <td>8.3</td>
  </tr>	
</tbody>
</table>
<p>Запустить приём в CAD режиме можно следующей командой:</p>
<pre tabindex="0"><code>AT+LORACADRX=433200012,125000,9,5,18,10,8,4,0,0,1,0
</code></pre><p>В итоге мне удалось получить:</p>
































<canvas id="cad" width="400" height="200"></canvas>
<div class='align-center' style="margin-bottom: 1.5em">
<small>
	<a class="downloadChart" data-canvasid="cad" download="cad.png" href="" title="Сравнение обычного и CAD режимов">Скачать</a>
</small>
</div>
<script>

function csvJSON(csv){
  var result = [];
  var headers=csv[0];
  for(var i=1;i<csv.length;i++){
      var obj = {};
      for(var j=0;j<headers.length;j++){
          obj[headers[j]] = parseFloat(csv[i][j]);
      }
      result.push(obj);
  }
  return result; 
}


	
	


var xAxisKey = 'time';
cadData.forEach(function(e, index) {
	e.time = '' + e.time;
});var cadCtx = document.getElementById('cad').getContext('2d');
const cadChart = new Chart(cadCtx, {
    type: 'line',
    data: {
        datasets: [{
        	label: 'Обычный режим',
            data: cadData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'normal'
            },
            borderColor: '#7fc35e',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#7fc35e',
            fill: true,
            borderWidth: 2,tension: 0.2
        },{
            label: 'CAD режим',
            data: cadData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'cad'
            },
            borderColor: '#ffcd00',
            backgroundColor: 'rgba(255, 205, 0, 0.1)',
            pointBackgroundColor: '#ffcd00',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        }]
    },
    options: {
    	stacked: false,
    	elements: {
    		point: {
    		      radius: 0,
    		      hitRadius: 10,
    		      hoverRadius: 4,
    		      hoverBorderWidth: 3
    		}	
    	},
        animation: {
            duration: 0
        },
        interaction: {
            intersect: false,
            mode: 'index',
        },
        scales: {x: {
                title: {
                    display: true,
                    text: 'Время'
                },
                ticks: {
                    
                    callback: function(value, index, ticks) {
                    	
                        return this.getLabelForValue(value) + ' мс';
                    }}
        	},y: {
                beginAtZero: true,
                position: 'left',title: {
                    display: true,
                    text: 'Ток'
                },
                ticks: {
                    callback: function(value, index, ticks) {
                        return value + ' мA';
                    }}
            }},
        plugins: {
            title: {
                display: true,
                text: 'Сравнение обычного и CAD режимов',
                font: {
                	size: 16
                }
            },
            legend: {
                display: false
            },
            tooltip: {
            	position: 'nearest',
            	callbacks: {title: function(context) {
                        return context[0].label + ' мс';
            		},label: function(context) {
            			let label = context.dataset.label || '';

                        if (label) {
                            label += ': ';
                        }
                        
                        var unit = "мA";if (context.parsed.y !== null) {
                        	label += context.parsed.y + ' ' + unit;
                        }
                        
                        return label;
            		}
            	}
            }
        }
    }
});
</script><noscript>
	<img src="/img/lora-at-power-profiling/cad.png">
</noscript>
<p>Тут сходу видно несколько интересных вещей:</p>
<ul>
<li>Почему-то потребление тока в режиме поиска преамбулы чуть больше, чем в обычном режиме</li>
<li>Разница между активным режимом и пассивным <strong>~6</strong>мА, что действительно похоже на правду при <strong>125</strong>кГц</li>
<li>После выхода из CAD режима и перед переходом обратно проходит примерно <strong>2</strong>мс. Это время нужно ESP32, чтобы обработать прерывание и опять перейти в CAD режим. Поскольку CAD режим заканчивается тем, что переходит в STANDBY режим, потребление энергии существенно ниже. 2мс на обработку прерывания - это очень много. Если в это время начнётся передача сообщения, то приёмник может пропустить его начало. Контрольная сумма не совпадёт и всё сообщение не будет принято. С другой стороны, на практике всё работает отлично.</li>
</ul>
<p>Если сравнивать энергопотребление, то CAD режим всё-таки более эффективный:</p>
<ul>
<li>Потраченый заряд <strong>1.41</strong>мКл против <strong>1.52</strong>мКл за <strong>40</strong>мс</li>
<li>Средний ток <strong>35.27</strong>мА против <strong>37.85</strong>мА</li>
</ul>
<h4 id="отправка-данных">Отправка данных</h4>
<p>Потребление тока при отправке данных зависит от:</p>
<ul>
<li>скорости передачи</li>
<li>типа модуляции</li>
<li>мощности передатчика</li>
<li>длины сообщения</li>
</ul>
<p>Чтобы упростить тестирование, я отправлял сообщение длиной 255 байт мощностью 4dbm. При этом менял скорость передачи и тип модуляции. Вот пример команды для тестирования FSK:</p>
<pre tabindex="0"><code>AT+FSKTX=000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9aaabacadaeafb0b1b2b3b4b5b6b7b8b9babbbcbdbebfc0c1c2c3c4c5c6c7c8c9cacbcccdcecfd0d1d2d3d4d5d6d7d8d9dadbdcdddedfe0e1e2e3e4e5e6e7e8e9eaebecedeeeff0f1f2f3f4f5f6f7f8f9fafbfcfdfe,433200012,1200,5000,4,12AD,0,2,1,4,240,0
</code></pre>































<canvas id="fskBaud" width="400" height="200"></canvas>
<div class='align-center' style="margin-bottom: 1.5em">
<small>
	<a class="downloadChart" data-canvasid="fskBaud" download="fskBaud.png" href="" title="Зависимость потребления энергии от скорости передачи (FSK)">Скачать</a>
</small>
</div>
<script>

function csvJSON(csv){
  var result = [];
  var headers=csv[0];
  for(var i=1;i<csv.length;i++){
      var obj = {};
      for(var j=0;j<headers.length;j++){
          obj[headers[j]] = parseFloat(csv[i][j]);
      }
      result.push(obj);
  }
  return result; 
}


	
	


var xAxisKey = 'baud';
fskBaudData.forEach(function(e, index) {
	e.baud = '' + e.baud;
});var fskBaudCtx = document.getElementById('fskBaud').getContext('2d');
const fskBaudChart = new Chart(fskBaudCtx, {
    type: 'line',
    data: {
        datasets: [{
        	label: 'Потраченный заряд',
            data: fskBaudData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'chargemC'
            },
            borderColor: '#7fc35e',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#7fc35e',
            fill: true,
            borderWidth: 2,yAxisID: 'myScale',tension: 0.2
        },{
            label: 'Время',
            data: fskBaudData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'latencyMs'
            },
            borderColor: '#ffcd00',
            backgroundColor: 'rgba(255, 205, 0, 0.1)',
            pointBackgroundColor: '#ffcd00',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        }]
    },
    options: {
    	stacked: false,
    	elements: {
    		point: {
    		      radius: 0,
    		      hitRadius: 10,
    		      hoverRadius: 4,
    		      hoverBorderWidth: 3
    		}	
    	},
        animation: {
            duration: 0
        },
        interaction: {
            intersect: false,
            mode: 'index',
        },
        scales: {x: {
                title: {
                    display: true,
                    text: 'Бод'
                },
                ticks: {
                    
                    callback: function(value, index, ticks) {
                    	
                        return this.getLabelForValue(value) + ' ';
                    }}
        	},y: {
                beginAtZero: true,
                position: 'left',type: 'logarithmic',title: {
                    display: true,
                    text: 'Время'
                },
                ticks: {
                    callback: function(value, index, ticks) {
                        return value + ' мс';
                    }}
            },
        	myScale: {
                display: true,
                axis: 'y',
                position: 'right',type: 'logarithmic',title: {
                    display: true,
                    text: 'Заряд'
                },
                ticks: {
                    callback: function(value, index, ticks) {
                        return value + ' мКл';
                    }},
                grid: {
                	drawOnChartArea: false
                }
            }},
        plugins: {
            title: {
                display: true,
                text: 'Зависимость потребления энергии от скорости передачи (FSK)',
                font: {
                	size: 16
                }
            },
            legend: {
                display: false
            },
            tooltip: {
            	position: 'nearest',
            	callbacks: {title: function(context) {
                        return context[0].label + ' ';
            		},label: function(context) {
            			let label = context.dataset.label || '';

                        if (label) {
                            label += ': ';
                        }
                        
                        var unit = "мс";if( context.datasetIndex == 0 ) {
                        	unit = "мКл";
                        }if (context.parsed.y !== null) {
                        	label += context.parsed.y + ' ' + unit;
                        }
                        
                        return label;
            		}
            	}
            }
        }
    }
});
</script><noscript>
	<img src="/img/lora-at-power-profiling/fskBaud.png">
</noscript>
<p>На графике видна однозначная зависимость. Чем больше скорость передачи, тем меньше тратится энергии. Кстати, график к районе 76800 бод не всегда был такой. Когда я впервые замерил скорость, оказалось, что она в два раза меньше, чем при 38400 бод. И её увеличение вообще никак не влияло на потребление. Немного повозившись, я нашёл багу в коде. При чтении из UART происходило переполнение uint16_t и устанавливалась гораздо меньшая скорость. Упс!</p>
<p>С отправкой данных в режиме LoRa всё гораздо сложнее. На скорость могут влиять: bandwidth, spreading factor и coding rate. Например, последний контролирует сколько бит используется для кодов коррекции ошибок. Чем больше, тем надёжнее передача, но при этом дольше передаются данные.</p>
<p>Я зафиксировал <code>coding rate=4</code> и менял лишь bandwidth и spreading factor:</p>
<pre tabindex="0"><code>AT+LORATX=000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9aaabacadaeafb0b1b2b3b4b5b6b7b8b9babbbcbdbebfc0c1c2c3c4c5c6c7c8c9cacbcccdcecfd0d1d2d3d4d5d6d7d8d9dadbdcdddedfe0e1e2e3e4e5e6e7e8e9eaebecedeeeff0f1f2f3f4f5f6f7f8f9fafbfcfdfe,433200012,500000,6,5,18,8,0,1,0,255,4,240,0
</code></pre>































<canvas id="loraBandwidthSf" width="400" height="200"></canvas>
<div class='align-center' style="margin-bottom: 1.5em">
<small>
	<a class="downloadChart" data-canvasid="loraBandwidthSf" download="loraBandwidthSf.png" href="" title="Зависимость потребления энергии от скорости передачи (LoRa)">Скачать</a>
</small>
</div>
<script>

function csvJSON(csv){
  var result = [];
  var headers=csv[0];
  for(var i=1;i<csv.length;i++){
      var obj = {};
      for(var j=0;j<headers.length;j++){
          obj[headers[j]] = parseFloat(csv[i][j]);
      }
      result.push(obj);
  }
  return result; 
}


	
	


var xAxisKey = 'bandwidth';
loraBandwidthSfData.forEach(function(e, index) {
	e.bandwidth = '' + e.bandwidth;
});var loraBandwidthSfCtx = document.getElementById('loraBandwidthSf').getContext('2d');
const loraBandwidthSfChart = new Chart(loraBandwidthSfCtx, {
    type: 'line',
    data: {
        datasets: [{
        	label: 'sf6',
            data: loraBandwidthSfData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'sf6'
            },
            borderColor: '#7fc35e',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#7fc35e',
            fill: true,
            borderWidth: 2,tension: 0.2
        },{
        	label: 'sf7',
            data: loraBandwidthSfData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'sf7'
            },
            borderColor: '#4161CC',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#4161CC',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        },{
        	label: 'sf8',
            data: loraBandwidthSfData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'sf8'
            },
            borderColor: '#5DD9BE',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#5DD9BE',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        },{
        	label: 'sf9',
            data: loraBandwidthSfData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'sf9'
            },
            borderColor: '#CF8659',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#CF8659',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        },{
        	label: 'sf10',
            data: loraBandwidthSfData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'sf10'
            },
            borderColor: '#800080',
            backgroundColor: 'rgba(229,204,229, 0.1)',
            pointBackgroundColor: '#800080',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        },{
        	label: 'sf11',
            data: loraBandwidthSfData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'sf11'
            },
            borderColor: '#FFC0CB',
            backgroundColor: 'rgba(255,229,234, 0.1)',
            pointBackgroundColor: '#FFC0CB',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        },{
            label: 'sf12',
            data: loraBandwidthSfData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'sf12'
            },
            borderColor: '#ffcd00',
            backgroundColor: 'rgba(255, 205, 0, 0.1)',
            pointBackgroundColor: '#ffcd00',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        }]
    },
    options: {
    	stacked: false,
    	elements: {
    		point: {
    		      radius: 0,
    		      hitRadius: 10,
    		      hoverRadius: 4,
    		      hoverBorderWidth: 3
    		}	
    	},
        animation: {
            duration: 0
        },
        interaction: {
            intersect: false,
            mode: 'index',
        },
        scales: {x: {
                title: {
                    display: true,
                    text: 'Bandwidth'
                },
                ticks: {
                    
                    callback: function(value, index, ticks) {
                    	
                        return this.getLabelForValue(value) + ' Гц';
                    }}
        	},y: {
                beginAtZero: true,
                position: 'left',title: {
                    display: true,
                    text: 'Заряд'
                },
                ticks: {
                    callback: function(value, index, ticks) {
                        return value + ' мКл';
                    }}
            }},
        plugins: {
            title: {
                display: true,
                text: 'Зависимость потребления энергии от скорости передачи (LoRa)',
                font: {
                	size: 16
                }
            },
            legend: {
                display: false
            },
            tooltip: {
            	position: 'nearest',
            	callbacks: {title: function(context) {
                        return context[0].label + ' Гц';
            		},label: function(context) {
            			let label = context.dataset.label || '';

                        if (label) {
                            label += ': ';
                        }
                        
                        var unit = "мКл";if (context.parsed.y !== null) {
                        	label += context.parsed.y + ' ' + unit;
                        }
                        
                        return label;
            		}
            	}
            }
        }
    }
});
</script><noscript>
	<img src="/img/lora-at-power-profiling/loraBandwidthSf.png">
</noscript>
<p>Небольшой анализ результатов:</p>
<ul>
<li>Чем больше spreading factor, тем дольше передаётся сообщение и тем больше тратится энергии</li>
<li>Самая быстрая передача данных в LoRa (коэффициент 6 и ширина канала 500Кгц) тратит энергии больше, чем самая быстрая передача FSK (скорость 300Кбод)</li>
</ul>
<p>В следующем тесте я сделал наоборот: зафиксировал скорость передачи данных и менял выходную мощность от -4 до 20.</p>
<pre tabindex="0"><code>AT+LORATX=CA,433200012,125000,9,5,18,8,0,1,1,0,-4,240,0
AT+LORATX=CA,433200012,125000,9,5,18,8,0,1,1,0,-3,240,0
...
AT+LORATX=CA,433200012,125000,9,5,18,8,0,1,1,0,17,240,1
AT+LORATX=CA,433200012,125000,9,5,18,8,0,1,1,0,20,240,1
</code></pre>































<canvas id="loraPower" width="400" height="200"></canvas>
<div class='align-center' style="margin-bottom: 1.5em">
<small>
	<a class="downloadChart" data-canvasid="loraPower" download="loraPower.png" href="" title="Зависимость потребления энергии от уровня мощности">Скачать</a>
</small>
</div>
<script>

function csvJSON(csv){
  var result = [];
  var headers=csv[0];
  for(var i=1;i<csv.length;i++){
      var obj = {};
      for(var j=0;j<headers.length;j++){
          obj[headers[j]] = parseFloat(csv[i][j]);
      }
      result.push(obj);
  }
  return result; 
}


	
	


var xAxisKey = 'level';
loraPowerData.forEach(function(e, index) {
	e.level = '' + e.level;
});var loraPowerCtx = document.getElementById('loraPower').getContext('2d');
const loraPowerChart = new Chart(loraPowerCtx, {
    type: 'line',
    data: {
        datasets: [{
        	label: 'Потраченный заряд',
            data: loraPowerData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'charge'
            },
            borderColor: '#7fc35e',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#7fc35e',
            fill: true,
            borderWidth: 2,yAxisID: 'myScale',tension: 0.2
        },{
            label: 'Средний ток',
            data: loraPowerData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'avgCurrent'
            },
            borderColor: '#ffcd00',
            backgroundColor: 'rgba(255, 205, 0, 0.1)',
            pointBackgroundColor: '#ffcd00',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        }]
    },
    options: {
    	stacked: false,
    	elements: {
    		point: {
    		      radius: 0,
    		      hitRadius: 10,
    		      hoverRadius: 4,
    		      hoverBorderWidth: 3
    		}	
    	},
        animation: {
            duration: 0
        },
        interaction: {
            intersect: false,
            mode: 'index',
        },
        scales: {x: {
                title: {
                    display: true,
                    text: 'Уровень'
                },
                ticks: {
                    
                    callback: function(value, index, ticks) {
                    	
                        return this.getLabelForValue(value) + ' ';
                    }}
        	},y: {
                beginAtZero: true,
                position: 'left',title: {
                    display: true,
                    text: 'Средний ток'
                },
                ticks: {
                    callback: function(value, index, ticks) {
                        return value + ' мА';
                    }}
            },
        	myScale: {
                display: true,
                axis: 'y',
                position: 'right',title: {
                    display: true,
                    text: 'Заряд'
                },
                ticks: {
                    callback: function(value, index, ticks) {
                        return value + ' мКл';
                    }},
                grid: {
                	drawOnChartArea: false
                }
            }},
        plugins: {
            title: {
                display: true,
                text: 'Зависимость потребления энергии от уровня мощности',
                font: {
                	size: 16
                }
            },
            legend: {
                display: false
            },
            tooltip: {
            	position: 'nearest',
            	callbacks: {title: function(context) {
                        return context[0].label + ' ';
            		},label: function(context) {
            			let label = context.dataset.label || '';

                        if (label) {
                            label += ': ';
                        }
                        
                        var unit = "мА";if( context.datasetIndex == 0 ) {
                        	unit = "мКл";
                        }if (context.parsed.y !== null) {
                        	label += context.parsed.y + ' ' + unit;
                        }
                        
                        return label;
            		}
            	}
            }
        }
    }
});
</script><noscript>
	<img src="/img/lora-at-power-profiling/loraPower.png">
</noscript>
<p>Интересно, почему при более высоком уровне мощности графики начинают пересекаться? Я передавал абсолютно одинаковое сообщение с одинаковыми параметрами. Время на передачу было одного и то же. Значит потраченный заряд должен линейно зависить от тока. Но вместо этого зависимость нелинейная.</p>
<p>Кстати, при 7dbm потребление тока достаточно ровное. А вот при 10dbm уже нет. Шумит внутренний усилитель мощности?</p>
































<canvas id="txNoise" width="400" height="200"></canvas>
<div class='align-center' style="margin-bottom: 1.5em">
<small>
	<a class="downloadChart" data-canvasid="txNoise" download="txNoise.png" href="" title="7dbm и 10dbm">Скачать</a>
</small>
</div>
<script>

function csvJSON(csv){
  var result = [];
  var headers=csv[0];
  for(var i=1;i<csv.length;i++){
      var obj = {};
      for(var j=0;j<headers.length;j++){
          obj[headers[j]] = parseFloat(csv[i][j]);
      }
      result.push(obj);
  }
  return result; 
}


	
	


var xAxisKey = 'time';
txNoiseData.forEach(function(e, index) {
	e.time = '' + e.time;
});var txNoiseCtx = document.getElementById('txNoise').getContext('2d');
const txNoiseChart = new Chart(txNoiseCtx, {
    type: 'line',
    data: {
        datasets: [{
        	label: '10dbm',
            data: txNoiseData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: '10dbm'
            },
            borderColor: '#7fc35e',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#7fc35e',
            fill: true,
            borderWidth: 2,tension: 0.2
        },{
            label: '7dbm',
            data: txNoiseData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: '7dbm'
            },
            borderColor: '#ffcd00',
            backgroundColor: 'rgba(255, 205, 0, 0.1)',
            pointBackgroundColor: '#ffcd00',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        }]
    },
    options: {
    	stacked: false,
    	elements: {
    		point: {
    		      radius: 0,
    		      hitRadius: 10,
    		      hoverRadius: 4,
    		      hoverBorderWidth: 3
    		}	
    	},
        animation: {
            duration: 0
        },
        interaction: {
            intersect: false,
            mode: 'index',
        },
        scales: {x: {
                title: {
                    display: true,
                    text: 'Время'
                },
                ticks: {
                    
                    callback: function(value, index, ticks) {
                    	
                        return this.getLabelForValue(value) + ' ';
                    }}
        	},y: {
                beginAtZero: true,
                position: 'left',title: {
                    display: true,
                    text: 'Ток'
                },
                ticks: {
                    callback: function(value, index, ticks) {
                        return value + ' мA';
                    }}
            }},
        plugins: {
            title: {
                display: true,
                text: '7dbm и 10dbm',
                font: {
                	size: 16
                }
            },
            legend: {
                display: false
            },
            tooltip: {
            	position: 'nearest',
            	callbacks: {title: function(context) {
                        return context[0].label + ' ';
            		},label: function(context) {
            			let label = context.dataset.label || '';

                        if (label) {
                            label += ': ';
                        }
                        
                        var unit = "мA";if (context.parsed.y !== null) {
                        	label += context.parsed.y + ' ' + unit;
                        }
                        
                        return label;
            		}
            	}
            }
        }
    }
});
</script><noscript>
	<img src="/img/lora-at-power-profiling/txNoise.png">
</noscript>
<p>Помимо разных уровней мощности, в чипе есть три разных физических пина, к которым может подключаться антенна: RFO_LF, RFO_HF и PA_BOOST. +20dbm может передаваться только по PA_BOOST. Но если передавать +7dbm, то есть ли разница какой пин использовать?</p>
<pre tabindex="0"><code>AT+LORATX=CA,168000012,125000,9,5,18,8,0,1,1,0,7,240,0
AT+LORATX=CA,433200012,125000,9,5,18,8,0,1,1,0,7,240,0
AT+LORATX=CA,433200012,125000,9,5,18,8,0,1,1,0,7,240,1
</code></pre>































<canvas id="txpin" width="400" height="200"></canvas>
<div class='align-center' style="margin-bottom: 1.5em">
<small>
	<a class="downloadChart" data-canvasid="txpin" download="txpin.png" href="" title="Зависимость уровня потребления тока от пина">Скачать</a>
</small>
</div>
<script>

function csvJSON(csv){
  var result = [];
  var headers=csv[0];
  for(var i=1;i<csv.length;i++){
      var obj = {};
      for(var j=0;j<headers.length;j++){
          obj[headers[j]] = parseFloat(csv[i][j]);
      }
      result.push(obj);
  }
  return result; 
}


	
	


var xAxisKey = 'time';
txpinData.forEach(function(e, index) {
	e.time = '' + e.time;
});var txpinCtx = document.getElementById('txpin').getContext('2d');
const txpinChart = new Chart(txpinCtx, {
    type: 'line',
    data: {
        datasets: [{
        	label: 'RFO_HF',
            data: txpinData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'hf7dbm'
            },
            borderColor: '#7fc35e',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#7fc35e',
            fill: true,
            borderWidth: 2,tension: 0.2
        },{
        	label: 'PA_BOOST',
            data: txpinData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'boost7dbm'
            },
            borderColor: '#4161CC',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#4161CC',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        },{
            label: 'RFO_LF',
            data: txpinData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'lf7dbm'
            },
            borderColor: '#ffcd00',
            backgroundColor: 'rgba(255, 205, 0, 0.1)',
            pointBackgroundColor: '#ffcd00',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        }]
    },
    options: {
    	stacked: false,
    	elements: {
    		point: {
    		      radius: 0,
    		      hitRadius: 10,
    		      hoverRadius: 4,
    		      hoverBorderWidth: 3
    		}	
    	},
        animation: {
            duration: 0
        },
        interaction: {
            intersect: false,
            mode: 'index',
        },
        scales: {x: {
                title: {
                    display: true,
                    text: 'Время'
                },
                ticks: {
                    
                    callback: function(value, index, ticks) {
                    	
                        return this.getLabelForValue(value) + ' ';
                    }}
        	},y: {
                beginAtZero: true,
                position: 'left',title: {
                    display: true,
                    text: 'Ток'
                },
                ticks: {
                    callback: function(value, index, ticks) {
                        return value + ' мA';
                    }}
            }},
        plugins: {
            title: {
                display: true,
                text: 'Зависимость уровня потребления тока от пина',
                font: {
                	size: 16
                }
            },
            legend: {
                display: false
            },
            tooltip: {
            	position: 'nearest',
            	callbacks: {title: function(context) {
                        return context[0].label + ' ';
            		},label: function(context) {
            			let label = context.dataset.label || '';

                        if (label) {
                            label += ': ';
                        }
                        
                        var unit = "мA";if (context.parsed.y !== null) {
                        	label += context.parsed.y + ' ' + unit;
                        }
                        
                        return label;
            		}
            	}
            }
        }
    }
});
</script><noscript>
	<img src="/img/lora-at-power-profiling/txpin.png">
</noscript>
<p>Да, разница есть.</p>
<ul>
<li>Если сравнивать RFO_LF и RFO_HF, то видно, что потребление тока на частоте 168Мгц выше. Видимо, на этих частотах антенна <a href="https://ru.wikipedia.org/wiki/%D0%9A%D0%BE%D1%8D%D1%84%D1%84%D0%B8%D1%86%D0%B8%D0%B5%D0%BD%D1%82_%D1%81%D1%82%D0%BE%D1%8F%D1%87%D0%B5%D0%B9_%D0%B2%D0%BE%D0%BB%D0%BD%D1%8B">не согласована</a> больше.</li>
<li>Потребление тока при передаче через отдельный усилитель мощности и PA_BOOST пин больше, чем при передаче через RFO_HF. Наверное, разница уходит на питание того самого усилителя.</li>
</ul>
<h4 id="токовая-защита-усилителя">Токовая защита усилителя</h4>
<p>В чипе есть защита усилителя от превышения выходящего тока. При этом приговариваются слова про батарею, химические компоненты и пиковое потребление тока. Поначалу я ничего не понял. Немного почитав теорию, стало чуть более понятно. Усилитель рассчитан на импеданс антенны <strong>50</strong>Ом. Если импеданс не совпадает, либо перестал совпадать (антенна заржавела), то для генерации заданного уровня мощности, будет тратится всё больше и больше тока. Это может привести к тому, что усилитель может перегореть. Я сравнил отправку сообщения: без защиты (240мА), с небольшим ограничением (140мА), с максимальным ограничением (45мА).</p>
<pre tabindex="0"><code>AT+LORATX=CA,140200012,125000,9,5,18,8,0,1,1,0,17,240,1
AT+LORATX=CA,140200012,125000,9,5,18,8,0,1,1,0,17,140,1
AT+LORATX=CA,140200012,125000,9,5,18,8,0,1,1,0,17,45,1
</code></pre>































<canvas id="ocp2" width="400" height="200"></canvas>
<div class='align-center' style="margin-bottom: 1.5em">
<small>
	<a class="downloadChart" data-canvasid="ocp2" download="ocp2.png" href="" title="Токовая защита усилителя">Скачать</a>
</small>
</div>
<script>

function csvJSON(csv){
  var result = [];
  var headers=csv[0];
  for(var i=1;i<csv.length;i++){
      var obj = {};
      for(var j=0;j<headers.length;j++){
          obj[headers[j]] = parseFloat(csv[i][j]);
      }
      result.push(obj);
  }
  return result; 
}


	
	


var xAxisKey = 'time';
ocp2Data.forEach(function(e, index) {
	e.time = '' + e.time;
});var ocp2Ctx = document.getElementById('ocp2').getContext('2d');
const ocp2Chart = new Chart(ocp2Ctx, {
    type: 'line',
    data: {
        datasets: [{
        	label: '140мА',
            data: ocp2Data,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'ocp140'
            },
            borderColor: '#7fc35e',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#7fc35e',
            fill: true,
            borderWidth: 2,tension: 0.2
        },{
        	label: '45мА',
            data: ocp2Data,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'ocp45'
            },
            borderColor: '#4161CC',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#4161CC',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        },{
            label: '240мА',
            data: ocp2Data,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'ocp240'
            },
            borderColor: '#ffcd00',
            backgroundColor: 'rgba(255, 205, 0, 0.1)',
            pointBackgroundColor: '#ffcd00',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        }]
    },
    options: {
    	stacked: false,
    	elements: {
    		point: {
    		      radius: 0,
    		      hitRadius: 10,
    		      hoverRadius: 4,
    		      hoverBorderWidth: 3
    		}	
    	},
        animation: {
            duration: 0
        },
        interaction: {
            intersect: false,
            mode: 'index',
        },
        scales: {x: {
                title: {
                    display: true,
                    text: 'Время'
                },
                ticks: {
                    
                    callback: function(value, index, ticks) {
                    	
                        return this.getLabelForValue(value) + ' ';
                    }}
        	},y: {
                beginAtZero: true,
                position: 'left',title: {
                    display: true,
                    text: 'Ток'
                },
                ticks: {
                    callback: function(value, index, ticks) {
                        return value + ' мA';
                    }}
            }},
        plugins: {
            title: {
                display: true,
                text: 'Токовая защита усилителя',
                font: {
                	size: 16
                }
            },
            legend: {
                display: false
            },
            tooltip: {
            	position: 'nearest',
            	callbacks: {title: function(context) {
                        return context[0].label + ' ';
            		},label: function(context) {
            			let label = context.dataset.label || '';

                        if (label) {
                            label += ': ';
                        }
                        
                        var unit = "мA";if (context.parsed.y !== null) {
                        	label += context.parsed.y + ' ' + unit;
                        }
                        
                        return label;
            		}
            	}
            }
        }
    }
});
</script><noscript>
	<img src="/img/lora-at-power-profiling/ocp2.png">
</noscript>
<p>Плата потребляет постоянное количество тока независимо от установленной защиты. Но это не значит, что защита не работает. Возможно, нужно измерять фактическую передаваемую мощность на антенне. К сожалению, у меня нет нужного оборудования, чтобы это проверить.</p>
<h2 id="сравнение-с-c-версией">Сравнение с C++ версией</h2>
<p>Как я уже писал, <a href="https://github.com/dernasherbrezon/lora-at">lora-at</a> изначально была реализована на C++ с помощью библиотек разного уровня качества. Моя теория заключалась в том, что переписав проект на С, я бы смог достичь более высокой эффективности и простоты. Одна из целей была достигнута - сборка проекта стала занимать меньше времени и размер прошивки уменьшился в два раза. Но что насчёт энергопотребления?</p>
<p>Работа чипа sx127x не зависит от выбранного языка, но вот всё остальное может теоретически отличаться.</p>
<h3 id="подключение-по-bluetooth">Подключение по bluetooth</h3>
<p>Одно из основных отличий первой версии от второй является работа с bluetooth. Если в первой версии использовалась С++ библиотека поверх Bluedroid, то во второй версии я использовал Nimble. В документации сказано, что Nimble - это более легковесная реализация BLE протокола. Но так ли это на самом деле? И есть ли разница в скорости работы? Это очень легко проверить. Для этого можно использовать команду:</p>
<pre tabindex="0"><code>AT+BLUETOOTH=B8:27:EB:6C:7C:F8
</code></pre><p>Эта команда сделает следующее:</p>
<ul>
<li>запустит подключение к bluetooth серверу по адресу <code>B8:27:EB:6C:7C:F8</code></li>
<li>выполнит поиск нужного GATT сервиса и характеристики</li>
</ul>
































<canvas id="bluetooth2" width="400" height="200"></canvas>
<div class='align-center' style="margin-bottom: 1.5em">
<small>
	<a class="downloadChart" data-canvasid="bluetooth2" download="bluetooth2.png" href="" title="Потребление тока при подключении к bluetooth серверу">Скачать</a>
</small>
</div>
<script>

function csvJSON(csv){
  var result = [];
  var headers=csv[0];
  for(var i=1;i<csv.length;i++){
      var obj = {};
      for(var j=0;j<headers.length;j++){
          obj[headers[j]] = parseFloat(csv[i][j]);
      }
      result.push(obj);
  }
  return result; 
}


	
	


var xAxisKey = 'time';
bluetooth2Data.forEach(function(e, index) {
	e.time = '' + e.time;
});var bluetooth2Ctx = document.getElementById('bluetooth2').getContext('2d');
const bluetooth2Chart = new Chart(bluetooth2Ctx, {
    type: 'line',
    data: {
        datasets: [{
        	label: 'С\u002b\u002b',
            data: bluetooth2Data,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'blecpp'
            },
            borderColor: '#7fc35e',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#7fc35e',
            fill: true,
            borderWidth: 2,tension: 0.2
        },{
        	label: 'С около RPi',
            data: bluetooth2Data,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'blec2'
            },
            borderColor: '#4161CC',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#4161CC',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        },{
            label: 'С',
            data: bluetooth2Data,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'blec'
            },
            borderColor: '#ffcd00',
            backgroundColor: 'rgba(255, 205, 0, 0.1)',
            pointBackgroundColor: '#ffcd00',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        }]
    },
    options: {
    	stacked: false,
    	elements: {
    		point: {
    		      radius: 0,
    		      hitRadius: 10,
    		      hoverRadius: 4,
    		      hoverBorderWidth: 3
    		}	
    	},
        animation: {
            duration: 0
        },
        interaction: {
            intersect: false,
            mode: 'index',
        },
        scales: {x: {
                title: {
                    display: true,
                    text: 'Время'
                },
                ticks: {
                    
                    callback: function(value, index, ticks) {
                    	
                        return this.getLabelForValue(value) + ' мс';
                    }}
        	},y: {
                beginAtZero: true,
                position: 'left',title: {
                    display: true,
                    text: 'Ток'
                },
                ticks: {
                    callback: function(value, index, ticks) {
                        return value + ' мA';
                    }}
            }},
        plugins: {
            title: {
                display: true,
                text: 'Потребление тока при подключении к bluetooth серверу',
                font: {
                	size: 16
                }
            },
            legend: {
                display: false
            },
            tooltip: {
            	position: 'nearest',
            	callbacks: {title: function(context) {
                        return context[0].label + ' мс';
            		},label: function(context) {
            			let label = context.dataset.label || '';

                        if (label) {
                            label += ': ';
                        }
                        
                        var unit = "мA";if (context.parsed.y !== null) {
                        	label += context.parsed.y + ' ' + unit;
                        }
                        
                        return label;
            		}
            	}
            }
        }
    }
});
</script><noscript>
	<img src="/img/lora-at-power-profiling/bluetooth2.png">
</noscript>
<p>Тут стоит отметить, что у меня не всегда получалось подключиться к серверу! В какой-то момент мне пришлось поднести плату поближе к RaspberryPI. Тут-то и обнаружилось, что чем ближе к bluetooth серверу, тем быстрее происходит подключение. Даже если я использовал разные версии приложения, то время на подключение было очень разным. Что давало сильный разброс в результатах. Например, с 3-х метров С-код мог потратить <strong>386.8</strong>мКл, а C++ вообще не подключиться. Или с одного метра С++ тратил <strong>308.3</strong>мКл, а С-код - <strong>150.2</strong>мКл. В общем, так себе получился тест.</p>
<h3 id="глубокий-сон">Глубокий сон</h3>
<p>Глубокий сон - это особый режим работы, при котором отключена вся периферия и ESP32 работает потребляя минимальное количество энергии. В этом режиме невозможно сделать ничего полезного, поэтому глубокий сон обычно чередуется активной фазой. В активной фазе устройство делает полезные операции, после чего опять уходит в сон. Чем меньше активная фаза, тем меньше энергии будет потреблять устройство в конечном итоге. В lora-at можно конфигурировать интервал глубокого сна. Например, команда ниже задаст конфигурацию: после 15 секунд бездействия перейти на 15 секунд в режим глубокого сна.</p>
<pre tabindex="0"><code>AT+DSCONFIG=15000,15000
</code></pre><p>Во время активной фазы lora-at подключается по bluetooth к серверу, получает расписание следующего включения и снова засыпает.</p>
































<canvas id="dsCycle" width="400" height="200"></canvas>
<div class='align-center' style="margin-bottom: 1.5em">
<small>
	<a class="downloadChart" data-canvasid="dsCycle" download="dsCycle.png" href="" title="Активная фаза">Скачать</a>
</small>
</div>
<script>

function csvJSON(csv){
  var result = [];
  var headers=csv[0];
  for(var i=1;i<csv.length;i++){
      var obj = {};
      for(var j=0;j<headers.length;j++){
          obj[headers[j]] = parseFloat(csv[i][j]);
      }
      result.push(obj);
  }
  return result; 
}


	
	


var xAxisKey = 'time';
dsCycleData.forEach(function(e, index) {
	e.time = '' + e.time;
});var dsCycleCtx = document.getElementById('dsCycle').getContext('2d');
const dsCycleChart = new Chart(dsCycleCtx, {
    type: 'line',
    data: {
        datasets: [{
        	label: 'Версия С\u002b\u002b',
            data: dsCycleData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'dscpp'
            },
            borderColor: '#7fc35e',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#7fc35e',
            fill: true,
            borderWidth: 2,tension: 0.2
        },{
            label: 'Версия С',
            data: dsCycleData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'dsc'
            },
            borderColor: '#ffcd00',
            backgroundColor: 'rgba(255, 205, 0, 0.1)',
            pointBackgroundColor: '#ffcd00',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        }]
    },
    options: {
    	stacked: false,
    	elements: {
    		point: {
    		      radius: 0,
    		      hitRadius: 10,
    		      hoverRadius: 4,
    		      hoverBorderWidth: 3
    		}	
    	},
        animation: {
            duration: 0
        },
        interaction: {
            intersect: false,
            mode: 'index',
        },
        scales: {x: {
                title: {
                    display: true,
                    text: 'Время'
                },
                ticks: {
                    
                    callback: function(value, index, ticks) {
                    	
                        return this.getLabelForValue(value) + ' ';
                    }}
        	},y: {
                beginAtZero: true,
                position: 'left',title: {
                    display: true,
                    text: 'Ток'
                },
                ticks: {
                    callback: function(value, index, ticks) {
                        return value + ' мA';
                    }}
            }},
        plugins: {
            title: {
                display: true,
                text: 'Активная фаза',
                font: {
                	size: 16
                }
            },
            legend: {
                display: false
            },
            tooltip: {
            	position: 'nearest',
            	callbacks: {title: function(context) {
                        return context[0].label + ' ';
            		},label: function(context) {
            			let label = context.dataset.label || '';

                        if (label) {
                            label += ': ';
                        }
                        
                        var unit = "мA";if (context.parsed.y !== null) {
                        	label += context.parsed.y + ' ' + unit;
                        }
                        
                        return label;
            		}
            	}
            }
        }
    }
});
</script><noscript>
	<img src="/img/lora-at-power-profiling/dsCycle.png">
</noscript>
<ul>
<li>Потребление энергии сильно зависит от скорости подключения к bluetooth серверу. Причём иногда это занимает 2 секунды, а иногда 7. Из-за такой нестабильности сложно делать какие-то выводы</li>
<li>Потребление энергии достаточно сильно варьируется: от <strong>474.6</strong>мКл (С++ версия) до <strong>179.2</strong>мКл (С версия)</li>
<li>Время старта C++ чуть меньше. <strong>~500</strong>мс против <strong>~664</strong>мс. Однако, мне ни разу не удалось получить меньше 7 секунд для подключения С++ версии. Возможно, она пропускала какое-то bluetooth событие и вынуждена была ожидать перепосылку от сервера.</li>
</ul>
<p>Потребление энергии в режиме глубокого сна - <strong>1.7</strong>мА. Это примерно в миллион раз больше, чем теоретический минимум ESP32. Я потратил примерно 2 недели, чтобы разобраться в чём проблема. После всех ухищрений мне удалось уменьшить потребление до <strong>10</strong>мкА.</p>
<h3 id="работа-на-пониженной-частоте">Работа на пониженной частоте</h3>
<p>ESP32 может работать как на частоте 240Мгц, так и на 80Мгц. Очевидно, это уменьшает потребление энергии, за счёт более медленной работы. Но куда нам спешить, когда SPI шина работает на частоте 3Мгц?</p>
<table>
<thead>
	<tr>
		<th>Режим работы</th>
		<th>Среднее потребление тока (C)</th>
		<th>Среднее потребление тока (C++)</th>		
	</tr>
</thead>
<tbody>
	<tr>
		<td>240Мгц</td>
		<td>48.27</td>
		<td>73.36</td>
	</tr>
	<tr>
		<td>160Мгц</td>
		<td>35.81</td>
		<td>50.64</td>
	</tr>
	<tr>
		<td>80Мгц</td>
		<td><strong>26.38</strong></td>
		<td>39.44</td>
	</tr>
</tbody>
</table>
<ul>
<li>Как и ожидалось, чем меньше частота микроконтроллера, тем меньше потребление энергии</li>
<li>Иногда у меня получалось получить ещё более низкие значения, но я не смог понять как их воспроизвести</li>
</ul>
<p>Кстати, разница между С и С++ версией связана с тем, как обрабатываются события. В С-версии вся обработка происходит в отдельных тасках FreeRTOS. Основной таск вообще перестаёт работать:</p>
<pre tabindex="0"><code>I (595) main_task: Returned from app_main()
</code></pre><p>А вот С++ версия проверяет события в бесконечном цикле. Если добавить похожий цикл в С-версию, то потребление энергии будет одинаковым:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">uint64_t</span> counter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">uint64_t</span> active <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000000</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> (true) {
</span></span><span style="display:flex;"><span>  counter<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (counter <span style="color:#f92672">==</span> active) {
</span></span><span style="display:flex;"><span>    counter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">vTaskDelay</span>(<span style="color:#a6e22e">pdMS_TO_TICKS</span>(<span style="color:#ae81ff">5000</span>));
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="обработка-прерываний-uart">Обработка прерываний UART</h4>
<p>Мне настолько понравилось разбираться в потреблении энергии, что я решил измерить совершенно странные вещи. Например, мне стало интересно сколько энергии тратится на обработку полученного символа по UART. Сильно увеличенный график выглядит следующим образом:</p>
































<canvas id="uartSymbol2" width="400" height="200"></canvas>
<div class='align-center' style="margin-bottom: 1.5em">
<small>
	<a class="downloadChart" data-canvasid="uartSymbol2" download="uartSymbol2.png" href="" title="Потребление тока при передаче символа">Скачать</a>
</small>
</div>
<script>

function csvJSON(csv){
  var result = [];
  var headers=csv[0];
  for(var i=1;i<csv.length;i++){
      var obj = {};
      for(var j=0;j<headers.length;j++){
          obj[headers[j]] = parseFloat(csv[i][j]);
      }
      result.push(obj);
  }
  return result; 
}


	
	


var xAxisKey = 'time';
uartSymbol2Data.forEach(function(e, index) {
	e.time = '' + e.time;
});var uartSymbol2Ctx = document.getElementById('uartSymbol2').getContext('2d');
const uartSymbol2Chart = new Chart(uartSymbol2Ctx, {
    type: 'line',
    data: {
        datasets: [{
            label: 'Ток',
            data: uartSymbol2Data,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'uartSymbol'
            },
            borderColor: '#ffcd00',
            backgroundColor: 'rgba(255, 205, 0, 0.1)',
            pointBackgroundColor: '#ffcd00',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        }]
    },
    options: {
    	stacked: false,
    	elements: {
    		point: {
    		      radius: 0,
    		      hitRadius: 10,
    		      hoverRadius: 4,
    		      hoverBorderWidth: 3
    		}	
    	},
        animation: {
            duration: 0
        },
        interaction: {
            intersect: false,
            mode: 'index',
        },
        scales: {x: {
                title: {
                    display: true,
                    text: 'Время'
                },
                ticks: {
                    
                    callback: function(value, index, ticks) {
                    	
                        return this.getLabelForValue(value) + ' мс';
                    }}
        	},y: {
                beginAtZero: true,
                position: 'left',title: {
                    display: true,
                    text: 'Ток'
                },
                ticks: {
                    callback: function(value, index, ticks) {
                        return value + ' мA';
                    }}
            }},
        plugins: {
            title: {
                display: true,
                text: 'Потребление тока при передаче символа',
                font: {
                	size: 16
                }
            },
            legend: {
                display: false
            },
            tooltip: {
            	position: 'nearest',
            	callbacks: {title: function(context) {
                        return context[0].label + ' мс';
            		},label: function(context) {
            			let label = context.dataset.label || '';

                        if (label) {
                            label += ': ';
                        }
                        
                        var unit = "мA";if (context.parsed.y !== null) {
                        	label += context.parsed.y + ' ' + unit;
                        }
                        
                        return label;
            		}
            	}
            }
        }
    }
});
</script><noscript>
	<img src="/img/lora-at-power-profiling/uartSymbol2.png">
</noscript>
<ul>
<li>Каждое нажатие вызывает скачок потребления тока примерно на <strong>10м</strong>А и длится примерно <strong>1.4</strong>мс</li>
<li>Не очень понятно почему два скачка</li>
<li>Если положить в буфер сразу несколько символов с помощью CMD+V, то это сгенерирует одно прерывание и очень похожий график</li>
</ul>
<p>Если за <strong>1.4</strong>мс потрачено <strong>37.32</strong>мкКл, а в режиме простоя за это же время тратится <strong>35.11</strong>мкКл, то нажатие на кнопку обошлось в <strong>2.21</strong>мкКл.</p>
<h2 id="выводы">Выводы</h2>
<ul>
<li>С-код в среднем более энергоэффективен за счёт использования задач FreeRTOS, а не бесконечного цикла</li>
<li>По графику потребления энергии можно находить баги в коде</li>
<li>Bluetooth Low Energy - не самый предсказуемый в плане потребления энергии протокол</li>
<li>Даже если код перехода в глубокий сон вызван правильным образом - это не гарантирует того, что устройство действительно потребляет мало энергии. Нужно мерить!</li>
</ul>

</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'><div class='tags'><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>

</svg>
<span class='screen-reader-text'>tags: </span><a class='tag' href='/tags/lora/'>Lora</a>, <a class='tag' href='/tags/lora-at/'>Lora-At</a>, <a class='tag' href='/tags/esp32/'>Esp32</a>, <a class='tag' href='/tags/esp-idf/'>Esp-Idf</a>, <a class='tag' href='/tags/ppk2/'>PPK2</a></div>

  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/posts/power-profiler-kit2/'>
        <span aria-hidden='true'><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>

</svg>
 </span>
        <span class='screen-reader-text'>: </span>Power Profiler Kit 2</a>
    </div><div class='next-entry sep-before'>
      <a href='/posts/troubleshoot-deep-sleep/'>
        <span class='screen-reader-text'>: </span>Оптимизация энергопотребления LoRa - Часть 2<span aria-hidden='true'> <svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
  <line x1="4" y1="12" x2="20" y2="12"/>
  <polyline points="14 6 20 12 14 18"/>

</svg>
</span>
      </a>
    </div></div>
</nav>


<section id='comments' class='comments'>
  <div class='container sep-before'>
    <div class='comments-area'><script>
  var remark_config = {
    host: "https://remark42.dernasherbrezon.com", 
    site_id: '9134',
    locale: 'ru',
    components: ['embed'] 
                          
                          
                          
                          
                          
  };

  (function(c) {
    for(var i = 0; i < c.length; i++){
      var d = document, s = d.createElement('script');
      s.src = remark_config.host + '/web/' +c[i] +'.js';
      s.defer = true;
      (d.head || d.body).appendChild(s);
    }
  })(remark_config.components || ['embed']);
</script>
<div id="remark42"></div>
</div>
  </div>
</section>

      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><section class='widget widget-social_menu sep-after'><nav aria-label=''>
    <ul><li>
        <a href='https://github.com/dernasherbrezon' target='_blank' rel='noopener me'>
          <span class='screen-reader-text'></span><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
      <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>

</svg>
</a>
      </li><li>
        <a href='https://twitter.com/dernasherbrezon' target='_blank' rel='noopener me'>
          <span class='screen-reader-text'></span><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
  <title>Twitter icon</title>
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>

</svg>
</a>
      </li><li>
        <a href='mailto:dernasherbrezon@gmail.com' target='_blank' rel='noopener me'>
          <span class='screen-reader-text'></span><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline>
</svg>
</a>
      </li><li>
        <a href='https://t.me/dernasherbrezonChannel' target='_blank' rel='noopener me'>
          <span class='screen-reader-text'></span><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <title>Telegram icon</title><path d="M23.91 3.79L20.3 20.84c-.25 1.21-.98 1.5-2 .94l-5.5-4.07-2.66 2.57c-.3.3-.55.56-1.1.56-.72 0-.6-.27-.84-.95L6.3 13.7l-5.45-1.7c-1.18-.35-1.19-1.16.26-1.75l21.26-8.2c.97-.43 1.9.24 1.53 1.73z"/>
</svg>
</a>
      </li></ul>
  </nav>
</section><div class='copyright'>
  <p><a href="https://creativecommons.org/licenses/by-nc-nd/3.0/">CC BY-NC-ND 3.0</a> &copy; 2017-2024 dernasherbrezon </p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__assets_js_src="/assets/js/"</script>

<script src='/assets/js/main.c3bcf2df.js'></script><script>
var downloadLinks = document.getElementsByClassName('downloadChart');
for (var i = 0; i < downloadLinks.length; i++) {
	downloadLinks[i].addEventListener('click', function(event){
		var targetElement = event.target || event.srcElement;
		var canvasId = targetElement.getAttribute('data-canvasid');
		console.log(canvasId);
		var url_base64 = document.getElementById(canvasId).toDataURL("image/png");
		targetElement.href = url_base64;
	});
}
</script>
</body>

</html>

