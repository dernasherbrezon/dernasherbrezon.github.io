<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:yandex="http://news.yandex.ru"
  xmlns:media="http://search.yahoo.com/mrss/"
  xmlns:turbo="http://turbo.yandex.ru" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>dernasherbrezon</title>
    <link>https://dernasherbrezon.com/posts/</link>
    <description>Блог о программировании на Java</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>ru</language>
    <lastBuildDate>Wed, 29 May 2019 07:48:18 +0100</lastBuildDate>
    
        <atom:link href="https://dernasherbrezon.com/posts/index.xml" rel="self" type="application/rss+xml" />
    
    
    <item turbo="true">
      <title>Расчёт мощности радиосигнала</title>
      <link>https://dernasherbrezon.com/posts/power-in-radio-channel/</link>
      <pubDate>Wed, 29 May 2019 07:48:18 +0100</pubDate>
      
      <guid>https://dernasherbrezon.com/posts/power-in-radio-channel/</guid>
      <description>Нашёл в Интернете совершенно потрясающую визуализацию изменения мощности при передаче радио сигнала:

Это картинка описывает как изменяется мощность от передатчика к приёмнику. Формула следующая:
$$ P_r = P_t - L_{tc} + G_{ta} - L_{all} + G_{ra} - L_{rc} $$
Где,
 \( P_r \) - результирующая мощность полученного сигнала \( P_t \) - мощность передачи сигнала \(L_{tc}\) - потери в кабеле при передаче сигнала от передатчика на его антенну \(G_{ta}\) - усиление антенны \(L_{all}\) - потери в среде \(G_{ra}\) - усиление принимающей антенны \(L_{rc}\) - потери в кабеле приёмника  Большинство параметров достаточно очевидны, но собранные все вместе они дают хорошую картину изменения мощности.</description>
      <turbo:content>
      	<![CDATA[
      		<header>
      			<h1>Расчёт мощности радиосигнала</h1><figure>
				    	<img src="https://dernasherbrezon.com/img/power-in-radio-channel/level2-2.gif"/>
				    </figure></header>
      		<div class='container entry-content'>
  <p>Нашёл в Интернете совершенно потрясающую визуализацию изменения мощности при передаче радио сигнала:</p>

<p><a href="https://www.cdt21.com/resources/TechnicalArticle/article9.asp" target="_blank"><img src="/img/power-in-radio-channel/level2-2.gif" alt="" /></a></p>

<p>Это картинка описывает как изменяется мощность от передатчика к приёмнику. Формула следующая:</p>

<p>$$
P_r = P_t - L_{tc} + G_{ta} - L_{all} + G_{ra} - L_{rc}
$$</p>

<p>Где,</p>

<ul>
<li>\( P_r \) - результирующая мощность полученного сигнала</li>
<li>\( P_t \) - мощность передачи сигнала</li>
<li>\(L_{tc}\) - потери в кабеле при передаче сигнала от передатчика на его антенну</li>
<li>\(G_{ta}\) - усиление антенны</li>
<li>\(L_{all}\) - потери в среде</li>
<li>\(G_{ra}\) - усиление принимающей антенны</li>
<li>\(L_{rc}\) - потери в кабеле приёмника</li>
</ul>

<p>Большинство параметров достаточно очевидны, но собранные все вместе они дают хорошую картину изменения мощности. Так, например, чтобы увеличить мощность принимаемого сигнала, надо уменьшить потери на различных участках и/или увеличить усиление антенн.</p>

</div>

      	]]>
      </turbo:content>
    </item>
    
    <item turbo="true">
      <title>Расчёт вероятности ошибки для BPSK</title>
      <link>https://dernasherbrezon.com/posts/ber-bpsk/</link>
      <pubDate>Sun, 05 May 2019 18:22:18 +0100</pubDate>
      
      <guid>https://dernasherbrezon.com/posts/ber-bpsk/</guid>
      <description>Введение Моя сеть приёма сигналов со спутников r2cloud постепенно растёт. Однако уровень приёма оставляет желать лучшего. Несмотря на то, что на спектограмме виден сигнал, демодулятор не может восстановить его. В попытках найти проблему, я понял, что мне не хватает фундаментальных знаний по теории обработки сигналов и некоторой математики. Дело в том, что в интернете зачастую выкладываются демодуляторы без обоснования их работы. Меня это не устраивает, потому что нужны метрики по которым я буду понимать насколько один алгоритм эффективнее другого.</description>
      <turbo:content>
      	<![CDATA[
      		<header>
      			<h1>Расчёт вероятности ошибки для BPSK</h1><figure>
				    	<img src="https://dernasherbrezon.com/img/ber-bpsk/ber-bpsk.png"/>
				    </figure></header>
      		<div class='container entry-content'>
  

<h2 id="введение">Введение</h2>

<p>Моя сеть приёма сигналов со спутников <a href="https://github.com/dernasherbrezon/r2cloud" target="_blank">r2cloud</a> постепенно растёт. Однако уровень приёма оставляет желать лучшего. Несмотря на то, что на спектограмме виден сигнал, демодулятор не может восстановить его. В попытках найти проблему, я понял, что мне не хватает фундаментальных знаний по теории обработки сигналов и некоторой математики. Дело в том, что в интернете зачастую выкладываются демодуляторы без обоснования их работы. Меня это не устраивает, потому что нужны метрики по которым я буду понимать насколько один алгоритм эффективнее другого. И стал ли новый код лучше, если я добавлю какой-нибудь другой блок в обработку.</p>

<p>Всё это привело меня к \( E_b / N_0 \). Эта метрика показывает отношение энергии сигнала, приходящейся на 1 бит принимаемого сообщения (\( E_b \)), к энергетической спектральной плотности шума (\( N_0 \)). Почему она так важна? Дело в том, что она не зависит от способа модуляции сигнала и пропускной способности канала. Из-за этого её можно использовать, чтобы сравнивать различные модуляции между собой. Обычно строят график отношения \( E_b / N_0 \) к вероятности ошибки (BER). Вот <a href="https://ru.wikipedia.org/wiki/Eb/N0" target="_blank">пример</a> графика сравнения BPSK/QPSK/8-PSK/16-PSK:</p>

<p><img src="/img/ber-bpsk/PSK_BER_curves.svg" alt="" /></p>

<p>Что из этого графика можно понять?</p>

<ol>
<li>Если увеличивать энергию передаваемого бита, то уменьшается вероятность возникновения ошибки.</li>
<li>В BPSK/QPSK ошибка возникает значительно реже, чем в 8-PSK и 16-PSK при одинаковых значениях энергии передаваемого бита.</li>
<li>График, например, читается следующим образом: при \( E_b / N_0 \) равным 4 децибелла и BPSK модуляции можно получить 1 ошибочный бит на каждые 100 полученных.</li>
</ol>

<p>Мне же график прежде всего нужен:</p>

<ol>
<li>Сравнивать теоретические значения с практической реализацией демодулятора. Прямо сейчас я точно знаю, что различия есть из-за ограниченной точности АЦП. Дело в том, что rtl-sdr имеет разрешающую способность 8 бит. А в теории числа могут быть бесконечной точности. Именно эта разница и должна давать ошибку.</li>
<li>Анализировать улучшится ли демодулятор, если добавить какой-то определённый блок. Как минимум я хочу попробовать различные алгоритмы получения несущего сигнала и компенсации <a href="https://ru.wikipedia.org/wiki/Многолучевое_распространение" target="_blank">многолучевого распространения</a>.</li>
</ol>

<p>Ну и для того, чтобы понять математику, я решил проделать выводы сам. Ниже я буду рассчитывать вероятности ошибки для BPSK (см. синий график выше). Вдохновение я черпал у <a href="http://www.dsplog.com/2007/08/05/bit-error-probability-for-bpsk-modulation/" target="_blank">dsplog</a> плюс добавлял свои мысли.</p>

<h2 id="дано">Дано</h2>

<p>Прежде всего необходимо описать физику процесса. Схема процесса показана ниже:</p>

<p><img src="/img/ber-bpsk/bpsk.png" alt="" /></p>

<ol>
<li>Изначальное сообщение кодируется в аналоговый сигнал. &ldquo;1&rdquo; кодируется в \(+\sqrt{E_b}\), &ldquo;0&rdquo; кодируется в \(-\sqrt{E_b}\). Почему именно как корень из \(E_b\)? Не знаю. Это единственное место, где я не разобрался.</li>
<li>После этого сигнал складывается с <a href="https://ru.wikipedia.org/wiki/Аддитивный_белый_гауссовский_шум" target="_blank">аддитивным белым гауссовским шумом</a>.</li>
<li>Далее сигнал демодулируется.</li>
</ol>

<p>Модулированный BPSK сигнал выглядит следующим образом:</p>

<p><a href="/img/ber-bpsk/bpsk-constellation.m"><img src="/img/ber-bpsk/bpsk-constellation.png" alt="" /></a></p>

<p>Красными точками обозначается сигнал без шума. Синими - сигнал с добавлением белого гауссовского шума. Как демодулируется этот сигнал? Все точки, которые больше &ldquo;0&rdquo; становятся &ldquo;1&rdquo;, а те, что меньше &ldquo;0&rdquo; становятся &ldquo;0&rdquo;. На рисунке выше все синие точки достаточно далеко от &ldquo;0&rdquo;, поэтому информацию можно однозначно восстановить. Но что если шум будет сильнее?</p>

<p><a href="/img/ber-bpsk/ber-awgn.m"><img src="/img/ber-bpsk/ber-awgn.png" alt="" /></a></p>

<p>Тут уже не всё так однозначно. Видно, что некоторые точки закодированные как &ldquo;1&rdquo; на самом деле оказались меньше &ldquo;0&rdquo;. И если бы я попытался их демодулировать, то получил бы неправильную информацию.</p>

<h2 id="решение">Решение</h2>

<p>Теперь, когда стало понятно влияние шума на результат демодуляции, можно переходить к графику зависимости вероятности от энергии сигнала. Этот график поможет посчитать вероятность ошибок для различных входных значений. Для начала возьмём сигнал без шума. Вероятность получения &ldquo;0&rdquo; или &ldquo;1&rdquo; всегда 1.</p>

<p><a href="/img/ber-bpsk/no-error-bpsk.m"><img src="/img/ber-bpsk/no-error-bpsk.png" alt="" /></a></p>

<p>Частота получения ошибочных битов (Bit error rate) будет 0. Т.е. 0 ошибочных битов на бесконечное количество принятых. В случае наличия гауссовского шума, вероятность получения определяется гауссовской функцией вероятности:</p>

<p><a href="/img/ber-bpsk/awgn-bpsk.m"><img src="/img/ber-bpsk/awgn-bpsk.png" alt="" /></a></p>

<p>Гауссовский шум определяется следующей формулой:</p>

<p>$$
p(x) = \dfrac{1}{\sqrt{2\pi\sigma^2}}e^\dfrac{-(x-\mu)^2}{2\sigma^2}
$$</p>

<p>Где:</p>

<ul>
<li>\(\mu=0\),</li>
<li>\(\sigma^2=N_0/2\)</li>
</ul>

<p>При передаче &ldquo;1&rdquo; \(\mu=+\sqrt{E_b}\), при &ldquo;0&rdquo; \(\mu=-\sqrt{E_b}\). Подставляя это в формулу:</p>

<p>$$
\begin{align}
P(x|s_0)=\dfrac{1}{\sqrt{\pi N_0}}e^\dfrac{-(x+\sqrt{E_b})^2}{N_0} \newline
P(x|s_1)=\dfrac{1}{\sqrt{\pi N_0}}e^\dfrac{-(x-\sqrt{E_b})^2}{N_0}
\end{align}
$$</p>

<p>Теперь самое интересное.</p>

<p><img src="/img/ber-bpsk/awgn-bpsk-error.png" alt="" /></p>

<p>На этом рисунке показаны области возникновения ошибки. Зелёная область - это место где возникает ошибка при передаче &ldquo;1&rdquo;, красная - при передаче &ldquo;0&rdquo;. Общую вероятность ошибки можно записать с помощью формулы полной вероятности:</p>

<p>$$
P(error)=\dfrac{1}{2}P(error|s_0) + \dfrac{1}{2}P(error|s_1)
$$</p>

<p>После этого необходимо найти каждую из вероятностей:</p>

<p>$$
\begin{align}
P(error|s_0) = \int_{0}^{\infty}P(x|s_0)dx = \dfrac{1}{\sqrt{\pi N_0}}\int_{0}^{\infty}e^\dfrac{-(x+\sqrt{E_b})^2}{N_0}dx \newline
P(error|s_1) = \int_{-\infty}^{0}P(x|s_1)dx = \dfrac{1}{\sqrt{\pi N_0}}\int_{-\infty}^{0}e^\dfrac{-(x-\sqrt{E_b})^2}{N_0}dx
\end{align}
$$</p>

<p>Обычно вероятность ошибки записывают с помощью <a href="https://ru.wikipedia.org/wiki/Функция_ошибок" target="_blank">функции ошибок</a>:</p>

<p>$$
erfc(x)=\dfrac{2}{\sqrt\pi}\int_{0}^{x}e^{-t^2}dt
$$</p>

<p>Для этого необходимо сделать следующее:</p>

<p>$$
z=\dfrac{y+\sqrt{E_b}}{\sqrt{N_0}} =&gt; z\sqrt{N_0} = y + \sqrt{E_b}
$$</p>

<p>Заменить пределы интегрирования:</p>

<p>$$
\begin{align}
y=0 =&gt; z = \dfrac{\sqrt{E_b}}{\sqrt{N_0}} \newline
y=\infty =&gt; z = \infty
\end{align}
$$</p>

<p>Получившаяся ошибка записывается как:</p>

<p>$$
\begin{align}
P(error|s_0)=\dfrac{1}{\sqrt{\pi N_0}}\int_\limits{\sqrt{\dfrac{E_b}{N_0}}}^{\infty}e^{-z^2}\sqrt{N_0}dz
=\dfrac{1}{\sqrt{\pi}}\int_\limits{\sqrt{\dfrac{E_b}{N_0}}}^{\infty}e^{-z^2}dz
=\dfrac{1}{2}erfc(\sqrt{\dfrac{E_b}{N_0}})
\end{align}
$$</p>

<p>Аналогично можно найти ошибку при передачи &ldquo;1&rdquo;:</p>

<p>$$
\begin{align}
P(error|s_1)=1-P(s_1)=1-\dfrac{1}{2}erfc(-\sqrt{\dfrac{E_b}{N_0}})
\end{align}
$$</p>

<p>Можно воспользоваться свойством функции ошибок:</p>

<p>$$
\begin{align}
erfc(-x)=2-erfc(x) =&gt; P(error|s_1) = \dfrac{1}{2}erfc(\sqrt{\dfrac{E_b}{N_0}})
\end{align}
$$</p>

<p>Если подставить в формулу полной вероятности:</p>

<p>$$
P(error)=\dfrac{1}{2}(\dfrac{1}{2}erfc(\sqrt{\dfrac{E_b}{N_0}})) + \dfrac{1}{2}(\dfrac{1}{2}erfc(\sqrt{\dfrac{E_b}{N_0}}))=\dfrac{1}{2}erfc(\sqrt{\dfrac{E_b}{N_0}})
$$</p>

<h2 id="ответ">Ответ</h2>

<p>Получившийся график:</p>

<p><a href="/img/ber-bpsk/ber-bpsk.m"><img src="/img/ber-bpsk/ber-bpsk.png" alt="" /></a></p>

</div>

      	]]>
      </turbo:content>
    </item>
    
    <item turbo="true">
      <title>Подписанные ссылки</title>
      <link>https://dernasherbrezon.com/posts/signed-urls/</link>
      <pubDate>Wed, 01 May 2019 18:22:18 +0100</pubDate>
      
      <guid>https://dernasherbrezon.com/posts/signed-urls/</guid>
      <description>Почти все REST сервисы имеют аутентификацию. Есть несколько способов её сделать:
 basic. В каждый запрос добавляется заголовок &amp;ldquo;Authorization&amp;rdquo; с логином и паролем.  GET / HTTP/1.1 Host: example.org Authorization: Basic Zm9vOmJhcg==   token. REST сервис обменивает логин и пароль на специальный токен аутентификации. Клиент должен все последующие запросы делать с этим токеном.  GET / HTTP/1.1 Host: example.org Authorization: Bearer 9yro9yueihfw497y33497y3oeiruhfvskdgjhfaowidayuh  Аутентификация на основе токенов наиболее безопасная и гибкая.</description>
      <turbo:content>
      	<![CDATA[
      		<header>
      			<h1>Подписанные ссылки</h1></header>
      		<div class='container entry-content'>
  

<p>Почти все REST сервисы имеют аутентификацию. Есть несколько способов её сделать:</p>

<ul>
<li>basic. В каждый запрос добавляется заголовок &ldquo;Authorization&rdquo; с логином и паролем.</li>
</ul>

<pre><code>GET / HTTP/1.1
Host: example.org
Authorization: Basic Zm9vOmJhcg==
</code></pre>

<ul>
<li>token. REST сервис обменивает логин и пароль на специальный токен аутентификации. Клиент должен все последующие запросы делать с этим токеном.</li>
</ul>

<pre><code>GET / HTTP/1.1
Host: example.org
Authorization: Bearer 9yro9yueihfw497y33497y3oeiruhfvskdgjhfaowidayuh
</code></pre>

<p>Аутентификация на основе токенов наиболее безопасная и гибкая. Токены можно <a href="https://ru.wikipedia.org/wiki/OAuth" target="_blank">отзывать и обновлять</a>, в них можно <a href="https://ru.wikipedia.org/wiki/JSON_Web_Token" target="_blank">класть дополнительную информацию</a>. С ними очень удобно работать из <a href="https://ru.wikipedia.org/wiki/Одностраничное_приложение" target="_blank">SPA приложений</a>. Например, доступ к защищённому ресурсу можно сделать следующим образом:</p>

<ul>
<li>Установить единый токен для всех запросов</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">axios</span>.<span style="color:#a6e22e">defaults</span>.<span style="color:#a6e22e">headers</span>.<span style="color:#a6e22e">common</span>[<span style="color:#e6db74">&#39;Authorization&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Bearer &#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">token</span>
</code></pre></div>
<ul>
<li>Делать вызывы к защищённым методам</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">$http</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;/admin/config/general&#39;</span>).<span style="color:#a6e22e">then</span>(<span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">response</span>) {
	<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">response</span>)
})
</code></pre></div>
<p>Но что делать, если необходимо защитить статические ресурсы? Например, в <a href="https://github.com/dernasherbrezon/r2cloud" target="_blank">r2cloud</a> статические ресурсы это снимки со спутников, телеметрия и метрики производительности. Есть несколько способов.</p>

<h3 id="data-src-атрибут">Data-src атрибут</h3>

<p>Схема работы следующая:</p>

<ul>
<li>Вместо обычного <code>src</code> атрибута, указывается <code>data-src</code></li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#f92672">img</span> <span style="color:#a6e22e">data-src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/admin/observation/picture.png&#34;</span>&gt;</code></pre></div>
<ul>
<li>После загрузки страницы код на javascript должен проходить по всем элементам img, загружать через ajax картинки и проставлять их в тэг <code>src</code></li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">$</span>(<span style="color:#e6db74">&#34;img&#34;</span>).<span style="color:#a6e22e">attr</span>(<span style="color:#e6db74">&#34;src&#34;</span>, <span style="color:#e6db74">&#34;data:image/png;base64,&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">response</span>);
</code></pre></div>
<p>У этого метода есть один большой недостаток: необходимо на каждой странице выполнять javascript код, который будет подгружать картинки. Но есть и другой способ.</p>

<h3 id="подписанные-ссылки">Подписанные ссылки</h3>

<p>Суть метода заключается в том, что к ссылке добавляется подпись. Эта подпись обладает следующими свойствами:</p>

<ul>
<li>позволяет получить данные без использования заголовка <code>Authorization</code>.</li>
<li>короткоживущая. Подпись содержит в себе время создания ссылки. Это время проверяется на сервере, и если оно превышает время жизни ссылки, то её данные нельзя получить.</li>
<li>её нельзя подделать. Она сгенерирована с использованием секретного ключа, который известен только на сервере.</li>
</ul>

<p>Вот как выглядит использование таких ссылок на странице:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#f92672">img</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/img/a.jpg?hash=3679d97d8b1d497743cd8da8ba0440f5&amp;timestamp=1508716800000&#34;</span>&gt;</code></pre></div>
<p>Где <code>hash</code> - это подпись, <code>timestamp</code> - время генерации ссылки. На сервере подпись можно <a href="https://github.com/dernasherbrezon/r2cloud/blob/master/src/main/java/ru/r2cloud/util/SignedURL.java" target="_blank">генерировать</a> следующим образом:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">computeMD5<span style="color:#f92672">(</span>path <span style="color:#f92672">+</span> timestamp <span style="color:#f92672">+</span> password<span style="color:#f92672">)</span></code></pre></div>
<p>Здесь нужно обратить внимание на то, что время включено в алгоритм генерации подписи. Это позволит защититься от <a href="https://ru.wikipedia.org/wiki/Атака_повторного_воспроизведения" target="_blank">атак повторного воспроизведения</a>.</p>

<h3 id="кэширование">Кэширование</h3>

<p>Данные, полученные по подписанным ссылкам, могут быть кэшированы браузером. Из-за этого необходимо аккуратно выставить заголовки ответа: не кэшировать на прокси серверах и кэшировать в браузере только на время жизни ссылки:</p>

<pre><code>Cache-Control: private, max-age=600
Last-Modified: Wed, 15 Nov 1995 04:58:08 GMT
</code></pre>

</div>

      	]]>
      </turbo:content>
    </item>
    
    <item turbo="true">
      <title>Тестирование ошибок файловой системы</title>
      <link>https://dernasherbrezon.com/posts/test-fs-failures/</link>
      <pubDate>Sat, 20 Apr 2019 21:50:18 +0100</pubDate>
      
      <guid>https://dernasherbrezon.com/posts/test-fs-failures/</guid>
      <description>Большинство статей в моём блоге посвящены интересным вещам, с которыми я периодически сталкиваюсь. Эта статья не исключение. В одном из моих проектов - r2cloud я столкнулся с одной интересной ошибкой.
Вот, что мне удалось восстановить глядя на логи и исходный код:
 Диск полностью заполнился В какой-то момент времени обновилась конфигурация. Например, обновилось текущее значение PPM При попытке записать в файл, происходит ошибка IOException &amp;ldquo;no disk space&amp;rdquo; Файл пользовательских настроек полностью портится.</description>
      <turbo:content>
      	<![CDATA[
      		<header>
      			<h1>Тестирование ошибок файловой системы</h1></header>
      		<div class='container entry-content'>
  

<p>Большинство статей в моём блоге посвящены интересным вещам, с которыми я периодически сталкиваюсь. Эта статья не исключение. В одном из моих проектов - <a href="http://github.com/dernasherbrezon/r2cloud" target="_blank">r2cloud</a> я столкнулся с одной интересной ошибкой.</p>

<p>Вот, что мне удалось восстановить глядя на логи и исходный код:</p>

<ol>
<li>Диск полностью заполнился</li>
<li>В какой-то момент времени обновилась конфигурация. Например, обновилось текущее значение <a href="https://davidnelson.me/?p=371" target="_blank">PPM</a></li>
<li>При попытке записать в файл, происходит ошибка IOException &ldquo;no disk space&rdquo;</li>
<li>Файл пользовательских настроек полностью портится. В зависимости от того, сколько диска было свободно, он становится либо частично записанным, либо пустым.</li>
</ol>

<p>Эта ошибка достаточно критичная. Дело в том, что с появлением большого количества спутников, диск будет периодически заполнятся. То есть, &ldquo;no disk space&rdquo; будет достаточно часто возникать. При этом пользовательские настройки не должны пропадать! Даже если диск полностью заполнен, приложение должно работать и отправлять в <a href="https://r2server.com" target="_blank">r2server</a> данные.</p>

<p>Исправить эту ошибку достаточно просто, однако, возникает немаловажный вопрос: а как вообще тестировать отказ файловой системы? И &ldquo;no disk space&rdquo; в частности?</p>

<h2 id="теория">Теория</h2>

<p>До JDK7 необходимо было бы создавать ещё один слой абстракции над файловой системой и делать его mock во время тестирования. В JDK7 появился специальный слой, абстрагирующий файловую систему: <code>java.nio.file.FileSystem</code>. Изначально <a href="http://github.com/dernasherbrezon/r2cloud" target="_blank">r2cloud</a> был написан на основе старого <code>java.io.File</code>, поэтому его необходимо переписать на новый API:</p>

<p><img src="/img/test-fs-failures/api.png" alt="" /></p>

<h2 id="mockfilesystem">MockFileSystem</h2>

<p>Во время тестирования FileSystem необходимо заменить на MockFileSystem, которая генерирует IOException по заранее сконфигурированному сценарию. К сожалению, я не нашёл такую файловую систему, поэтому написал свою <a href="http://github.com/dernasherbrezon/mockfs" target="_blank">mockfs</a>.</p>

<p>Она позволяет проксировать запросы к файловой системе по-умолчанию и генерировать IOException при доступе к определённым файлам.</p>

<p>Тест при этом выглядит следующим образом.</p>

<p>Инициалиация. Чтобы MockFileSystem использовалась, необходимо её передавать компонентам извне.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">	<span style="color:#a6e22e">@Before</span>
	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
		fs <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MockFileSystem<span style="color:#f92672">(</span>FileSystems<span style="color:#f92672">.</span><span style="color:#a6e22e">getDefault</span><span style="color:#f92672">());</span>
		config <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TestConfiguration<span style="color:#f92672">(</span>tempFolder<span style="color:#f92672">,</span> fs<span style="color:#f92672">);</span>
	<span style="color:#f92672">}</span></code></pre></div>
<p>Сам тест при этом выглядит следующим образом:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">	<span style="color:#a6e22e">@Test</span>
	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testCorruptedAfterFailedWrite</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
		String lat <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;53.40&#34;</span><span style="color:#f92672">;</span>
		config<span style="color:#f92672">.</span><span style="color:#a6e22e">setProperty</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;locaiton.lat&#34;</span><span style="color:#f92672">,</span> lat<span style="color:#f92672">);</span>
		config<span style="color:#f92672">.</span><span style="color:#a6e22e">update</span><span style="color:#f92672">();</span>

		fs<span style="color:#f92672">.</span><span style="color:#a6e22e">mock</span><span style="color:#f92672">(</span>config<span style="color:#f92672">.</span><span style="color:#a6e22e">getTempDirectoryPath</span><span style="color:#f92672">(),</span> <span style="color:#66d9ef">new</span> FailingByteChannelCallback<span style="color:#f92672">(</span>3<span style="color:#f92672">));</span>
		Path userParentPath <span style="color:#f92672">=</span> fs<span style="color:#f92672">.</span><span style="color:#a6e22e">getPath</span><span style="color:#f92672">(</span>TestConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">getUserSettingsLocation</span><span style="color:#f92672">(</span>tempFolder<span style="color:#f92672">)).</span><span style="color:#a6e22e">getParent</span><span style="color:#f92672">();</span>
		fs<span style="color:#f92672">.</span><span style="color:#a6e22e">mock</span><span style="color:#f92672">(</span>userParentPath<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> FailingByteChannelCallback<span style="color:#f92672">(</span>3<span style="color:#f92672">));</span>

		String newLat <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;23.40&#34;</span><span style="color:#f92672">;</span>
		config<span style="color:#f92672">.</span><span style="color:#a6e22e">setProperty</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;locaiton.lat&#34;</span><span style="color:#f92672">,</span> newLat<span style="color:#f92672">);</span>
		<span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
			config<span style="color:#f92672">.</span><span style="color:#a6e22e">update</span><span style="color:#f92672">();</span>
			fail<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;config should not be updated&#34;</span><span style="color:#f92672">);</span>
		<span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
			<span style="color:#75715e">// expected
</span><span style="color:#75715e"></span>		<span style="color:#f92672">}</span>
		
		fs<span style="color:#f92672">.</span><span style="color:#a6e22e">removeMock</span><span style="color:#f92672">(</span>config<span style="color:#f92672">.</span><span style="color:#a6e22e">getTempDirectoryPath</span><span style="color:#f92672">());</span>
		fs<span style="color:#f92672">.</span><span style="color:#a6e22e">removeMock</span><span style="color:#f92672">(</span>userParentPath<span style="color:#f92672">);</span>

		config <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TestConfiguration<span style="color:#f92672">(</span>tempFolder<span style="color:#f92672">,</span> fs<span style="color:#f92672">);</span>
		assertEquals<span style="color:#f92672">(</span>lat<span style="color:#f92672">,</span> config<span style="color:#f92672">.</span><span style="color:#a6e22e">getProperty</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;locaiton.lat&#34;</span><span style="color:#f92672">));</span>
	<span style="color:#f92672">}</span></code></pre></div>
<ul>
<li>В самом начале происходит запись в файл.</li>
<li>Потом идёт установка поведения файловой системы. В данной случае MockFileSystem будет выбрасывать IOException после записи 3 байт.</li>
<li>Очистка mock объектов.</li>
<li>Загрузка данных из файла и проверка того, что предыдущее значение успешно было загружено.</li>
</ul>

<p>После того, как тест был написан, исправление ошибки достаточно простое:</p>

<ul>
<li>делать запись во временный файл</li>
<li>атомарно перезаписывать временный файл в результирующий</li>
</ul>

</div>

      	]]>
      </turbo:content>
    </item>
    
    <item turbo="true">
      <title>Сжимание I/Q потока на raspberrypi</title>
      <link>https://dernasherbrezon.com/posts/rtlsdr-gzip/</link>
      <pubDate>Mon, 04 Mar 2019 17:22:18 +0100</pubDate>
      
      <guid>https://dernasherbrezon.com/posts/rtlsdr-gzip/</guid>
      <description>Недавно я добавил поддержку более 20 спутников в r2cloud. Из-за этого принимаемых данных стало значительно больше и диск переполнился. Чтобы как-то решить эту проблему, я уменьшил количество сохраняемых наблюдений. Теперь сохраняются последние 3 наблюдения для каждого спутника. Это не сильно помогло:
Дело в том, что при пролёте спутника, я сохраняю данные в raw I/Q с частотой пример 240 000 сэмплов в секунду. Это создаёт файл:
240 000 байт/сек * 2 (канала) * 12 минут = 288000000 байт = ~288мб Почему такая большая частота?</description>
      <turbo:content>
      	<![CDATA[
      		<header>
      			<h1>Сжимание I/Q потока на raspberrypi</h1><figure>
				    	<img src="https://dernasherbrezon.com/img/rtlsdr-gzip/3.png"/>
				    </figure></header>
      		<div class='container entry-content'>
  

<p>Недавно я добавил поддержку более 20 спутников в <a href="https://github.com/dernasherbrezon/r2cloud" target="_blank">r2cloud</a>. Из-за этого принимаемых данных стало значительно больше и диск переполнился. Чтобы как-то решить эту проблему, я уменьшил количество сохраняемых наблюдений. Теперь сохраняются последние 3 наблюдения для каждого спутника. Это не сильно помогло:</p>

<p><img src="/img/rtlsdr-gzip/1.png" alt="" /></p>

<p>Дело в том, что при пролёте спутника, я сохраняю данные в raw I/Q с частотой пример 240 000 сэмплов в секунду. Это создаёт файл:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#ae81ff">240</span> <span style="color:#ae81ff">000</span> байт/сек * <span style="color:#ae81ff">2</span> <span style="color:#f92672">(</span>канала<span style="color:#f92672">)</span> * <span style="color:#ae81ff">12</span> минут <span style="color:#f92672">=</span> <span style="color:#ae81ff">288000000</span> байт <span style="color:#f92672">=</span> ~288мб</code></pre></div>
<p>Почему такая большая частота? Кубсаты обычно занимают гораздо меньшую полосу частот, но дело в том, что rtl-sdr не умеет меньше. Поэтому необходимо сохранить данные с такой частотой, а потом даунсэмплировать в более низкую.</p>

<p>Конвертация в .wav файл с частотой 48 000 сэмплов в секунду занимает слишком много времени. Так что, пока она происходит, запускается следующее наблюдение. Предыдущий файл не успевает сконвертироваться, и запускается ещё одно наблюдение и так далее. Всё это приводит к тому, что диск переполняется.</p>

<p>Чтобы этого избежать, я придумал следующее:</p>

<ol>
<li>Не запускать следующее наблюдение, если не произведено даунсэмплирование предыдущего</li>
<li>Сохранять данные на диск сразу в сжатом виде</li>
</ol>

<p>Первый пункт было достаточно просто <a href="https://github.com/dernasherbrezon/r2cloud/commit/ba4550407a352d85134c0a9986e84e6bba184f89" target="_blank">реализовать</a>. Для второго пункта необходимо было провести тестирование, о котором я и хочу написать дальше.</p>

<h2 id="тестирование">Тестирование</h2>

<p>Тестирование заключается в сравнении старого способа (писать данные напрямую на диск) и нового.</p>

<p>Скрипт для запуска старого способа следующий:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">timeout 10m vmstat <span style="color:#ae81ff">1</span> &gt; ~/nogz_vmstat.txt &amp;
timeout 10m rtl_sdr -f <span style="color:#ae81ff">145952432</span> -s <span style="color:#ae81ff">240000</span> -g <span style="color:#ae81ff">45</span> -p <span style="color:#ae81ff">7</span> /tmp/nogz.raw &amp;</code></pre></div>
<p>В результате получаются следующие графики загрузки CPU (us) и диска (wa):</p>

<p><img src="/img/rtlsdr-gzip/2.png" alt="" /></p>

<p>Новый способ запускается следующим образом:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">timeout 10m vmstat <span style="color:#ae81ff">1</span> &gt; ~/gz_vmstat.txt &amp;
timeout 10m rtl_sdr -f <span style="color:#ae81ff">145952432</span> -s <span style="color:#ae81ff">240000</span> -g <span style="color:#ae81ff">45</span> -p <span style="color:#ae81ff">7</span> - | gzip &gt; /tmp/gz.raw.gz &amp;</code></pre></div>
<p>И получается:</p>

<p><img src="/img/rtlsdr-gzip/3.png" alt="" /></p>

<p>На диске при этом:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">pi@raspberrypi:/tmp $ ls -lh
-rw-r--r-- <span style="color:#ae81ff">1</span> pi   pi    47M Apr  <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">21</span>:30 gz.raw.gz
-rw-r--r-- <span style="color:#ae81ff">1</span> pi   pi   275M Apr  <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">21</span>:17 nogz.raw</code></pre></div>
<h2 id="выводы">Выводы</h2>

<ol>
<li>Запись на диск ожидаемо потребляет CPU в районе 10%</li>
<li>Простоя из-за большого потока данных на флэшку меньше при использовании gzip. Тоже ожидаемо</li>
<li>Потребление диска уменьшилось почти в 6 раз!</li>
</ol>

</div>

      	]]>
      </turbo:content>
    </item>
    
    <item turbo="true">
      <title>Производительность rtl_sdr на raspberrypi</title>
      <link>https://dernasherbrezon.com/posts/rtlsdr-perf/</link>
      <pubDate>Sat, 02 Mar 2019 18:22:18 +0100</pubDate>
      
      <guid>https://dernasherbrezon.com/posts/rtlsdr-perf/</guid>
      <description>Очень часто в сети можно встретить гиды по быстрой сборке на коленке анализатора радио с помощью rtl_sdr и raspberrypi. Большинство таких гидов ограничивается достаточно простым описанием: &amp;ldquo;возьмите одно вставьте другое, потом немного питоновских скриптов и у вас всё получится&amp;rdquo;. Для новичков и просто любителей DIY - это прекрасный подход. Можно достаточно быстро познакомится с технологией и увидеть результат. Но что делать если нужно собрать что-то более продвинутое? Что если важна производительность?</description>
      <turbo:content>
      	<![CDATA[
      		<header>
      			<h1>Производительность rtl_sdr на raspberrypi</h1><figure>
				    	<img src="https://dernasherbrezon.com/img/rtlsdr-perf/8.png"/>
				    </figure></header>
      		<div class='container entry-content'>
  

<p>Очень часто в сети можно встретить гиды по быстрой сборке на коленке анализатора радио с помощью rtl_sdr и raspberrypi. Большинство таких гидов ограничивается достаточно простым описанием: &ldquo;возьмите одно вставьте другое, потом немного питоновских скриптов и у вас всё получится&rdquo;. Для новичков и просто любителей DIY - это прекрасный подход. Можно достаточно быстро познакомится с технологией и увидеть результат. Но что делать если нужно собрать что-то более продвинутое? Что если важна производительность? Для этого необходимо провести более серьезные тесты.</p>

<p>Один из таких тестов - производительность системы во время записи сигнала. Дело в том, что есть несколько способов обработки сигнала с rtl_sdr:</p>

<ol>
<li>В реальном времени. Сигнал считывается из rtl_sdr и сразу же демодулируется. Результат либо сохраняется на диск, либо отправляется по сети дальше.</li>

<li><p>В отложенном режиме.</p>

<ul>
<li>предобработки. Сигнял считывается, немного трансформируется и сохраняется на диск. После завершения наблюдения он демодулируется. Например, во время пролёта спутника, сигнал считывается, децимируетс и сохраняется на диск. Обычно это делается для того, чтобы уменьшить размер файла на диске. rtl_sdr поддерживает минимальную ширину 240 КГц. Если ширина сигнала меньше, например, 150 КГц, то имеет смысл уменьшить частоту дискретизации.</li>
<li>сырые данные. Сигнал считывается и напрямую сохраняется в файл. Такой вариант вариант наиболее быстрый, поскольку не требует обработки. С другой стороны он наиболее требовательный к размеру диска.
<br /></li>
</ul></li>
</ol>

<h2 id="описание-теста">Описание теста</h2>

<p>В своём проекте <a href="https://github.com/dernasherbrezon/r2cloud" target="_blank">r2cloud</a> я занимаюсь обработкой телеметрии различных спутников. Поэтому мне интересно было померить поведение системы при обработке сигнала в отложенном режиме. Для этого я провёл несколько тестов:</p>

<ul>
<li>предобработка. В этих тестах я считывал данные из rtl_sdr и делал децимацию с помощью программы <a href="http://sox.sourceforge.net" target="_blank">sox</a>. Передачу данных от одной программы к другой можно сделать через <a href="https://www.gnu.org/software/bash/manual/html_node/Pipelines.html" target="_blank">pipe</a>.

<ul>
<li>pipe сделан в Java. Посколько сама обработка сигнала написана на Java, то и pipe я реализовал на Java. Я создавал sox процесс, затем rtl_sdr процесс, и вручную копировал байти из stdin rtl_sdr в sox. Последний писал результат на диск в файл. Я сделал специальный проект <a href="https://github.com/dernasherbrezon/rtlsdr-pipe-tester" target="_blank">rtlsdr-pipe-tester</a>, чтобы лучше локализовать алгоритм работы.
<br /></li>
</ul></li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">java -jar rtlsdr-pipe-tester-0.0.1-SNAPSHOT-jar-with-dependencies.jar</code></pre></div>
<ul>
<li>pipe сделан в bash. То же самое, только команды запускаются в bash. Для измерения скорости записи на диск использовалась команда <a href="https://linux.die.net/man/1/pv" target="_blank">pv</a>.
<br /></li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">rtl_sdr -f <span style="color:#ae81ff">137900000</span> -s <span style="color:#ae81ff">1440000</span> -g <span style="color:#ae81ff">45</span> -p <span style="color:#ae81ff">0</span> - | pv --numeric --bytes <span style="color:#ae81ff">2</span>&gt;raw.txt | sox --type raw --rate <span style="color:#ae81ff">1440000</span> --encoding unsigned-integer --bits <span style="color:#ae81ff">8</span> --channels <span style="color:#ae81ff">2</span> - /tmp/test.wav rate <span style="color:#ae81ff">150000</span></code></pre></div>
<ul>
<li>сырые данные</li>
<li>raspberrypi 1 и raspberrypi 3. Новая версия имеет большее количество процессоров. Мне хотелось понять, влияет ли количество процессоров на производительность задачи.</li>
<li>использование <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=f7d34b445abc00e979b7cf36b9580ac3d1a47cd8" target="_blank">usbfs zerocopy</a> (появилось в rtl_sdr 0.6.x) и нет. В этом режиме процесс может читать память драйвера напрямую, без копирования через память ядра Linux. В теории это должно уменьшить нагрузку на систему и сделать её более стабильной.</li>
</ul>

<h2 id="raspberrypi-1">RaspberryPI 1</h2>

<p><img src="/img/rtlsdr-perf/1.png" alt="" /></p>

<p>Среднее значение 820 кбайт/сек для bash и 800 кбайт/сек для Java. Это совсем не то, что должно быть. Дело в том, что я запрашиваю 1440000 сэмплов в секунду. Каждый сэмпл содержит в себе I и Q пару по одному байту. Итого мне нужно 2880 кбайт/сек. Похоже сэмплы теряются. Загрузка CPU при этом следующая:</p>

<p><img src="/img/rtlsdr-perf/2.png" alt="" /></p>

<p>На графики видны падения использования CPU. Согласно полной статистике из <a href="https://en.wikipedia.org/wiki/Vmstat" target="_blank">vmstat</a> в это время происходит 100% wa. Система явно не справляется с нагрузкой.</p>

<h2 id="raspberrypi-1-zerocopy">RaspberryPI 1 - zerocopy</h2>

<p><img src="/img/rtlsdr-perf/3.png" alt="" /></p>

<p>Большой разброс в значениях в обработке с помощью bash pipe - на самом деле хороший признак. Это значит, что система успевает обработать данные и периодически сбрасывает наполняет внутренние буфера для копирования. Конечно, можно было бы и лучше - сразу копировать данные, как только они появляются. Тем не менее среднее значение в районе 2880 кбайт/сек, что очень хорошо.</p>

<p>Копирование с помощью Java pipe по-прежнему 800 кбайт/сек, что значит выигрыша zerocopy не даёт.</p>

<p><img src="/img/rtlsdr-perf/4.png" alt="" /></p>

<p>При этом график потребления CPU выглядит достаточно интересным. С одной стороны, видно что потребление при bash pipe снизилось до 35 процентов. С другой стороны, всё равно остались участки, где wa 100 и CPU простаивает. У меня есть подозрение, что нужно оптимизировать запись на диск. Дело в том, что в raspberrypi диск - это флэш карта. Видимо она не справляется с нагрузкой.</p>

<h2 id="raspberrypi-3">RaspberryPI 3</h2>

<p><img src="/img/rtlsdr-perf/5.png" alt="" /></p>

<p>Для RaspberryPi 3 ситуация выглядит получше. Похоже производительность хватает, чтобы обработать 2880 кбайт/сек.</p>

<p><img src="/img/rtlsdr-perf/6.png" alt="" /></p>

<p>Потребление CPU около 19%. Для 4х ядерного процессора RaspberryPi 3 это значит, что одно ядро почти полностью загружено.</p>

<h2 id="raspberrypi-3-zerocopy">RaspberryPI 3 - zerocopy</h2>

<p><img src="/img/rtlsdr-perf/7.png" alt="" /></p>

<p>Скорость обработки более-менее стабильная 2880 кбайт/сек.</p>

<p><img src="/img/rtlsdr-perf/8.png" alt="" /></p>

<p>А вот загрузка CPU достаточно неожиданная. При использовании zerocopy, я бы ожидал, что она уменьшится. В реальности же она осталась неизменной. Возможно операционная система запустила sox на втором ядре. Тогда небольшая загрузка на первом ядре (rtl_sdr) и небольшая нагрузка на втором ядре (sox) в сумме как раз дают около 19% загрузки CPU в сумме.</p>

<h2 id="выводы">Выводы</h2>

<ol>
<li>RaspberryPi 3 значительно мощнее RaspberryPi 1</li>
<li>Использование rtl_sdr 0.6.x c usbfs zerocopy значительно уменьшает нагрузку на систему</li>
</ol>

</div>

      	]]>
      </turbo:content>
    </item>
    
    <item turbo="true">
      <title>Тестирование JSP тэгов</title>
      <link>https://dernasherbrezon.com/posts/jsp-tag-testing/</link>
      <pubDate>Sat, 02 Mar 2019 12:48:18 +0100</pubDate>
      
      <guid>https://dernasherbrezon.com/posts/jsp-tag-testing/</guid>
      <description>Недавно для себя открыл совершенно бесплатный для open source проектов sonarcloud. Я верю, что статичный анализ кода - это очень полезная штука, поэтому сразу же решил перевести свои наиболее популярные проекты туда.
Среди них был достаточно маленький проект jtimeago. Это небольшая библиотека jsp тэгов для вывода дат.
После добавления проекта через travis, я увидел, что jtimeago полностью зеленый.
Если зайти на страницу проекта в sonarcloud, то видно что все показатели хорошие за исключением нескольких мелких code smells.</description>
      <turbo:content>
      	<![CDATA[
      		<header>
      			<h1>Тестирование JSP тэгов</h1><figure>
				    	<img src="https://dernasherbrezon.com/img/jsp-tag-testing/3.png"/>
				    </figure></header>
      		<div class='container entry-content'>
  

<p>Недавно для себя открыл совершенно бесплатный для open source проектов <a href="https://sonarcloud.io/organizations/dernasherbrezon-github/projects" target="_blank">sonarcloud</a>. Я верю, что статичный анализ кода - это очень полезная штука, поэтому сразу же решил перевести свои наиболее популярные проекты туда.</p>

<p>Среди них был достаточно маленький проект <a href="https://github.com/dernasherbrezon/jtimeago" target="_blank">jtimeago</a>. Это небольшая библиотека jsp тэгов для вывода дат.</p>

<p>После добавления проекта через travis, я увидел, что jtimeago полностью зеленый.</p>

<p><img src="/img/jsp-tag-testing/1.png" alt="" /></p>

<p>Если зайти на страницу проекта в sonarcloud, то видно что все показатели хорошие за исключением нескольких мелких code smells. Пофиксить их можно было достаточно тривиально, что я и решил сделать.</p>

<p>Однако, после моего коммита sonarcloud начал выдавать статус &ldquo;Failed&rdquo;.</p>

<p><img src="/img/jsp-tag-testing/2.png" alt="" /></p>

<p>Оказывается в нём есть несколько метрик, которые влияют на финальный статус проекта:</p>

<ul>
<li>количество критичных багов</li>
<li>процент покрытия кода тестами за последние 30 дней</li>
<li>процент дублирующего кода за последние 30 дней</li>
</ul>

<p>После моего героического изменения кода, он стал отображаться как нетестируемый за последние 30 дней. Тут нужно понимать, что код - это несколько классов для JSP. Внутри него есть сильная привязка к servlet api, которую так просто нельзя замокать. Но и оставлять такой простой проект в статусе &ldquo;Quality: Failed&rdquo; мне не позволяла гордость. Я засучил рукава и принялся исследовать.</p>

<p>Сами классы реализуют <code>javax.servlet.jsp.tagext.TagSupport</code>. Это часть спецификации J2EE для создания тэгов в JSP. Надо сказать технология достаточно древняя и во время её проектирования ни о каком юнит тестировании ещё не думали. Исходя из этого я решил поднимать честный web контейнер для каждого теста, рендерить страницу и сравнивать с результатом.</p>

<p>Jetty - это легковесный web контейнер, который полностью реализует спецификацию j2ee. Его удобно запускать в embedded режиме. Так же в самом Jetty проекте есть несколько модулей для тестирования, которые предоставляют достаточно удобные функции. Подключается так:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;dependency&gt;</span>
	<span style="color:#f92672">&lt;groupId&gt;</span>org.eclipse.jetty<span style="color:#f92672">&lt;/groupId&gt;</span>
	<span style="color:#f92672">&lt;artifactId&gt;</span>jetty-http<span style="color:#f92672">&lt;/artifactId&gt;</span>
	<span style="color:#f92672">&lt;version&gt;</span>${jetty.version}<span style="color:#f92672">&lt;/version&gt;</span>
	<span style="color:#f92672">&lt;classifier&gt;</span>tests<span style="color:#f92672">&lt;/classifier&gt;</span>
	<span style="color:#f92672">&lt;scope&gt;</span>test<span style="color:#f92672">&lt;/scope&gt;</span>
<span style="color:#f92672">&lt;/dependency&gt;</span></code></pre></div>
<p>После чего будет доступен класс <code>org.eclipse.jetty.http.HttpTester</code>. С помощью него можно удобно выполнять HTTP запросы и получать ответы:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">HttpTester<span style="color:#f92672">.</span><span style="color:#a6e22e">Request</span> request <span style="color:#f92672">=</span> HttpTester<span style="color:#f92672">.</span><span style="color:#a6e22e">newRequest</span><span style="color:#f92672">();</span>
HttpTester<span style="color:#f92672">.</span><span style="color:#a6e22e">Response</span> response<span style="color:#f92672">;</span>

request<span style="color:#f92672">.</span><span style="color:#a6e22e">setMethod</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;GET&#34;</span><span style="color:#f92672">);</span>
request<span style="color:#f92672">.</span><span style="color:#a6e22e">setVersion</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;HTTP/1.0&#34;</span><span style="color:#f92672">);</span>
request<span style="color:#f92672">.</span><span style="color:#a6e22e">setHeader</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Host&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;tester&#34;</span><span style="color:#f92672">);</span>
request<span style="color:#f92672">.</span><span style="color:#a6e22e">setURI</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/&#34;</span> <span style="color:#f92672">+</span> pageName <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.jsp&#34;</span><span style="color:#f92672">);</span>
response <span style="color:#f92672">=</span> HttpTester<span style="color:#f92672">.</span><span style="color:#a6e22e">parseResponse</span><span style="color:#f92672">(</span>HttpTester<span style="color:#f92672">.</span><span style="color:#a6e22e">from</span><span style="color:#f92672">(</span>localConnector<span style="color:#f92672">.</span><span style="color:#a6e22e">getResponse</span><span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">generate</span><span style="color:#f92672">())));</span></code></pre></div>
<p>Сами тесты достаточно простые. Создаётся jsp страница</p>

<pre><code>&lt;%@page contentType=&quot;text/html; charset=UTF-8&quot; pageEncoding=&quot;UTF-8&quot; trimDirectiveWhitespaces=&quot;true&quot; %&gt;
&lt;%@ taglib prefix=&quot;ta&quot; uri=&quot;https://github.com/dernasherbrezon/jtimeago&quot; %&gt;
&lt;%
	java.util.Date comment = new java.util.Date(1534320716000L);
	pageContext.setAttribute(&quot;comment&quot;, comment);
%&gt;
&lt;ta:formatDate value=&quot;${comment}&quot; var=&quot;outputCommentDate&quot; pattern=&quot;dd MMM yyyy HH:mm&quot; /&gt;
${outputCommentDate}
</code></pre>

<p>Для неё создаётся соответствующий файл проверки результатов:</p>

<pre><code>15 Aug 2018 08:11
</code></pre>

<p>Параметризованный junit тест проходит по всем файлам в директории и выполняет один и тот же код: запросить страницу и сравнить её с ожидаемой. После того, как я написал несколько тестов, оказалось, что у меня есть несколько багов:</p>

<ol>
<li>Если указать аттрибут var и при этом не указывать scope, то JSP вернёт ошибку 502. По умолчанию scope оказывался равен 0, а это неверное значение.</li>
<li>Изначально scope можно было задавать цифрами. Эти цифры достаточно неочевидны и не совместимы с jstl. Поскольку я старался сделать тэг максимально похожим на fmt:formatDate, то и семантику необходимо было сохранить. scope должен задаваться строкой и конвертироваться в цисло.</li>
<li>Геттеры необязательно указывать для аттрибутов тэга.</li>
</ol>

<p>После всех исправлений покрытие тестами улучшилось и проект снова стал зелёным:</p>

<p><img src="/img/jsp-tag-testing/3.png" alt="" /></p>

<p>Несмотря на то, что sonar считает проект зелёным и тэг отрабатывает в настоящем web контейнере как надо, мне не хватает тестов соответствия спецификации. J2EE стандарт достаточно большой с множеством хитрых требований, которые не все полностью реализуют. Например, тэги могут создаваться и кэшироваться на диск. Для этого <code>javax.servlet.jsp.tagext.TagSupport</code> реализует интерфейс <code>java.io.Serializable</code>. J2EE ожидает, что после сериализации кэша тэгов на диск, его можно восстановить и он будет работать. На практике необходимо, чтобы каждый тэг правильно реализовывал <code>java.io.Serializable</code>. Я пока не придумал, как это можно сделать.</p>

<h2 id="выводы">Выводы</h2>

<ol>
<li>Sonarcube достаточно мощный и простой в настройке инструмент. Пользуйтесь им для своих проектов.</li>
<li>Процент покрытия тестами кода - важный параметр.</li>
<li>Даже если в проекте всего 3 класса, то тесты нужны.</li>
</ol>

</div>

      	]]>
      </turbo:content>
    </item>
    
    <item turbo="true">
      <title>Приватный репозиторий в Ubuntu</title>
      <link>https://dernasherbrezon.com/posts/ubuntu-private-repo/</link>
      <pubDate>Thu, 07 Jun 2018 10:07:18 +0100</pubDate>
      
      <guid>https://dernasherbrezon.com/posts/ubuntu-private-repo/</guid>
      <description>В Ubuntu репозитории – это специальные сервера-хранилища для приложений. Если Вы разрабатываете коммерческое приложение и запускаете его в Ubuntu, то логично положить его в репозиторий. А потом управлять этим приложением так же, как и обычными системными приложениями. Для этого нужно поднять в локальной сети или облаке apache, настроить логин и пароль, не забывать его обновлять&amp;hellip;Но что если есть другой способ?
Облачные хранилища С помощью apt-transport-s3 можно превратить bucket в приватный apt репозиторий.</description>
      <turbo:content>
      	<![CDATA[
      		<header>
      			<h1>Приватный репозиторий в Ubuntu</h1><figure>
				    	<img src="https://dernasherbrezon.com/img/ubuntu-private-repo/xxiubje3ios6bvc16lre6dl-vlq.png"/>
				    </figure></header>
      		<div class='container entry-content'>
  

<p>В Ubuntu репозитории – это специальные сервера-хранилища для приложений. Если Вы разрабатываете коммерческое приложение и запускаете его в Ubuntu, то логично положить его в репозиторий. А потом управлять этим приложением так же, как и обычными системными приложениями. Для этого нужно поднять в локальной сети или облаке apache, настроить логин и пароль, не забывать его обновлять&hellip;Но что если есть другой способ?</p>

<h2 id="облачные-хранилища">Облачные хранилища</h2>

<p>С помощью <a href="https://packages.debian.org/sid/apt-transport-s3" target="_blank">apt-transport-s3</a> можно превратить bucket в приватный apt репозиторий. Однако, у этого способа появились следующие недостатки:
- Некоторые адреса Амазона заблокированы в России
- Данные находятся в Европе, поэтому может быть медленно.</p>

<p>Какие же есть альтернативы?</p>

<p>Самой известной считается <a href="https://docs.openstack.org/swift/latest/" target="_blank">Openstack Swift</a>. Swift (OpenStack Object Storage) — это полностью распределенное «безграничное» хранилище, которое характеризуется отказоустойчивостью и высокой надежностью. Создано как конкурент Amazon S3. Его преимущества:
- В России как минимум 2 провайдера предоставляют Swift как сервис: <a href="http://lib.clodo.ru/cloud-storage/cloudstorage.html" target="_blank">Clodo</a> и <a href="https://selectel.ru/services/cloud/storage/" target="_blank">Selectel</a>
- Данные находятся в России
- Если Вы достаточно большие, то можете поднять его у себя
- Все плюсы облачного хранилища: оплата за непосредственно используемые ресурсы, распределенное хранение, отказоустойчивость, <sup>24</sup>&frasl;<sub>7</sub>.</p>

<p>Из недостатков можно выделить лишь полное отсутствие интеграции с Ubuntu. Это сложно назвать недостатком, если Вы программист. Поэтому я написал интеграцию сам: <a href="https://github.com/dernasherbrezon/apt-transport-swift" target="_blank">apt-transport-swift</a>.</p>

<h1 id="разработка">Разработка</h1>

<p>Для начала нужно немного погрузиться в то, как apt взаимодействует в репозиториями. Для того, чтобы получить информацию из репозитория, apt:
- находит соответствующий метод из списка установленных. Все они лежат в папке: /usr/lib/apt/methods/
- отправляет ему необходимые команды согласно протоколу</p>

<p>По умолчанию доступно достаточно много методов: http, ftp, cdrom, file, ssh и тд. Все они работают следующим образом:
- каждый метод - это отдельная программа
- на вход apt отправляет через stdin команды для выполнения
- на выходе через stdout метод должен вернуть результат работы</p>

<p>Команды и ответы передаются в текстовом виде очень похожим на http. Например:</p>

<pre><code>100 Capabilities
Version: 1.2
Pipeline: true
Send-Config: true
</code></pre>

<p>Эту команду отправляет метод, чтобы получить конфигурацию apt.conf:</p>

<pre><code>600 URI Acquire
URI: swift://container/dists/stretch/InRelease
Filename: dists_stretch_InRelease
Expected-SHA1: 123
Last-Modified: Wed, 23 May 2018 14:13:16 GMT
</code></pre>

<p>Эту команду отправляет apt, когда необходимо скачать файл. Когда метод закончил скачивание, он возвращает:</p>

<pre><code>201 URI Done
URI: swift://container/dists/stretch/InRelease
Filename: dists_stretch_InRelease
Expected-SHA1: 123
Size: 762361
Last-Modified: Wed, 23 May 2018 14:13:16 GMT
</code></pre>

<p>Поскольку все методы написаны на C++, я решил тоже написать на C++. После двух недель, мои глаза стали вытекать и я решил начать с чего-нибудь попроще. С. Программа вылядела достаточно простой, но результат не удовлетворял моих высоких стандартов качества. Еще две недели пришлось потратить на изучение утечек памяти, инструментов тестирования и настройки билда в <a href="https://travis-ci.org/dernasherbrezon/apt-transport-swift" target="_blank">Travis</a>.</p>

<h1 id="всё-вместе">Всё вместе</h1>

<p>В результате я получил следующую схему для Java проектов:</p>

<p><img src="/img/ubuntu-private-repo/xxiubje3ios6bvc16lre6dl-vlq.png" alt="" /></p>

<ol>
<li><p>Сброка .deb артефакта с помощью <a href="https://github.com/dernasherbrezon/deb-maven-plugin" target="_blank">deb-maven-plugin</a>. pom.xml:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;plugins&gt;</span>
...
	<span style="color:#f92672">&lt;plugin&gt;</span>
		<span style="color:#f92672">&lt;groupId&gt;</span>com.aerse.maven<span style="color:#f92672">&lt;/groupId&gt;</span>
		<span style="color:#f92672">&lt;artifactId&gt;</span>deb-maven-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
		<span style="color:#f92672">&lt;version&gt;</span>1.4<span style="color:#f92672">&lt;/version&gt;</span>
		<span style="color:#f92672">&lt;executions&gt;</span>
			<span style="color:#f92672">&lt;execution&gt;</span>
				<span style="color:#f92672">&lt;id&gt;</span>package<span style="color:#f92672">&lt;/id&gt;</span>
				<span style="color:#f92672">&lt;phase&gt;</span>package<span style="color:#f92672">&lt;/phase&gt;</span>
				<span style="color:#f92672">&lt;goals&gt;</span>
					<span style="color:#f92672">&lt;goal&gt;</span>package<span style="color:#f92672">&lt;/goal&gt;</span>
				<span style="color:#f92672">&lt;/goals&gt;</span>
			<span style="color:#f92672">&lt;/execution&gt;</span>
		<span style="color:#f92672">&lt;/executions&gt;</span>
		<span style="color:#f92672">&lt;configuration&gt;</span>
			<span style="color:#f92672">&lt;unixUserId&gt;</span>ubuntu<span style="color:#f92672">&lt;/unixUserId&gt;</span>
			<span style="color:#f92672">&lt;unixGroupId&gt;</span>ubuntu<span style="color:#f92672">&lt;/unixGroupId&gt;</span>
			<span style="color:#f92672">&lt;osDependencies&gt;</span>
				<span style="color:#f92672">&lt;openjdk-7-jdk&gt;&lt;/openjdk-7-jdk&gt;</span>
				<span style="color:#f92672">&lt;nginx&gt;&lt;/nginx&gt;</span>
			<span style="color:#f92672">&lt;/osDependencies&gt;</span>
			<span style="color:#f92672">&lt;javaServiceWrapper&gt;</span>true<span style="color:#f92672">&lt;/javaServiceWrapper&gt;</span>
			<span style="color:#f92672">&lt;fileSets&gt;</span>
				<span style="color:#f92672">&lt;fileSet&gt;</span>
					\<span style="color:#f92672">&lt;source&gt;</span>${basedir}/src/main/deb<span style="color:#f92672">&lt;/source&gt;</span>
					<span style="color:#f92672">&lt;target&gt;</span>/<span style="color:#f92672">&lt;/target&gt;</span>
				<span style="color:#f92672">&lt;/fileSet&gt;</span>
			<span style="color:#f92672">&lt;/fileSets&gt;</span>
		<span style="color:#f92672">&lt;/configuration&gt;</span>
	<span style="color:#f92672">&lt;/plugin&gt;</span>
...
<span style="color:#f92672">&lt;/plugins&gt;</span></code></pre></div></li>

<li><p>Дистрибьюция артефакта в apt репозиторий. <a href="https://github.com/dernasherbrezon/apt-maven-plugin" target="_blank">Плагин</a> проинициализирует репозиторий, если он изначально пустой. pom.xml:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;plugins&gt;</span>
...
<span style="color:#f92672">&lt;plugin&gt;</span>
<span style="color:#f92672">&lt;groupId&gt;</span>com.aerse.maven<span style="color:#f92672">&lt;/groupId&gt;</span>
<span style="color:#f92672">&lt;artifactId&gt;</span>apt-maven-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
<span style="color:#f92672">&lt;version&gt;</span>1.9<span style="color:#f92672">&lt;/version&gt;</span>
<span style="color:#f92672">&lt;executions&gt;</span>
  <span style="color:#f92672">&lt;execution&gt;</span>
    <span style="color:#f92672">&lt;id&gt;</span>deploy<span style="color:#f92672">&lt;/id&gt;</span>
    <span style="color:#f92672">&lt;goals&gt;</span>
      <span style="color:#f92672">&lt;goal&gt;</span>deploy<span style="color:#f92672">&lt;/goal&gt;</span>
    <span style="color:#f92672">&lt;/goals&gt;</span>
  <span style="color:#f92672">&lt;/execution&gt;</span>
<span style="color:#f92672">&lt;/executions&gt;</span>
	<span style="color:#f92672">&lt;configuration&gt;</span>
		<span style="color:#f92672">&lt;component&gt;</span>main<span style="color:#f92672">&lt;/component&gt;</span>
		<span style="color:#f92672">&lt;codename&gt;</span>myrepo<span style="color:#f92672">&lt;/codename&gt;</span>
		<span style="color:#f92672">&lt;sign&gt;</span>true<span style="color:#f92672">&lt;/sign&gt;</span>
		<span style="color:#f92672">&lt;keyname&gt;</span>name<span style="color:#f92672">&lt;/keyname&gt;</span>
		<span style="color:#f92672">&lt;passphraseServerId&gt;</span>gpg.passphrase<span style="color:#f92672">&lt;/passphraseServerId&gt;</span>
	<span style="color:#f92672">&lt;/configuration&gt;</span>
<span style="color:#f92672">&lt;/plugin&gt;</span>
...
<span style="color:#f92672">&lt;/plugins&gt;</span></code></pre></div>
<p>settings.xml:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;settings&gt;</span>
...
<span style="color:#f92672">&lt;servers&gt;</span>
...
<span style="color:#f92672">&lt;server&gt;</span>
  <span style="color:#f92672">&lt;id&gt;</span>gpg.passphrase<span style="color:#f92672">&lt;/id&gt;</span>
  <span style="color:#f92672">&lt;passphrase&gt;</span>passphrase<span style="color:#f92672">&lt;/passphrase&gt;</span>
<span style="color:#f92672">&lt;/server&gt;</span>
...
<span style="color:#f92672">&lt;/servers&gt;</span>
...
<span style="color:#f92672">&lt;/settings&gt;</span></code></pre></div></li>

<li><p>В maven есть такое понятие как wagon. Это особая точка расширения, позволяющая добавить новый протокол. С помощью <a href="https://github.com/dernasherbrezon/swift-maven" target="_blank">swift-maven</a> я добавил поддержку протокола swift. pom.xml:</p></li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;project&gt;</span>
  ...
  <span style="color:#f92672">&lt;distributionManagement&gt;</span>
    <span style="color:#f92672">&lt;repository&gt;</span>
      <span style="color:#f92672">&lt;id&gt;</span>private-repo<span style="color:#f92672">&lt;/id&gt;</span>
      <span style="color:#f92672">&lt;url&gt;</span>swift://api.selcdn.ru/v3<span style="color:#f92672">&lt;/url&gt;</span>
    <span style="color:#f92672">&lt;/repository&gt;</span>
  <span style="color:#f92672">&lt;/distributionManagement&gt;</span>
  ...

  <span style="color:#f92672">&lt;build&gt;</span>
    ...
    <span style="color:#f92672">&lt;extensions&gt;</span>
      ...
      <span style="color:#f92672">&lt;extension&gt;</span>
        <span style="color:#f92672">&lt;groupId&gt;</span>com.aerse<span style="color:#f92672">&lt;/groupId&gt;</span>
        <span style="color:#f92672">&lt;artifactId&gt;</span>swift-maven<span style="color:#f92672">&lt;/artifactId&gt;</span>
        <span style="color:#f92672">&lt;version&gt;</span>1.1<span style="color:#f92672">&lt;/version&gt;</span>
      <span style="color:#f92672">&lt;/extension&gt;</span>
      ...
    <span style="color:#f92672">&lt;/extensions&gt;</span>
    ...
  <span style="color:#f92672">&lt;/build&gt;</span>  
<span style="color:#f92672">&lt;/project&gt;</span></code></pre></div>
<p>settings.xml:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;settings&gt;</span>
  ...
  <span style="color:#f92672">&lt;servers&gt;</span>
    ...
    <span style="color:#f92672">&lt;server&gt;</span>
      <span style="color:#f92672">&lt;id&gt;</span>private-repo<span style="color:#f92672">&lt;/id&gt;</span>
      <span style="color:#f92672">&lt;username&gt;</span>username<span style="color:#f92672">&lt;/username&gt;</span>
      <span style="color:#f92672">&lt;password&gt;</span>password<span style="color:#f92672">&lt;/password&gt;</span>
    <span style="color:#f92672">&lt;/server&gt;</span>
    ...
  <span style="color:#f92672">&lt;/servers&gt;</span>
  ...
<span style="color:#f92672">&lt;/settings&gt;</span></code></pre></div>
<ol>
<li>В качестве облачного хранения данных я выбрал <a href="https://selectel.com/?ref_code=9AMKYUS5Md3m" target="_blank">Selectel</a>. Они поддерживают API Swift v3.</li>
<li><a href="https://github.com/dernasherbrezon/apt-transport-swift" target="_blank">apt-transport-swift</a> реализует swift протокол для apt.</li>
</ol>

<pre><code>#: cat /etc/apt/sources.list.d/privaterepo.list

deb swift://container myrepo main
</code></pre>

<p>И конфигурация:</p>

<pre><code>#: cat /etc/apt/apt.conf.d/80privaterepo

Swift {
 Container0 {
   Name &quot;container&quot;;
   URL &quot;https://api.selcdn.ru&quot;;
   Username &quot;username&quot;;
   Password &quot;password&quot;;
 };
};
</code></pre>

<h1 id="результат">Результат</h1>

<p>Хочется отметить, что схема не добавляет никаких новых сущностей в уже существующие инструменты. Всё реализовано в виде плагинов и должно работать независимо друг от друга. Например, с помощью <a href="https://github.com/dernasherbrezon/apt-maven-plugin" target="_blank">apt-maven-plugin</a> можно деплоить в S3.</p>

</div>

      	]]>
      </turbo:content>
    </item>
    
    <item turbo="true">
      <title>DSP на Java</title>
      <link>https://dernasherbrezon.com/posts/dsp-java/</link>
      <pubDate>Thu, 08 Mar 2018 17:22:18 +0100</pubDate>
      
      <guid>https://dernasherbrezon.com/posts/dsp-java/</guid>
      <description>Java - язык программирования общего назначения. Общего назначения - значит можно писать почти любые программы. Вот я и попытался написать программу, которую обычно пишут на С или C++. Под катом я попытаюсь рассказать, как я декодировал спутниковые снимки с Метеор-М №2.
Предисловие Когда я впервые заинтересовался декодированием спутниковых сигналов, то был, прямо говоря, удивлён. Сейчас софт для декодирования сигналов выглядит так же, как и библиотеки общего назначения лет 20 назад.</description>
      <turbo:content>
      	<![CDATA[
      		<header>
      			<h1>DSP на Java</h1><figure>
				    	<img src="https://dernasherbrezon.com/img/dsp-java/evf0t2iu5xcammoaobfgopwewai.png"/>
				    </figure></header>
      		<div class='container entry-content'>
  

<p>Java - язык программирования общего назначения. Общего назначения - значит можно писать почти любые программы. Вот я и попытался написать программу, которую обычно пишут на С или C++. Под катом я попытаюсь рассказать, как я декодировал спутниковые снимки с <a href="https://ru.wikipedia.org/wiki/Метеор-М_№2" target="_blank">Метеор-М №2</a>.</p>

<p><img src="/img/dsp-java/evf0t2iu5xcammoaobfgopwewai.png" alt="DSP in Java" /></p>

<h1 id="предисловие">Предисловие</h1>

<p>Когда я впервые заинтересовался декодированием спутниковых сигналов, то был, прямо говоря, удивлён. Сейчас софт для декодирования сигналов выглядит так же, как и библиотеки общего назначения лет 20 назад. Каждый пишет, что хочет, в каком хочет формате и совершенно не заботится о результатах. Яркий тому пример - декодирование сигнала с Метеор-М. <a href="https://www.rtl-sdr.com/rtl-sdr-tutorial-receiving-meteor-m-n2-lrpt-weather-satellite-images-rtl-sdr/" target="_blank">Обычно</a> алгоритм получения картинки выглядит следующим образом:</p>

<ol>
<li>Записать сигнал</li>
<li>Запустить SDR# с определёнными плагинами и настройками и демодулировать сигнал. На выходе получается бинарный файл.</li>
<li>Запустить LRPToffLineDecoder и на вход передать бинарный файл, полученный ранее.</li>
<li>Из LRPToffLineDecoder сохранить картинку куда-нибудь.</li>
</ol>

<p>Видимо, всех радиолюбителей такой подход устраивал, если за 9 лет существования спутника на орбите, ничего лучше не было придумано. Но для <a href="https://github.com/dernasherbrezon/r2cloud" target="_blank">автоматического</a> получения картинки такой подход не работает:</p>

<ol>
<li>Весь софт работает под Windows</li>
<li>Нельзя запускать в headless режиме. Софт - это формочки с кнопочками.</li>
<li>Невозможно получить обратную связь по приёму сигнала. Нет никаких метрик, по которым можно было бы оценить хорошо или плохо была принята картинка.</li>
</ol>

<p>Из-за этого я забросил вэб формочки кровавого энтепрайза и начал долгое погружение в гремучий мир DSP. На полное декодирование сигнала у меня ушло 2 месяца свободного времени.</p>

<p>Разбор сигнала логически можно представить как две фазы:</p>

<ol>
<li>Демодуляция. Преобразование аудио-сигнала в информацию.</li>
<li>Декодирование. Преобразование информации в понятный пользователю вид.</li>
</ol>

<h1 id="демодуляция">Демодуляция</h1>

<p>Согласно <a href="http://meteor.robonuka.ru/wp-content/uploads/2014/08/pdf_spe_95413_eps_hrpt-lrpt.pdf" target="_blank">официальной документации</a> сигнал модулирован с помощью <a href="https://ru.wikipedia.org/wiki/Фазовая_манипуляция" target="_blank">QPSK</a>. Если в кратце, то для передачи двух бит информации используется одно положение фазы.</p>

<p>Итак, нужно демодулировать QPSK сигнал на Java. То ли никому это неинтересно, то ли Java медленная, но я не нашёл ни одной библиотеки, которые бы это делали. Поэтому я взял <a href="https://github.com/otti-soft/meteor-m2-lrpt" target="_blank">существующий</a> проект демодуляции QPSK сигнала для GNURadio и начал переписывать блоки на Java.</p>

<p><img src="/img/dsp-java/jcsaroyobfqo11zvh3jino1qq7i.png" alt="QPSK demodulation" /></p>

<h2 id="блоки-демодуляции">Блоки демодуляции</h2>

<p><strong>WavFile source</strong> и <strong>Float to Complex</strong>. Чтение из .wav файла <a href="https://ru.wikipedia.org/wiki/Синфазная_и_квадратурная_составляющие_сигнала" target="_blank">IQ</a> сигнала. Значения записаны в файле последовательно. Сначала реальная часть, потом мнимая, потом реальная и так далее. В GNURadio есть свои типы данных и каждый блок рассчин для работы только с определёнными. Так как у нас QPSK модуляция, то нам нужно использовать комплексные числа. Здесь ничего сложного, так как в Java есть поддержка .wav файлов - AudioSystem.getAudioInputStream(inputStream).</p>

<p><strong>Low Pass Filter</strong>. Это первый фильтр, который предназначен для фильтрации низких частот. Так как наш сигнал занимает 130Mhz, то нам надо отфильтровать лишние частоты.</p>

<p><img src="/img/dsp-java/yp4g51xrjxss0v9ho9sqt8rdd4y.png" alt="lowpass" /></p>

<p>На картинке выше, частоты нашего сигнала обведены зелёным. Остальные частоты справа должны быть отфильтрованы. Это делается с помощью <a href="https://ru.wikipedia.org/wiki/Фильтр_с_конечной_импульсной_характеристикой" target="_blank">КИХ-фильтра</a>. Для программиста это выглядит как:</p>

<ol>
<li>Взять последние N значений, текущее и положить в массив</li>
<li>Перемножить получившийся массив с заранее заданным (вычисляется из ЛАФЧХ фильтра). По сути, перемножение одного вектора на другой.</li>
<li>Все значения результирующего массива сложить.</li>
<li>Это и будет результат.</li>
</ol>

<p><strong><a href="https://ru.wikipedia.org/wiki/Автоматическая_регулировка_усиления" target="_blank">AGC</a></strong>. Автоматическая регулировка усиления.</p>

<p><img src="/img/dsp-java/hcpmhaclhse8f7-ye05iml_sjvi.png" alt="agc" /></p>

<p>С точки зрения реализации - перемножение входного сигнала на некий уровень и вычисление следующего уровня в зависимости от текущего.</p>

<p><strong><a href="https://en.wikipedia.org/wiki/Root-raised-cosine_filter" target="_blank">Root Raised Cosine Filter</a></strong>. Используется для уменьшения <a href="https://en.wikipedia.org/wiki/Intersymbol_interference" target="_blank">Intersymbol interference</a>. Если вкратце, то при получении сигнала одни уровни переданного сигнала могут накладываться на последующие. Чтобы выделить максимальный уровень сигнала между символами, применяют этот фильтр. Работает так же как и Low Pass Filter, но использует другую <a href="https://ru.wikipedia.org/wiki/Логарифмическая_амплитудно-фазовая_частотная_характеристика#ЛАЧХ_2" target="_blank">ЛАФЧХ</a></p>

<p><img src="/img/dsp-java/42kvsx8xtrx3k14qehe1jziunde.png" alt="rrcf" /></p>

<p><strong><a href="https://ru.wikipedia.org/wiki/Фазовая_автоподстройка_частоты" target="_blank">Costas Loop</a></strong> - это алгоритм фазовой подстройки частоты. Для чего он нужен? Например, для того, чтобы корректировать доплеровское смещение частоты. Так как, мы точно знаем, что фаза у нас скачет по четырём уровням, то можно сравнивать значение двух разных фаз. Если оно отличается на дельта, то корректировать частоту. Это ярче всего видно на картинках внизу.</p>

<p><img src="/img/dsp-java/it-g9hju18tmhnqq0twuj2qizja.png" alt="before costas loop" /></p>

<p>До коррекции частоты, у нас круг (почти). Это значит, что частота немного меняется каждый раз, и точки фазы не попадают в одно и то же место.</p>

<p><img src="/img/dsp-java/um77gdjsnwyirvj1joikwgb8qk4.png" alt="after costas loop" /></p>

<p>Здесь уже значительно лучше - видны 4 отчётливые точки фазы.</p>

<p><strong><a href="https://www.tablix.org/~avian/blog/archives/2015/03/notes_on_m_m_clock_recovery/" target="_blank">Clock recovery MM</a></strong>. Этот блок пытается восстановить шаг часов передатчика и отбрасывает все сэмплы, которые не относятся к изменению уровня. Примерная схема работы изображена ниже:</p>

<p><img src="/img/dsp-java/n1i8mli4sagj4lh-qc_6wif7kjw.jpg" alt="clock recovery in a nutshell" /></p>

<p>После того, как все лишние сэмплы выкинуты, получается хорошее QPSK созвездие.</p>

<p><img src="/img/dsp-java/cxrwwpey0e-solb-mig03ua1dvs.png" alt="clock recovery" /></p>

<p><strong>Constellation Soft Decoder</strong>. Этот блок преобразует координаты в вероятность битов. Тут надо остановится поподробнее, так это очень важно в дальнейшем. Допустим все точки у которых координаты положительные будут отображаться в пару &ldquo;00&rdquo;.</p>

<p><img src="/img/dsp-java/s3bddzcvb9z7te0u7y2hjhyt6ua.png" alt="initial" /></p>

<p>Теперь допустим, что мы получили значение в красной точке.</p>

<p><img src="/img/dsp-java/nerub3aklfpmzkksbtdbyo0ik90.png" alt="hard decision" /></p>

<p>Если мы будем делать жёсткое решение, то координаты красной точки мы преобразуем в пару &ldquo;00&rdquo;. При этом мы потеряем информацию о том, что точка-то почти &ldquo;01&rdquo; (в нижним квадранте). А эта информация на самом деле может помочь в декодировании. Есть алгоритмы, которые дают лучшие результаты, если передать эту информацию. Поэтому вместо того, чтобы принимать жёсткое решение, надо посчитать вероятность 0 и вероятность 1. Например 100% вероятность нахождения в правом верхнем квадранте будет 255,255. Использование мягких решений увеличивает поток данных в 8 раз, зато даёт более лучшие результаты при декодировании сигнала. Для того, чтобы посчитать мягкое решение, необходимо рассчитать расстояние между текущей точкой и каждой из точек созвездия.</p>

<p><strong>Rail</strong>, <strong>Float to char</strong>, <strong>File sink</strong>. Эти блоки немного преобразуют результаты и записывают их в файл. Для моего декодера записывать результаты в промежуточный файл не надо. Но в целях отладки было крайне полезно сначала демодулировать сигнал из Java, а затем посмотреть может ли LRPToffLineDecoder извлечь картинку.</p>

<h1 id="декодирование">Декодирование</h1>

<p>Итак, у нас есть поток 0 и 1 из которого нужно получить картинку. Для начала необходимо открыть <a href="http://planet.iitp.ru/spacecraft/meteor_m_n2_structure_2.pdf" target="_blank">официальную документацию</a>, где неплохо описана структура пакетов. Некоторые моменты там были опущены, поэтому я открыл еще <a href="http://meteor.robonuka.ru/wp-content/uploads/2014/08/pdf_spe_95413_eps_hrpt-lrpt.pdf" target="_blank">более официальную документацию</a>.</p>

<p>Декодирование состоит из следующих этапов:</p>

<ul>
<li>поиск в потоке бит синхромаркера. Каждый пакет начинается с него.</li>
<li>после того, как синхромаркер был найден, декодировать следующие 16384 бита алгоритмом Витерби</li>
<li>результат подвергнуть скрэмблированию, после чего</li>
<li>применить коды рида соломона и извлечь данные транспортного кадра</li>
<li>из последовательности транспортных кадров извлечь последовательность парциальных пакетов. Для тех, кто изучал <a href="https://ru.wikipedia.org/wiki/Сетевая_модель_OSI" target="_blank">модель OSI</a> вопросов быть не должно.</li>
<li>из парциальных пакетов извлечь MCU формата JPEG</li>
<li>декодировать пикселы JPEG, используя коды Хаффмана и Run-length coding</li>
<li>правильно заполнить пикселами картинку с учётом пропущенных пакетов</li>
<li>наложить 3 канала друг на друга с учётом пропущенных пакетов</li>
</ul>

<p>Пожалуй я не буду здесь рассказывать про каждый из алгоритмов. Они сами по себе потянут на отдельную статью. Хочу лишь выложить результаты работы <a href="https://github.com/dernasherbrezon/jradio" target="_blank">моей программы</a>, <a href="http://meteor.robonuka.ru/for-experts/soft/" target="_blank">официальной</a> и <a href="https://github.com/artlav/meteor_decoder" target="_blank">на паскале</a>.</p>

<p><img src="/img/dsp-java/gjnitpweqxobjmifktc5mli_ehu.jpg" alt="compare" /></p>

<p>К сожалению общая картина занимает 4500x2800px, поэтому я привожу сильно пожатую версию.</p>

<h1 id="оптимизации">Оптимизации</h1>

<p>А при чём тут Java? - скажут самые стойкие, кто смог дочитать до сюда.</p>

<p>Сейчас будет немного Java. Дело в том, что оптимизацию имеет смысл для корректно работающей программы. После каждого шага оптимизации можно запустить тесты и убедиться, что всё по прежнему работает корректно.</p>

<p>Итак, я начну с декодирования. При запуске <a href="https://www.yourkit.com/java/profiler/features/" target="_blank">профайлера</a>, ничего странного не обнаружилось:</p>

<ul>
<li>одно ядро работает на полную мощность</li>
<li>самый горячий метод - это <a href="https://ru.wikipedia.org/wiki/Алгоритм_Витерби" target="_blank">декодирование Витерби</a>. Сложность этого алгоритма О(T*S), где T - это длина массива данных, S - пространство состояний. В нашем случае у нас 8 (бит) * 4 (00,01,10,11) = 32.</li>
</ul>

<p>Помимо CPU, я запустил еще анализ аллокаций объектов. Оказывается, этот метод создаёт миллионы короткоживущих объектов. Они создают лишнюю нагрузку на GC и процессор. Посмотрим, можно ли это оптимизировать. Наивная реализация создаёт связный список для хранения решений каждого входящего бита:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">	LinkedList<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">long</span><span style="color:#f92672">[]&gt;</span> decisions <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LinkedList<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">long</span><span style="color:#f92672">[]&gt;();</span>
	<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> data<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span> i <span style="color:#f92672">+=</span> 2<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		<span style="color:#66d9ef">long</span><span style="color:#f92672">[]</span> d <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">long</span><span style="color:#f92672">[</span>2<span style="color:#f92672">];</span> <span style="color:#75715e">//decision
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> b <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> b <span style="color:#f92672">&lt;</span> 32<span style="color:#f92672">;</span> b<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
			d<span style="color:#f92672">[</span>b <span style="color:#f92672">/</span> 16<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">...;</span>
		<span style="color:#f92672">}</span>
		<span style="color:#f92672">...</span>
		decisions<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>d<span style="color:#f92672">);</span>
	<span style="color:#f92672">}</span></code></pre></div>
<p>Это можно попробовать развернуть в одномерный массив и обращаться к результатам хитро вычисляя индекс. Например так:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">	<span style="color:#66d9ef">long</span><span style="color:#f92672">[]</span> decisions <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">long</span><span style="color:#f92672">[</span>data<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">];</span>
	<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> data<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span> i <span style="color:#f92672">+=</span> 2<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		decisions<span style="color:#f92672">[</span>i <span style="color:#f92672">+</span> b <span style="color:#f92672">/</span> 16<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">...;</span>
	<span style="color:#f92672">}</span></code></pre></div>
<p>В итоге, на одно декодирование создаётся один объект - массив decisions. ViterbiSoft можно ещё дальше оптимизировать. Например, зная то, что размер массива всегда одинаковый, создать long[] decisions в конструкторе и переиспользовать.</p>

<p>Ещё одним проблемным местом оказался класс FixedLengthTagger. Этот класс содержит скользящее окно. Оно работает следующим образом:</p>

<ul>
<li>новый байт читается из источника</li>
<li>записывается в конец окна</li>
<li>если размер окна больше размера пакета, то удалить байт из начала окна</li>
</ul>

<p>Наивная реализация использовала LinkedList<Byte> и алгоритм движения окна был такой:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">	window<span style="color:#f92672">.</span><span style="color:#a6e22e">offerLast</span><span style="color:#f92672">(</span>curByte<span style="color:#f92672">);</span>
	<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>window<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> packet_len<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		window<span style="color:#f92672">.</span><span style="color:#a6e22e">removeFirst</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span></code></pre></div>
<p>На самом деле это очень накладная операция, так как на каждую операцию offerLast внутри LinkedList создаётся объект Node. Он будет содержать наш байт и иметь ссылки на следующий элемент списка и предыдущий. Однако, зная, что размер нашего окна фиксированный, его можно заменить на циклический массив:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">	window<span style="color:#f92672">[</span>windowIndex<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> curByte<span style="color:#f92672">;</span>
	windowIndex<span style="color:#f92672">++;</span>
	<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>windowIndex <span style="color:#f92672">&gt;=</span> window<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		windowIndex <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
	<span style="color:#f92672">}</span></code></pre></div>
<p>Для того, чтобы правильно взять его содержимое надо скопировать данные до текущего указателя первыми и после текущего указателя последними. Как то так:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">	<span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> packet<span style="color:#f92672">;</span>
	System<span style="color:#f92672">.</span><span style="color:#a6e22e">arraycopy</span><span style="color:#f92672">(</span>window<span style="color:#f92672">,</span> windowIndex<span style="color:#f92672">,</span> packet<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> window<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> windowIndex<span style="color:#f92672">);</span>
	System<span style="color:#f92672">.</span><span style="color:#a6e22e">arraycopy</span><span style="color:#f92672">(</span>window<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> packet<span style="color:#f92672">,</span> window<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> windowIndex<span style="color:#f92672">,</span> windowIndex<span style="color:#f92672">);</span></code></pre></div>
<p>Эти две оптимизации позволили уменьшить время декодирования файла с 4 минут до 20 секунд. Для сравнения LRPToffLineDecoder делает это за 40 секунд.</p>

<p>Декодирование можно ещё немного оптимизировать, но в ущерб читаемости. Вместо этого можно попробовать ускорить демодуляцию.</p>

<p>Алгоритмы демодуляции на входе получают большой поток данных, а на выходе выдают сравнительно небольшой. Поэтому эти алгоритмы очень чувствительны к различным оптимизациям. При запуске профайлера, видно, что большая часть приходится именно на математические операции внутри блоков.</p>

<p><img src="/img/dsp-java/aeenpwb8z_nfkpg8w8pfl6iqsuo.png" alt="profiling demodulation" /></p>

<p>Тут мало что можно сделать: память не выделяется, безумных циклов нет. Единственное что интересно проверить это компилирует ли Java JIT код в <a href="https://ru.wikipedia.org/wiki/SIMD" target="_blank">SIMD</a> инструкции. Если вкратце, то это специальные инструкции процессора, которые работают с 128битными регистрами и обрабатывают их одной командой. Схематично это выглядит так:</p>

<p><img src="/img/dsp-java/l7ng0x8bwn8-z4fe1001iwsj9gq.png" alt="simd" /></p>

<p>Как видно, такие инструкции идеально ложаться на КИХ-фильтры. GNURadio использует библиотеку VOLK, которая в зависимости от поддерживаемой архитектуры, может использовать SIMD инструкции. В Java скорей всего вызывать JNI обёртку будет значительно затратнее, чем выигрыш от использования таких инструкций. Одна надежда на JIT, который может съоптимизировать перемножение одного массива на другой. Чтобы это проверить, необходимо запустить JVM с опцией &ldquo;-XX:CompileCommand=print,*FIRFilter.filterComplex&rdquo;. Она заставит JVM выводить ассемблерный код для метода filterComplex из класса FIRFilter.</p>

<p>Вот что у меня получилось при запуске с Oracle JDK 1.8.0_161 на MacBook Air:</p>

<blockquote>
<p>0x0000000115994750: vmovss 0x10(%r10,%r11,4),%xmm1
  0x0000000115994757: vmulss 0x10(%rcx,%r11,4),%xmm1,%xmm4
  0x000000011599475e: vmulss 0x10(%r8,%r11,4),%xmm1,%xmm1
  0x0000000115994765: vaddss %xmm2,%xmm4,%xmm3
  0x0000000115994769: vaddss %xmm0,%xmm1,%xmm0
  0x000000011599476d: movslq %r11d,%r9
  0x0000000115994770: vmovss 0x1c(%r10,%r9,4),%xmm2
  0x0000000115994777: vmulss 0x1c(%rcx,%r9,4),%xmm2,%xmm8
  0x000000011599477e: vmulss 0x1c(%r8,%r9,4),%xmm2,%xmm1
  0x0000000115994785: vmovss 0x14(%r10,%r9,4),%xmm4
  0x000000011599478c: vmulss 0x14(%rcx,%r9,4),%xmm4,%xmm2
  0x0000000115994793: vmulss 0x14(%r8,%r9,4),%xmm4,%xmm5
  0x000000011599479a: vmovss 0x18(%r10,%r9,4),%xmm4  ;*faload
                                                ; - ru.r2cloud.jradio.blocks.FIRFilter::filterComplex@24 (line 26)</p>
</blockquote>

<p>Судя по всему SIMD инструкции не используются.</p>

<p>Ещё одним интересным местом стало вычисление sincos. Блок Costasloop вычисляет значение синуса и косинуса для одного и того же угла (фазы) для каждого входящего значения. В CPU есть специальная команда - fsincos. Она вычисляет одновременно синус и косинус угла. Однако, в Java такой функции нет. Да и реализовывать её непонятно как: надо либо возвращать double[] (а это сильно ударит по GC), либо возвращать одно значение как результат работы функции, а другое через изменяемый параметр (double в функцию Java передаётся копированием, а Double опять же ударит по GC). Наивная же имплементация выглядит так:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">	<span style="color:#66d9ef">float</span> sinImg <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">float</span><span style="color:#f92672">)</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">sin</span><span style="color:#f92672">(-</span>d_phase<span style="color:#f92672">);</span>
	<span style="color:#66d9ef">float</span> cosReal <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">float</span><span style="color:#f92672">)</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">cos</span><span style="color:#f92672">(-</span>d_phase<span style="color:#f92672">);</span></code></pre></div>
<p>Можно попробовать вспомнить тригонометрию и заменить на:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">	<span style="color:#66d9ef">float</span> sinImg <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">float</span><span style="color:#f92672">)</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">sin</span><span style="color:#f92672">(-</span>d_phase<span style="color:#f92672">);</span>
	<span style="color:#66d9ef">float</span> cosReal <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">float</span><span style="color:#f92672">)</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">sqrt</span><span style="color:#f92672">(</span>1 <span style="color:#f92672">-</span> sinImg <span style="color:#f92672">*</span> sinImg<span style="color:#f92672">)</span> <span style="color:#f92672">+</span> calculate sign<span style="color:#f92672">;</span></code></pre></div>
<p>Переход с Math.cos на Math.sqrt позволил сократить время демодуляции с 6 минут до 5 минут и 30 секунд. Тригонометрические операции можно ещё больше ускорить, если использовать <a href="https://ru.wikipedia.org/wiki/Таблица_поиска" target="_blank">таблицы поиска</a>. Однако, я пока не готов исследовать зависимость результатов декодирования от точности таблиц. Может быть кто-нибудь поможет с этим?</p>

<h1 id="заключение">Заключение</h1>

<p>Поскольку я использовал одни и те же блоки для демодуляции сигнала, то можно сравнить время работы Java программы и GNURadio. Как и ожидалось, GNURadio быстрее: ~2 минуты против 5.5 минут. Да, Java почти в 2 раза медленее. Но, если учесть, что файл записывался в течении 15 минут, то производительности Java вполне хватит, чтобы в реальном времени демодулировать сигнал.</p>

</div>

      	]]>
      </turbo:content>
    </item>
    
    <item turbo="true">
      <title>Тестирование debian пакетов в Travis-CI</title>
      <link>https://dernasherbrezon.com/posts/test-deb-travis/</link>
      <pubDate>Sat, 04 Nov 2017 13:51:18 +0100</pubDate>
      
      <guid>https://dernasherbrezon.com/posts/test-deb-travis/</guid>
      <description>Возникла передо мной такая задача: тестирование debian пакета. И требования:
 пакет устанавливает и стартует systemd сервис. используются native armhf библиотеки  Тестирование должно включать в себя:
 установка пакета на чистую систему: проверка наличия зависимостей запуск: проверка зависимостей в рантайме тестирование запущенного приложения: проверка prod конфигурации  Введение Как обычно, первым делом необходимо оглядеться по сторонам и поискать уже существующие решения и подходы. Системе Debian уже 20+ лет и я не должен быть первым, кому пришло в голову тестирование пакетов.</description>
      <turbo:content>
      	<![CDATA[
      		<header>
      			<h1>Тестирование debian пакетов в Travis-CI</h1><figure>
				    	<img src="https://dernasherbrezon.com/img/test-deb-travis/1tonmhzpsbqtt5yqf6sxnpumnk8.png"/>
				    </figure></header>
      		<div class='container entry-content'>
  

<p>Возникла передо мной такая задача: тестирование debian пакета. И требования:</p>

<ul>
<li>пакет устанавливает и стартует systemd сервис.</li>
<li>используются native armhf библиотеки</li>
</ul>

<p>Тестирование должно включать в себя:</p>

<ul>
<li>установка пакета на чистую систему: проверка наличия зависимостей</li>
<li>запуск: проверка зависимостей в рантайме</li>
<li>тестирование запущенного приложения: проверка prod конфигурации</li>
</ul>

<p><img src="/img/test-deb-travis/1tonmhzpsbqtt5yqf6sxnpumnk8.png" alt="" /></p>

<h2 id="введение">Введение</h2>

<p>Как обычно, первым делом необходимо оглядеться по сторонам и поискать уже существующие решения и подходы. Системе Debian уже 20+ лет и я не должен быть первым, кому пришло в голову тестирование пакетов. Поэтому я провел небольшое исследование экосистемы и получил следующее:</p>

<p><img src="/img/test-deb-travis/rw9hiwy9lgzw4oxcgijh85_qvnw.png" alt="" /></p>

<h2 id="autopkgtest">autopkgtest</h2>

<p>Итак, в центре тестирования любого debian пакета находится autopkgtest. Это по сути набор правил для сборки и набор скриптов для запуска тестов. Более детально о том, как писать такие тесты и конфигурировать сборку пакетов можно почитать в <a href="http://packaging.ubuntu.com/ru/html/auto-pkg-test.html" target="_blank">официальной документации</a>.</p>

<h2 id="debci">debci</h2>

<p><img src="/img/test-deb-travis/soiwyhiobqzphzpiagvplg9ryfo.png" alt="" /></p>

<p><a href="https://github.com/terceiro/debci" target="_blank">debci</a>  - это <a href="https://ci.debian.net" target="_blank">официальная</a> система для тестирования пакетов. Используется самим сообществом debian для continuous integration релизов. Представляет собой набор сервисов, которые общаются между собой через rabbitmq:</p>

<ul>
<li>debci-enqueue - добавление пакета в очередь на тестирование</li>
<li>debci-worker - запуск autopkgtest на конкретной машине</li>
<li>debci-collector - сбор результатов запуска и генерация статичного html</li>
</ul>

<p>Идеально подходит для моей задачи, поэтому я решил глубоко разобраться с системой и настроить. Наибольшую сложность доставила настройка debci-worker:</p>

<ul>
<li>по умолчанию он запускает autopkgtest-virt-lxc, который запускает lxc контейнер, которому нужен настроенный lvm.</li>
<li>логов работы нет</li>
<li>документации почти нет</li>
</ul>

<p>Методом проб и ошибок я поднял debci и понял следующее:</p>

<ol>
<li>никакой это не continuous integration. В моём понимании CI должен не только постоянно интегрировать пакет в систему, но и не пропускать ошибки интеграции в прод. В настоящий момент debci попросту показывает ошибку. Пакет как был в репозитории, так и останется там. Таким образом, если хочется большей автоматизации (а для проекта с одним разработчиком это важно), то необходимо настроить такую схему:

<ul>
<li>CI собирает пакет и кладёт его в dev/unstable apt репозиторий</li>
<li>CI дёргает debci, чтобы тот его протестировал</li>
<li>debci запускает тестирование</li>
<li>если тест прошел, то debci должен дёргать какой-то внешний скрипт, который</li>
<li>перекладывает успешно протестированный пакет из dev/unstable в stable apt репозиторий
Подобной интеграции сейчас просто нет, поэтому придется её писать.</li>
</ul></li>
<li>debci должен работать на отдельно выделенном сервере. Добавить собственный проект в уже работающий <a href="https://ci.debian.net" target="_blank">https://ci.debian.net</a> нельзя. Там тестируются только пакеты из официального репозитория. Сервер должен быть на armhf. Найти облачный хостинг с такими серверами непросто, но у меня <a href="https://www.scaleway.com" target="_blank">получилось</a>.</li>
<li>Зачем rabbitmq?</li>
<li>Баги в настройке LXC и LVM. К слову в <a href="https://github.com/terceiro/debci/tree/master/docs" target="_blank">офциальной документации</a> ничего про LVM не сказано.</li>
</ol>

<h2 id="travis-debian-net">travis.debian.net</h2>

<p>Представляет собой скрипт для <a href="http://travis-ci.org/" target="_blank">travis-ci</a>, который создаёт docker образ, который внутри себя запускает сборку проекта и autopkgtest. Из положительных моментов:</p>

<ul>
<li>не нужен хостинг. travis-ci может абсолютно бесплатно собирать ваши приложения.</li>
<li>запускает autopkgtest</li>
</ul>

<p>Чего не хватает:</p>

<ul>
<li>пропуск стадии сборки пакета. Мой пакет собирается с помощью <a href="https://github.com/dernasherbrezon/deb-maven-plugin" target="_blank">maven</a> и структура никак не похожа на стандартную.</li>
<li>тестирование systemd сервиса.</li>
</ul>

<h2 id="своё">Своё</h2>

<p>Итак, всё-таки ничего не подошло. В принципе, после достаточно продолжительного исследования, уже становится понятно, что нужно:</p>

<ul>
<li>сборка на travis-ci</li>
<li>собственный docker образ, в котором</li>
<li>устанавливается пакет</li>
<li>запускается интеграционный тест, который</li>
<li>выполняет интеграционные тесты напротив работающего приложения</li>
</ul>

<p>Мне <a href="https://travis-ci.org/dernasherbrezon/r2cloud/builds/296993677" target="_blank">удалось</a> собрать такую конфигурацию. Но дьявол, как обычно, в деталях, поэтому я приведу здесь наиболее яркие wtf:</p>

<ol>
<li>Вы знали, что разработчики systemd и docker друг друга ненавидят? У них что-то вроде архитектурного коллапса. Одни хотят легковесности, а другие говорят, что <a href="https://blog.phusion.nl/2015/01/20/docker-and-the-pid-1-zombie-reaping-problem/" target="_blank">PID 1 проблему</a> таки надо решать. Страдают, конечно, при этом простые пользователи. &ldquo;Нельзя просто взять и запустить systemd в docker&rdquo; &copy;. Есть правда восхитительная компания <a href="https://resin.io" target="_blank">resin</a>, которая очень много сделала, чтобы <a href="https://docs.resin.io/runtime/resin-base-images/" target="_blank">помочь</a>.</li>
<li>Билд машины travis-ci работают на архитектуре intel. Нужно хитро подключить qemu и надеяться, что проблема решена.</li>
<li>При запуске resin-based контейнера, ваша команда запускается как ещё один systemd сервис (сам systemd запускается как pid 1). Команда может запустить systemd сервис, который будет тестировать, nginx, выполнить тесты, но не сможет убить systemd и завершить работу docker контейнера. Из-за этого необходимо сначала запускать контейнер в detached режиме, а выполнять тесты в работающем контейнере через docker exec. Как только последняя команда в travis.yaml выполнится, то travis сможет завершить билд с работающим контейнером.</li>
</ol>

</div>

      	]]>
      </turbo:content>
    </item>
    
    <item turbo="true">
      <title>Управление сертификатами с помощью протокола ACME</title>
      <link>https://dernasherbrezon.com/posts/java-acme/</link>
      <pubDate>Sun, 10 Sep 2017 16:45:18 +0100</pubDate>
      
      <guid>https://dernasherbrezon.com/posts/java-acme/</guid>
      <description>Возникла передо мной такая задача: автоматический выпуск сертификатов для Web приложения. И требования: - CA должны доверять все браузеры т.е. самоподписанные сертификаты не подходят; - желательно бесплатно; - Выпуск надо делать программно с помощью Java Embedded compact1 profile. Это всё по следам Java и без 16Gb памяти?.
Наверное многие уже слышали про бесплатные сертификаты от LetsEncrypt и certbot. А можно ли certbot заменить Java?
ACME Многие, конечно, любят LetsEncrypt за бесплатные сертификаты, которые, фактически, позволят перевести весь вэб на https.</description>
      <turbo:content>
      	<![CDATA[
      		<header>
      			<h1>Управление сертификатами с помощью протокола ACME</h1><figure>
				    	<img src="https://dernasherbrezon.com/img/java-acme/67f139f59aff4f0d82e4ae0b3c0d1e64.png"/>
				    </figure></header>
      		<div class='container entry-content'>
  

<p>Возникла передо мной такая задача: автоматический выпуск сертификатов для Web приложения. И требования:
- CA должны доверять все браузеры т.е. самоподписанные сертификаты не подходят;
- желательно бесплатно;
- Выпуск надо делать программно с помощью Java Embedded compact1 profile. Это всё по следам <a href="https://dernasherbrezon.com/posts/java-small-heap/" target="_blank">Java и без 16Gb памяти?</a>.</p>

<p>Наверное многие уже слышали про бесплатные сертификаты от <a href="https://letsencrypt.org" target="_blank">LetsEncrypt</a> и certbot. А можно ли certbot заменить Java?</p>

<p><img src="/img/java-acme/67f139f59aff4f0d82e4ae0b3c0d1e64.png" alt="" /></p>

<h1 id="acme">ACME</h1>

<p>Многие, конечно, любят LetsEncrypt за бесплатные сертификаты, которые, фактически, позволят перевести весь вэб на https. Но не многие знают, что для этого они придумали специальный протокол - ACME. И для меня он по значимости чуть ли не выше самих бесплатных сертификатов.</p>

<p>Основные особенности протокола:</p>

<ul>
<li>Описывает взаимодействие клиента и REST сервера;</li>
<li>Есть поддержка как платных сертификатов, так и бесплатных;</li>
<li>Несколько способов авторизации владения доменом;</li>
<li>Внесен на принятие в IETF. Сейчас находится в состоянии <a href="https://tools.ietf.org/html/draft-ietf-acme-acme-06" target="_blank">draft</a>;</li>
<li>Все сообщения передаются в формате <a href="https://tools.ietf.org/html/rfc7519" target="_blank">JSON Web Token</a>.</li>
</ul>

<p>Для тех, кому интересны детали и все возможные варианты взаимодействия, можно почитать <a href="https://tools.ietf.org/html/draft-ietf-acme-acme-06" target="_blank">официальную документацию</a>. Она действительно простая и легко читается в отличии от наших гостов. Здесь же я приведу диаграмму последовательности при выдаче сертификата, которую нужно представлять, если Вы решили интегрироваться.</p>

<p><img src="/img/java-acme/f00f2eb1b57a414b8443304b7b01de3b.png" alt="" /></p>

<h1 id="использование">Использование</h1>

<p>На официальном сайте LetsEncrypt есть <a href="https://letsencrypt.org/docs/client-options/" target="_blank">множество клиентов</a> работающих по протоколу ACME. Я взял <a href="https://github.com/shred/acme4j" target="_blank">acme4j</a>. Эта библиотека достаточно компактная и работает в compact1 profile!</p>

<p>У неё есть вполне рабочий <a href="https://github.com/shred/acme4j/blob/master/acme4j-example/src/main/java/org/shredzone/acme4j/ClientTest.java" target="_blank">пример использования</a>, с помощью которого я смог выпустить себе сертификат. Для того, чтобы интегрировать библиотеку достаточно с минимальными изменениями скопировать этот код.</p>

<p>Для продления сертификата необходимо авторизоваться, взять уже готовый CSR и <a href="https://shredzone.org/maven/acme4j/usage/certificate.html" target="_blank">отправить его в CA</a>. После чего скачать новый сертификат.</p>

<p>Единственная проблема, которая у меня возникла - это подкладывание сертификата в nginx. Поясню на примере:</p>

<ul>
<li>приложение стартует в первый раз;</li>
<li>nginx стартует. Поскольку приложение стартует в первый раз, то сертификата ещё нет, и nginx слушает на 80 порту;</li>
<li>пользователь заходит в приложение, соглашается с правилами использования сертификатов LetsEncrypt и нажимает кнопку &ldquo;выдать сертификат&rdquo;;</li>
<li>сертификат скачивается.</li>
</ul>

<p>И вот тут проблема: для того чтобы включить 443 порт с новым сертификатом, nginx должен перезачитать конфигурацию. Но чтобы это сделать нужен root. Запускать приложение из под root - плохая идея. Запускать nginx из под пользователя тоже - нельзя будет слушать 80 и 443 порты.</p>

<p>Я добавил правило для пользователя в sudoers, чтобы можно было делать <code>sudo nginx -s reload</code>. Но это выглядит как костыль. Может кто-нибудь знает как это сделать красивее?</p>

<h1 id="итого">Итого</h1>

<p>Получение сертификата в автоматическом режиме оказалось достаточно простой процедурой. А если использовать ACME сервер <a href="https://github.com/letsencrypt/boulder" target="_blank">boulder</a>, то можно даже развернуть такую схему у себя в большой организации! Если у вас есть собственный CA для внутренних сервисов, то ACME должен сильно упростить работу с сертификатами.</p>

</div>

      	]]>
      </turbo:content>
    </item>
    
    <item turbo="true">
      <title>Мониторинг Raspberry PI</title>
      <link>https://dernasherbrezon.com/posts/raspberrypi-monitoring/</link>
      <pubDate>Mon, 31 Jul 2017 12:45:18 +0100</pubDate>
      
      <guid>https://dernasherbrezon.com/posts/raspberrypi-monitoring/</guid>
      <description>Возникла передо мной такая задача: сделать мониторинг Raspberry PI. И требования:
 самодостаточность. Возможность показывать статус и исторические данные без доступа в интернет; работа в Java Embedded compact1 profile. Это всё по следам Java и без 16Gb памяти?.  Анализ требований Здесь и далее под мониторингом системы я буду понимать сбор time series данных. Например, JVM heap size или количество обработанных сообщений за интервал.
Самодостаточность автоматически означает, что данные надо хранить локально.</description>
      <turbo:content>
      	<![CDATA[
      		<header>
      			<h1>Мониторинг Raspberry PI</h1><figure>
				    	<img src="https://dernasherbrezon.com/img/raspberrypi-monitoring/3231b4f9f5a3453799d709d10c39c4a1.jpg"/>
				    </figure></header>
      		<div class='container entry-content'>
  

<p>Возникла передо мной такая задача: сделать мониторинг Raspberry PI. И требования:</p>

<ul>
<li>самодостаточность. Возможность показывать статус и исторические данные без доступа в интернет;</li>
<li>работа в Java Embedded compact1 profile. Это всё по следам <a href="https://dernasherbrezon.com/posts/java-small-heap/" target="_blank">Java и без 16Gb памяти?</a>.</li>
</ul>

<p><img src="/img/raspberrypi-monitoring/3231b4f9f5a3453799d709d10c39c4a1.jpg" alt="" /></p>

<h2 id="анализ-требований">Анализ требований</h2>

<p>Здесь и далее под мониторингом системы я буду понимать сбор time series данных. Например, JVM heap size или количество обработанных сообщений за интервал.</p>

<p>Самодостаточность автоматически означает, что данные надо хранить локально. Отображать их надо в браузере, потому что уже есть вэб-админка для этого. Итак, что мы имеем из современного:</p>

<ul>
<li><p><a href="https://www.influxdata.com" target="_blank">InfluxDB</a>. Специальная база для хранения time series данных. Умеет делать аггрегации и data retention. Opensource версия не поддерживает кластеризацию, но для Raspberry PI и не нужно. Проблема с системными требованиями: <a href="https://docs.influxdata.com/influxdb/v1.3/guides/hardware_sizing/" target="_blank">CPU 2-4 ядра и RAM 2-4 Gb</a>. Не подходит.</p></li>

<li><p><a href="https://graphiteapp.org" target="_blank">Graphite</a>. Хранит данные в базе данных <a href="http://graphite.readthedocs.io/en/latest/whisper.html" target="_blank">whisper</a>, который, <a href="http://graphite.wikidot.com/whisper#toc1" target="_blank">как уверяется</a>, немного лучше RRD. В зависимостях Python 2.7 и Django. Имеет свой собственный интерфейс, который надо бы ещё интегрировать в существующую админку. Ну можно конечно же взять.. Но когда на сервере сплошная Java, стоит ли тащить весь мир Python? Опять же запущенные WSGI процессы будут занимать дополнительную память.</p></li>
</ul>

<p>Все остальные варианты найденные на просторах, не подошли либо потому, что надо вручную делать data retention, либо требовательны к ресурсам, либо уж совсем наколеночные.</p>

<p>А что если продолжить мысль про RRD и Java? Получается <a href="https://github.com/rrd4j/rrd4j" target="_blank">RRD4J</a>. Эта библиотека на Java, которая полностью поддерживает все операции и возможности оригинального <a href="https://oss.oetiker.ch/rrdtool/index.en.html" target="_blank">rrdtool</a>. Единственное отличие - это несовместимость баз данных между rrdtool и RRD4J. Но с другой стороны это даже лучше. Базы, созданные оригинальным rrdtool, бинарно несовместимы между различными архитектурами.</p>

<p>Итак, RRD. Он идеально подходит для Raspberry PI:</p>

<ul>
<li>файлы баз данных фиксированного размера. Можно легко посчитать размер на диске. Очень удобно для embedded систем, которые надо один раз настроить и забыть;</li>
<li>один раз открытый файл обновляется через RandomAccessFile. Оригинальный rrdtool <a href="https://oss.oetiker.ch/rrdtool/doc/rrdupdate.en.html#___top" target="_blank">каждый раз</a> открывает файл, записывает данные и закрывает файл.</li>
</ul>

<p>Но и не без проблем.</p>

<ul>
<li><p>Не совместим с compact1 профайлом. RRD4J написан, похоже, в лихие 2000-е, когда шаблон <a href="https://ru.wikipedia.org/wiki/Посетитель_(шаблон_проектирования)" target="_blank">visitor</a> был очень модным, поэтому базовые классы зависят от org.w3c.*. Оказывается одной из фич оригинального rrdtool была возможность писать в XML вместо бинарного файла. И эту фичу RRD4J гордо скопировал. Решается просто: делается <a href="https://github.com/dernasherbrezon/rrd4j-light" target="_blank">hard fork</a> и удаляется все ненужное. Грязно, но работает.</p></li>

<li><p>Создание графиков. С самой генерацией проблем нет. Графики действительно получаются красивые. Но вот шаблоны создания никуда не годятся. В те же лихие 2000-е, когда RRD был на пике популярности, вполне нормальным считалось добавление команды <a href="https://oss.oetiker.ch/rrdtool/doc/rrdgraph.en.html" target="_blank">rrdgraph</a> в crontab и выполнение с периодом в 5 минут. Заставлять генерировать .png графики на Raspberry PI - дело неблагородное. Слишком много ресурсов будет тратиться. А если учесть специфику проекта (вэб-админка, которая используется в лучшем случае раз в год), то видимо нужно придумать более хитрую схему.</p></li>
</ul>

<h2 id="rrd4j-js">RRD4J-js</h2>

<p>И тут мне в голову приходит осознание. Мы же в 2017 году! Время, когда у нас есть стандарты на передачу бинарных файлов в браузер и разные мощные javascript библиотеки для рисования графиков. Что если передавать скачивать RRD базу с сервера как есть, вытаскивать из неё данные и рисовать уже какой-нибудь готовой и проверенной временем Javascript библиотекой?</p>

<p>Посидев несколько ночей в попытке понять как писать на Javascript и создать плагин для Jquery (а на нём ещё модно писать?), я создал <a href="https://www.npmjs.com/package/rrd4j-js" target="_blank">rrd4j-js</a>.</p>

<p>Суть проекта достаточно проста: скачивать RRD, парсить и передавать данные для отрисовки во <a href="http://www.flotcharts.org" target="_blank">flot</a>. А уже плагинами flot добивать нужные стили и интерактив. В итоге, решение оказалось даже лучше, чем стандартные графики rrdgraph:</p>

<ul>
<li>по наведению мышки в подсказке можно отображать значение точки в момент времени</li>
<li>растягивать, сжимать и изменять размер графика в зависимости от разрешения экрана</li>
<li>форматировать данные в зависимости от типа. Например, с помощью <a href="https://github.com/whatbox/jquery.flot.byte" target="_blank">jquery.flot.byte</a> можно форматировать данные в килобайты, мегабайты и гигабайты.</li>
</ul>

<p><img src="/img/raspberrypi-monitoring/b43bb4a25a8c451dbc599ce70708f435.png" alt="" /></p>

<p>Библиотека получилась достаточно простая. Больше всего времени конечно заняло выяснение конвенций по оформлению кода, созданию классов (sic!) в javascript и попытке поделиться проектом с миром.</p>

<p>Я с самого начала решил сделать самодостаточную библиотеку, которую можно загрузить в npm. После нескольких попыток это сделать, у меня, конечно же, всё получилось. Но тут же выяснилось, что npm используется только для server-side разработки на nodejs. И нельзя <a href="https://stackoverflow.com/questions/35062852/npm-vs-bower-vs-browserify-vs-gulp-vs-grunt-vs-webpack" target="_blank">просто так</a> зарелизить библиотеку в правильный репозиторий. Да что тут стесняться: нельзя понять какой из репозиториев правильный. В итоге я остановился на npm. Может кто-нибудь сведущий подскажет как правильно?</p>

<h2 id="послесловие">Послесловие</h2>

<p>С получившимся инструментом, уже можно было начинать творить. А именно периодически сохранять метрики в RRD4J. Обвязка в виде достаточно распространённых <a href="https://github.com/dropwizard/metrics" target="_blank">metrics</a> работающая в compact1 - приятное дополнение. В итоге пришлось написать достаточно простой <a href="https://github.com/dernasherbrezon/r2cloud/blob/master/src/main/java/ru/r2cloud/metrics/RRD4JReporter.java" target="_blank">RRD4JReporter</a>, который расширяет com.codahale.metrics.ScheduledReporter и пользоваться в удовольствие.</p>

</div>

      	]]>
      </turbo:content>
    </item>
    
    <item turbo="true">
      <title>Java и без 16Gb памяти?</title>
      <link>https://dernasherbrezon.com/posts/java-small-heap/</link>
      <pubDate>Sun, 16 Jul 2017 15:11:18 +0100</pubDate>
      
      <guid>https://dernasherbrezon.com/posts/java-small-heap/</guid>
      <description>Однажды меня посетила мысль о том, что надо закодить что-нибудь на Java для RaspberryPI. Предыстория того, как я дошёл до жизни такой, сама по себе потянет на отдельный пост. Но вот сочные технические подробности, трудности и счастливый конец ниже под катом.
Постановка задачи Немного разочаровавшись в движении проекта satnogs, я решил попробовать сам написать базовую станцию для приёма радио сигналов на raspberry pi. Проанализировав текущую функциональность satnogs и сложив с собственным заскорузлым enterprise пониманием того, что такое стабильная платформа, я придумал следующие требования:</description>
      <turbo:content>
      	<![CDATA[
      		<header>
      			<h1>Java и без 16Gb памяти?</h1><figure>
				    	<img src="https://dernasherbrezon.com/img/java-small-heap/0ebcb88f4c7d47cc96e872f9c182638c.jpg"/>
				    </figure></header>
      		<div class='container entry-content'>
  

<p>Однажды меня посетила мысль о том, что надо закодить что-нибудь на Java для RaspberryPI. Предыстория того, как я дошёл до жизни такой, сама по себе потянет на отдельный пост. Но вот сочные технические подробности, трудности и счастливый конец ниже под катом.</p>

<p><img src="/img/java-small-heap/0ebcb88f4c7d47cc96e872f9c182638c.jpg" alt="" /></p>

<h2 id="постановка-задачи">Постановка задачи</h2>

<p>Немного разочаровавшись в движении проекта <a href="https://satnogs.org">satnogs</a>, я решил попробовать сам написать базовую станцию для приёма радио сигналов на <a href="https://www.raspberrypi.org">raspberry pi</a>. Проанализировав текущую функциональность satnogs и сложив с собственным заскорузлым enterprise пониманием того, что такое стабильная платформа, я придумал следующие требования:</p>

<ul>
    <li>java вместо python. Конечно же.</li>
<li>низкое потребление ресурсов. Embedded же.</li>
<li>переиспользование уже существующих библиотек. Цель проекта не научиться декодировать самому, а максимально интегрировать уже существующие библиотеки</li>
<li>стабильность. Коробочка должна работать сама по себе как можно дольше. В идеале её нужно настроить и забыть.</li>
</ul>

<p>В результате в противоречие вступают только два требования: Java и низкое потребление ресурсов.</p>

<p>В этот момент я почему то вспомнил древний древний слоган &ldquo;Java - write once, run everywhere&rdquo; и присказку, что Java может запускаться на кофеварке. С этого момента началось погружение в Java Embedded.</p>

<p>Если вкратце, то в Java существуют две платформы для написания под маленькие устройства: <a href="https://ru.wikipedia.org/wiki/Java_Platform,_Micro_Edition">Java ME</a> и Java Embedded. Первая платформа предназначена для совсем маленьких (кофеварки) устройств, а вторая для тех, что чуть-чуть покрупнее. Я выбрал Java Embedded.</p>

<p>Сама Java Embedded в Java 8 претерпела изменения. Теперь её можно собрать с различными профайлами: compact1, compact2, compact3. По сути, это depedency management для бедных. Каждый профайл содержит <a href="http://www.oracle.com/technetwork/java/embedded/resources/tech/compact-profiles-overview-2157132.html">какие-то части rt.jar</a>, тем самым уменьшая минимальное потребление памяти JVM при загрузке. На моих как-бы тестах (колонка %RES в выводе команды top), я получил следующее потребление:</p>

<ul>
    <li>compact1 - <b>10mb</b></li>
    <li>compact2 - <b>12mb</b></li>
</ul>

<p>Для начала я выбрал самый хардкорный вариант: compact1. Нo если не получится найти под него библиотеки, то можно попробовать compact2.</p>

<p>После выбора версии Java нужно выбрать библиотеки. И вот тут дикий-дикий запад. Поскольку в Java мире всё течёт неспеша и с оглядкой на обратную совместимость, то никто из разработчиков библиотек не побежал оптимизировать свой код под новые профайлы. Тем более скоро выходит Java 9, где всё может ещё раз измениться.</p>

<p>Дальше я проанализировал, минимальный набор библиотек для создания не слишком нагруженного web приложения.</p>

<h3>IoC фреймворк</h3>
<ul>
<li><a href="https://github.com/google/dagger">Dagger</a>, <a href="https://github.com/zsoltherpai/feather">Feather</a> - нет @PreDestroy, @PostConstruct и принципиально не планируется. Про graceful shutdown разработчики видимо не слышали. Вручную контролировать последовательность вызова метода start, чтобы при остановке в обратном порядке вызвать stop, совсем не хочется делать. </li>
<li><a href="https://github.com/google/guice">Guice</a> - зависимость на <a href="https://github.com/google/guava">guava</a>, а значит ещё +2mb.</li>
<li><a href="http://picocontainer.com">picocontainer</a> - не compact1</li>
</ul>

<h3>База данных</h3>

<p>Какой же Java проект без базы данных. Но тут есть один подвох: в compact1 нет java.sql api. Поэтому я первым делом посмотрел на базы с native api без jdbc:</p>

<ul>
    <li><a href="http://www.oracle.com/technetwork/database/berkeleydb/overview/index-093405.html">berkleydb</a>. NoSQL, но почему-то зависит от javax.transactional. </li>
</ul>

<p>И с jdbc:</p>

<ul>
    <li> <a href="https://github.com/xerial/sqlite-jdbc">sqlite</a> - библиотека весит 5mb. Видимо содержит все нативные библиотеки для всех платформ.</li>
<li><a href="https://github.com/xerial/sqlite-jdbc">java db</a>. Весит конечно много и разные версии отличаются существенно: 10.8 - 2.5mb, 10.13 - 3.1mb. </li>
</ul>

<p>Есть ещё куча других мелких непонятных embedded баз данных, которые можно было бы попробовать. Но отлавливать их баги под raspberry pi у меня желания нет.</p>

<p>Зато есть пара других идей:</p>

<ul>
<li><p>А что, если обхитрить JVM: взять compact1 и вручную подложить <a href="https://mvnrepository.com/artifact/org.xerial.thirdparty/jdbc-api/1.4">java.sql api</a>? Ответ: не получится. В Classloader есть вот такой замечательный код:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">       <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>name <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> name<span style="color:#f92672">.</span><span style="color:#a6e22e">startsWith</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;java.&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> SecurityException
                <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Prohibited package name: &#34;</span> <span style="color:#f92672">+</span>
                 name<span style="color:#f92672">.</span><span style="color:#a6e22e">substring</span><span style="color:#f92672">(</span>0<span style="color:#f92672">,</span> name<span style="color:#f92672">.</span><span style="color:#a6e22e">lastIndexOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;.&#39;</span><span style="color:#f92672">)));</span>
        <span style="color:#f92672">}</span></code></pre></div>
<p>Вообще непонятно почему существует такой maven артефакт, если его даже теоретически нельзя загрузить.</p></li>

<li><p>А может без базы? Для моих целей вполне подходят обычные файлы. Sql join тоже вроде не имеет смысла делать.</p></li>
</ul>

<p>В общем отказался совсем от базы. Посмотрим надолго ли.</p>

<p><h3>Web container</h3>
<ul>
    <li><a href="https://github.com/apache/tomcat">tomcat</a> - Ха-ха-ха</li>
<li><a href="http://www.eclipse.org/jetty/">jetty</a> - не compact1  </li>
<li><a href="https://github.com/NanoHttpd/nanohttpd">nanohttpd</a> - не servlet, нет поддержки сессий. Но видимо такова судьба Embedded разработчика. </li>
</ul></p>

<p><h3>SSL temination</h3>
<ul>
    <li>nginx. 3mb master node + 3mb 1 client worker. = 6mb. Вроде неплохо. </li>
</ul></p>

<p><h3>Вэб клиент</h3>
<ul>
    <li>angular, reactjs - на ровном месте привносят десяток короткоживущих технологий. </li>
<li>good-o-templates - наш выбор же.</li>
</ul></p>

<p><h3>Шаблонизаторы</h3>
<ul>
    <li>JSP - слишком тяжело и нужно много библиотек. Даже не стал копать.</li>
<li>Freemarker - легко, но как оказалось не compact1.</li>
<li>Кто-нибудь слышал про <a href="http://jtwig.org">jtwig</a>? Я тоже нет, но они умееют работать в compact1 и поддерживают базовые фичи. </li>
</ul></p>

<p><h3>Логирование</h3>
<ul>
    <li>logback - <a href="https://jira.qos.ch/browse/LOGBACK-1071">только</a> compact3 </li>
<li>log4j - full JRE</li>
<li>java.util.logging? - Хуже уже не будет.</li>
</ul></p>

<p><h3>Json</h3>
<ul>
    <li><a href="https://github.com/google/gson">gson</a>. Зависимость на java.sql (!!!)</li>
<li><a href="https://github.com/FasterXML/jackson-databind">jacksonxml</a>. Зависимость на org.w3c.dom.Node</li>
<li>очередной &ldquo;нагуглил-ночью&rdquo; код <a href="https://github.com/ralfstx/minimal-json">https://github.com/ralfstx/minimal-json</a>. Посмотрел, вроде там нечему ломаться.</li>
</ul></p>

<p>После нескольких запусков и сборке всего вместе выплыло несколько косяков, но их можно поправить конфигурацией. Например:
<a href="https://stackoverflow.com/questions/13825403/java-how-to-get-logger-to-work-in-shutdown-hook">https://stackoverflow.com/questions/13825403/java-how-to-get-logger-to-work-in-shutdown-hook</a></p>

<p><h2>Итого</h2>
<ul>
    <li>все библиотеки в сборе + прогретый кэш для шаблонизатора занимают в памяти ~<b>23mb</b></li>
<li>код открыт и доступен: <a href="https://github.com/dernasherbrezon/r2cloud">https://github.com/dernasherbrezon/r2cloud</a> (надеюсь пароли нигде там не закоммитил)</li>
</ul></p>

</div>

      	]]>
      </turbo:content>
    </item>
    
    <item turbo="true">
      <title>Enterprise Java на страже космоса</title>
      <link>https://dernasherbrezon.com/posts/enterprise-java-space/</link>
      <pubDate>Sat, 08 Apr 2017 12:48:18 +0100</pubDate>
      
      <guid>https://dernasherbrezon.com/posts/enterprise-java-space/</guid>
      <description>Научно технический прогресс постепенный по своей природе. Никто не берет горсть песка с пляжа и делает из нее компьютер. Мы берем грубые инструменты и создаем с помощью них более качественные. Затем с помощью последних еще более точные и так далее. Каждое малое усовершенствование - это ступенька прогресса и все они должны быть пройдены.
Председатель Шенчжи Ян.
 В сознании каждого человека есть одна простая мысль: космические технологии - это сложно.</description>
      <turbo:content>
      	<![CDATA[
      		<header>
      			<h1>Enterprise Java на страже космоса</h1><figure>
				    	<img src="https://dernasherbrezon.com/img/enterprise-java-space/24dbbef6d38b4de59fef6b67a0308e40.jpg"/>
				    </figure></header>
      		<div class='container entry-content'>
  <blockquote>
<p>Научно технический прогресс постепенный по своей природе. Никто не берет горсть песка с пляжа и делает из нее компьютер. Мы берем грубые инструменты и создаем с помощью них более качественные. Затем с помощью последних еще более точные и так далее. Каждое малое усовершенствование - это ступенька прогресса и все они должны быть пройдены.</p>

<p>Председатель Шенчжи Ян.</p>
</blockquote>

<p><img src="/img/enterprise-java-space/24dbbef6d38b4de59fef6b67a0308e40.jpg" alt="" /></p>

<p>В сознании каждого человека есть одна простая мысль: космические технологии - это сложно. На самом деле это не так. Не все технологии, применимые в космической отрасли - это Rocket science. И последние успехи в космонавтике, ренессанс космической тематики сподвигли меня на поиск проблемных областей, которые простой Enterprise Java разработчик может улучшить.
<cut />
<h2>Предисловие</h2>
Самый простой способ - это пойти на сайт любой компании, работающей в космической отрасли, и поискать вакансии. Несмотря на то, что <a href="http://www.spacex.com/careers">SpaceX</a> ищет программистов, мне было отказано на этапе резюме. Видимо, государственные контракты от NASA не позволяют им нанимать людей из других стран. Видимо, по этой же причине <a href="https://www.linkedin.com/jobs/search/?keywords=nasa&f_C=2003">NASA</a> даже не ответили на моё резюме. <a href="http://global.jaxa.jp/about/employ/index.html">JAXA</a> набирает не-программистов и тех, у кого японский не ниже уровня jlpt2.</p>

<p>С небольшими частными компаниями должно было бы быть значительно лучше. Но <a href="http://www.planetaryresources.com/careers/#pri-workplace">Planetary Resources</a> отказали на этапе резюме. Видимо, слишком маленькие, чтобы держать под рукой Enterprise Java разработчика. <a href="https://www.planet.com/company/careers/?office=View%20All&department=Software%20Engineering">Planet</a> попросили написать программу на Си. Я конечно вспомнил синтаксис и смог, но после пары интервью они отказали. Видимо, слишком маленькая компания, у которой нет офиса в России, и переезд в другую страну они не потянут.</p>

<p>Ну и, наконец, дефолт сити. <a href="https://www.roscosmos.ru/23310/">Роскосмос</a> - ни списка вакансий, ни требований.</p>

<p><h2>Станции наблюдения за спутниками</h2>
Но мне повезло, и я случайно обнаружил проект <a href="https://geektimes.ru/post/241834/">Satnogs</a>. Это проект по созданию любительских станций наблюдения за спутниками по всему миру. Можно самому распечатать на 3д принтере части станции и по инструкции собрать. Также у них есть центральный сервер, который рассылает на станции запросы для наблюдения за пролетающими спутниками и собирает данные со всего мира: <a href="https://network.satnogs.org">https://network.satnogs.org</a>.</p>

<p>Для меня, как новичка в этой области, было не совсем понятно кому и зачем это нужно. Однако, повертевшись на <a href="https://community.satnogs.org">форумах</a> и в mailing листах <a href="http://www.cubesat.org/mailinglist">cubesat</a>, я стал немного представлять проблематику.</p>

<p>Обычно маленькие спутники и кубсаты запускают университеты для отработки той или иной <a href="http://sail.planetary.org">технологии</a>. Иногда их запускают даже солидные коммерческие компании для финальных тестов своих <a href="https://www.nasa.gov/centers/ames/engineering/projects/nodes">наработок</a>. Обычно эти компании и университеты достаточно небольшие и не могут себе позволить <a href="https://geektimes.ru/company/mailru/blog/280132/">флот</a> для наблюдения за спутниками. Однако, понимание того, как ведет себя технология, важно в <a href="https://geektimes.ru/post/251506/">течении всего времени</a> полета, а не только во время пятиминутного интервала связи. Именно поэтому университеты и компании <a href="http://www.space.aau.dk/aausat4/index.php?n=Main.ReportBeaconsAndPassInfo">заинтересованы</a> в постоянном слежении за своими спутниками.</p>

<p>И тут на помощь должны прийти интернет и <a href="https://en.wikipedia.org/wiki/Space_Communications_and_Navigation_Program">глобальная сеть наблюдения</a>.</p>

<p><h2>Телеметрия</h2>
По мере того, как спутник вращается на орбите, он периодически посылает телеметрию. <a href="https://ru.wikipedia.org/wiki/Телеметрия">Телеметрия</a> - это текущее состояние системы: напряжение батарей, момент вращения, температура и пр. Если постоянно получать эту информацию, то можно построить график изменения данных во времени и провести анализ.</p>

<p>Поскольку я прежде всего программист, меня заинтересовала именно программная часть, а в особенности digital signal processing. Как из .wav файла можно получить данные. Но прежде чем расчехлять прибор и начать кодить необходимо проанализировать существующие решения. Если вкратце, то эта область застряла где-то в 60х. Энтузиасты пересылают данные в виде <a href="http://www.dk3wn.info/p/?cat=8">скриншотов</a> к windows программам.</p>

<p><img src="/img/enterprise-java-space/192591f0007246fc8cc434b47e76ef4f.jpg" alt="" /></p>

<p>Хотелось бы что-то более современное. Например, облачный сервис, который на вход получает .wav файл, а на выходе возвращает json. Почему именно такая архитектура?</p>

<p><ol>
<li>для того, чтобы отправить данные и получить результат не нужно специального ПО. Достаточно лишь curl, который есть во всех linux дистрибутивах;</li>
<li>результат в текстовом формате упрощает разработку и интеграцию;</li>
<li>микросервисная архитектура. Такой сервис будет отлично встраивается в другие более сложные системы.</li>
</ol>
Следующим этапом был выбор технологий. Поскольку специализированные железки для декодирования радио сигналов ну совсем никак не поставить в обычные датацентры, то необходимо программное декодирование. Тут все просто: <a href="http://gnuradio.org">gnuradio</a>. Это стандарт де-факто для программного декодирования - достаточно мощный и бесплатный инструмент, который поддерживает множество режимов и способов работы. Как раз то, что нужно для того, чтобы работать с зоопарком различных способов кодирования сигнала. Daniel Estévez <a href="https://github.com/daniestevez/gr-satellites">написал</a> замечательные скрипты по декодированию сигналов различных спутников и приложил рабочие примеры.</p>

<p><img src="/img/enterprise-java-space/e9ddc3c4bc8e448f8ca1d6f7e0b99e79.png" alt="" /></p>

<p>Казалось бы вот оно, счастье. Однако, и тут есть несколько ложек дегтя:</p>

<p><ol>
<li><a href="https://www.gnu.org/licenses/old-licenses/gpl-2.0.ru.html">GPLv2</a>. Это не позволит вам писать коммерческий софт по декодированию сигналов. И уж точно не подходит для облачного сервиса - кто-то должен платить за хостинг.</li>
<li>Безумная связка C/C++/Python/Swig. Если вкратце, то в gnuradio есть понятие блока. Это такой атомарный преобразователь сигнала. Когда сигнал декодируется данные проходят через множества, связанных между собой, блоков, и на выходе из последнего блока получается результат. Так вот, блоки можно писать на С++ и python. А раз можно писать, значит кто-то обязательно напишет. В итоге, часть блоков написана на Python 2, часть на <a href="https://github.com/gnuradio/gnuradio/issues/1153">Python 3</a>, часть на C++, который иногда <a href="http://stackoverflow.com/questions/24898791/gnu-radio-build-error-no-rule-to-make-target-filter-generated-includes-neede">не компилируется</a> и <a href="https://wiki.gnuradio.org/index.php/MacInstall">не всегда устанавливается</a>, и все это связано через <a href="http://www.swig.org">SWIG</a>.</li>
</ol>
Переписывать уже рабочий код, который используется уже много лет и знаком многим энтузиастам, задача неблагодарная. Но помучившись с виртуальными машинами и продравшись сквозь десяток ошибок компиляции, я решил пойти на невозможное: переписать ключевые блоки на <a href="https://github.com/dernasherbrezon/jradio">Java</a>. Разумеется бездумно переписывать все подряд блоки не имеет смысла, поэтому я решил проверить концепцию, переписав только блоки, нужные для декодирования <a href="https://github.com/daniestevez/gr-aausat">aausat-4</a>. В итоге у меня получилось сделать бинарно совместимые с gnuradio блоки и декодировать сигнал.</p>

<p>Поскольку концепция оказалась успешной, я решил запустить <a href="https://r2cloud.ru">облачный сервис</a>, который по сути предоставляет REST интерфейс к библиотеке <a href="https://github.com/dernasherbrezon/jradio">jradio</a>. Следующим этапом я планирую подключить его к <a href="https://network.satnogs.org">satnogs</a> для декодирования данных.</p>

<p><h2>Выводы</h2>
Даже если вы Enterprise Java разработчик, вы можете помочь Элону. Возможно, по прошествии времени Вы сможете говорить внукам что шаттл, который летает между Марсом и Землей, каждую секунду выполняет Ваш код. Дерзайте!</p>

</div>

      	]]>
      </turbo:content>
    </item>
    
    <item turbo="true">
      <title>Дистрибьюция Java приложений</title>
      <link>https://dernasherbrezon.com/posts/java-dist/</link>
      <pubDate>Tue, 18 Aug 2015 13:55:18 +0100</pubDate>
      
      <guid>https://dernasherbrezon.com/posts/java-dist/</guid>
      <description>Удивительно, но факт - дистрибьюция Java приложений в 21 веке по прежнему огромный костыль. Разработчики до сих пор придумывают способы вроде rsync/copy-paste/wget для установки java приложений на сервер. И только монструозные enterprise production ready платформы иногда позволяют сделать чуть больше - откатить приложение на предыдущую версию. В этой статье я хотел бы рассказать о доступном и простом способе организации дистрибьюции.
deb и apt В мире существует множество действительно гигантских репозиториев приложений и инструментов по их дистрибьюции.</description>
      <turbo:content>
      	<![CDATA[
      		<header>
      			<h1>Дистрибьюция Java приложений</h1><figure>
				    	<img src="https://dernasherbrezon.com/img/java-dist/75bbd9f6074d4cb8a46ad705051aa8e0.png"/>
				    </figure></header>
      		<div class='container entry-content'>
  

<p><img src="/img/java-dist/75bbd9f6074d4cb8a46ad705051aa8e0.png" alt="" /></p>

<p>Удивительно, но факт - дистрибьюция Java приложений в 21 веке по прежнему огромный костыль. Разработчики до сих пор придумывают способы вроде rsync/copy-paste/wget для установки java приложений на сервер. И только монструозные enterprise production ready платформы иногда позволяют сделать чуть больше - откатить приложение на предыдущую версию. В этой статье я хотел бы рассказать о доступном и простом способе организации дистрибьюции.</p>

<h2 id="deb-и-apt">deb и apt</h2>

<p>В мире существует множество действительно гигантских репозиториев приложений и инструментов по их дистрибьюции. Самые большие, по ощущениям, - это AppStore, Google Play, Debian/Ubuntu репозитории и CentOS/Fedora YUM репозитории. Например в Ubuntu репозитории для версии 15.04 содержится около 90000 приложений (без учета различных версий). Почему бы не воспользоваться провернной временем системой и для дистрибьюции Java приложений? Тем более, что:</p>

<ul>
<li><a href="http://w3techs.com/technologies/details/os-linux/all/all" target="_blank">большинство</a> серверов и так используют Debian/Ubuntu</li>
<li>проверенный временем инструмент: первый релиз был <a href="https://en.wikipedia.org/wiki/Advanced_Packaging_Tool" target="_blank">16 лет</a> назад</li>
<li>нативная поддержка в операционной системе</li>
</ul>

<p>Для начала немного о системе дистрибьюции приложений в Debian/Ubuntu. Она состоит из двух основных частей:</p>

<ul>
<li>deb пакеты</li>
<li>apt (Advanced Package Tool) инструменты</li>
</ul>

<h2 id="deb-пакеты">deb пакеты</h2>

<p>deb это бинарный дистрибутив приложения. Он состоит из 3 основных частей:</p>

<ul>
<li>метаинформация. Производитель, версия, зависимости на другие пакеты (очень похоже на maven), описание и пр.</li>
<li>непосредственно приложение. .tar.gz архив</li>
<li>(опционально) скрипты, которые будут выполняться во время установки</li>
</ul>

<p>Структура .tar.gz архива может быть абсолютно произвольной. Однако, чтобы Ваше приложение было похоже на все остальные приложения системы, оно должно следовать структуре каталогов Debian/Ubuntu:</p>

<ul>
<li>/etc - конфиги</li>
<li>/etc/init.d/ - скрипты запуска демонов</li>
<li>/usr/bin - исполняемые файлы</li>
<li>/usr/lib - библиотеки</li>
<li>/var/log - логи</li>
</ul>

<p>В зависимости от Вашего приложения каталоги могут немного отличаться, но общая структура надеюсь понятна.</p>

<p>Еще одной важной особенностью deb пакетов является возможность запускать скрипты во время установки. Эти скрипты тоже хранятся в deb пакете и имеют стандартное именование. Каждый скрипт может выполняться в определенную фазу установки. Установка пакета делится на несколько фаз:</p>

<ul>
<li>preinst</li>
<li>inst</li>
<li>postinst</li>
<li>prerm</li>
<li>rm</li>
<li>postrm</li>
</ul>

<p>Существует множество различных промежуточных фаз и различные комбинации состояния инсталляции. Нас они мало интересуют, но тем кто хочет разобраться можно почитать <a href="https://www.debian.org/doc/debian-policy/ch-maintainerscripts.html">официальную документацию</a>. Обычно эти скрипты настраивают ротацию и архивирование логов, задают начальные значения конфигураций (например, root-пароль для mysql). Если же у вас конечное бизнес-приложение, то лучше взять какое-нибудь нормальное средство автоматизации вроде <a href="http://www.ansible.com/home">Ansible</a>, <a href="https://www.chef.io/chef/">Chief</a>, <a href="https://puppetlabs.com">Puppet</a>.</p>

<h2 id="apt">apt</h2>

<p>apt - это набор инструментов для работы с deb пакетами. Он позволяет:</p>

<ul>
<li>конфигурировать репозитории и работать с ними: добавлять, удалять, менять, обновлять индекс</li>
<li>управлять пакетами: устанавливать, удалять, обновлять, искать</li>
</ul>

<p>apt репозиторий в упрощенном виде - это HTTP сервер, который раздает deb пакеты. У него есть индекс (файл), который доступен по стандартному пути и непосредственно бинарники, путь к которым находится в индексе.</p>

<h2 id="связывая-все-воедино">Связывая все воедино</h2>

<p>После того, как стала понятна примерная схема работы связки deb + apt, можно попробовать их съинтегрировать. Примерная схема такая:</p>

<ul>
<li>создания deb пакета в фазе package</li>
<li>публикация получившегося пакета в фазе deploy</li>
</ul>

<p>Для этого есть несколько maven плагинов.</p>

<h2 id="a-href-https-github-com-tcurdt-jdeb-jdeb-a"><a href="https://github.com/tcurdt/jdeb">jdeb</a></h2>

<p>Схема его работы достаточно <a href="https://github.com/tcurdt/jdeb/blob/master/src/examples/maven/pom.xml">проста</a>:</p>

<ul>
<li>перечислить файлы и директории, которые попадут в результирующий .tar.gz архив</li>
<li>указать пермиссии</li>
</ul>

<p>Более полная документация о возможностях плагина можно узнать на официальной <a href="https://github.com/tcurdt/jdeb/blob/master/docs/maven.md">странице</a>.</p>

<h2 id="a-href-https-github-com-dernasherbrezon-apt-maven-plugin-apt-maven-plugin-a"><a href="https://github.com/dernasherbrezon/apt-maven-plugin">apt-maven-plugin</a></h2>

<p>Работает с репозиторием заданным в distributionManagement как с apt репозиторием, а не maven репозиторием. Хотя ничего не мешает их использовать одновременно под одним url. Их layout&rsquo;ы совместимы между собой.</p>

<p>Пример конфигурации выглядит следующим образом:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;plugin&gt;</span>
	<span style="color:#f92672">&lt;groupId&gt;</span>com.aerse.maven<span style="color:#f92672">&lt;/groupId&gt;</span>
	<span style="color:#f92672">&lt;artifactId&gt;</span>apt-maven-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
	<span style="color:#f92672">&lt;version&gt;</span>1.5<span style="color:#f92672">&lt;/version&gt;</span>
	<span style="color:#f92672">&lt;executions&gt;</span>
		<span style="color:#f92672">&lt;execution&gt;</span>
			<span style="color:#f92672">&lt;id&gt;</span>deploy<span style="color:#f92672">&lt;/id&gt;</span>
			<span style="color:#f92672">&lt;goals&gt;</span>
				<span style="color:#f92672">&lt;goal&gt;</span>deploy<span style="color:#f92672">&lt;/goal&gt;</span>
			<span style="color:#f92672">&lt;/goals&gt;</span>
		<span style="color:#f92672">&lt;/execution&gt;</span>
	<span style="color:#f92672">&lt;/executions&gt;</span>
	<span style="color:#f92672">&lt;configuration&gt;</span>
		<span style="color:#f92672">&lt;component&gt;</span>main<span style="color:#f92672">&lt;/component&gt;</span>
		<span style="color:#f92672">&lt;codename&gt;</span>strepo<span style="color:#f92672">&lt;/codename&gt;</span>
	<span style="color:#f92672">&lt;/configuration&gt;</span>
<span style="color:#f92672">&lt;/plugin&gt;</span></code></pre></div>
<p>И секция distributionManagement (ничего <a href="https://maven.apache.org/plugins/maven-deploy-plugin/usage.html">необычного</a>):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;distributionManagement&gt;</span>
	<span style="color:#f92672">&lt;repository&gt;</span>
		<span style="color:#f92672">&lt;id&gt;</span>maven-release-repo<span style="color:#f92672">&lt;/id&gt;</span>
		<span style="color:#f92672">&lt;url&gt;</span>http://example.com/maven<span style="color:#f92672">&lt;/url&gt;</span>
	<span style="color:#f92672">&lt;/repository&gt;</span>
<span style="color:#f92672">&lt;/distributionManagement&gt;</span></code></pre></div>
<p>После выполнения фазы deploy, <a href="http://example.com/maven" target="_blank">http://example.com/maven</a> станет еще и apt репозиторием. И можно смело писать:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo add-apt-repository <span style="color:#e6db74">&#34;deb http://example.com/maven strepo main&#34;</span>
sudo apt-get update
sudo apt-get install &lt;artifactId&gt;</code></pre></div>
<h2 id="немного-любимого-enterprise">Немного любимого enterprise</h2>

<p>Манца любого java-enterprise разработчика звучит следующим образом:</p>

<ul>
<li>security</li>
<li>stability</li>
<li>high availability production ready platform</li>
</ul>

<p>Все это отлично решается, если устроить apt репозиторий из самого популярного хостинга для разработчиков: <a href="https://aws.amazon.com/s3/">s3</a>. Вкупе с cloudfront, он даёт гарантию <a href="https://aws.amazon.com/s3/sla/">99.9%</a> надёжности и географическую <a href="https://www.google.com/maps/d/viewer?mid=zq41xmfbtRfA.kUKJZcl-4O7k&hl=en">распределённость</a>.</p>

<p>Делается это опять же достаточно просто. Надо подключить плагин для работы с s3:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;build&gt;</span>
	<span style="color:#f92672">&lt;extensions&gt;</span>
		<span style="color:#f92672">&lt;extension&gt;</span>
			<span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.build<span style="color:#f92672">&lt;/groupId&gt;</span>
			<span style="color:#f92672">&lt;artifactId&gt;</span>aws-maven<span style="color:#f92672">&lt;/artifactId&gt;</span>
			<span style="color:#f92672">&lt;version&gt;</span>5.0.0.RELEASE<span style="color:#f92672">&lt;/version&gt;</span>
		<span style="color:#f92672">&lt;/extension&gt;</span>
	<span style="color:#f92672">&lt;/extensions&gt;</span>
<span style="color:#f92672">&lt;/build&gt;</span></code></pre></div>
<p>Поменять url в секции distributionManagement на имя bucket&rsquo;a:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;distributionManagement&gt;</span>
	<span style="color:#f92672">&lt;repository&gt;</span>
		<span style="color:#f92672">&lt;id&gt;</span>maven-release-repo<span style="color:#f92672">&lt;/id&gt;</span>
		<span style="color:#f92672">&lt;url&gt;</span>s3://example.bucket<span style="color:#f92672">&lt;/url&gt;</span>
	<span style="color:#f92672">&lt;/repository&gt;</span>
<span style="color:#f92672">&lt;/distributionManagement&gt;</span></code></pre></div>
<p>И настроить доступ к вашему bucket&rsquo;у:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;servers&gt;</span>
	<span style="color:#f92672">&lt;server&gt;</span>  
		<span style="color:#f92672">&lt;id&gt;</span>maven-release-repo<span style="color:#f92672">&lt;/id&gt;</span>  
		<span style="color:#f92672">&lt;username&gt;</span>apikey<span style="color:#f92672">&lt;/username&gt;</span>  
		<span style="color:#f92672">&lt;password&gt;</span>apisecret<span style="color:#f92672">&lt;/password&gt;</span>  
	<span style="color:#f92672">&lt;/server&gt;</span>
<span style="color:#f92672">&lt;/servers&gt;</span></code></pre></div>
<p>На конечных серверах для доступа к такому репозиторию существует специальный плагин: <a href="https://launchpad.net/~leonard-ehrenfried/+archive/ubuntu/apt-transport-s3">apt-transport-s3</a>. К сожалению его еще нет в официальных репозиториях, поэтому необходимо добавить вручную один из репозиториев, где он содержится:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo add-apt-repository ppa:leonard-ehrenfried/apt-transport-s3
sudo apt-get install apt-transport-s3</code></pre></div>
<p>После чего можно уже указывать наш s3 репозиторий:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo add-apt-repository <span style="color:#e6db74">&#34;deb s3://apikey:apisecret@s3.amazonaws.com/example.bucket strepo main&#34;</span></code></pre></div>
<h2 id="итого">Итого</h2>

<p>В результате всех манипуляций установка приложения:</p>

<ul>
<li>mvn clean deploy</li>
</ul>

<p>На любом Debian/Ubuntu сервере в любой точке мира:</p>

<ul>
<li>apt-get update</li>
<li>apt-get install artifactId</li>
</ul>

</div>

      	]]>
      </turbo:content>
    </item>
    
    <item turbo="true">
      <title>Спецификация конструкции CubeSat</title>
      <link>https://dernasherbrezon.com/posts/cubespec/</link>
      <pubDate>Tue, 24 Sep 2013 13:14:18 +0100</pubDate>
      
      <guid>https://dernasherbrezon.com/posts/cubespec/</guid>
      <description>1. Введение. CubeSat (Cube Satellite - кубический спутник, КубСат) - это малые спутники (пикоспутники) модульной кубической формы. Самый маленький имеет длину ребра 10 см и массу до 1.33кг. Более крупные спутники имеют форму и массу, кратные 1.5x, 2x, 3x одиночных модулей, состыкованным друг с другом по одной линии.
1.1 История создания Проект CubeSat был начат в 1999 году совместными усилиями профессора Джорди Пьюг-Суари (Prof. Jordi Puig-Suari) из Калифорнийского Политехнического Университета (California Polytechnic State University), Сан Луис Обиспо (San Luis Obispo), профессором Бобом Твиггсом (Prof.</description>
      <turbo:content>
      	<![CDATA[
      		<header>
      			<h1>Спецификация конструкции CubeSat</h1></header>
      		<div class='container entry-content'>
  

<h2 id="1-введение">1. Введение.</h2>

<p>CubeSat (Cube Satellite - кубический спутник, КубСат) - это малые спутники (пикоспутники) модульной кубической формы. Самый маленький имеет длину ребра 10 см и массу до 1.33кг. Более крупные спутники имеют форму и массу, кратные 1.5x, 2x, 3x одиночных модулей, состыкованным друг с другом по одной линии.</p>

<h3 id="1-1-история-создания">1.1 История создания</h3>

<p>Проект CubeSat был начат в 1999 году совместными усилиями профессора Джорди Пьюг-Суари (Prof. Jordi Puig-Suari) из Калифорнийского Политехнического Университета (California Polytechnic State University),  Сан Луис Обиспо (San Luis Obispo), профессором Бобом Твиггсом (Prof. Bob Twiggs) из Лаборатории Развития Космических Систем Стэнфордского университета (Stanford University&rsquo;s Space Systems Development Laboratory (SSDL)).
Целью проекта является создание стандартных требований к конструкции пикоспутников для уменьшение стоимости и сроков разработки, обеспечения доступности доступа в космос и осуществления частых запусков.
В настоящее время в работе над проектом CubeSat участвуют более 100 международных универсистетов,  школ и частных предприятий, разрабатывающих пикоспутники для научных, частных и государственных задач.</p>

<div class="row pagination-centered">
    <div class="span12">
        <img src="/img/cubespec/cubesat-figure1.jpg" width="500" height="333" alt="кубсаты и P-POD">
    </div>
</div>

<h3 id="1-2-назначение">1.2 Назначение</h3>

<p>Основное назначение проекта CubeSat - предоставить возможность запускать в космос небольшие полезные нагрузки. Основной зоной ответственности Калифорнийского Политехнического Университета, как разработчика P-POD (Poly Picosatellite Orbital Deployer - Носитель для вывода на орбиту набора пикоспутников), является обеспечение безопасности запускаемого CubeSat&rsquo;а, ракеты-носителя, основной полезной нагрузки и других CubeSat&rsquo;ов.
Разработчики CubeSat&rsquo;ов должны активно участвовать в обеспечении безопасности и успешности CubeSat миссий, применяя хорошие инженерные практики, тестирование и проверку систем. Аварии в работе CubeSat, P-POD или интерфейсных систем могут повредить ракету-носитель, основную полезную нагрузку и подвергнуть всю программу CubeSat большому риску. Все участники сообщества CubeSat обязаны обеспечить безопасную работу своих систем и соответствие требованиям к конструкции и испытаниям, описанным в данном документе. Требования, приведенные в данном документе, могут быть заменены требованиями поставщика запуска ракеты-носителя.</p>

<h3 id="1-3-процедура-согласования-отклонений-от-основных-требований">1.3 Процедура согласования отклонений от основных требований.</h3>

<p>Разработчики обязаны заполнить форму &ldquo;Запроса проверки отклонений от   требований&rdquo; DAR (Deviation Wavier Approval Request), если их CubeSat не удовлетворяет любому требованию из указанных в разделе 2 или 3 настоящего документа. Процесс согласования должен быть быстрым и простым. Его назначение - это облегчение взаимных согласований и обмена сложной документацией между CubeSat разработчиками, интеграторами P-POD, различным персоналом безопасности и поставщиком запуска ракеты-носителя. Это должно облегчить определение, а также нахождение путей решения любого вопроса, который может возникнуть до интеграции P-POD и запуска. Скачать DAR можно с сайта <a href="http://www.cubesat.org" target="_blank">http://www.cubesat.org</a>. Все запросы следует отправлять по адресу: standards@cubesat.org</p>

<p>При получении запроса согласования отклонений DAR интегратор P-POD рассматривает запрос, решает все возникшие вопросы, и определяет какие дополнительные действия (тесты, анализы или издержки) необходимы для выполнения процедуры согласования. При наличии дополнительных действий, разработчик на основе информации от интегратора P-POD составляет план испытаний и проводит испытания до того, как запрос будет одобрен P-POD интегратором. Запросы одобряются интегратором P-POD до того, как будет определен конкретный запуск CubeSat. Как только подробности конкретного запуска становятся известны, процедура согласования становится специфичной для запуска и отправляется на рассмотрение Менеджеру Миссии запуска ракеты-носителя (Launch Vehicle Mission Manager). Менеджер Миссии запуска имеет право утверждения запроса согласования, а также может потребовать дополнительные изменения и/или испытания перед одобрением запроса. Разработчики должны понимать, что каждое отклонение от требований уменьшает шансы найти возможность подходящего запуска.</p>

<div class="row pagination-centered">
    <div class="span12">
        <object width="369.004" height="567.429" data="/img/cubespec/cubesat-figure2.svg" type="image/svg+xml"></object>
    </div>
</div>

<h2 id="2-носитель-для-вывода-на-орбиту-набора-пикоспутников">2. Носитель для вывода на орбиту набора пикоспутников</h2>

<p>Poly Picosatellite Orbital Deployer (P-POD)</p>

<h3 id="2-1-интерфейс-p-pod">2.1 Интерфейс P-POD</h3>

<p>P-POD - это стандартизированная система для вывода на орбиту CubeSat. P-POD может нести 3 стандартных CubeSat&rsquo;а и служит промежутоным звеном между CubeSat&rsquo;ом и ракетой-носителем. P-POD - это прямоугольный контейнер с крышкой и пружинным механизмом. По сигналу с ракеты-носителя о начале вывода на орбиту включается освобождающий механизм P-POD&rsquo;а, несколько торсионных пружин в петле открывают крышку, и CubeSat&rsquo;ы выталкиваются пружиной по направляющим P-POD&rsquo;а (см. рис. 3а). P-POD изготовлен из анодированного алюминия. Выталкиваемые CubeSat&rsquo;ы скользят по нескольким направляющим при выводе на орбиту. CubeSat&rsquo;ы совместимы с P-POD при выполнении всех требований, приведенных в данном документе. P-POD имеет обратную совместимость, поэтому CubeSat&rsquo;ы, созданные в соответствии со Спецификацией конструкции CubeSat (CDS) версии 9 и выше, не будут иметь проблем с совместимостью. Разработчикам рекомендуется применять последнюю актуальную версию Спецификации конструкции CubeSat, чтобы использовать все возможности P-POD.</p>

<div class="row pagination-centered">
    <div class="span12">
        <img src="/img/cubespec/cubesat-figure3.png" width="1015" height="443" alt="P-POD">
    </div>
</div>

<h2 id="3-спецификация-cubesat">3. Спецификация CubeSat</h2>

<h3 id="3-1-общие-требования">3.1 Общие требования</h3>

<p>3.1.1 CubeSat&rsquo;ы с отклонениями от Спецификации конструкции CubeSat&rsquo;ов должны пройти процедуру согласования отклонений и отправить запрос на согласование отклонений DAR (см. раздел 1.3 и Дополнение А).
3.1.2 Все детали CubeSat&rsquo;а должны быть закреплены во время запуска, вывода на орбиту и функционирования, чтобы не создавать дополнительный космический мусор.
3.1.3 Использование пиротехники не допускается.
3.1.4 Любые двигательные системы должны быть спроектированы, установлены и протестированы в соответствии с <a href="afspcman91-710v3.html" target="_blank">AFSPCMAN 91-710 Volume 3</a>.
3.1.5 Двигательные системы должны иметь как минимум 3 блокировки активации.
3.1.6 Общий запас химической энергии не должен превышать 100 Вт·Ч (360 кДж).
3.1.6.1 Примечание: допускаются большие значения, но это может ограничить возможность запуска.
3.1.7 Применяемые опасные материалы  должны соответствовать требованиям <a href="afspcman91-710v3.html" target="_blank">AFSPCMAN 91-710 Volume 3</a>.
3.1.8 Применяемые материалы должны удовлетворять высокой устойчивости к дегазации для предотвращения загрязнения космического аппарата во время интеграции, тестирования и запуска. Список одобренных NASA подобных материалов можно найти на <a href="http://outgassing.nasa.gov" target="_blank">http://outgassing.nasa.gov</a>.
3.1.8.1 Применяемые материалы должны иметь <a href="material/tml.html" target="_blank">общую убыль массы</a> (Total Mass Loss) &lt;= 1.0%.
3.1.8.2 Применяемые Материалы кубсатов должны иметь <a href="material/cvcm.html" target="_blank">содержание летучих конденсируемых материалов</a> (Collected Volatile Condensable Material (CVCM)) &lt;= 0.1%.
3.1.9 Последняя версия Спецификации CubeSat является официальной версией, которой должны придерживаться разработчики. Последняя версия доступна по адресу: <a href="http://www.cubesat.org" target="_blank">http://www.cubesat.org</a>.
3.1.9.1 Калифорнийский Политехнический Университет рассылает обновления по списку подписчиков CubeSat при изменениях спецификации. Вы можете подписаться на обновления по адресу: <a href="http://www.cubesat.org/index.php/about-us/how-to-join" target="_blank">http://www.cubesat.org/index.php/about-us/how-to-join</a>.
3.1.10 Примечание: Некоторые ракеты-носители имеют дополнительные требования к величине магнитного поля. Кроме того сильные магниты могут помешать разделению CubeSat&rsquo;ов из одного P-POD. Рекомендуется ограничить магнитное поле за пределами внешнего габарита CubeSat&rsquo;а величиной не превышающей магнитное поле Земли более чем на 0.5 гс (Гаусс).
3.1.11  Конструкция CubeSat&rsquo;a должна обеспечивать при подъеме вентиляцию вентилируемого объема/пространства &lt; 2000 дюймов (50,8 метра).</p>

<h3 id="3-2-механические-требования-к-cubesat">3.2 Механические требования к CubeSat</h3>

<p>Кубсаты - это пикоспутники в форме куба. Основные изображения и размеры приведены на чертеже в приложении Б. Система координат P-POD представлена ниже на Рис. 4.</p>

<div class="row pagination-centered">
    <div class="span12">
        <img src="/img/cubespec/cubesat-figure4.png" width="577" height="437" alt="Координатная система PPOD">
    </div>
</div>

<p>Рис. 4: Координатная система P-POD</p>

<p>3.2.1 Система координат CubeSat должна соответствовать изображенной в приложении Б соответствующего размера. Система координат СubeSat должна совпадать с системой координат P-POD при интеграции.Точка начала системы координат CubeSat совпадает с геометрическим центром CubeSat.
3.2.1.1 Конфигурации CubeSat и физические размеры приведены в приложении Б.
3.2.1.2 Для CubeSat размера 3U+ доступен дополнительный объем, который представлен на рис 6 .
3.2.2 CubeSat устанавливается в P-POD стороной -Z.
3.2.3 Никакие компоненты на сторонах, отмеченных зеленым и желтым, не должны выступать более чем на 6.5 мм по нормали к поверхности.
3.2.3.1 При проверке перечня приемки CubeSat&rsquo;а (CubeSat Acceptance Checklist (CAC)) выступающие элементы измеряются от плоскости направляющих.
3.2.4 Выводимые на орбиту компоненты должны быть соединены с CubeSat&rsquo;том, но не P-POD&rsquo;ом.
3.2.5 Ширина направляющих должна быть не менее 8.5 мм.
3.2.6 Направляющие должны иметь шероховатость поверхности менее 1.6 мкм.
3.2.7 Кромки направляющих должны быть скруглены радиусом не менее 1 мм.
3.2.8 Торцы направляющих на на сторонах +/- Z должны иметь минимальный размер зоны контакта с направляющими соседних CubeSat&rsquo;ов 6.5 мм х 6.5 мм (см. Рис 6).
3.2.9 Не менее 75% поверхности направляющих должны соприкасаться с направляющими P-POD&rsquo;а. Остальные 25% направляющих могут быть утоплены, но направляющие не должны выходить за границы, указанные в спецификации.
3.2.10 Максимальная масса 1U CubeSat&rsquo;а не более 1.33 кг.
3.2.10.1 Примечание: большая масса может быть рассмотрена в зависимости от конкретной миссии (запуска).
3.2.11 Максимальная масса 1.5U CubeSat&rsquo;а не более 2.00 кг.
3.2.11.1 Примечание: большая масса может быть рассмотрена в зависимости от конкретной миссии (запуска).
3.2.12 Максимальная масса 2U CubeSat&rsquo;а не более 2.66 кг.
3.2.12.1 Примечание: большая масса может быть рассмотрена в зависимости от конкретной миссии (запуска).
3.2.13 Максимальная масса 3U CubeSat&rsquo;а должна быть 4.00 кг.
3.2.13.1 Примечание: большая масса может быть рассмотрена в зависимости от конкретной миссии (запуска).
3.2.14 Центр масс CubeSat&rsquo;а должен быть расположен в пределах 2 см от его геометрического центра в направлении осей X и Y.
3.2.14.1 Центр масс 1U CubeSat&rsquo;а должен быть расположен в пределах 2 см от его геометрического центра в направлении оси Z.
3.2.14.2 Центр масс 1.5U CubeSat&rsquo;а должен быть расположен в пределах 3 см от его геометрического центра в направлении оси Z.
3.2.14.3 Центр масс 2U CubeSat&rsquo;а должен быть расположен в пределах 4.5 см от его геометрического центра в направлении оси Z.
3.2.14.4 Центр масс 3U и 3U+ CubeSat&rsquo;ов должен быть расположен в пределах 7 см от его геометрического центра в направлении оси Z.
3.2.15 Для каркаса CubeSat&rsquo;а и его направляющих должен применяться Алюминий 7075, 6061, 5005, и/или 5052.
3.2.15.1 Если применяются другие материалы, разработчик должен отправить запрос согласования отклонений DAR и пройти процедуру согласования отклонений от требований спецификации.
3.2.16 Боковые поверхности направляющих и торцевые поверхности выступающих концов направляющих CubeSat&rsquo;а, которые соприкасаются с P-POD и соседними CubeSat&rsquo;ами, должны иметь твердое анодирование для предотвращения холодной сварки внутри P-POD.
3.2.17 CubeSat&rsquo;ы 1U, 1.5U и 2U  должны использовать разделительные упругие элементы для обеспечения надежного разделения.
3.2.17.1 Примечание: Характеристики рекомендуемого разделительного упругого элемента приведены ниже в Таблице 1. Эти элементы изготавливаются на заказ и доступны в Калифорнийском Политехническом Университете. Для получения разделительных упругих элементов обратитесь по адресу cubesat@gmail.com.
3.2.17.2 Разделительные упругие элементы в сжатом виде не должны выступать за пределы торцевой поверхности выступающих концов направляющих и могут быть утоплены глубже этой поверхности.
3.2.17.3 Разделительные пружины для 1U, 1.5U и 2U CubeSat&rsquo;ов должны располагаться в центре торцевой части выступающего конца направляющей со стороны -Z CubeSat&rsquo;а, как показано на рис. 7.
3.2.17.4 Разделительные упругие элементы не требуются для 3U CubeSat&rsquo;ов.</p>

<table class="table table-striped table-condensed table-bordered">
    <tr>
        <th>Характеристика</th>
        <th>Значение</th>
    </tr>
    <tr>
        <td>Материал толкателя</td>
        <td>Нержавеющая сталь</td>
    </tr>
    <tr>
        <td>Усилие начальное/конечное</td>
        <td>0.14 lbs. / 0.9 lbs. (63 г / 408 г)</td>
    </tr>
    <tr>
        <td>Ход толкателя</td>
        <td>минимум 0.16 дюйма над поверхностью отступа</td>
    </tr>
    <tr>
        <td>Резьба</td>
        <td>8-36 UNF-2B</td>
    </tr>
</table>

<p>Таблица 1. Свойства разделительных упругих элементов CubeSat&rsquo;а.</p>

<div class="row pagination-centered">
    <div class="span12">
        <img src="/img/cubespec/cubesat-figure5.jpg" width="632" height="440" alt="Разделительная пружина">
    </div>
</div>

<p>Рис. 5: Разделительный упругий элемент (толкатель).</p>

<div class="row pagination-centered">
    <div class="span12">
        <img src="/img/cubespec/cubesat-figure6.jpg" width="976" height="368" alt="дополнительный объем для 3U+">
    </div>
</div>

<p>Рис. 6: 3U+ Дополнительный Объем (&ldquo;Tuna Can&rdquo;)</p>

<div class="row pagination-centered">
    <div class="span12">
        <img src="/img/cubespec/cubesat-figure7.jpg" width="1040" height="680" alt="Местоположение разделительных упругих элементов и выключателей развертывания">
    </div>
</div>

<p>Рис. 7: Выключатели развертывания и разделительные упругие элементы</p>

<h3 id="3-3-электрические-требования">3.3 Электрические требования</h3>

<p>Электронные системы должны разрабатываться с учетом следующих требований.</p>

<p>3.3.1 Система энергоснабжения CubeSat&rsquo;а должна находиться в выключенном состоянии для предотвращения запуска и выполнения любых функций при нахождении внутри P-POD&rsquo;а с момента монтажа на ракету-носитель до момента вывода на орбиту. Электрические системы CubeSat&rsquo;а могут включать в себя различные подсистемы, такие как: система обработки команд и данных (Command and Data Handling (C&amp;DH), радиосвязь (RF Communication), определение и управление положением (Attitude Determine and Control (ADC)), привод складного механизма. Системы энергоснабжения CubeSat&rsquo;а включают в себя любые батарейные сборки, солнечные панели и батарейки таблеточного типа.
3.3.2 CubeSat должен иметь как минимум один выключатель развертывания на выступе направляющих, как указано на рисунке 7.
3.3.3 В нажатом состоянии переключатель развертывания CubeSat&rsquo;а должен разъединять электрическую схему питания от электрических потребителей; Это относится и к часам реального времени RTC.
3.3.4 Выключатель развертывания должен находиться в нажатом состоянии в течении всего времени когда CubeSat находится внутри P-POD.
3.3.4.1 В нажатом состоянии выключатель развертывания CubeSat не должен выступать над торцевой поверхностью выступающей части направляющей CubeSat&rsquo;а.
3.3.5 Если выключатель развертывания CubSat&rsquo;а из нажатого состояния перейдет в отжатое и обратно, таймеры передачи и развертывания должны быть сброшены к значению t=0.
3.3.6 Стержень, вынимаемый перед полетом (Remove Before Flight pin - RBF), и все коннекторы отрывных кабелей CubeSat&rsquo;а должны находиться  в области окон доступа, выделенных темно-зеленым цветом  в приложении Б.
3.3.6.1 Примечание: Вся диагностика и зарядка батарей будет происходить внутри P-POD при не нажатом выключателе развертывания.
3.3.7 CubeSat должен содержать стержень, вынимаемый перед полётом (RBF pin).
3.3.7.1 RBF pin должен отключать все питание спутника с момента его установки в CubeSat.
3.3.7.2 По завершению интеграции CubeSat&rsquo;а в P-POD необходимо извлечь RBF pin.
3.3.7.3 Установленный в спутник RBF пин не должен выступать более чем на 6.5 мм за плоскость направляющих.
3.3.8 CubSat должен содержать цепь защиты батареи от заряда/разряда во избежание несбалансированных состояний ячеек батареи.
3.3.9 При проектировании CubeSat необходимо выполнить как минимум одно из следующих требований по предотвращению случайной передачи радиосигнала. Настоятельно рекомендуется наличие трех независимых блокировок, что может уменьшить количество необходимой документации и исследований. Блокировка - это физическое устройство между источником энергии и опасным компонентом. Таймер не считается  независимой блокировкой.
3.3.9.1 CubeSat должен иметь одну блокировку включения передачи радиосигнала, и выходная мощность радиосигнала не должна превышать 1.5 Вт на входе передающей антенны.
3.3.9.2 CubeSat  должен иметь две независимых блокировки передачи радиосигнала.</p>

<p>###3.4 Требования по эксплуатации</p>

<p>CubeSat должен удовлетворять конкретным требованиям, зависящим от конкретного набора интегрированных CubeSat&rsquo;ов и выполняемых ими функций, чтобы соответствовать правовым обязательствам и обеспечивать безопасность других CubeSat&rsquo;ов.
3.4.1 Операторы должны получить и предоставить документы соответствующих лицензий на использование радиочастот.
3.4.1.1 Для использования любительских радиочастот, необходимо предоставить доказательство согласования использования частот с Международным Союзом Радиолюбителей  (International Amateur Radio Union (IARU)). Формы заявлений могут быть найдены на www.iaru.org.
3.4.2 CubeSat&rsquo;ы должны соответствовать государственным лицензионным соглашениям и ограничениям по использованию радиочастот.
3.4.3 Конструкции и оборудование миссий CubeSat должны соответствовать NPR 8715.6 по ограничению космического мусора.
3.4.3.1 Любой компонент кубсата должен (?) возвращаться/повторно входить/входить в атмосферу (?) с энергией менее 15 Дж.
3.4.3.2 Разработчики должны получить и предоставить документацию одобрения плана по снижению космического мусора от FCC (Federal Communication Commission - Федеральная комиссия связи (США)) (или NOAA (National Oceanic and Atmospheric Administration - Национальное управление по исследованию океанов и атмосферы (США)) если существует ?? imager ??)
3.4.3.2.1 Примечание: Правила/Регламент любительского радио FCC можно найти по адресу <a href="http://www.arrl.org/part-97-amateur-radio" target="_blank">http://www.arrl.org/part-97-amateur-radio</a>.
3.4.3.3 Примечание: Анализ на соответствие вышеуказанным правилам может быть проведен с помощью Программы для оценки космического мусора NASA DAS (Debris Assessment Software), доступной по адресу <a href="http://orbitaldebris.jsc.nasa.gov/mitigate/das.html" target="_blank">http://orbitaldebris.jsc.nasa.gov/mitigate/das.html</a>.
3.4.4 Все развертываемые элементы спутника, такие как штанги (фермы), антенны и солнечные панели должны иметь задержку разворачивания как минимум 30 мин после срабатывания выключателей развертывания при выталкивании из P-POD.
3.4.5 CubeSat&rsquo; не должны генерировать или передавать любые сигналы с момента интеграции в P-POD и в течении 45 минут после выхода на орбиту из P-POD&rsquo;а. Тем не менее CubeSat могут питаться (?) в последующем разворачивании от P-POD (?) (возможно опечатка FORM - FROM) (?) on following deployment form the P-POD (?).
3.4.6 Частным организациям (не относящимся к Правительству США), управляемым или подпадающим под юрисдикцию США, которые предполагают использование системы (спутника) дистанционных измерений (телеметрической системы), может потребоваться лицензия в по требованиям Закона США. Для получения дополнительной информации посетите <a href="http://www.nesdis.noaa.gov/CRSRA/licenseHome.html" target="_blank">http://www.nesdis.noaa.gov/CRSRA/licenseHome.html</a>. Нажмите на ссылку Application Process.
3.4.7 Калифорнийский Политехнический Университет произведет как минимум одну проверку соответствия, при которой оборудование разработчика будет исследовано и интегрировано в P-POD или TestPOD. Окончательная проверка соответствия будет произведена перед запуском. Для проверки соответствия спутника требованиям Спецификации используется Перечень Приемки CubeSat (CubeSat Acceptance Checklist (CAC)). Список приведен в  приложении к этому документу или доступен по адресу <a href="http://cubesat.org/index.php/documents/developers" target="_blank">http://cubesat.org/index.php/documents/developers</a>.</p>

<h2 id="4-требования-к-испытаниям">4. Требования к испытаниям</h2>

<p>Испытания проводятся с целью проверки соответствия всем требованиям поставщика запуска ракеты-носителя, а также любым дополнительным требованиям испытаний, необходимым для обеспечения безопасности CubeSat&rsquo;ов, P-POD&rsquo;а и основной миссии. Если условия работы (?) ракеты-носителя неизвестны, то для определения требований к испытаниям могут использоваться стандарты The General Environmental Verification Standard (GEVS, GSFC-STD-7000) и MIL-STD-1540. Стандарты GSFC-STD-7000 и MIL-STD-1540 являются полезной справочной информацией при определении условий испытаний и требований к испытаниям, но нет гарантий, что контрольные уровни в них полностью охватывают и удовлетворяют всем условиям испытаний ракеты-носителя. Официальными требованиями к испытаниям и контрольными уровнями считаются только предоставленные поставщиком запуска или интегратором P-POD. Требования к испытаниям от поставщика запуска имеют более высокий приоритет и заменяют собой требования из любого другого источника. P-POD испытывается подобным образом для обеспечения безопасности и качества изготовления перед интеграцией с CubeSat&rsquo;ами. Все CubeSat&rsquo;ы проходят как минимум все нижеприведенные испытания.</p>

<h3 id="4-1-случайные-колебания-random-vibration">4.1 Случайные колебания (Random Vibration)</h3>

<p>Испытание на случайные колебания проводятся в соответствии с требованиями поставщика запуска.</p>

<p>###4.2 Термический вакуумный отжиг (Thermal Vacuum Bakeout)</p>

<p>Термический вакуумный отжиг проводится, чтобы убедиться в надлежащем газовыделении компонентов. Спецификацию испытаний предоставляет поставщик запуска.</p>

<h3 id="4-3-ударное-испытание-shock-testing">4.3 Ударное испытание (Shock Testing)</h3>

<p>Ударное испытание должно быть производится согласно требованиям поставщика запуска.</p>

<h3 id="4-4-визуальный-осмотр-visual-inspection">4.4 Визуальный осмотр (Visual Inspection)</h3>

<p>Визуальный осмотр CubeSat&rsquo;а и измерение критических областей производится согласно приемочному листу CubeSat&rsquo;а CAC (Приложение В)</p>

<h3 id="4-5-принципы-испытаний-cubesat-ов">4.5 Принципы испытаний CubeSat&rsquo;ов</h3>

<p>CubeSat подвергается либо квалификационным испытаниям (проверка соответствия техническим условиям), либо испытаниям по сокращенной программе (protoflight) согласно диаграмме процесса испытаний CubeSat&rsquo;ов (CubeSat Testing Flow Diagram), представленной на Рис. 8. Контрольные уровни и продолжительности определяются поставщиком запуска или  интегратором P-POD.</p>

<h4 id="4-5-1-квалификационные-испытания">4.5.1 Квалификационные испытания</h4>

<p>Квалификационные испытания производятся на инженерном образце, идентичному полетной модели CubeSat&rsquo;а. Квалификационные уровни определяются поставщиком запуска или интегратором P-POD. Оба стандарта MIL-STD-1540 и LSP-REQ-317.01 используются в качестве руководства при определении уровней испытаний. После этого полётная модель подвергается приемочным испытаниям в TestPOD, затем интегрируется в полетный P-POD для окончательного испытания на случайные колебания. Если конструкция CubeSat&rsquo;а подверглась изменению или модификации после квалификационных испытаний, то могут потребоваться дополнительные испытания.</p>

<h4 id="4-5-2-испытание-по-сокращенной-программе-protoflight">4.5.2 Испытание по сокращенной программе (Protoflight)</h4>

<p>Испытание по сокращенной программе производиться на полетной модели CubeSat&rsquo;а. Уровни испытаний определяются поставщиком запуска или интегратором P-POD. Оба стандарта MIL-STD-1540 и LSP-REQ-317.01 используются в качестве руководства при определении уровней испытаний. Полётная модель подвергается испытаниям по сокращенной программе в TestPOD, затем интегрируется в полетный P-POD для окончательных приёмочных испытаний, испытаний качества изготовления и испытаний на случайные колебания. После испытаний по сокращенной программе полетная модель CubeSat&rsquo;а не разбирается и не модифицируется. Разборка оборудования после испытаний по сокращенной программе потребует подачи разработчиком &ldquo;Запроса проверки отклонений от   требований&rdquo; DAR и пройти процедуру согласования отклонений перед разборкой. Если конструкция CubeSat&rsquo;а подверглась изменению или модификации после испытаний по ускоренной программе, то могут потребоваться дополнительные испытания.</p>

<h4 id="4-5-3-приёмка">4.5.3 Приёмка</h4>

<p>После доставки и интеграции CubeSat в P-POD, дополнительные испытания проводятся над всей системой P-POD с интегрированными CubeSat&rsquo;ами. Данные испытания проверяет надлежащую интеграцию CubeSat&rsquo;а и P-POD. Кроме того, любые неизвестные и опасные взаимодействия между CubeSat&rsquo;ами могут быть выявлены во время приемочного испытания. Интегратор P-POD координирует и проводит приемочные испытания. Оба стандарта MIL-STD-1540 и LSP-REQ-317.01 используются в качестве руководства при определении уровней испытаний. С этого момента P-POD и находящиеся внутри CubeSat&rsquo;ы не разделяются. При обнаружении неисправности CubeSat&rsquo;а, решение о разделении P-POD принимается разработчиками CubeSat&rsquo;ов в конкретном P-POD и интегратором P-POD исходя из соображений безопасности. Разработчик несет ответственность за любые дополнительные испытания, требующимися в связи с доводочными исправлениями, с разделенными P-POD и CubeSat&rsquo;ами.</p>

<div class="row pagination-centered">
    <div class="span12">
        <object width="611.389" height="410.502" data="/img/cubespec/cubesat-figure8.svg" type="image/svg+xml"></object>
    </div>
</div>

</div>

      	]]>
      </turbo:content>
    </item>
    
    <item turbo="true">
      <title>Оптимизация web приложения с помощью YourKit и JMeter</title>
      <link>https://dernasherbrezon.com/posts/webapp-perf/</link>
      <pubDate>Fri, 28 Dec 2012 14:58:18 +0100</pubDate>
      
      <guid>https://dernasherbrezon.com/posts/webapp-perf/</guid>
      <description>Постановка задачи  web server - Jetty. Запускается в embedded режиме с помощью spring. Общая настройка очень похожа на http://wiki.eclipse.org/Jetty/Howto/Spring IoC - spring 3.0.5 Servlet - собственный сервлет для роутинга запросов к обработчикам. Mysql 5.5, jdbc driver 5.1.21 view - JSP + JSTL YourKit 11 JMeter 2.8  Приложение:
 две страницы требующие локализации. первая - статичная страница (главная). Собирается из разных кусочков jsp вторая - динамичная. Отображает некоторую сущность.</description>
      <turbo:content>
      	<![CDATA[
      		<header>
      			<h1>Оптимизация web приложения с помощью YourKit и JMeter</h1><figure>
				    	<img src="https://dernasherbrezon.com/img/webapp-perf/9.png"/>
				    </figure></header>
      		<div class='container entry-content'>
  

<h2 id="постановка-задачи">Постановка задачи</h2>

<ul>
<li>web server - Jetty. Запускается в embedded режиме с помощью spring. Общая настройка очень похожа на <a href="http://wiki.eclipse.org/Jetty/Howto/Spring" target="_blank">http://wiki.eclipse.org/Jetty/Howto/Spring</a></li>
<li>IoC - spring 3.0.5</li>
<li>Servlet - собственный сервлет для роутинга запросов к обработчикам.</li>
<li>Mysql 5.5, jdbc driver 5.1.21</li>
<li>view - JSP + JSTL</li>
<li>YourKit 11</li>
<li>JMeter 2.8</li>
</ul>

<p>Приложение:</p>

<ul>
<li>две страницы требующие локализации.</li>
<li>первая - статичная страница (главная). Собирается из разных кусочков jsp</li>
<li>вторая - динамичная. Отображает некоторую сущность. Например товар и его свойства.</li>
</ul>

<p>Итак, для начала будем оптимизировать первую страницу. Перед тем, как начать что-то оптимизировать, необходимо померить текущее состояние, найти узкие места. Для этого необходимо сконфигурировать JMeter. Он будет симулировать пользователей, которые кликают ссылки.</p>

<ol>
<li>Скачать JMeter можно тут: <a href="http://jmeter.apache.org/" target="_blank">http://jmeter.apache.org/</a></li>
<li>Запустить jmeter.sh и настроить тест:</li>
<li>Количество пользователей: 500
<img src="/img/webapp-perf/1.png" alt="" /></li>
<li>Настроить запрос: сервер находится по адресу localhost:8080 путь: / (главная). Так же нужно добавить http cache manager и http cookie manager, чтобы съэмулировать поведение реальных браузеров
<img src="/img/webapp-perf/2.png" alt="" /></li>
</ol>

<p>После этого, необходимо запустить jetty из под YourKit. Это очень удобно можно сделать, если использовать интеграцию с IDE. Например, Eclipse: <a href="http://www.yourkit.com/docs/12/help/eclipse.jsp" target="_blank">http://www.yourkit.com/docs/12/help/eclipse.jsp</a>. После запуска приложения, необходимо запустить JMeter на выполнение.</p>

<h2 id="анализ-данных">Анализ данных</h2>

<p>Первые вещи, которые бросаются в глаза это:</p>

<ul>
<li>278 потоков приложения
<img src="/img/webapp-perf/3.png" alt="" /></li>
<li>большой затуп всех этих ~200 потоков в самом начале
<img src="/img/webapp-perf/4.png" alt="" /></li>
</ul>

<p>Что говорят эти графики:</p>

<ul>
<li>Jetty сконфигурирован с использованием NIO. На каждый входящий запрос, NIO коннектор получает запрос и адресует его внутреннему threadpool&rsquo;у, который и обрабатывает этот запрос (потоки с именем qtp******). Поскольку пользователей больше 200, то создаются все потоки из внутреннего пула и новые пользователи ждут пока отработает запрос предыдущих пользователей. Такая схема обработки запросов достаточно правильная, однако тут есть тонкость: не в каждой машине есть ~250 ядер. А следовательно операционная система будет тратить больше времени на переключение между этими потоками. Поэтому максимальный размер пула необходимо изменить. Хорошая формула размера пула приведена здесь: <a href="http://www.ibm.com/developerworks/library/j-jtp0730/index.html#heading6" target="_blank">http://www.ibm.com/developerworks/library/j-jtp0730/index.html#heading6</a>. Настроить пул можно передав в JettyServer новый <code>org.eclipse.jetty.util.thread.QueuedThreadPool</code> c указанным свойством maxThreads.</li>
<li>Затуп вначале связан с первичной компиляцией jsp страницы. В development среде это очень полезная вещь: можно менять jsp страницы и сервер будет автоматически показывать новую версию. В production среде, это необходимо отключить. Это можно сделать в файле webdefault.xml в Jetty. Или переопределить параметры org.apache.jasper.servlet.JspServlet в web.xml приложения. Необходимо настроить параметры: scratchdir - в эту директорию необходимо поместить скопилированные jsp и параметр development = false - jsp сервлет не будет проверять новую версию файла, из-за этого сильно увеличится быстродействие, так как не будут использоваться локи внутри сервлета.</li>
</ul>

<p>После произведённых начальных оптимизаций можно посмотреть на потребляемые ресурсы.</p>

<p>На рисунке ниже приведён stacktrace узкого места (performance snapshot, CPU profiling: sampling):
<img src="/img/webapp-perf/5.png" alt="" /></p>

<p>В YourKit есть специальный инструмент, который называется &ldquo;Hot spots&rdquo;, но он выдаёт простым списком все узкие места и методы и не учитывает то, что одни узкие места вложены в другие (находятся в одном стеке вызовов). На картинке видно, что узкое место находится в index.jsp. Однако, на этой картинке не видно сколько раз вызывался этот метод и сколько времени (в среднем хотя бы) занимает обработка одного запроса. Для этого необходимо получить snapshot с использованием CPU profiling: Tracing:</p>

<p><img src="/img/webapp-perf/6.png" alt="" /></p>

<p>После этого можно получить snapshot с абсолютными значениями</p>

<p><img src="/img/webapp-perf/7.png" alt="" /></p>

<p>Как видно, обработка jsp страницы занимает <strong>34ms</strong>.</p>

<p>Зачем же нужны абсолютные значения? В режиме sampling YourKit выдаёт информацию об узких местах, это оптимальный способ узнать где приложение работает медленно и при этом профайлер даёт низкий overhead. Однако для итерационной оптимизации, этот метод не очень подходит, так как необходимо понимать на сколько увеличилось или уменьшилось быстродействие после каждой оптимизации.</p>

<p>Как видно из картинки, всё время занимает отрисовка страницы. Как это можно оптимизировать?</p>

<ol>
<li>Если приглядется к тому, что происходит при отрисовке, то видно что очень много времени занимает выполнение <a href="http://www.tutorialspoint.com/jsp/jstl_format_message_tag.htm" target="_blank">fmt:message</a>. Этот тэг используется для локализации страницы. Если посмотреть код <code>org.apache.taglibs.standard.tag.common.fmt.MessageSupport.doEndTag()</code> то видно, что там происходит слишком много общей логики, от которой можно отказаться. Для этого необходимо сделать следующие допущения (ввести ограничения): локализация приложения не зависит от параметров запроса пользователя - это позволяет закэшировать ResourceBundle на старте приложения, используется один и тот же ResourceBundle для всех типов сообщений. После оптимизации время отрисовки страницы на сервере стало занимать: <strong>7ms</strong>. <strong>Оптимизация 80%</strong>!</li>
<li>Кэширование. Бывает на разных уровнях. Для данной статичной страницы, можно сделать два уровня кэширования: 1. На уровне сервера - при старте страница полностью отрисовывается и помещается в кэш. При обращении пользователей, она отдаётся из кэша. 2. На уровне клиента - если пользователь запросил страницу, то браузер кэширует её и при последующем обращении отображает страницу из кэша. Поскольку наша страница статична, то её можно попробовать закэшировать. В протоколе HTTP предусмотрено множество способов кэширования данных. Очень хорошая статья про типы кэширования: <a href="http://betterexplained.com/articles/how-to-optimize-your-site-with-http-caching/" target="_blank">http://betterexplained.com/articles/how-to-optimize-your-site-with-http-caching/</a>. Для кэширования страницы мы будем использовать lastModifiedTime. По умолчанию в <code>javax.servlet.http.HttpServlet.getLastModified()</code> возвращает -1 (не использует lastModified). Какое же время необходимо возвращать на нашей странице? Поскольку у нас выключена перекомпиляция jsp на production, то новые изменения могут появится не раньше рестарта сервера. А значит lastModifiedTime можно вычислить следующим способом: на старте обработчика (сервлета) запомнить время System.currentTimeMillis()/1000 * 1000 и возвращать всегда его. После оптимизации время ответа стало занимать: <strong>3ms</strong>. Т.е. для пользователя, который посещает страницу второй и более раз <strong>оптимизация 91%</strong>.</li>
</ol>

<p>Настало время посмотреть на вторую страницу, тут несколько сложнее, так как есть больше логики приложения.</p>

<p>Для этого необходимо указать другой путь сервлета/обработчика запроса в JMeter. Например path: &ldquo;/servlet&rdquo;</p>

<p>Изначально отрисовка страницы занимает <strong>7ms</strong>, так как же и для первой страницы, выполнение бизнес логики занимает <strong>21ms</strong>. Бизнес логика заключается в получении из базы сущности. Сущность - иерархическая, т.е. состоит из нескольких простых сущностей, каждая из которой хранится в отдельной таблице. После запуска JMeter:</p>

<p><img src="/img/webapp-perf/8.png" alt="" /></p>

<p>Из этой картины видно, что потоки блокируются при получении <code>java.sql.Connection</code> из <code>org.apache.commons.dbcp.BasicDataSource</code>. Это происходит из-за того, что для обработки одного запроса несколько раз вызывается <code>datasource.getConnection</code> и <code>conn.close()</code> - т.е. соединение берётся и кладётся в пул. Это можно оптимизировать, если использовать ThreadBoundDatasource. Как он работает?</p>

<ol>
<li>Он реализует интерфейс <code>java.sql.Datasource</code> и работает поверх <code>org.apache.commons.dbcp.BasicDataSource</code></li>
<li>При получении запроса, в методе doGet он получает соединение и кэширует его для этого потока. Например, с помощью ThreadLocal.</li>
<li>При любом обращении datasource.getConnection() он возвращает это соединение.</li>
<li>Бизнес логика не закрывает соединение, оно закрывается на выходе из doGet.</li>
</ol>

<p>Алгоритм достаточно простой, но для большого приложения, где есть очень много сервлетов, контроллеров и простых потоков, реализовать и поддерживать его достаточно сложно: нужно не забывать получать и возвращать соединение в пул.</p>

<p>Реализовать этот алгоритм можно двумя способами:</p>

<ol>
<li>С использованием aop (aspect oriented programming) и aspectj. Для этого необходимо создать аннотацию, например, <code>@ThreadBoundDatasource(readOnly=false)</code> и пометить ею метод сервлета. Создать аспект, который будет создавайть соединение перед методом с этой аннотацией, а затем возвращать соединение после выполнения метода. У этого подхода есть недостатки: aspectj генерирует очень много мусора и как оказалось выигрыш в производительности не даёт (увеличивает время выполнения на ~1ms), создание Proxy объекта не позволяет посмотреть stacktrace в YourKit.</li>
<li>Ручное добавление логики к каждому из сервлетов. Из недостатков можно отметить рутинность операции и большую вероятность ошибок для большого проекта.</li>
</ol>

<p>После реализации алгоритма, график стал выглядеть следующим образом:</p>

<p><img src="/img/webapp-perf/9.png" alt="" /></p>

<p>Время обработки запроса стало <strong>16ms. Оптимизация 20%</strong></p>

<p>Как видно потоки больше не ждут соединения, или ждут но очень мало времени, так что YourKit не успевает это отобразить. Из блокировок остались блокировки на пуле тэгов. Небольшое исследование показало, что есть пул PerThreadTagHandlerPool, но в нём есть утечки памяти и его использование не рекомендовано: <a href="https://issues.apache.org/bugzilla/show_bug.cgi?id=43790" target="_blank">https://issues.apache.org/bugzilla/show_bug.cgi?id=43790</a></p>

<p>На следующим этапе оптимизации встала задача внедрения кэширования результатов запросов к базе данных. Performance snapshot показал, что узкое место приложения - это запрос к базе данных. Так же исходя из графика потребления памяти видно, что генерируется очень много мусора (~600Mb), который можно сократить если переиспользовать объекты:</p>

<p><img src="/img/webapp-perf/10.png" alt="" /></p>

<p>YourKit имеет замечательный UI на котором можно посмотреть сколько времени потрачено на сборку мусора и как при этом работали потоки:</p>

<p><img src="/img/webapp-perf/11.png" alt="" /></p>

<p>Белая область в работе потоков означает stop-the-world, когда останавливаются все потоки приложения и выполняется сборка мусора. Как видно, со временем сборка мусора начинает занимать больше времени.</p>

<p>Для кэширования использовалась библиотека <a href="http://ehcache.org/" target="_blank">Ehcache</a>.</p>

<p>После введения кэширования для некоторых объектов, время обработки бизнес логики стало составлять <strong>9ms</strong>. Что в сумме даёт <strong>оптимизацию 57%</strong>.</p>

<p>В YourKit есть замечательная метрика: количество и типы Exception&rsquo;ов и stacktrace мест, где они были вызваны. Генерация Exception - это очень ресурсоёмкая операция. Поэтому генерацию обычно стараются избегать в высоконагруженных приложениях. При запуске performance теста, данная метрика выдала следующую картину:</p>

<p><img src="/img/webapp-perf/12.png" alt="" /></p>

<p>Оказывается драйвер кидает SQLException при закрытии курсора, и проглатывает (не обрабатывает) его. На каждый запрос к базе кидается несколько SQLException. Это баг самого драйвера: <a href="http://bugs.mysql.com/bug.php?id=67318" target="_blank">http://bugs.mysql.com/bug.php?id=67318</a>. После того, как этот баг пофиксят, ожидается серьёзный прирост в производительности.</p>

<h2 id="выводы">Выводы</h2>

<ol>
<li>Современные фреймворки позволяют быстро разрабатывать приложения, но есть место для их оптимизации.</li>
<li>Настройки по умолчанию не всегда оптимальны для нагруженных проектов.</li>
<li>Даже проекты проверенные временем, не всегда оптимизированы под быстродействие.</li>
<li>Многоуровневое кэширование очень сильно разгружает сервер и увеличивает быстродействие.</li>
<li>Кэширование сократило объём генерируемого мусора, но серьёзных изменений не произошло, кривая роста мусора в памяти лишь немного стала пологой. Видимо есть ещё места, в которых генерируется мусор.</li>
</ol>

</div>

      	]]>
      </turbo:content>
    </item>
    
    <item turbo="true">
      <title>Log4j DOMConfigurator</title>
      <link>https://dernasherbrezon.com/posts/dom4jconfigurator/</link>
      <pubDate>Thu, 11 Oct 2012 15:14:18 +0100</pubDate>
      
      <guid>https://dernasherbrezon.com/posts/dom4jconfigurator/</guid>
      <description>DOMConfigurator не поддерживает подстановку свойств при реконфигурации. Будьте бдительны!
Use case:
 Конфигурация по умолчанию с использованием log4j.configuration параметра Получение свойств и проставление через System.setProperty() DOMConfigurator.configure(System.getProperty(&amp;quot;log4j.configuration&amp;quot;))  </description>
      <turbo:content>
      	<![CDATA[
      		<header>
      			<h1>Log4j DOMConfigurator</h1></header>
      		<div class='container entry-content'>
  <p>DOMConfigurator не поддерживает подстановку свойств при реконфигурации. Будьте бдительны!</p>

<p>Use case:</p>

<ol>
<li>Конфигурация по умолчанию с использованием <code>log4j.configuration</code> параметра</li>
<li>Получение свойств и проставление через <code>System.setProperty()</code></li>
<li><code>DOMConfigurator.configure(System.getProperty(&quot;log4j.configuration&quot;))</code></li>
</ol>

</div>

      	]]>
      </turbo:content>
    </item>
    
    <item turbo="true">
      <title>Производительность функции split</title>
      <link>https://dernasherbrezon.com/posts/splitperf/</link>
      <pubDate>Sat, 11 Aug 2012 15:14:18 +0100</pubDate>
      
      <guid>https://dernasherbrezon.com/posts/splitperf/</guid>
      <description>В одном из проектов в очередной раз пришлось писать собственную реализацию split строки, в связи с этим заинтересовался о производительности различных решений.
Для тестирования выбраны следующие кандидаты:
 JDK Guava Apache commons-lang Custom   Проводилось тестирование следующих параметров в различных комбинациях: короткая строка большое количество итераций, длинная строка малое количество итераций.
Поскольку Guava поддерживает lazy вычисление, то была добавлена ещё одна комбинация: отложенная итерация по результатам и непосредственная итерация.</description>
      <turbo:content>
      	<![CDATA[
      		<header>
      			<h1>Производительность функции split</h1></header>
      		<div class='container entry-content'>
  <p>В одном из проектов в очередной раз пришлось писать собственную реализацию split строки, в связи с этим заинтересовался о производительности различных решений.</p>

<p>Для тестирования выбраны следующие кандидаты:</p>

<ul>
<li>JDK</li>
<li>Guava</li>
<li>Apache commons-lang</li>
<li>Custom
<br /></li>
</ul>

<p>Проводилось тестирование следующих параметров в различных комбинациях: короткая строка большое количество итераций, длинная строка малое количество итераций.</p>

<p>Поскольку Guava поддерживает lazy вычисление, то была добавлена ещё одна комбинация: отложенная итерация по результатам и непосредственная итерация.</p>

<p>В результате получились следующие значения:</p>

<p><img src="/img/splitperf/1.png" alt="" />
<img src="/img/splitperf/2.png" alt="" />
<img src="/img/splitperf/3.png" alt="" />
<img src="/img/splitperf/4.png" alt="" /></p>

<p>Выводы:</p>

<ul>
<li>Стабильно плохой результат показывает Pattern.split. Он генерирует множество объектов, да и слишком общий для решения такой частной задачи. Использования паттерна это достаточно большой overhead.</li>
<li>для не lazy тестов google guava показывает достаточно плохой результат. Видимо это связано с количеством мусора который генерирует библиотека. В исходных кодах можно найти следующие конструкции:</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">String description <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StringBuilder<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;CharMatcher.is(&#34;</span><span style="color:#f92672">)</span>  
    <span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>Integer<span style="color:#f92672">.</span><span style="color:#a6e22e">toHexString</span><span style="color:#f92672">(</span>match<span style="color:#f92672">))</span>  
    <span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;)&#34;</span><span style="color:#f92672">)</span>  
    <span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">();</span>  
<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> CharMatcher<span style="color:#f92672">(</span>description<span style="color:#f92672">)</span> <span style="color:#f92672">{...};</span> </code></pre></div>
<ul>
<li>Заметное отставание даёт commons-lang на lazy итерациях. Наверное потому, что они не поддерживаются.</li>
<li>Как всегда победителем становится собственная реализация.
<br /></li>
</ul>

<p>Выводы 2:</p>

<p>Как говорят в google guava: &ldquo;Знайте свои библиотеки&rdquo;. Даже знаменитые библиотеки иногда могут быть написаны очень коряво. В частности в guava лежат очень много здравых идей, например, &ldquo;везде возвращать Iterable&rdquo; для lazy обхода. Это очень мощная идея, о которой я раньше не догадывался. Однако реализация очень сильно страдает от большого количество &ldquo;как-бы&rdquo; функционального кода, который в java сильно ударяет по производительности.</p>

</div>

      	]]>
      </turbo:content>
    </item>
    
    <item turbo="true">
      <title>Сборка пакета с помощью debconf</title>
      <link>https://dernasherbrezon.com/posts/debconf/</link>
      <pubDate>Sat, 11 Aug 2012 13:14:18 +0100</pubDate>
      
      <guid>https://dernasherbrezon.com/posts/debconf/</guid>
      <description>Недавно столкнулся с задачей создания .deb пакета. Поскольку информация в сети разбросана и само описание команд debhelper несколько сумбурно, ниже привожу список действий помогающих собрать архив с нуля:
Создание исходников.
#: mkdir package-1.0 #: echo &amp;quot;Sample file in package&amp;quot; &amp;gt; package-1.0/file  Создание специального архива с исходниками
#: tar czf package-1.0.tar.gz package-1.0/ #: dh_make -c apache -f ../package-1.0.tar.gz  Редактирование параметров пакета.
#: nano debian/control  Создание конфигураций:
#: nano debain/package.</description>
      <turbo:content>
      	<![CDATA[
      		<header>
      			<h1>Сборка пакета с помощью debconf</h1></header>
      		<div class='container entry-content'>
  <p>Недавно столкнулся с задачей создания .deb пакета. Поскольку информация в сети разбросана и само описание команд debhelper несколько сумбурно, ниже привожу список действий помогающих собрать архив с нуля:</p>

<p>Создание исходников.</p>

<pre><code>#: mkdir package-1.0
#: echo &quot;Sample file in package&quot; &gt; package-1.0/file
</code></pre>

<p>Создание специального архива с исходниками</p>

<pre><code>#: tar czf package-1.0.tar.gz package-1.0/
#: dh_make -c apache -f ../package-1.0.tar.gz
</code></pre>

<p>Редактирование параметров пакета.</p>

<pre><code>#: nano debian/control
</code></pre>

<p>Создание конфигураций:</p>

<pre><code>#: nano debain/package.templates

Template: package/test
Type: boolean
Default: true
Description: Test boolean property
  Test boolean property long description
</code></pre>

<p>Создание конфига</p>

<pre><code>#: nano debian/package.config

#!/bin/bash -e

. /usr/share/debconf/confmodule

db_input medium package/test || true
db_go || true
</code></pre>

<p>Вызов конфига из postinst скрипта. debhelper не может сгенерировать такой postinst так как &ldquo;слишком сложно&rdquo;.</p>

<pre><code>#: mv debian/postinst.ex debian/postinst
#: nano debian/postinst

...
configure)
. /usr/share/debconf/confmodule
db_get package/test
echo &quot;$RET;
;;
...
</code></pre>

<p>Копирование скриптов в некую временную директорию</p>

<pre><code>#: sudo dh_installdebconf
#: sudo dh_installdeb
</code></pre>

<p>Создание пакета</p>

<pre><code>#: sudo dh_builddeb

#: cd ../
</code></pre>

<p>Пакет package_1.0-1_any.deb готов.
Имя пакета package изменить везде выше на необходимое. Например: mycoollapp.</p>

</div>

      	]]>
      </turbo:content>
    </item>
    
    <item turbo="true">
      <title>Выбор быстрого алгоритма поиска подстроки</title>
      <link>https://dernasherbrezon.com/posts/substring/</link>
      <pubDate>Mon, 11 Jun 2012 13:14:18 +0100</pubDate>
      
      <guid>https://dernasherbrezon.com/posts/substring/</guid>
      <description>Есть такая задача: отфильтровать строки в множестве файлов. Вариантов решения я вижу несколько:
 ReplaceAll. String.replaceAll(&amp;ldquo;pattern&amp;rdquo;,&amp;ldquo;$1&amp;rdquo; + 1); Pattern. Pattern p = Pattern.compile(&amp;ldquo;pattern&amp;rdquo;); and etc. Ручной способ через indexOf и substring   Первый способ можно сразу отбросить так как он медленный: на каждый файл будет компилироваться pattern. На следующих двух можно остановиться поподробнее.
У меня было чувство что ручной способ всегда быстрее, хоть и немного дольше в реализации. Я написал небольшой тест, чтобы проверить насколько быстрее.</description>
      <turbo:content>
      	<![CDATA[
      		<header>
      			<h1>Выбор быстрого алгоритма поиска подстроки</h1></header>
      		<div class='container entry-content'>
  <p>Есть такая задача: отфильтровать строки в множестве файлов. Вариантов решения я вижу несколько:</p>

<ul>
<li>ReplaceAll. String.replaceAll(&ldquo;pattern&rdquo;,&ldquo;$1&rdquo; + 1);</li>
<li>Pattern. Pattern p = Pattern.compile(&ldquo;pattern&rdquo;); and etc.</li>
<li>Ручной способ через indexOf и substring
<br /></li>
</ul>

<p>Первый способ можно сразу отбросить так как он медленный: на каждый файл будет компилироваться pattern. На следующих двух можно остановиться поподробнее.</p>

<p>У меня было чувство что ручной способ всегда быстрее, хоть и немного дольше в реализации. Я написал небольшой тест, чтобы проверить насколько быстрее. Результат графически изображён ниже:</p>

<p><img src="/img/substring/1.png" alt="" /></p>

<p>Тест запускал фильтрацию одного и того же файла 10к раз. Размер файла - 4286 символов. Время выполнения абсолютное и указано в миллисекундах.</p>

<p>Столбец А: время выполнения фильтрации с помощью ручного способа</p>

<p>Столбец В: время выполнения фильтрации с помощью pattern&rsquo;а</p>

<p><strong>Вывод 1</strong>: ручная фильтрация на порядок быстрее фильтрации с помощью pattern. Если не нужно производить более сложных подстановок, то ручной способ значительно лучше.</p>

<p><strong>Вывод 2</strong>: при линейном увеличении размера файла, время фильтрации возрастает линейно для обоих способов.</p>

</div>

      	]]>
      </turbo:content>
    </item>
    
    <item turbo="true">
      <title>Производительность Hibernate Validator</title>
      <link>https://dernasherbrezon.com/posts/hibernate-perf/</link>
      <pubDate>Wed, 11 Apr 2012 13:14:18 +0100</pubDate>
      
      <guid>https://dernasherbrezon.com/posts/hibernate-perf/</guid>
      <description>Недавно столкнулся с библиотекой Hibernate Validator и jsr 303 в частности. Ниже привожу небольшой микро-бенчмарк тестирования производительности. Тестовый POJO:
public class BusinessObject { @NotBlank private String name; @CustomNotNull(groups = { APIValidationGroup.class }) private String uuid; public String getName() { return name; } public void setName(String name) { this.name = name; } public String getUuid() { return uuid; } public void setUuid(String uuid) { this.uuid = uuid; } }  Для чистоты эксперимента и приближения к реальному сценарию я сделал кастомную валидацию, которая просто проверяет на null:</description>
      <turbo:content>
      	<![CDATA[
      		<header>
      			<h1>Производительность Hibernate Validator</h1></header>
      		<div class='container entry-content'>
  <p>Недавно столкнулся с библиотекой Hibernate Validator и jsr 303 в частности. Ниже привожу небольшой микро-бенчмарк тестирования производительности.
Тестовый POJO:</p>

<pre><code>public class BusinessObject {  

    @NotBlank  
    private String name;  
    @CustomNotNull(groups = { APIValidationGroup.class })  
    private String uuid;  

    public String getName() {  
        return name;  
    }  

    public void setName(String name) {  
        this.name = name;  
    }  

    public String getUuid() {  
        return uuid;  
    }  

    public void setUuid(String uuid) {  
        this.uuid = uuid;  
    }  

}  
</code></pre>

<p>Для чистоты эксперимента и приближения к реальному сценарию я сделал кастомную валидацию, которая просто проверяет на null:</p>

<pre><code>public class CustomNotNullValidator implements ConstraintValidator&lt;CustomNotNull, String&gt; {  

    public void initialize(CustomNotNull constraintAnnotation) {  
    }  

    public boolean isValid(String value, ConstraintValidatorContext context) {  
        if( value == null ) {  
            return false;  
        }  
        return true;  
    }  
}
</code></pre>

<p>Собственно сам тест:</p>

<pre><code>public static void main(String[] args) {  

    int heatCount = 10000;  
    int count = 1000000;  

    Validator validator = Validation.buildDefaultValidatorFactory().getValidator();  

    BusinessObject validObject = new BusinessObject();  
     validObject.setName(&quot;123&quot;);  
     validObject.setUuid(&quot;123&quot;);  

     for (int i = 0; i &lt; heatCount; i++) {  
      validator.validate(validObject, Default.class);  
     }  

     long start = System.currentTimeMillis();  
     for (int i = 0; i &lt; count; i++) {  
      validator.validate(validObject, Default.class);  
     }  
     long diff = (System.currentTimeMillis() - start);  
     System.out.println(&quot;hibernate validation absolute: &quot; + diff + &quot; avg: &quot; + ((double)diff / count));  

     for (int i = 0; i &lt; heatCount; i++) {  
      validate(validObject);  
     }  

     start = System.currentTimeMillis();  
     for (int i = 0; i &lt; count; i++) {  
      validate(validObject);  
     }  
     diff = (System.currentTimeMillis() - start);  
     System.out.println(&quot;static validation absolute: &quot; + diff + &quot; avg: &quot; + ((double)diff / count));  

     start = System.currentTimeMillis();  
     for (int i = 0; i &lt; count; i++) {  
      validator.validate(validObject, APIValidationGroup.class);  
     }  
     diff = (System.currentTimeMillis() - start);  
     System.out.println(&quot;hibernate custom validation absolute: &quot; + diff + &quot; avg: &quot; + ((double)diff / count));  

     start = System.currentTimeMillis();  
     for (int i = 0; i &lt; count; i++) {  
      validateCustom(validObject);  
     }  
     diff = (System.currentTimeMillis() - start);  
     System.out.println(&quot;static custom validation absolute: &quot; + diff + &quot; avg: &quot; + ((double)diff / count));  
    }  

    private static boolean validate(BusinessObject obj) {  
     if (StringUtils.isBlank(obj.getName())) {  
      return false;  
     }  
     return true;  
    }  

    private static boolean validateCustom(BusinessObject obj) {  
     if (!validate(obj)) {  
      return false;  
     }  
     if (obj.getUuid() == null) {  
      return false;  
     }  
     return true;  
}
</code></pre>

<p>Результаты выполнения следующие (hibernate validator 4.2.0.Final):</p>

<ul>
<li>hibernate validation absolute: 2410 avg: 0.00241</li>
<li>static validation absolute: 17 avg: 1.7E-5</li>
<li>hibernate custom validation absolute: 3407 avg: 0.003407</li>
<li>static custom validation absolute: 16 avg: 1.6E-5
<br /></li>
</ul>

<p>Выводы:</p>

<ol>
<li>Hibernate валидация на ровном месте даёт падение производительности в ~150 раз. Поэтому если Ваше приложение это low-latency система, то, возможно, стоит подумать сколько объектов нужно проверять и как много полей. Возможно (но не гарантированно) стоит делать проверки через static методы.</li>
<li>Однако если посмотреть абсолютные величины, то заметно, что удобство и гибкость в настройки валидации стоит всего 0.002 миллисекунды. Если у Вас CRUD интернет приложение, то Hibernate validator будет гораздо лучшим выбором.</li>
</ol>

</div>

      	]]>
      </turbo:content>
    </item>
    
    <item turbo="true">
      <title>Оптимизация spring jmx</title>
      <link>https://dernasherbrezon.com/posts/spring-jmx-tuning/</link>
      <pubDate>Sun, 11 Dec 2011 13:14:18 +0100</pubDate>
      
      <guid>https://dernasherbrezon.com/posts/spring-jmx-tuning/</guid>
      <description>Spring по умолчанию позволяет настроить экспорт бинов в jmx. Сделано это через удобные аннотации @ManagedResource. Однако существует сценарий при котором поведение по умолчанию не совсем подходит. Рассмотрим этот случай:
 spring context лениво инициализируется. Очень удобно если есть некоторый db-context.xml в котором описаны все Datasource. Соответственно инициализируются только те которые используются. Также очень удобно при ограниченных ресурсах. fail-fast + старт только необходимого. org.springframework.jmx.export.MBeanExporter умеет инициализировать JMX бины для ленивых spring бинов.</description>
      <turbo:content>
      	<![CDATA[
      		<header>
      			<h1>Оптимизация spring jmx</h1></header>
      		<div class='container entry-content'>
  <p>Spring по умолчанию позволяет настроить экспорт бинов в jmx. Сделано это через удобные аннотации @ManagedResource. Однако существует сценарий при котором поведение по умолчанию не совсем подходит. Рассмотрим этот случай:</p>

<ul>
<li>spring context лениво инициализируется. Очень удобно если есть некоторый db-context.xml в котором описаны все Datasource. Соответственно инициализируются только те которые используются. Также очень удобно при ограниченных ресурсах. fail-fast + старт только необходимого.</li>
<li>org.springframework.jmx.export.MBeanExporter умеет инициализировать JMX бины для ленивых spring бинов. Как это происходит: если spring бин - лениво инициализируется, то создаётся proxy через cglib который и будет jmx бином. При первом обращении к его методам/аттрибутам происходит инициализация spring бина.
<br /></li>
</ul>

<p>Проблема:</p>

<ul>
<li>возможна инициализация ненужных соединений. Список бинов содержит все возможные jmx бины.
<br /></li>
</ul>

<p>Решение:</p>

<ul>
<li>Необходимо создать BeanPostProcessor для контроля уже проинициализированных бинов.
<br /></li>
</ul>

<p>Например:</p>

<pre><code>import java.util.ArrayList;  
import java.util.List;  

import org.springframework.beans.BeansException;  
import org.springframework.beans.factory.config.BeanPostProcessor;  

public class StartedBeansAwarePostProcessor implements BeanPostProcessor {  

 private final List&lt;String&gt; beanNames = new ArrayList&lt;String&gt;();  

 @Override  
 public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {  
  return bean;  
 }  

 @Override  
 public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {  
  beanNames.add(beanName);  
  return bean;  
 }  

 public boolean isStarted(String beanName) {  
  return beanNames.contains(beanName);  
 }  

} 
</code></pre>

<p>После этого необходимо создать свой Assembler. Например:</p>

<pre><code>import org.springframework.beans.factory.annotation.Required;  
import org.springframework.jmx.export.assembler.MetadataMBeanInfoAssembler;  
import org.springframework.jmx.support.JmxUtils;  

public class LazyAssembler extends MetadataMBeanInfoAssembler {  

 private StartedBeansAwarePostProcessor startedBeans;  

 @Override  
 public boolean includeBean(Class beanClass, String beanName) {  
  if (startedBeans.isStarted(beanName)) {  
   if (isMBean(beanClass)) {  
    return true;  
   }  
   return super.includeBean(beanClass, beanName);  
  }  
  return false;  
 }  

 @Required  
 public void setStartedBeans(StartedBeansAwarePostProcessor startedBeans) {  
  this.startedBeans = startedBeans;  
 }  

 private boolean isMBean(Class beanClass) {  
  return JmxUtils.isMBean(beanClass);  
 }  

} 
</code></pre>

<p>И сконфигурировать spring контекст:</p>

<pre><code>&lt;bean id=&quot;lazyAssembler&quot; class=&quot;LazyAssembler&quot; p:attributeSource-ref=&quot;jmxAttributeSource&quot;&gt;  
 &lt;property name=&quot;startedBeans&quot; ref=&quot;startedBeanAwarePostProcessor&quot; /&gt;  
&lt;/bean&gt;  
&lt;bean id=&quot;startedBeanAwarePostProcessor&quot; class=&quot;StartedBeansAwarePostProcessor&quot; /&gt;  
&lt;bean name=&quot;mbeanServer&quot; class=&quot;org.springframework.jmx.support.MBeanServerFactoryBean&quot; p:locateExistingServerIfPossible=&quot;true&quot; /&gt;  
&lt;bean id=&quot;jmxAttributeSource&quot; class=&quot;org.springframework.jmx.export.annotation.AnnotationJmxAttributeSource&quot; /&gt;  
&lt;bean id=&quot;mbeanExporter&quot; class=&quot;org.springframework.jmx.export.MBeanExporter&quot;  
 p:server-ref=&quot;mbeanServer&quot;&gt;  
 &lt;property name=&quot;assembler&quot; ref=&quot;lazyAssembler&quot; /&gt;  
 &lt;property name=&quot;autodetectMode&quot; value=&quot;2&quot; /&gt;  
 &lt;property name=&quot;namingStrategy&quot;&gt;  
  &lt;bean class=&quot;org.springframework.jmx.export.naming.MetadataNamingStrategy&quot;&gt;  
   &lt;property name=&quot;attributeSource&quot; ref=&quot;jmxAttributeSource&quot; /&gt;  
   &lt;property name=&quot;defaultDomain&quot; value=&quot;domain&quot; /&gt;  
  &lt;/bean&gt;  
 &lt;/property&gt;  
&lt;/bean&gt; 
</code></pre>

<p>Особое внимание на параметр: autodetectMode. Он должен обязательно быть равен 2, иначе MBeanExporter будет игнорировать Assembler при принятии решении о том включать бин или нет. Теперь можно инициализировать контекст. Например:</p>

<pre><code>ctx.getBean(SomeBean.class); //инициализация корневого бина. По зависимостям должна инициализировать все бины необходимые для работы приложения. StartedBeansAwarePostProcessor запоминает все проинициализированные бины.  
ctx.getBean(&quot;mbeanExporter&quot;); //инициализация jmx бинов. Выполнять строго после инициализации всех бинов приложения.
</code></pre>

</div>

      	]]>
      </turbo:content>
    </item>
    
    <item turbo="true">
      <title>Оптимизация spring-mvc</title>
      <link>https://dernasherbrezon.com/posts/spring-mvc-tuning/</link>
      <pubDate>Fri, 11 Nov 2011 13:14:18 +0100</pubDate>
      
      <guid>https://dernasherbrezon.com/posts/spring-mvc-tuning/</guid>
      <description>Общие решения всегда медленнее частных. Ниже я собираюсь немного оптимизировать spring-mvc. Оптимизация прежде всего рассчитана на уменьшение генерируемого мусора. Прежде чем начать оптимизировать надо определиться какие функции фреймворка можно выкинуть и какими фичами пренебречь:
 ISO-8859-1-encoded URLs. Человеко-понятные-урл (ЧПУ) используются SEO продвижения в поисковых движках. Но что если это не нужно? Зачем на каждый запрос тратить процессорное время и память? Всегда абсолютные пути для сервлетов-контроллёров. По умолчанию spring-mvc позволяет использовать относительные пути для include запросов.</description>
      <turbo:content>
      	<![CDATA[
      		<header>
      			<h1>Оптимизация spring-mvc</h1></header>
      		<div class='container entry-content'>
  <p>Общие решения всегда медленнее частных. Ниже я собираюсь немного оптимизировать spring-mvc. Оптимизация прежде всего рассчитана на уменьшение генерируемого мусора. Прежде чем начать оптимизировать надо определиться какие функции фреймворка можно выкинуть и какими фичами пренебречь:</p>

<ul>
<li>ISO-8859-1-encoded URLs. Человеко-понятные-урл (ЧПУ) используются SEO продвижения в поисковых движках. Но что если это не нужно? Зачем на каждый запрос тратить процессорное время и память?</li>
<li>Всегда абсолютные пути для сервлетов-контроллёров. По умолчанию spring-mvc позволяет использовать относительные пути для include запросов. При оптимизации выполненной ниже и использовании Jetty результат такой же. Возможно это актуально для других контейнеров.</li>
<li>Не использовать jstl. Достаточно спорное предположение, однако кто то может не использовать jstl и писать на обычных JSP. Я не знаю jstl. И пишу &lt;% %&gt;.
<br /></li>
</ul>

<p>Итак первая достаточно безболезненная оптимизация не требующая никаких жертв: выключить publishEvent в DispatcherServlet. По умолчанию он отправляет в ApplicationContext сообщение о времени обработки запроса. В production зачастую уже поздно что то мерить. Делается это в web.xml:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;init-param&gt;</span>  
	<span style="color:#f92672">&lt;param-name&gt;</span>publishEvents<span style="color:#f92672">&lt;/param-name&gt;</span>  
	<span style="color:#f92672">&lt;param-value&gt;</span>false<span style="color:#f92672">&lt;/param-value&gt;</span>  
<span style="color:#f92672">&lt;/init-param&gt;</span></code></pre></div>
<p>Избавиться от @RequestMapping. Это очень удобно передавать @Param напрямую в метод. Однако реализация AnnotationMethodHandlerAdapter в spring-mvc достаточно требовательна к ресурсам и генерирует кучу мусора на каждый запрос. Логичнее было бы сделать найденные методы кешируемыми, но согласно <a href="https://jira.springsource.org/browse/SPR-6151" target="_blank">https://jira.springsource.org/browse/SPR-6151</a> разработчики считают сложным пофиксить. Поэтому для простоты и небольшого увеличения скорости сделаем новый контроллёр:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">FastController</span> <span style="color:#f92672">{</span>  
  
    String <span style="color:#a6e22e">handleRequest</span><span style="color:#f92672">(</span>HttpServletRequest request<span style="color:#f92672">,</span> HttpServletResponse response<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception<span style="color:#f92672">;</span>  
      
    String <span style="color:#a6e22e">getRequestMappingURL</span><span style="color:#f92672">();</span>  

<span style="color:#f92672">}</span></code></pre></div>
<p>Чем он лучше чем org.springframework.web.servlet.mvc.Controller? Он позволяет задавать url в том же месте где и содержится его реализация. Не нужно делать лишних движений чтобы добавить его в spring.xml. Соответственно необходимо определить классы которые будут его использовать:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FastUrlDetector</span> <span style="color:#66d9ef">extends</span> AbstractDetectingUrlHandlerMapping <span style="color:#f92672">{</span>  
  
      
    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">FastUrlDetector</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>  
        setAlwaysUseFullPath<span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>  
        setUrlDecode<span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>  
    <span style="color:#f92672">}</span>  
      
    <span style="color:#a6e22e">@Override</span>  
    <span style="color:#66d9ef">protected</span> String<span style="color:#f92672">[]</span> <span style="color:#a6e22e">determineUrlsForHandler</span><span style="color:#f92672">(</span>String beanName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
        ApplicationContext context <span style="color:#f92672">=</span> getApplicationContext<span style="color:#f92672">();</span>  
        Class<span style="color:#f92672">&lt;?&gt;</span> handlerType <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getType</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">);</span>  
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>FastController<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isAssignableFrom</span><span style="color:#f92672">(</span>handlerType<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>  
            FastController controller <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>FastController<span style="color:#f92672">)</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">);</span>  
            String result <span style="color:#f92672">=</span> controller<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequestMappingURL</span><span style="color:#f92672">();</span>  
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>result <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;controller doesnt have url mapping: &#34;</span> <span style="color:#f92672">+</span> beanName<span style="color:#f92672">);</span>  
            <span style="color:#f92672">}</span>  
            <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span> result<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">()</span> <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;controller doesnt have url mapping: &#34;</span> <span style="color:#f92672">+</span> beanName<span style="color:#f92672">);</span>  
            <span style="color:#f92672">}</span>  
            <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span> <span style="color:#f92672">!</span>result<span style="color:#f92672">.</span><span style="color:#a6e22e">startsWith</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;only absolute urls are required. Beanname: &#34;</span> <span style="color:#f92672">+</span> beanName <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; Url: &#34;</span> <span style="color:#f92672">+</span> result<span style="color:#f92672">);</span>  
            <span style="color:#f92672">}</span>  
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> String<span style="color:#f92672">[]{</span>result<span style="color:#f92672">};</span>  
        <span style="color:#f92672">}</span>  
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>  
    <span style="color:#f92672">}</span>  
  
<span style="color:#f92672">}</span>  
  
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FastMethodHandlerAdapter</span> <span style="color:#66d9ef">implements</span> HandlerAdapter <span style="color:#f92672">{</span>  
  
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">supports</span><span style="color:#f92672">(</span>Object handler<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>handler <span style="color:#66d9ef">instanceof</span> FastController<span style="color:#f92672">);</span>  
    <span style="color:#f92672">}</span>  
  
    <span style="color:#66d9ef">public</span> ModelAndView <span style="color:#a6e22e">handle</span><span style="color:#f92672">(</span>HttpServletRequest request<span style="color:#f92672">,</span> HttpServletResponse response<span style="color:#f92672">,</span> Object handler<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>  
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ModelAndView<span style="color:#f92672">(((</span>FastController<span style="color:#f92672">)</span> handler<span style="color:#f92672">).</span><span style="color:#a6e22e">handleRequest</span><span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">));</span>  
    <span style="color:#f92672">}</span>  
  
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">getLastModified</span><span style="color:#f92672">(</span>HttpServletRequest request<span style="color:#f92672">,</span> Object handler<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
 <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>handler <span style="color:#66d9ef">instanceof</span> LastModified<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
  <span style="color:#66d9ef">return</span> <span style="color:#f92672">((</span>LastModified<span style="color:#f92672">)</span> handler<span style="color:#f92672">).</span><span style="color:#a6e22e">getLastModified</span><span style="color:#f92672">(</span>request<span style="color:#f92672">);</span>  
 <span style="color:#f92672">}</span>  
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">;</span>  
    <span style="color:#f92672">}</span>  
  
<span style="color:#f92672">}</span></code></pre></div>
<p>Они практически не генерируют мусора. Убрать new ModelAndView не получится не переписав DispatcherServlet. Тем более генерация ModelAndView занимает небольшой процент мусора генерируемого при каждом запросе. После этого необходимо добавить Adapter и Decoder в spring.xml чтобы они автоматически подцеплялись DispatcherServlet при поиске контроллёров.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;FastMethodHandlerAdapter&#34;</span><span style="color:#f92672">/&gt;</span>  
<span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;FastUrlDetector&#34;</span> <span style="color:#f92672">/&gt;</span>  </code></pre></div>
<p>Далее. Следующим большим местом которое генерирует много мусора является Renderer. Я не знаю как работает jstl и почему spring-mvc делает множество приседаний для его работы. Поэтому я просто выкинул JstlView (которое используется по умолчанию для .jsp) и заменил его на:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FastJSPView</span> <span style="color:#66d9ef">extends</span> AbstractUrlBasedView <span style="color:#f92672">{</span>  
  
    <span style="color:#a6e22e">@Override</span>  
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">renderMergedOutputModel</span><span style="color:#f92672">(</span>Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Object<span style="color:#f92672">&gt;</span> model<span style="color:#f92672">,</span> HttpServletRequest request<span style="color:#f92672">,</span> HttpServletResponse response<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>  
        RequestDispatcher rd <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequestDispatcher</span><span style="color:#f92672">(</span>getUrl<span style="color:#f92672">());</span>  
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>useInclude<span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>  
            response<span style="color:#f92672">.</span><span style="color:#a6e22e">setContentType</span><span style="color:#f92672">(</span>getContentType<span style="color:#f92672">());</span>  
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>logger<span style="color:#f92672">.</span><span style="color:#a6e22e">isDebugEnabled</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>  
                logger<span style="color:#f92672">.</span><span style="color:#a6e22e">debug</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Including resource [&#34;</span> <span style="color:#f92672">+</span> getUrl<span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;] in InternalResourceView &#39;&#34;</span> <span style="color:#f92672">+</span> getBeanName<span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#39;&#34;</span><span style="color:#f92672">);</span>  
            <span style="color:#f92672">}</span>  
            rd<span style="color:#f92672">.</span><span style="color:#a6e22e">include</span><span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">);</span>  
        <span style="color:#f92672">}</span>  
  
        <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>  
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>logger<span style="color:#f92672">.</span><span style="color:#a6e22e">isDebugEnabled</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>  
                logger<span style="color:#f92672">.</span><span style="color:#a6e22e">debug</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Forwarding to resource [&#34;</span> <span style="color:#f92672">+</span> getUrl<span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;] in InternalResourceView &#39;&#34;</span> <span style="color:#f92672">+</span> getBeanName<span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#39;&#34;</span><span style="color:#f92672">);</span>  
            <span style="color:#f92672">}</span>  
            rd<span style="color:#f92672">.</span><span style="color:#a6e22e">forward</span><span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">);</span>  
        <span style="color:#f92672">}</span>          
    <span style="color:#f92672">}</span>  
      
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">useInclude</span><span style="color:#f92672">(</span>HttpServletRequest request<span style="color:#f92672">,</span> HttpServletResponse response<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>WebUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isIncludeRequest</span><span style="color:#f92672">(</span>request<span style="color:#f92672">)</span> <span style="color:#f92672">||</span> response<span style="color:#f92672">.</span><span style="color:#a6e22e">isCommitted</span><span style="color:#f92672">());</span>  
    <span style="color:#f92672">}</span>  
  
<span style="color:#f92672">}</span>  
  
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FastJSPViewResolver</span> <span style="color:#66d9ef">extends</span> UrlBasedViewResolver <span style="color:#f92672">{</span>  
  
    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">FastJSPViewResolver</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>  
        setViewClass<span style="color:#f92672">(</span>FastJSPView<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>  
    <span style="color:#f92672">}</span>  
      
<span style="color:#f92672">}</span>  </code></pre></div>
<p>Часть кода в FastJSPView скопирована с JstlView. И соответственно необходимо добавить в spring.xml:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;bean</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;viewResolver&#34;</span>  
 <span style="color:#a6e22e">class=</span><span style="color:#e6db74">&#34;com.st.FastJSPViewResolver&#34;</span><span style="color:#f92672">&gt;</span>  
 <span style="color:#f92672">&lt;property</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;prefix&#34;</span><span style="color:#f92672">&gt;</span>  
  <span style="color:#f92672">&lt;value&gt;</span>/WEB-INF/pages/<span style="color:#f92672">&lt;/value&gt;</span>  
 <span style="color:#f92672">&lt;/property&gt;</span>  
 <span style="color:#f92672">&lt;property</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;suffix&#34;</span><span style="color:#f92672">&gt;</span>  
  <span style="color:#f92672">&lt;value&gt;</span>.jsp<span style="color:#f92672">&lt;/value&gt;</span>  
 <span style="color:#f92672">&lt;/property&gt;</span>  
<span style="color:#f92672">&lt;/bean&gt;</span> </code></pre></div>
<p>Чтобы проверить что есть некоторые улучшения ниже приведён тестовый контроллер который перенаправляет запрос в jsp:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Controller</span>  
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FastServlet</span> <span style="color:#66d9ef">implements</span> FastController <span style="color:#f92672">{</span>  
  
    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">handleRequest</span><span style="color:#f92672">(</span>HttpServletRequest request<span style="color:#f92672">,</span> HttpServletResponse response<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>  
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;index2&#34;</span><span style="color:#f92672">;</span>  
    <span style="color:#f92672">}</span>  
      
    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getRequestMappingURL</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>  
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;/test2&#34;</span><span style="color:#f92672">;</span>  
    <span style="color:#f92672">}</span>  
      
<span style="color:#f92672">}</span> </code></pre></div>
<p>Аннотация @Controller используется для автоматического поиска контроллёра в classpath при старте приложения. В результате под нагрузкой jmeter (50 пользователей) получаются следующие показатели:</p>

<ul>
<li>Настройки GC по умолчанию. Оптимизированная версия ~3 коллекции в секунду, неоптимизированная ~6 коллекций</li>
<li>Latency &amp; throughtput одинаковые для обоих версий.</li>
<li>Время работы HandlerAdapter.handle (от общего времени обработки запроса): для оптимизированной версии 0%, неоптимизированной 31%. Результат впечатляющий. Очевидно это связано с тем что вызов метода напрямую быстрее поиска метода по аанотации и вызова через Reflection</li>
<li>Время работы для DispatcherServlet.getLastModified: для оптимизированной версии 0%, неоптимизированной 11%. Связано с тем что AbstractHandlerMapping.getHandler использует абсолютные пути и не использует DefaultAnnotationHandlerMapping.</li>
<li>Среднее количество генерируемых объектов в минуту: для оптимизированной версии 4к-5к, неоптимизированной 9к-14к. Уменьшение в 2 раза!
<br /></li>
</ul>

<p>Дополнительные находки:</p>

<ul>
<li>ServletRequestAttributes. Не очень удачная абстракция. На каждый запрос создаётся этот объект. Не совсем понятно зачем он нужен когда обычный HTTPServletRequest предоставляет методы setAttribute и getAttribute и пр.</li>
<li>Не очень удачная имплементация некоторых объектов в Jetty: Response.setLocale, Request.getRequestDispatcher, Dispatcher.forward. После оптимизации они стали теми местами которые генерируют наибольшее количество мусора. Не совсем понятно зачем им генерировать много объектов, также непонятно почему они не кешируют результаты вычислений.</li>
<li>при использовании for each генерируется итератор, который превращается в мусор. Настольные microbenchmark&rsquo;и показали что итерация по ArrayList при использовании простых индексов быстрее в два раза.
<br /></li>
</ul>

<p>Выводы:</p>

<ul>
<li>чем больше слоёв абстракции и &ldquo;упрощений&rdquo;, тем медленнее обработка.</li>
<li>текущие технологии есть куда оптимизировать.</li>
<li>нужно хорошо понимать что можно оптимизировать а что нет
<br /></li>
</ul>

</div>

      	]]>
      </turbo:content>
    </item>
    
    <item turbo="true">
      <title>Запуск Jetty Embedded через spring</title>
      <link>https://dernasherbrezon.com/posts/jetty-embedded-maven/</link>
      <pubDate>Thu, 11 Nov 2010 13:14:18 +0100</pubDate>
      
      <guid>https://dernasherbrezon.com/posts/jetty-embedded-maven/</guid>
      <description>Для начала необходимо добавить зависимости в pom.xml:
&amp;lt;dependency&amp;gt; &amp;lt;groupId&amp;gt;org.eclipse.jetty&amp;lt;/groupId&amp;gt; &amp;lt;artifactId&amp;gt;jetty-server&amp;lt;/artifactId&amp;gt; &amp;lt;version&amp;gt;7.2.0.RC0&amp;lt;/version&amp;gt; &amp;lt;exclusions&amp;gt; &amp;lt;exclusion&amp;gt; &amp;lt;groupId&amp;gt;org.mortbay.jetty&amp;lt;/groupId&amp;gt; &amp;lt;artifactId&amp;gt;test-jndi-webapp&amp;lt;/artifactId&amp;gt; &amp;lt;/exclusion&amp;gt; &amp;lt;exclusion&amp;gt; &amp;lt;groupId&amp;gt;org.mortbay.jetty&amp;lt;/groupId&amp;gt; &amp;lt;artifactId&amp;gt;test-annotation-webapp&amp;lt;/artifactId&amp;gt; &amp;lt;/exclusion&amp;gt; &amp;lt;exclusion&amp;gt; &amp;lt;groupId&amp;gt;org.mortbay.jetty&amp;lt;/groupId&amp;gt; &amp;lt;artifactId&amp;gt;test-jaas-webapp&amp;lt;/artifactId&amp;gt; &amp;lt;/exclusion&amp;gt; &amp;lt;exclusion&amp;gt; &amp;lt;groupId&amp;gt;org.mortbay.jetty&amp;lt;/groupId&amp;gt; &amp;lt;artifactId&amp;gt;example-async-rest-webapp&amp;lt;/artifactId&amp;gt; &amp;lt;/exclusion&amp;gt; &amp;lt;/exclusions&amp;gt; &amp;lt;/dependency&amp;gt; &amp;lt;dependency&amp;gt; &amp;lt;groupId&amp;gt;org.eclipse.jetty&amp;lt;/groupId&amp;gt; &amp;lt;artifactId&amp;gt;jetty-servlet&amp;lt;/artifactId&amp;gt; &amp;lt;version&amp;gt;7.2.0.RC0&amp;lt;/version&amp;gt; &amp;lt;/dependency&amp;gt; &amp;lt;dependency&amp;gt; &amp;lt;groupId&amp;gt;org.eclipse.jetty&amp;lt;/groupId&amp;gt; &amp;lt;artifactId&amp;gt;jetty-jsp-2.1&amp;lt;/artifactId&amp;gt; &amp;lt;version&amp;gt;7.2.0.RC0&amp;lt;/version&amp;gt; &amp;lt;/dependency&amp;gt; &amp;lt;dependency&amp;gt; &amp;lt;groupId&amp;gt;org.eclipse.jetty&amp;lt;/groupId&amp;gt; &amp;lt;artifactId&amp;gt;jetty-webapp&amp;lt;/artifactId&amp;gt; &amp;lt;version&amp;gt;7.2.0.RC0&amp;lt;/version&amp;gt; &amp;lt;/dependency&amp;gt; &amp;lt;dependency&amp;gt; &amp;lt;groupId&amp;gt;org.springframework&amp;lt;/groupId&amp;gt; &amp;lt;artifactId&amp;gt;spring-core&amp;lt;/artifactId&amp;gt; &amp;lt;version&amp;gt;3.0.1.RELEASE&amp;lt;/version&amp;gt; &amp;lt;/dependency&amp;gt; &amp;lt;dependency&amp;gt; &amp;lt;groupId&amp;gt;org.springframework&amp;lt;/groupId&amp;gt; &amp;lt;artifactId&amp;gt;spring-context&amp;lt;/artifactId&amp;gt; &amp;lt;version&amp;gt;3.0.1.RELEASE&amp;lt;/version&amp;gt; &amp;lt;/dependency&amp;gt; &amp;lt;dependency&amp;gt; &amp;lt;groupId&amp;gt;org.springframework&amp;lt;/groupId&amp;gt; &amp;lt;artifactId&amp;gt;spring-web&amp;lt;/artifactId&amp;gt; &amp;lt;version&amp;gt;3.0.1.RELEASE&amp;lt;/version&amp;gt; &amp;lt;/dependency&amp;gt; &amp;lt;dependency&amp;gt; &amp;lt;groupId&amp;gt;org.springframework&amp;lt;/groupId&amp;gt; &amp;lt;artifactId&amp;gt;spring-webmvc&amp;lt;/artifactId&amp;gt; &amp;lt;version&amp;gt;3.0.1.RELEASE&amp;lt;/version&amp;gt; &amp;lt;/dependency&amp;gt; Затем в main-class указать:
Server server = new Server(9090); ServletHolder holder = new ServletHolder(new DispatcherServlet()); holder.</description>
      <turbo:content>
      	<![CDATA[
      		<header>
      			<h1>Запуск Jetty Embedded через spring</h1></header>
      		<div class='container entry-content'>
  <p>Для начала необходимо добавить зависимости в pom.xml:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;dependency&gt;</span>  
 <span style="color:#f92672">&lt;groupId&gt;</span>org.eclipse.jetty<span style="color:#f92672">&lt;/groupId&gt;</span>  
 <span style="color:#f92672">&lt;artifactId&gt;</span>jetty-server<span style="color:#f92672">&lt;/artifactId&gt;</span>  
 <span style="color:#f92672">&lt;version&gt;</span>7.2.0.RC0<span style="color:#f92672">&lt;/version&gt;</span>  
 <span style="color:#f92672">&lt;exclusions&gt;</span>  
  <span style="color:#f92672">&lt;exclusion&gt;</span>  
   <span style="color:#f92672">&lt;groupId&gt;</span>org.mortbay.jetty<span style="color:#f92672">&lt;/groupId&gt;</span>  
   <span style="color:#f92672">&lt;artifactId&gt;</span>test-jndi-webapp<span style="color:#f92672">&lt;/artifactId&gt;</span>  
  <span style="color:#f92672">&lt;/exclusion&gt;</span>  
  <span style="color:#f92672">&lt;exclusion&gt;</span>  
   <span style="color:#f92672">&lt;groupId&gt;</span>org.mortbay.jetty<span style="color:#f92672">&lt;/groupId&gt;</span>  
   <span style="color:#f92672">&lt;artifactId&gt;</span>test-annotation-webapp<span style="color:#f92672">&lt;/artifactId&gt;</span>  
  <span style="color:#f92672">&lt;/exclusion&gt;</span>  
  <span style="color:#f92672">&lt;exclusion&gt;</span>  
   <span style="color:#f92672">&lt;groupId&gt;</span>org.mortbay.jetty<span style="color:#f92672">&lt;/groupId&gt;</span>  
   <span style="color:#f92672">&lt;artifactId&gt;</span>test-jaas-webapp<span style="color:#f92672">&lt;/artifactId&gt;</span>  
  <span style="color:#f92672">&lt;/exclusion&gt;</span>  
  <span style="color:#f92672">&lt;exclusion&gt;</span>  
   <span style="color:#f92672">&lt;groupId&gt;</span>org.mortbay.jetty<span style="color:#f92672">&lt;/groupId&gt;</span>  
   <span style="color:#f92672">&lt;artifactId&gt;</span>example-async-rest-webapp<span style="color:#f92672">&lt;/artifactId&gt;</span>  
  <span style="color:#f92672">&lt;/exclusion&gt;</span>  
 <span style="color:#f92672">&lt;/exclusions&gt;</span>  
<span style="color:#f92672">&lt;/dependency&gt;</span>  
<span style="color:#f92672">&lt;dependency&gt;</span>  
 <span style="color:#f92672">&lt;groupId&gt;</span>org.eclipse.jetty<span style="color:#f92672">&lt;/groupId&gt;</span>  
 <span style="color:#f92672">&lt;artifactId&gt;</span>jetty-servlet<span style="color:#f92672">&lt;/artifactId&gt;</span>  
 <span style="color:#f92672">&lt;version&gt;</span>7.2.0.RC0<span style="color:#f92672">&lt;/version&gt;</span>  
<span style="color:#f92672">&lt;/dependency&gt;</span>  
      <span style="color:#f92672">&lt;dependency&gt;</span>  
          <span style="color:#f92672">&lt;groupId&gt;</span>org.eclipse.jetty<span style="color:#f92672">&lt;/groupId&gt;</span>  
          <span style="color:#f92672">&lt;artifactId&gt;</span>jetty-jsp-2.1<span style="color:#f92672">&lt;/artifactId&gt;</span>  
          <span style="color:#f92672">&lt;version&gt;</span>7.2.0.RC0<span style="color:#f92672">&lt;/version&gt;</span>  
      <span style="color:#f92672">&lt;/dependency&gt;</span>    
      <span style="color:#f92672">&lt;dependency&gt;</span>  
          <span style="color:#f92672">&lt;groupId&gt;</span>org.eclipse.jetty<span style="color:#f92672">&lt;/groupId&gt;</span>  
          <span style="color:#f92672">&lt;artifactId&gt;</span>jetty-webapp<span style="color:#f92672">&lt;/artifactId&gt;</span>  
          <span style="color:#f92672">&lt;version&gt;</span>7.2.0.RC0<span style="color:#f92672">&lt;/version&gt;</span>  
      <span style="color:#f92672">&lt;/dependency&gt;</span>    
<span style="color:#f92672">&lt;dependency&gt;</span>  
 <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework<span style="color:#f92672">&lt;/groupId&gt;</span>  
 <span style="color:#f92672">&lt;artifactId&gt;</span>spring-core<span style="color:#f92672">&lt;/artifactId&gt;</span>  
 <span style="color:#f92672">&lt;version&gt;</span>3.0.1.RELEASE<span style="color:#f92672">&lt;/version&gt;</span>  
<span style="color:#f92672">&lt;/dependency&gt;</span>  
<span style="color:#f92672">&lt;dependency&gt;</span>  
 <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework<span style="color:#f92672">&lt;/groupId&gt;</span>  
 <span style="color:#f92672">&lt;artifactId&gt;</span>spring-context<span style="color:#f92672">&lt;/artifactId&gt;</span>  
 <span style="color:#f92672">&lt;version&gt;</span>3.0.1.RELEASE<span style="color:#f92672">&lt;/version&gt;</span>  
<span style="color:#f92672">&lt;/dependency&gt;</span>  
<span style="color:#f92672">&lt;dependency&gt;</span>  
 <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework<span style="color:#f92672">&lt;/groupId&gt;</span>  
 <span style="color:#f92672">&lt;artifactId&gt;</span>spring-web<span style="color:#f92672">&lt;/artifactId&gt;</span>  
 <span style="color:#f92672">&lt;version&gt;</span>3.0.1.RELEASE<span style="color:#f92672">&lt;/version&gt;</span>  
<span style="color:#f92672">&lt;/dependency&gt;</span>  
<span style="color:#f92672">&lt;dependency&gt;</span>  
 <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework<span style="color:#f92672">&lt;/groupId&gt;</span>  
 <span style="color:#f92672">&lt;artifactId&gt;</span>spring-webmvc<span style="color:#f92672">&lt;/artifactId&gt;</span>  
 <span style="color:#f92672">&lt;version&gt;</span>3.0.1.RELEASE<span style="color:#f92672">&lt;/version&gt;</span>  
<span style="color:#f92672">&lt;/dependency&gt;</span></code></pre></div>
<p>Затем в <code>main-class</code> указать:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">Server server <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Server<span style="color:#f92672">(</span>9090<span style="color:#f92672">);</span>  
ServletHolder holder <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ServletHolder<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> DispatcherServlet<span style="color:#f92672">());</span>  
holder<span style="color:#f92672">.</span><span style="color:#a6e22e">setName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;root&#34;</span><span style="color:#f92672">);</span>  
WebAppContext webappContext <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> WebAppContext<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;src/main/webapp/&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">);</span>  
webappContext<span style="color:#f92672">.</span><span style="color:#a6e22e">addServlet</span><span style="color:#f92672">(</span>holder<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;*.do&#34;</span><span style="color:#f92672">);</span>  
server<span style="color:#f92672">.</span><span style="color:#a6e22e">setHandler</span><span style="color:#f92672">(</span>webappContext<span style="color:#f92672">);</span>  
server<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>  
server<span style="color:#f92672">.</span><span style="color:#a6e22e">join</span><span style="color:#f92672">();</span></code></pre></div>
<p>После этого создать WEB-INF/root-servlet.xml:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>  
<span style="color:#f92672">&lt;beans</span>  <span style="color:#a6e22e">xmlns=</span><span style="color:#e6db74">&#34;http://www.springframework.org/schema/beans&#34;</span>   
        <span style="color:#a6e22e">xmlns:xsi=</span><span style="color:#e6db74">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>   
        <span style="color:#a6e22e">xmlns:mvc=</span><span style="color:#e6db74">&#34;http://www.springframework.org/schema/mvc&#34;</span>  
        <span style="color:#a6e22e">xmlns:context=</span><span style="color:#e6db74">&#34;http://www.springframework.org/schema/context&#34;</span>  
       <span style="color:#a6e22e">xsi:schemaLocation=</span><span style="color:#e6db74">&#34;http://www.springframework.org/schema/beans   
</span><span style="color:#e6db74">                           http://www.springframework.org/schema/beans/spring-beans.xsd  
</span><span style="color:#e6db74">                           http://www.springframework.org/schema/context   
</span><span style="color:#e6db74">                           http://www.springframework.org/schema/context/spring-context.xsd  
</span><span style="color:#e6db74">                           http://www.springframework.org/schema/mvc  
</span><span style="color:#e6db74">                           http://www.springframework.org/schema/mvc/spring-mvc.xsd&#34;</span><span style="color:#f92672">&gt;</span>  
  
  
    <span style="color:#f92672">&lt;context:component-scan</span> <span style="color:#a6e22e">base-package=</span><span style="color:#e6db74">&#34;com.my.package&#34;</span> <span style="color:#f92672">/&gt;</span>  
    <span style="color:#f92672">&lt;mvc:annotation-driven</span> <span style="color:#f92672">/&gt;</span>  
  
<span style="color:#f92672">&lt;/beans&gt;</span> </code></pre></div>
</div>

      	]]>
      </turbo:content>
    </item>
    
    <item turbo="true">
      <title>Рефакторинг старых систем</title>
      <link>https://dernasherbrezon.com/posts/refactoring-legacy/</link>
      <pubDate>Mon, 11 May 2009 13:14:18 +0100</pubDate>
      
      <guid>https://dernasherbrezon.com/posts/refactoring-legacy/</guid>
      <description>Навеяно http://www.amazon.com/Working-Effectively-Legacy-Robert-Martin/dp/0131177052
Мне достаточно часто приходилось работать с наследными системами. Поэтому выработал некоторые свои собственные интересные практики при работе с такими системами.
 Зачастую имена классов, методов и переменных не отражают сути. В таких случаях обычно переименовывают их. Однако в наследных системах такого делать не рекомендуется. Даже при использовании мощных инструментов в современных IDE. Это связано с тем что в конечном итоге подобные системы собираются своими скриптами сборки, зачастую такими же запутанными и очень confuse&amp;rsquo;ными как и сам код.</description>
      <turbo:content>
      	<![CDATA[
      		<header>
      			<h1>Рефакторинг старых систем</h1></header>
      		<div class='container entry-content'>
  <p>Навеяно <a href="http://www.amazon.com/Working-Effectively-Legacy-Robert-Martin/dp/0131177052" target="_blank">http://www.amazon.com/Working-Effectively-Legacy-Robert-Martin/dp/0131177052</a></p>

<p>Мне достаточно часто приходилось работать с наследными системами. Поэтому выработал некоторые свои собственные интересные практики при работе с такими системами.</p>

<ol>
<li>Зачастую имена классов, методов и переменных не отражают сути. В таких случаях обычно переименовывают их. Однако в наследных системах такого делать не рекомендуется. Даже при использовании мощных инструментов в современных IDE. Это связано с тем что в конечном итоге подобные системы собираются своими скриптами сборки, зачастую такими же запутанными и очень confuse&rsquo;ными как и сам код. Если используется maven, то задача сильно упрощается. По крайней мере можно посмотреть на зависимости и проанализировать зависимости между артефактами. Если же используется ant&hellip; Сочувствую. В одной из систем с которыми я работал, различные конечные артефакты собирались фильтрованием уже скомпилированных классов. Определить в какие артефакты попадёт ваш класс просто так не получится. Поэтому есть два варианта:

<ul>
<li>Добавить комментарий.</li>
<li>Более предпочтительный. Использовать @deprecated. Например смысл переменной price изменился. По всей системе она используется как amount. Как будет выглядеть рефакторинг:</li>
</ul></li>
</ol>

<p>До</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Pojo</span> <span style="color:#f92672">{</span>  
    <span style="color:#66d9ef">private</span> Integer price<span style="color:#f92672">;</span>  
    <span style="color:#66d9ef">public</span> Integer <span style="color:#a6e22e">getPrice</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>  
         <span style="color:#66d9ef">return</span> price<span style="color:#f92672">;</span>  
    <span style="color:#f92672">}</span>  
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setPrice</span><span style="color:#f92672">(</span>Integer price<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
         <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">price</span> <span style="color:#f92672">=</span> price<span style="color:#f92672">;</span>  
    <span style="color:#f92672">}</span>  
<span style="color:#f92672">}</span></code></pre></div>
<p>После:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Pojo</span> <span style="color:#f92672">{</span>  
    <span style="color:#66d9ef">private</span> Integer amount<span style="color:#f92672">;</span>  
    <span style="color:#75715e">/** 
</span><span style="color:#75715e">    * @deprecated use getAmount() 
</span><span style="color:#75715e">    **/</span>  
    <span style="color:#a6e22e">@deprecated</span>  
    <span style="color:#66d9ef">public</span> Integer <span style="color:#a6e22e">getPrice</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>  
         <span style="color:#66d9ef">return</span> amount<span style="color:#f92672">;</span>  
    <span style="color:#f92672">}</span>  
    <span style="color:#75715e">/** 
</span><span style="color:#75715e">    * @deprecated use setAmount(amount) 
</span><span style="color:#75715e">    **/</span>  
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setPrice</span><span style="color:#f92672">(</span>Integer amount<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
         <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">amount</span> <span style="color:#f92672">=</span> amount<span style="color:#f92672">;</span>  
    <span style="color:#f92672">}</span>  
    <span style="color:#66d9ef">public</span> Integer <span style="color:#a6e22e">getAmount</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>  
         <span style="color:#66d9ef">return</span> amount<span style="color:#f92672">;</span>  
    <span style="color:#f92672">}</span>  
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setAmount</span><span style="color:#f92672">(</span>Integer amount<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
         <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">amount</span> <span style="color:#f92672">=</span> amount<span style="color:#f92672">;</span>  
    <span style="color:#f92672">}</span>  
<span style="color:#f92672">}</span> </code></pre></div>
<ol>
<li>Использование синглетона вида: Application.getInstance(). В общем случае использование синглетонов ведёт к спагетти коду. Например в двух совершенно разных системах я обнаружил не только наличие подобных синглетонов но их их использование вида.
<br /></li>
</ol>

<p>Использование:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Pojo</span> <span style="color:#f92672">{</span>  
	<span style="color:#66d9ef">private</span> Integer amount<span style="color:#f92672">;</span>  
	<span style="color:#66d9ef">public</span> Integer <span style="color:#a6e22e">getCalculatedAmount</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>  
         Integer someDiff <span style="color:#f92672">=</span> Application<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getDAO</span><span style="color:#f92672">().</span><span style="color:#a6e22e">queryDBByKey</span><span style="color:#f92672">(</span>amount<span style="color:#f92672">);</span>  
         <span style="color:#66d9ef">return</span> amount <span style="color:#f92672">-</span> someDiff<span style="color:#f92672">;</span>  
    <span style="color:#f92672">}</span>  
<span style="color:#f92672">}</span></code></pre></div>
<p>Разумеется поддерживать подобные вещи достаточно сложно. Зачастую эти синглетоны содержат соединения с базами данных, читают из файлов какую то информацию и делают прочие вещи. Единственным возможным эффективным образом работать с наследными системами - написание тестов перед внесением новой функциональности, для того чтобы проверить работоспособность системы после внесения изменений. С подобным использованием синглетонов модульные тесты практически невозможно написать. Однако опять же существует два способа:</p>

<ul>
<li>Писать интеграционные тесты с базами данных другими сервисами и пр. Но это неудобно если нужно протестировать небольшую часть системы.</li>
<li>Немного отрефакторить синглетон
<br /></li>
</ul>

<p>До</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Aplication</span> <span style="color:#f92672">{</span>  
     <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> Application instance<span style="color:#f92672">;</span>  
  
     <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">Application</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>  
     <span style="color:#f92672">}</span>  
  
     <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">synchronized</span> Application <span style="color:#a6e22e">getInstace</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>  
           <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>instance <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
                  instance <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Application<span style="color:#f92672">();</span>  
           <span style="color:#f92672">}</span>  
           <span style="color:#66d9ef">return</span> instance<span style="color:#f92672">;</span>  
     <span style="color:#f92672">}</span>  
<span style="color:#f92672">}</span> </code></pre></div>
<p>После</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Aplication</span> <span style="color:#f92672">{</span>  
     <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String APPLICATION_CLASS_NAME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;application&#34;</span><span style="color:#f92672">;</span>  
     <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> Application instance<span style="color:#f92672">;</span>  
  
     <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">Application</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>  
     <span style="color:#f92672">}</span>  
  
     <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">synchronized</span> Application <span style="color:#a6e22e">getInstace</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>  
           <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>instance <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  
                  Class clazz <span style="color:#f92672">=</span> Class<span style="color:#f92672">.</span><span style="color:#a6e22e">forName</span><span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">getProperty</span><span style="color:#f92672">(</span>APPLICATION_CLASS_NAME<span style="color:#f92672">));</span>  
                  instance <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Application<span style="color:#f92672">)</span>clazz<span style="color:#f92672">.</span><span style="color:#a6e22e">newInstance</span><span style="color:#f92672">();</span>  
           <span style="color:#f92672">}</span>  
           <span style="color:#66d9ef">return</span> instance<span style="color:#f92672">;</span>  
     <span style="color:#f92672">}</span>  
<span style="color:#f92672">}</span>  
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ApplicationMock</span> <span style="color:#66d9ef">extends</span> Application <span style="color:#f92672">{</span>  
  
     <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>  
          System<span style="color:#f92672">.</span><span style="color:#a6e22e">setProperty</span><span style="color:#f92672">(</span>APPLICATION_CLASS_NAME<span style="color:#f92672">,</span>ApplicationMock<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">());</span>  
     <span style="color:#f92672">}</span>  
  
<span style="color:#f92672">}</span></code></pre></div>
</div>

      	]]>
      </turbo:content>
    </item>
    
    <item turbo="true">
      <title>Glassfish Async JMS JCA</title>
      <link>https://dernasherbrezon.com/posts/glassfish-async-jms-jca/</link>
      <pubDate>Sat, 11 Apr 2009 13:14:18 +0100</pubDate>
      
      <guid>https://dernasherbrezon.com/posts/glassfish-async-jms-jca/</guid>
      <description>Достаточно интересное и недокументированное поведение Glassfish v.2.0.
Если в потоке вызова endpointActivation(...) в реализации Resource Adapter&amp;rsquo;a вызвать метод consumer.setMessageListener(...) то потоки асинхронного получения сообщения не создадутся. С чем это связано - неизвестно. Исходные коды не смотрел. Возможно с требованиями спецификации о создании потоков через WorkManager. Но разработчик не контролирует создания потоков в JMS клиенте!
Решение:
 Создать инициализацию message listener&amp;rsquo;a в отдельном потоке через WorkManager.  </description>
      <turbo:content>
      	<![CDATA[
      		<header>
      			<h1>Glassfish Async JMS JCA</h1></header>
      		<div class='container entry-content'>
  <p>Достаточно интересное и недокументированное поведение Glassfish v.2.0.</p>

<p>Если в потоке вызова <code>endpointActivation(...)</code> в реализации Resource Adapter&rsquo;a вызвать метод <code>consumer.setMessageListener(...)</code> то потоки асинхронного получения сообщения не создадутся. С чем это связано - неизвестно. Исходные коды не смотрел. Возможно с требованиями спецификации о создании потоков через WorkManager. Но разработчик не контролирует создания потоков в JMS клиенте!</p>

<p>Решение:</p>

<ul>
<li>Создать инициализацию message listener&rsquo;a в отдельном потоке через WorkManager.</li>
</ul>

</div>

      	]]>
      </turbo:content>
    </item>
    
    <item turbo="true">
      <title>IMQ Connection Concurrent Glassfish</title>
      <link>https://dernasherbrezon.com/posts/imq-connection-glassfish/</link>
      <pubDate>Sun, 11 Jan 2009 13:14:18 +0100</pubDate>
      
      <guid>https://dernasherbrezon.com/posts/imq-connection-glassfish/</guid>
      <description>Наблюдается следующая проблема:
thread1:
javax.jms.Connection conn = connFactory.createConnection(); Work connectionHandler = new MyWorker(conn); WorkManager.scheduleWork(connectionHandler);  thread2 (MyWorker):
Session s = conn.createSession(...); Consumer c = s.createConsumer(someDestination); Message m = c.receive();  При receive JMSException и пишет что consumer closed. Однако если:
thread1:
Work connectionHandler = new MyWorker(connFactory); WorkManager.scheduleWork(connectionHandler);  thread2 (MyWorker):
javax.jms.Connection conn = connFactory.createConnection(); Session s = conn.createSession(...); Consumer c = s.createConsumer(someDestination); Message m = c.receive();  То всё работает. Happy holidays</description>
      <turbo:content>
      	<![CDATA[
      		<header>
      			<h1>IMQ Connection Concurrent Glassfish</h1></header>
      		<div class='container entry-content'>
  <p>Наблюдается следующая проблема:</p>

<p>thread1:</p>

<pre><code>javax.jms.Connection conn = connFactory.createConnection();  
Work connectionHandler = new MyWorker(conn);  
WorkManager.scheduleWork(connectionHandler); 
</code></pre>

<p>thread2 (MyWorker):</p>

<pre><code>Session s = conn.createSession(...);  
Consumer c = s.createConsumer(someDestination);  
Message m = c.receive(); 
</code></pre>

<p>При receive JMSException и пишет что consumer closed. Однако если:</p>

<p>thread1:</p>

<pre><code>Work connectionHandler = new MyWorker(connFactory);  
WorkManager.scheduleWork(connectionHandler);
</code></pre>

<p>thread2 (MyWorker):</p>

<pre><code>javax.jms.Connection conn = connFactory.createConnection();  
Session s = conn.createSession(...);  
Consumer c = s.createConsumer(someDestination);  
Message m = c.receive(); 
</code></pre>

<p>То всё работает. Happy holidays</p>

</div>

      	]]>
      </turbo:content>
    </item>
    
    <item turbo="true">
      <title>Интеграция Eclipse и Maven</title>
      <link>https://dernasherbrezon.com/posts/eclipse-maven/</link>
      <pubDate>Sat, 10 Jan 2009 13:14:18 +0100</pubDate>
      
      <guid>https://dernasherbrezon.com/posts/eclipse-maven/</guid>
      <description>Maven в Eclipse - это очень удобно.
Однако при всех достоинствах каждого есть некоторые неудобства интеграции. Например следующий вариант: Есть проект. В нём есть основные исходные коды и для тестов. Соответственно они находятся в разных папках. Есть два builder&amp;rsquo;а. Стандартный JDT и Maven Builder. Я не сильно вдавался в детали их работы, но в первом приближении они компилируют. JDT&amp;rsquo;шный стандартно в output folder для Eclipse&amp;rsquo;a, а maven&amp;rsquo;овский я так понимаю выполняет target compile и помещает скомпилированные классы в target/classes &amp;amp; target/test-classes (по дефолту).</description>
      <turbo:content>
      	<![CDATA[
      		<header>
      			<h1>Интеграция Eclipse и Maven</h1></header>
      		<div class='container entry-content'>
  <p>Maven в Eclipse - это очень удобно.</p>

<p>Однако при всех достоинствах каждого есть некоторые неудобства интеграции. Например следующий вариант:
Есть проект. В нём есть основные исходные коды и для тестов. Соответственно они находятся в разных папках. Есть два builder&rsquo;а. Стандартный JDT и Maven Builder. Я не сильно вдавался в детали их работы, но в первом приближении они компилируют. JDT&rsquo;шный стандартно в output folder для Eclipse&rsquo;a, а maven&rsquo;овский я так понимаю выполняет target compile и помещает скомпилированные классы в target/classes &amp; target/test-classes (по дефолту).</p>

<p>Вот тут то и возникает проблема. Вернее маленькое неудобство. Хочется выполнять тесты с помощью JUnit&rsquo;a встроенного в Eclipse. Потому что удобно. Однако он как то странно съинтегрирован с maven&rsquo;ом и похоже видит только классы скомпилированные JDT. Поэтому если нажать Run -&gt; JUnit Test то можно увидеть сообщение: NoClassDefFoundError: /my/test/Class</p>

<p>Решение проблемы два:</p>

<ol>
<li>Выполнять компиляцию тестов с помощью maven&rsquo;а а затем выполнять запуск junit тестов. Но это же слишком неудобно? Каждый раз при изменении класса запускать компиляцию maven&rsquo;ом, поэтому есть ещё один путь.</li>
<li>Написать нехитрые настройки.
<br /></li>
</ol>

<p>У каждого maven-проекта есть родительским pom. Поэтому в родительском pom&rsquo;е нужно:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;build&gt;</span>  
    <span style="color:#f92672">&lt;outputdirectory&gt;</span>${output.dir}<span style="color:#f92672">&lt;/outputdirectory&gt;</span>  
    <span style="color:#f92672">&lt;testoutputdirectory&gt;</span>${testoutput.dir}<span style="color:#f92672">&lt;/testoutputdirectory&gt;</span>  
    ...  
<span style="color:#f92672">&lt;/build&gt;</span>  
  
<span style="color:#f92672">&lt;properties&gt;</span>  
    <span style="color:#f92672">&lt;output.dir&gt;</span>${basedir}/target/classes<span style="color:#f92672">&lt;/output.dir&gt;</span>  
    <span style="color:#f92672">&lt;testoutput.dir&gt;</span>${basedir}/target/test-classes<span style="color:#f92672">&lt;/testoutput.dir&gt;</span>  
<span style="color:#f92672">&lt;/properties&gt;</span>  
   
<span style="color:#f92672">&lt;profiles&gt;</span>  
    <span style="color:#f92672">&lt;profile&gt;</span>  
        <span style="color:#f92672">&lt;id&gt;</span>eclipse-folders<span style="color:#f92672">&lt;/id&gt;</span>  
        <span style="color:#f92672">&lt;properties&gt;</span>  
            <span style="color:#f92672">&lt;output.dir&gt;</span>${basedir}/target/eclipse<span style="color:#f92672">&lt;/output.dir&gt;</span>  
            <span style="color:#f92672">&lt;testoutput.dir&gt;</span>${basedir}/target/eclipse<span style="color:#f92672">&lt;/testoutput.dir&gt;</span>  
        <span style="color:#f92672">&lt;/properties&gt;</span>  
    <span style="color:#f92672">&lt;/profile&gt;</span>  
<span style="color:#f92672">&lt;/profiles&gt;</span></code></pre></div>
<p>В настройках проекта:</p>

<ul>
<li>Maven -&gt; Active Maven Profiles написать &ldquo;eclipse-folders&rdquo;</li>
<li>Java build Path -&gt; Default Output Folder написать &ldquo;target/eclipse&rdquo; и в настройках папок ресурсов (типа &ldquo;/src/test/resources&rdquo;) удалить Excluded чтобы ресурсы подцеплялись при запуске тестов (например log4j.properties)
<br /></li>
</ul>

<p>Я ещё отключил Maven Builder. Но думаю это необязательно.</p>

</div>

      	]]>
      </turbo:content>
    </item>
    
  </channel>
</rss>