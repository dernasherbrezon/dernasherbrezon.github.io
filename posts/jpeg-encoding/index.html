<!DOCTYPE html>
<html lang='ru' dir='auto'><head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='Введение Для работой с jpeg файлами написано множество библиотек. Даже Java по умолчанию поддерживает чтение и запись jpeg файлов. Однако, когда требуется декодировать более сложные типы передачи jpeg, то необходимо понимать как устроен формат и какие алгоритмы используются. В этой статье я постараюсь максимально дотошно разобрать кодирование jpeg.
Типы передачи jpeg Прежде, чем разбирать кодирование цвета в jpeg, необходимо чётко разделять две вещи: кодирование цвета и передача блоков изображения.
Кодирование цвета - это набор алгоритмов для формирования, так называемых MCU, блоков пикселей 8х8 или 16х16.'>
<meta name='theme-color' content='#ffcd00'>

<meta property='og:title' content='Кодирование jpeg • dernasherbrezon'>
<meta property='og:description' content='Введение Для работой с jpeg файлами написано множество библиотек. Даже Java по умолчанию поддерживает чтение и запись jpeg файлов. Однако, когда требуется декодировать более сложные типы передачи jpeg, то необходимо понимать как устроен формат и какие алгоритмы используются. В этой статье я постараюсь максимально дотошно разобрать кодирование jpeg.
Типы передачи jpeg Прежде, чем разбирать кодирование цвета в jpeg, необходимо чётко разделять две вещи: кодирование цвета и передача блоков изображения.
Кодирование цвета - это набор алгоритмов для формирования, так называемых MCU, блоков пикселей 8х8 или 16х16.'>
<meta property='og:url' content='https://dernasherbrezon.com/posts/jpeg-encoding/'>
<meta property='og:site_name' content='dernasherbrezon'>
<meta property='og:type' content='article'><meta property='og:image' content='https://dernasherbrezon.com/img/jpeg-encoding/2.png'><meta property='article:section' content='posts'><meta property='article:tag' content='jpeg'><meta property='article:published_time' content='2020-02-08T16:04:00Z'/><meta property='article:modified_time' content='2020-02-08T16:04:00Z'/><meta name='twitter:card' content='summary_large_image'><meta name='twitter:site' content='@dernasherbrezon'><meta property='twitter:image' content='https://dernasherbrezon.com/img/jpeg-encoding/2.png'>

<meta name="generator" content="Hugo 0.81.0" />

  <title>Кодирование jpeg • dernasherbrezon</title>
  <link rel='canonical' href='https://dernasherbrezon.com/posts/jpeg-encoding/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.ab98e12b.css'><style>
:root{--color-accent:#ffcd00;}
</style>

  <meta name="telegram:channel" content="@dernasherbrezonChannel">
</head>
<body class='page type-posts has-sidebar'>

  <div class='site'><div id='sidebar' class='sidebar'>
  <a class='screen-reader-text' href='#main-menu'></a>

  <div class='container'><section class='widget widget-about sep-after'>
  <header>
    
    <div class='logo'>
      <a href='/'>
        <img src='/img/logo.jpeg'>
      </a>
    </div>
    
    <h2 class='title site-title '>
      <a href='/'>
      dernasherbrezon
      </a>
    </h2>
    <div class='desc'>
    Блог о программировании на Java
    </div>
  </header>

</section>
<section class='widget widget-sidebar_menu sep-after'><nav id='sidebar-menu' class='menu sidebar-menu' aria-label=''>
    <div class='container'>
      <ul><li class='item'>
  <a href='/posts/'>Все записи</a></li><li class='item'>
  <a href='/%D0%BE%D0%B1-%D0%B0%D0%B2%D1%82%D0%BE%D1%80%D0%B5/'>Об авторе</a></li><li class='item'>
  <a href='/%D0%BF%D0%BE%D0%B4%D0%B4%D0%B5%D1%80%D0%B6%D0%B0%D1%82%D1%8C/'>Поддержать</a></li></ul>
    </div>
  </nav>

</section><section class='widget widget-taxonomy_cloud sep-after'>
  <header>
    <h4 class='title widget-title'>Тэги</h4>
  </header>

  <div class='container list-container'>
  <ul class='list taxonomy-cloud'><li>
        <a href='/tags/abbreviated-jpeg/' style='font-size:1.0222222222222221em'>abbreviated jpeg</a>
      </li><li>
        <a href='/tags/acme/' style='font-size:1em'>acme</a>
      </li><li>
        <a href='/tags/api/' style='font-size:1.0666666666666667em'>api</a>
      </li><li>
        <a href='/tags/apt/' style='font-size:1.0444444444444445em'>apt</a>
      </li><li>
        <a href='/tags/awgn/' style='font-size:1em'>awgn</a>
      </li><li>
        <a href='/tags/bash/' style='font-size:1.0222222222222221em'>bash</a>
      </li><li>
        <a href='/tags/ber/' style='font-size:1.0666666666666667em'>ber</a>
      </li><li>
        <a href='/tags/bpsk/' style='font-size:1.0222222222222221em'>bpsk</a>
      </li><li>
        <a href='/tags/c/' style='font-size:1.1777777777777778em'>c</a>
      </li><li>
        <a href='/tags/deb/' style='font-size:1.0666666666666667em'>deb</a>
      </li><li>
        <a href='/tags/design/' style='font-size:1.0444444444444445em'>design</a>
      </li><li>
        <a href='/tags/docker/' style='font-size:1em'>docker</a>
      </li><li>
        <a href='/tags/dsp/' style='font-size:1.0888888888888888em'>dsp</a>
      </li><li>
        <a href='/tags/eclipse/' style='font-size:1em'>eclipse</a>
      </li><li>
        <a href='/tags/embedded/' style='font-size:1.0666666666666667em'>embedded</a>
      </li><li>
        <a href='/tags/flot/' style='font-size:1em'>flot</a>
      </li><li>
        <a href='/tags/fsk/' style='font-size:1.0222222222222221em'>fsk</a>
      </li><li>
        <a href='/tags/gc/' style='font-size:1em'>gc</a>
      </li><li>
        <a href='/tags/gdal/' style='font-size:1.0222222222222221em'>gdal</a>
      </li><li>
        <a href='/tags/georeferencing/' style='font-size:1.0666666666666667em'>georeferencing</a>
      </li><li>
        <a href='/tags/geotiff/' style='font-size:1.0444444444444445em'>geotiff</a>
      </li><li>
        <a href='/tags/glassfish/' style='font-size:1.0222222222222221em'>glassfish</a>
      </li><li>
        <a href='/tags/gnuradio/' style='font-size:1.0666666666666667em'>gnuradio</a>
      </li><li>
        <a href='/tags/heap/' style='font-size:1em'>heap</a>
      </li><li>
        <a href='/tags/hibernate/' style='font-size:1em'>hibernate</a>
      </li><li>
        <a href='/tags/j2ee/' style='font-size:1.0222222222222221em'>j2ee</a>
      </li><li>
        <a href='/tags/java/' style='font-size:2em'>java</a>
      </li><li>
        <a href='/tags/javafx/' style='font-size:1em'>javafx</a>
      </li><li>
        <a href='/tags/javascript/' style='font-size:1.0444444444444445em'>javascript</a>
      </li><li>
        <a href='/tags/jetty/' style='font-size:1.0444444444444445em'>jetty</a>
      </li><li>
        <a href='/tags/jmeter/' style='font-size:1em'>jmeter</a>
      </li><li>
        <a href='/tags/jpeg/' style='font-size:1.1111111111111112em'>jpeg</a>
      </li><li>
        <a href='/tags/jpoint/' style='font-size:1em'>jpoint</a>
      </li><li>
        <a href='/tags/jquery/' style='font-size:1em'>jquery</a>
      </li><li>
        <a href='/tags/jsp/' style='font-size:1.0666666666666667em'>jsp</a>
      </li><li>
        <a href='/tags/jstl/' style='font-size:1.0444444444444445em'>jstl</a>
      </li><li>
        <a href='/tags/junit/' style='font-size:1.0444444444444445em'>junit</a>
      </li><li>
        <a href='/tags/letsencrypt/' style='font-size:1em'>letsencrypt</a>
      </li><li>
        <a href='/tags/log4j/' style='font-size:1em'>log4j</a>
      </li><li>
        <a href='/tags/lrpt/' style='font-size:1.0444444444444445em'>lrpt</a>
      </li><li>
        <a href='/tags/matlab/' style='font-size:1.0222222222222221em'>matlab</a>
      </li><li>
        <a href='/tags/maven/' style='font-size:1.1111111111111112em'>maven</a>
      </li><li>
        <a href='/tags/memory/' style='font-size:1em'>memory</a>
      </li><li>
        <a href='/tags/meteor-m/' style='font-size:1.0888888888888888em'>meteor-m</a>
      </li><li>
        <a href='/tags/mobitex/' style='font-size:1em'>mobitex</a>
      </li><li>
        <a href='/tags/monitoring/' style='font-size:1.0222222222222221em'>monitoring</a>
      </li><li>
        <a href='/tags/open-source/' style='font-size:1.0444444444444445em'>open source</a>
      </li><li>
        <a href='/tags/openapi/' style='font-size:1.0222222222222221em'>openapi</a>
      </li><li>
        <a href='/tags/openstack/' style='font-size:1em'>openstack</a>
      </li><li>
        <a href='/tags/openstack-swift/' style='font-size:1em'>openstack swift</a>
      </li><li>
        <a href='/tags/orekit/' style='font-size:1.0222222222222221em'>orekit</a>
      </li><li>
        <a href='/tags/pipe/' style='font-size:1em'>pipe</a>
      </li><li>
        <a href='/tags/plutosdr/' style='font-size:1em'>plutosdr</a>
      </li><li>
        <a href='/tags/r2cloud/' style='font-size:1.0444444444444445em'>r2cloud</a>
      </li><li>
        <a href='/tags/r2weather/' style='font-size:1.0444444444444445em'>r2weather</a>
      </li><li>
        <a href='/tags/radio/' style='font-size:1.1777777777777778em'>radio</a>
      </li><li>
        <a href='/tags/raspberrypi/' style='font-size:1.2em'>raspberrypi</a>
      </li><li>
        <a href='/tags/refactoring/' style='font-size:1em'>refactoring</a>
      </li><li>
        <a href='/tags/rest/' style='font-size:1.0222222222222221em'>REST</a>
      </li><li>
        <a href='/tags/rrd/' style='font-size:1.0222222222222221em'>rrd</a>
      </li><li>
        <a href='/tags/rtl_power/' style='font-size:1.0222222222222221em'>rtl_power</a>
      </li><li>
        <a href='/tags/rtlsdr/' style='font-size:1.2222222222222223em'>rtlsdr</a>
      </li><li>
        <a href='/tags/rtlspectrum/' style='font-size:1.0444444444444445em'>rtlSpectrum</a>
      </li><li>
        <a href='/tags/s3/' style='font-size:1em'>s3</a>
      </li><li>
        <a href='/tags/satellite/' style='font-size:1.288888888888889em'>satellite</a>
      </li><li>
        <a href='/tags/satnogs/' style='font-size:1.0444444444444445em'>satnogs</a>
      </li><li>
        <a href='/tags/sdr-modem/' style='font-size:1.0222222222222221em'>sdr-modem</a>
      </li><li>
        <a href='/tags/security/' style='font-size:1.0222222222222221em'>security</a>
      </li><li>
        <a href='/tags/selectel/' style='font-size:1em'>selectel</a>
      </li><li>
        <a href='/tags/simd/' style='font-size:1.0444444444444445em'>SIMD</a>
      </li><li>
        <a href='/tags/sonarcube/' style='font-size:1.0444444444444445em'>sonarcube</a>
      </li><li>
        <a href='/tags/spring/' style='font-size:1.0222222222222221em'>spring</a>
      </li><li>
        <a href='/tags/spring-mvc/' style='font-size:1em'>Spring-mvc</a>
      </li><li>
        <a href='/tags/sqnr/' style='font-size:1em'>sqnr</a>
      </li><li>
        <a href='/tags/ssdv/' style='font-size:1.0222222222222221em'>ssdv</a>
      </li><li>
        <a href='/tags/string/' style='font-size:1.0222222222222221em'>String</a>
      </li><li>
        <a href='/tags/systemd/' style='font-size:1em'>systemd</a>
      </li><li>
        <a href='/tags/testing/' style='font-size:1.0222222222222221em'>testing</a>
      </li><li>
        <a href='/tags/travis-ci/' style='font-size:1.0222222222222221em'>travis-ci</a>
      </li><li>
        <a href='/tags/ubuntu/' style='font-size:1.0888888888888888em'>ubuntu</a>
      </li><li>
        <a href='/tags/valgrind/' style='font-size:1.0444444444444445em'>valgrind</a>
      </li><li>
        <a href='/tags/validator/' style='font-size:1em'>validator</a>
      </li><li>
        <a href='/tags/vuejs/' style='font-size:1.0222222222222221em'>vuejs</a>
      </li><li>
        <a href='/tags/yourkit/' style='font-size:1em'>yourkit</a>
      </li><li>
        <a href='/tags/%D0%B0%D0%B4%D0%BC%D0%B8%D0%BD%D0%B8%D1%81%D1%82%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5/' style='font-size:1.1555555555555554em'>администрирование</a>
      </li><li>
        <a href='/tags/%D0%B4%D0%B7%D0%B7/' style='font-size:1.0666666666666667em'>ДЗЗ</a>
      </li><li>
        <a href='/tags/%D0%B4%D0%B8%D0%B7%D0%B0%D0%B9%D0%BD/' style='font-size:1.0444444444444445em'>дизайн</a>
      </li><li>
        <a href='/tags/%D0%B8%D0%B4%D0%B5%D0%B8/' style='font-size:1em'>идеи</a>
      </li><li>
        <a href='/tags/%D0%BA%D0%BE%D1%81%D0%BC%D0%BE%D0%BD%D0%B0%D0%B2%D1%82%D0%B8%D0%BA%D0%B0/' style='font-size:1.0444444444444445em'>космонавтика</a>
      </li><li>
        <a href='/tags/%D0%BA%D1%83%D0%B1%D1%81%D0%B0%D1%82/' style='font-size:1.0444444444444445em'>кубсат</a>
      </li><li>
        <a href='/tags/%D0%BF%D0%B5%D1%80%D0%B5%D0%B2%D0%BE%D0%B4/' style='font-size:1.0222222222222221em'>перевод</a>
      </li><li>
        <a href='/tags/%D0%BF%D0%BE%D0%B2%D0%BE%D1%80%D0%BE%D1%82%D0%BD%D0%BE%D0%B5-%D1%83%D1%81%D1%82%D1%80%D0%BE%D0%B9%D1%81%D1%82%D0%B2%D0%BE/' style='font-size:1.0444444444444445em'>поворотное устройство</a>
      </li><li>
        <a href='/tags/%D0%BF%D1%80%D0%BE%D0%B8%D0%B7%D0%B2%D0%BE%D0%B4%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D0%BE%D1%81%D1%82%D1%8C/' style='font-size:1.2222222222222223em'>производительность</a>
      </li><li>
        <a href='/tags/%D1%80%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B0/' style='font-size:1.0444444444444445em'>разработка</a>
      </li><li>
        <a href='/tags/%D1%81%D0%BF%D0%B5%D1%86%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F/' style='font-size:1em'>спецификация</a>
      </li><li>
        <a href='/tags/%D1%81%D0%BF%D1%83%D1%82%D0%BD%D0%B8%D0%BA%D0%B8/' style='font-size:1.3333333333333335em'>спутники</a>
      </li><li>
        <a href='/tags/%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5/' style='font-size:1.1777777777777778em'>тестирование</a>
      </li><li>
        <a href='/tags/%D1%84%D0%B8%D0%BB%D1%8C%D1%82%D1%80%D1%8B/' style='font-size:1.0444444444444445em'>фильтры</a>
      </li></ul>
</div>


</section>
</div>

  <div class='sidebar-overlay'></div>
</div><div class='main'><nav id='main-menu' class='menu main-menu' aria-label=''>
  <div class='container'>
    <a class='screen-reader-text' href='#content'></a>

<button id='sidebar-toggler' class='sidebar-toggler' aria-controls='sidebar'>
  <span class='screen-reader-text'></span>
  <span class='open'><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
  <line x1="3" y1="12" x2="21" y2="12" />
  <line x1="3" y1="6" x2="21" y2="6" />
  <line x1="3" y1="18" x2="21" y2="18" />

</svg>
</span>
  <span class='close'><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
  <line x1="18" y1="6" x2="6" y2="18" />
  <line x1="6" y1="6" x2="18" y2="18" />

</svg>
</span>
</button>
    <ul><li class='item'>
        <a href='/posts/'>Все записи</a>
      </li><li class='item'>
        <a href='/%D0%BE%D0%B1-%D0%B0%D0%B2%D1%82%D0%BE%D1%80%D0%B5/'>Об авторе</a>
      </li><li class='item'>
        <a href='/%D0%BF%D0%BE%D0%B4%D0%B4%D0%B5%D1%80%D0%B6%D0%B0%D1%82%D1%8C/'>Поддержать</a>
      </li></ul>
  </div>
</nav><div class='header-widgets'>
        <div class='container'></div>
      </div>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>dernasherbrezon</p><p class='desc site-desc'>Блог о программировании на Java</p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='ru' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>Кодирование jpeg</h1>
      

    </div>
    <div class='entry-meta'>
  <span class='posted-on'><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>

</svg>
<span class='screen-reader-text'> </span>
  <time class='entry-date' datetime='2020-02-08T16:04:00Z'>08 Feb 2020</time>
</span>

  
  

</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  <h2 id="введение">Введение</h2>
<p>Для работой с jpeg файлами написано множество библиотек. Даже Java по умолчанию поддерживает <a href="https://docs.oracle.com/javase/tutorial/2d/images/loadimage.html">чтение и запись</a> jpeg файлов. Однако, когда требуется декодировать более сложные типы передачи jpeg, то необходимо понимать как устроен формат и какие алгоритмы используются. В этой статье я постараюсь максимально дотошно разобрать кодирование jpeg.</p>
<h2 id="типы-передачи-jpeg">Типы передачи jpeg</h2>
<p>Прежде, чем разбирать кодирование цвета в jpeg, необходимо чётко разделять две вещи: кодирование цвета и передача блоков изображения.</p>
<p>Кодирование цвета - это набор алгоритмов для формирования, так называемых MCU, блоков пикселей 8х8 или 16х16. Именно эти алгоритмы отвечают за сжатие изображения.</p>
<p>Передача или хранение блоков изображения бывает нескольких видов. Файл - наиболее распространённый способ. Вначале файла идёт описание таблиц квантования и всевозможная мета-информация о картинке. После этого идёт список MCU блоков jpeg.</p>
<p>Несмотря на то, что файл используется в 99.999% процентов случаев, существуют и другие способы передачи jpeg картинки. В основном они решают ту или иную проблему, которую нельзя решить с использованием стандартных файлов. <a href="https://dernasherbrezon.com/posts/decoding-meteor-m/">Continuous jpeg</a> - способ передачи &ldquo;бесконечного&rdquo; jpeg файла. Используется в метеорологических спутниках для передачи полос сканирования Земли. Так как спутник летает вокруг Земли и постоянно шлёт информацию, то и картинка получается как бы &ldquo;бесконечной&rdquo; высоты.</p>
<p><a href="https://dernasherbrezon.com/posts/decoding-jy1sat/">SSDV</a> - способ передачи jpeg файла, при котором часть пакетов может потеряться. Используется в спутниках с более узким каналом передачи данных.</p>
<p>Ниже я постараюсь описать только алгоритмы кодирования цвета в jpeg.</p>
<h2 id="кодирование-jpeg">Кодирование jpeg</h2>
<h3 id="шаг-1-преобразование-в-ycbcr">Шаг 1. Преобразование в YCbCr</h3>
<p>Изначальный RGB цвет преобразуется в YCbCr с помощью формулы:</p>
<pre><code>Y  =  0.299  * R + 0.587  * G + 0.114  * B
Cb = -0.1687 * R - 0.3313 * G + 0.5    * B + 128
Cr =  0.5    * R - 0.4187 * G - 0.0813 * B + 128
</code></pre><p>Зачем это сделано? Тут важно понять, что всё сжатие jpeg основано на восприятии цвета человеком. Задача алгоритма так уменьшить размер картинки, чтобы человек не заметил большой разницы. Тут важно &ldquo;не заметил&rdquo;. Некоторые люди вполне могут заметить, некоторые нет. Алгоритм не делает между ними различия, а работает с усредненным значением &ldquo;не заметил&rdquo;. Это значение получено эмпирически путём опроса множества людей.</p>
<p>В данном случае важно знать, что человеческий глаз более чувствителен к зелёному цвету. Так же человеческий глаз более чувствителен к контрасту, чем к оттенкам цветов. Это прежде всего связано с тем, что роговица позволяет различать предметы в темноте.</p>
<p>Зная это, можно преобразовать &ldquo;компьютерный&rdquo; формат RGB в более человеческий YCbCr. Уменьшая качество CbCr можно, не теряя в качестве восприятия, сильно уменьшить количество информации. На этом основан следующий шаг.</p>
<h3 id="шаг-2-сэмплирование">Шаг 2. Сэмплирование</h3>
<p>Компоненты Cb и Cr можно сэмплировать со значительным интервалом, тем самым уменьшая размер изображения. Этот приём называется цветовая субдискретизация (chroma subsampling). Он заключается в том, что для каждого блока Y, блоки Cb и Cr берутся с некоторым интервалом.</p>
<p><img src="/img/jpeg-encoding/1.png" alt=""></p>
<p>Например, на картинке выше, цветовая субдискретизация 4:2:0. Это значит, что для блока пикселей 2х2 Y компоненты, пикселы Cb и Cr усредняются и берутся только один раз. Jpeg поддерживает различные варианты субдискретизации: 4:1:1, 4:2:0.</p>
<p>В данном случае удалось уменьшить с 12 байт ( 3 * 4 * 1 байт ) до 6 байт ( 4 байт + байт + байт ). То есть уменьшить размер в 2 раза!</p>
<h3 id="шаг-3">Шаг 3.</h3>
<p>Самый простой шаг - перевод цвета из интервала 0 ~ 255 в знаковый -128 ~ 127.</p>
<h3 id="шаг-4-дискретное-косинусное-преобразование">Шаг 4. Дискретное косинусное преобразование</h3>
<p>Следующие шаги позволяют уменьшить размер за счёт отфильтровывания высокочастотных деталей изображения. Этот процесс лучше понять на примере. Но для начала необходимо разбить пикселы изображения на блоки 8х8 пикселей. Немного терминологии jpeg. DU (data unit) - это блок пикселей 8х8 одного компонента. MCU (minimum coding unit) - это несколько или один DU, которые все вместе дают кусочек картинки 8х8 или 16х16 пикселей. Для примера выше, MCU выглядит следующим образом:</p>
<p><img src="/img/jpeg-encoding/2.png" alt=""></p>
<p>MCU состоит из 6 блоков DU. Каждый блок DU состоит из 8х8 пикселей.</p>
<p>После того, как картинка разбита на блоки DU, идёт кодирование каждого блока. <a href="https://ru.wikipedia.org/wiki/%D0%94%D0%B8%D1%81%D0%BA%D1%80%D0%B5%D1%82%D0%BD%D0%BE%D0%B5_%D0%BA%D0%BE%D1%81%D0%B8%D0%BD%D1%83%D1%81%D0%BD%D0%BE%D0%B5_%D0%BF%D1%80%D0%B5%D0%BE%D0%B1%D1%80%D0%B0%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5">Дискретное косинусное преобразование</a> применяется для каждого по очереди. Эта операция преобразует матрицу чисел 8х8 в их частотное представление. Это очень похоже на <a href="https://ru.wikipedia.org/wiki/%D0%94%D0%B8%D1%81%D0%BA%D1%80%D0%B5%D1%82%D0%BD%D0%BE%D0%B5_%D0%BF%D1%80%D0%B5%D0%BE%D0%B1%D1%80%D0%B0%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D0%A4%D1%83%D1%80%D1%8C%D0%B5">дискретное преобразование фурье</a>. У получившейся матрицы 8х8 есть одна особенность: большая энергия сосредоточна в левом верхнем углу, а наименьшая энергия в правом нижнем.</p>
<p><img src="/img/jpeg-encoding/3.png" alt=""></p>
<p>Это свойство будет использоваться далее.</p>
<h3 id="шаг-5-зиг-заг-преобразование">Шаг 5. Зиг-заг преобразование</h3>
<p>Основной целью всех этих преобразований является удаление высокочастотных компонент, которые находятся в правом нижнем углу. Но для этого необходимо представить массив так, чтобы все высокочастотные значения шли последними в массиве. Для этого используется так называемое зиг-заг преобразование. Элементы массива 8х8 берутся в зигзагобразном порядке начиная с левого верхнего угла.</p>
<p><img src="/img/jpeg-encoding/4.png" alt=""></p>
<h3 id="шаг-6-квантизация">Шаг 6. Квантизация</h3>
<p>На этом шаге как раз и удаляются высокочастотные значения. Получившуюся матрицу на прошлом шаге необходимо поэлементно разделить на таблицу квантования. Y компонент имеет свою таблицу квантования, Cb и Cr - свою. Каждая из этих таблиц получена опытным путём на основе опроса множества людей.</p>
<pre><code> 16 11 10 16 24  40  51  61

 12 12 14 19 26  58  60  55

 14 13 16 24 40  57  69  56

 14 17 22 29 51  87  80  62

 18 22 37 56 68  109 103 77

 24 35 55 64 81  104 113 92

 49 64 78 87 103 121 120 101

 72 92 95 98 112 100 103 99 
</code></pre><p>Из этой таблицы видно, что значения правого нижнего угла имеют наибольшие значения и соответствуют высокочастотным значениям DU. Если поделить соответствующие значения таблиц друг на друга и округлить к ближайшему целому, то с большой вероятностью в правом нижнем углу будут 0.</p>
<p>Например, после выполнения дискретного косинусного преобразования мы имеем таблицу:</p>
<pre><code>364 42 0 0 0 0 0 0 
 63 20 0 0 0 0 0 0 
-24  0 0 0 0 0 0 0 
  0  0 0 0 0 0 0 0 
  0  0 0 0 0 0 0 0 
  0  0 0 0 0 0 0 0 
  0  0 0 0 0 0 0 0 
  0  0 0 0 0 0 0 0
</code></pre><p>После квантования и зиг-заг преобразования получаем:</p>
<pre><code>13 2 3 -1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
</code></pre><h3 id="шаг-7-кодирование-серий">Шаг 7. Кодирование серий</h3>
<p>Первый элемент массива обладает особыми свойствами - он всегда ненулевой. Поэтому в стандарте jpeg получившийся массив разбивают на 2 части и кодируют разными способами. Первый элемент называется DC коэффициент и я дальше опишу как он кодируется. Оставшийся массив называется AC коэффициентами. Их кодируют с помощью серий. Для этого массив записывают следующим образом:</p>
<pre><code>(0,2) (0,3) (0,-1) (0,1) (EOB)
</code></pre><p>Первое число обозначает количество &ldquo;0&rdquo;, которые идут перед вторым числом. EOB (end of block) - это особое число, которое показывает, что блок закончился и дальше идут только 0. Вот ещё один пример кодирования серий:</p>
<pre><code>57,45,0,0,0,0,23,0,-30,-16,0,,,,0
</code></pre><p>Даст:</p>
<pre><code>(0,57) (0,45) (4,23) (1,-30) (0,-16) (EOB)
</code></pre><p>Зиг-заг преобразование как раз и нужно было, чтобы поместить все &ldquo;0&rdquo; в конце и заменить их на EOB.</p>
<p>Одним из условий кодирования является то, что первое число не может быть больше 0xF. Поэтому 16 и более нулей кодируются в несколько блоков. Например, <code>57 восемнадцать нулей 45</code> кодируется как:</p>
<pre><code>(0, 57) (15, 0) (2, 45)
</code></pre><h3 id="шаг-8-кодирование-хаффмана-для-ac-коэффициентов">Шаг 8. Кодирование Хаффмана для AC коэффициентов</h3>
<p>Прежде, чем переходить к кодированию Хаффмана, необходимо описать, как хранятся числа согласно стандарту jpeg. Обычно, для хранения чисел в программе используют типы данных фиксированной длины: byte, short, int. В jpeg для хранения числа используется минимальное количество бит. Это значит, что для хранения числа &ldquo;1&rdquo; используется только 1 бит. Для хранения числа &ldquo;9&rdquo; используется 4 бита - 1001. Но так, как длина числа заранее неизвестна, то необходимо также хранить его длину. В стандарте jpeg длина числа называется категорией. Вот список возможных длин и соответствующих им чисел:</p>
<table>
	<thead>
		<tr>
			<th style="text-align: center;">Значения</th>
			<th style="width: 15%">Категория</th>
			<th style="text-align: center;">Биты</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td style="text-align: center;">0</td>
			<td style="text-align: center;">0</td>
			<td style="text-align: center;">-</td>
		</tr>
		<tr>
			<td style="text-align: center;">-1,1</td>
			<td style="text-align: center;">1</td>
			<td style="text-align: center;">0,1</td>
		</tr>
		<tr>
			<td style="text-align: center;">-3,-2,2,3</td>
			<td style="text-align: center;">2</td>
			<td style="text-align: center;">00,01,10,11</td>
		</tr>
		<tr>
			<td style="text-align: center;">-7,-6,-5,-4,4,5,6,7</td>
			<td style="text-align: center;">3</td>
			<td style="text-align: center;">000,001,010,011,100,101,110,111</td>
		</tr>
		<tr>
			<td style="text-align: center;">-15,..,-8,8,..,15</td>
			<td style="text-align: center;">4</td>
			<td style="text-align: center;">0000,..,0111,1000,..,1111</td>
		</tr>
		<tr>
			<td style="text-align: center;">-31,..,-16,16,..,31</td>
			<td style="text-align: center;">5</td>
			<td style="text-align: center;">00000,..,01111,10000,..,11111</td>
		</tr>
		<tr>
			<td style="text-align: center;">-63,..,-32,32,..,63</td>
			<td style="text-align: center;">6</td>
			<td style="text-align: center;">-</td>
		</tr>
		<tr>
			<td style="text-align: center;">-127,..,-64,64,..,127</td>
			<td style="text-align: center;">7</td>
			<td style="text-align: center;">-</td>
		</tr>
		<tr>
			<td style="text-align: center;">-255,..,-128,128,..,255</td>
			<td style="text-align: center;">8</td>
			<td style="text-align: center;">-</td>
		</tr>
		<tr>
			<td style="text-align: center;">-511,..,-256,256,..,511</td>
			<td style="text-align: center;">9</td>
			<td style="text-align: center;">-</td>
		</tr>
		<tr>
			<td style="text-align: center;">-1023,..,-512,512,..,1023</td>
			<td style="text-align: center;">10</td>
			<td style="text-align: center;">-</td>
		</tr>
		<tr>
			<td style="text-align: center;">-2047,..,-1024,1024,..,2047</td>
			<td style="text-align: center;">11</td>
			<td style="text-align: center;">-</td>
		</tr>
		<tr>
			<td style="text-align: center;">-4095,..,-2048,2048,..,4095</td>
			<td style="text-align: center;">12</td>
			<td style="text-align: center;">-</td>
		</tr>
		<tr>
			<td style="text-align: center;">-8191,..,-4096,4096,..,8191</td>
			<td style="text-align: center;">13</td>
			<td style="text-align: center;">-</td>
		</tr>
		<tr>
			<td style="text-align: center;">-16383,..,-8192,8192,..,16383</td>
			<td style="text-align: center;">14</td>
			<td style="text-align: center;">-</td>
		</tr>
		<tr>
			<td style="text-align: center;">-32767,..,-16384,16384,..,32767</td>
			<td style="text-align: center;">15</td>
			<td style="text-align: center;">-</td>
		</tr>
	</tbody>
</table>
<p>Результат с прошлого шага:</p>
<pre><code>(0,2) (0,3) (0,-1) (0,1) (EOB)
</code></pre><p>Можно переписать немного в другом виде - (количество нулей, категория, число в двоичной форме):</p>
<pre><code>(0,2,10) (0,2,11) (0,1,0) (0,1,1) (EOB)
</code></pre><p>Теперь можно заметить, что первые 2 числа не могут превышать байт. Количество нулей не может быть больше 0xF, а количество категорий тоже не может быть больше 0xF. Этот первый байт и кодируется с помощью <a href="https://ru.wikipedia.org/wiki/%D0%9A%D0%BE%D0%B4_%D0%A5%D0%B0%D1%84%D1%84%D0%BC%D0%B0%D0%BD%D0%B0">кода Хаффмана</a>.</p>
<p>В основе кодов Хаффмана лежит достаточно интересная идея: а давайте наиболее часто встречаемые числа будем кодировать наименьшим количеством бит. Например, для последовательности <code>6 6 4 5 6 4</code> число &ldquo;6&rdquo; заменить на &ldquo;0&rdquo;. Тогда вместо 110 оно будет кодироваться как 0. Но этого недостаточно. Необходимо кодировать количество бит в числе. Это делается с помощью <a href="https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%B5%D1%84%D0%B8%D0%BA%D1%81%D0%BD%D1%8B%D0%B9_%D0%BA%D0%BE%D0%B4">префиксного кодирования</a>. То есть зная префикс, можно однозначно определить значение числа. При этом редкие числа будут занимать больше бит. Более формальное описание кода Хаффмана с помощью бинарных деревьев можно почитать в <a href="https://ru.wikipedia.org/wiki/%D0%9A%D0%BE%D0%B4_%D0%A5%D0%B0%D1%84%D1%84%D0%BC%D0%B0%D0%BD%D0%B0">википедии</a>.</p>
<p>Для кодирования АС коэффициентов существует своя таблица Хаффмана. Она может быть определена в файле, либо заранее оговорена. Например, она <a href="https://www.w3.org/Graphics/JPEG/itu-t81.pdf">может выглядеть</a> так:</p>
<table>
	<thead>
		<tr>
			<th>Количество нулей / категория</th>
			<th>Длина кода</th>
			<th>Код</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>0/0 (EOB)</td>
			<td>4</td>
			<td>1010</td>
		</tr>
		<tr>
			<td>0/1</td>
			<td>2</td>
			<td>00</td>
		</tr>
		<tr>
			<td>0/2</td>
			<td>2</td>
			<td>01</td>
		</tr>
		<tr>
			<td>0/3</td>
			<td>3</td>
			<td>100</td>
		</tr>
		<tr>
			<td>0/4</td>
			<td>4</td>
			<td>1011</td>
		</tr>
		<tr>
			<td>1/1</td>
			<td>4</td>
			<td>1100</td>
		</tr>
		<tr>
			<td>0/5</td>
			<td>5</td>
			<td>11010</td>
		</tr>		
		<tr>
			<td colspan="3">...</td>
		</tr>
		<tr>
			<td>15/10</td>
			<td>16</td>
			<td>1111111111111110</td>
		</tr>
	</tbody>
</table>
<p>Это пример таблицы Хаффмана из стандарта jpeg. Однако, никто не мешает иметь собственную таблицу для каждого файла. На этом, кстати, основаны можество программ оптимизации jpeg файлов. Вместо того, чтобы использовать стандартную таблицу, эти программы считают количество наиболее частых чисел и на основе этого строят свои таблицы Хаффмана.</p>
<p>Хранение таблицы Хаффмана, тоже нетривиально. Вместо того, чтобы хранить результирующую таблицу, в файле хранятся 2 таблицы: список длин и список значений. По ним <a href="https://github.com/dernasherbrezon/ssdv4j/blob/master/src/main/java/ru/r2cloud/ssdv/DataUnitDecoder.java#L347">можно построить</a> необходимые таблицы.</p>
<p>Итак, используя таблицу Хаффмана, можно закодировать первый байт следующим образом:</p>
<pre><code>(01,10) (01,11) (00,0) (00,1) (1010)
</code></pre><p>Итого:</p>
<pre><code>011001110000011010
</code></pre><h3 id="шаг-9-кодирование-хаффмана-для-dc-коэффициента">Шаг 9. Кодирование Хаффмана для DC коэффициента</h3>
<p>Коэффициент DC особенный и поэтому кодируется отдельно. Алгоритм состоит из двух этапов:</p>
<ol>
<li>вычисление разницы с предыдущем DC коэффициентом. Исследователи заметили, что последовательные блоки 8х8 обычно имеют очень похожие DC коэффициенты. Если вычесть один из другого, то разница между ними небольшая и как следствие она будет занимать меньше бит при кодировании Хаффмана. Таким образом, кодируется только разница DC коэффициентов:</li>
</ol>
<pre><code>Разница = DC текущий - DC предыдущий
</code></pre><p>Если предыдущего нет, то он считается равным &ldquo;0&rdquo;.</p>
<ol start="2">
<li>На втором шаге число кодируется с помощью кодов Хаффмана. Например, &ldquo;13&rdquo; принадлежит 4ой категории: (4,1101). Для DC коэффициентов существует своя собственная таблица Хаффмана:</li>
</ol>
<table>
	<thead>
		<tr>
			<th>Категория</th>
			<th>Длина кода</th>
			<th>Код</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>0</td>
			<td>2</td>
			<td>00</td>
		</tr>
		<tr>
			<td>1</td>
			<td>3</td>
			<td>010</td>
		</tr>
		<tr>
			<td>2</td>
			<td>3</td>
			<td>011</td>
		</tr>
		<tr>
			<td>3</td>
			<td>3</td>
			<td>100</td>
		</tr>
		<tr>
			<td>4</td>
			<td>3</td>
			<td>101</td>
		</tr>
		<tr>
			<td>5</td>
			<td>3</td>
			<td>110</td>
		</tr>
		<tr>
			<td>6</td>
			<td>4</td>
			<td>1110</td>
		</tr>
		<tr>
			<td>7</td>
			<td>5</td>
			<td>11110</td>
		</tr>
		<tr>
			<td>8</td>
			<td>6</td>
			<td>111110</td>
		</tr>
		<tr>
			<td>9</td>
			<td>7</td>
			<td>1111110</td>
		</tr>
		<tr>
			<td>10</td>
			<td>8</td>
			<td>11111110</td>
		</tr>
		<tr>
			<td>11</td>
			<td>9</td>
			<td>111111110</td>
		</tr>
	</tbody>
</table>
<p>В результате DC коэффициент &ldquo;13&rdquo; будет кодирован как (101,1101):</p>
<pre><code>1011101
</code></pre><p>И финальный результат:</p>
<pre><code>1011101 011001110000011010
</code></pre><p>Если бы кодировали &ldquo;в лоб&rdquo;, то получилось бы (8 * 8) * 8 бит = 512 бит. Однако, с помощью различных алгоритмов, их удалось сократить до 25 бит. Итого, сжатие почти в 20 раз!</p>
<p>Таким же образом кодируются все оставшиеся DU.</p>
<h2 id="декодирование-jpeg">Декодирование jpeg</h2>
<p>Чтобы декодировать jpeg, необходимо выполнить все шаги в обратном порядке.</p>
<p>Отличительной особенностью декодирования является поиск кодового слова в таблице Хаффмана. Обычно для этих целей <a href="https://github.com/dernasherbrezon/ssdv4j/blob/master/src/main/java/ru/r2cloud/ssdv/DataUnitDecoder.java#L294">создают таблицы поиска</a> со всеми возможными префиксами кодов Хаффмана. После чего, из файла читаются 2 байта и по ним ищется категория, количество нулей и пр.</p>
<h2 id="бонус">Бонус</h2>
<p>Если внимательно прочитать алгоритмы, то можно заметить, что дискретное косинусное преобразование, квантизация и конвертация из RGB в YCbCr могут давать дробные значения. А так, как цвета хранятся в целом значении, то будет происходить округление. При одноразовом декодировании из jpeg (YCbCr) в RGB это округление не будет давать заметной ошибки. Однако, при многократной конвертации из растра в jpeg и обратно, ошибка будет накапливаться и давать <a href="https://www.impulseadventure.com/photo/jpeg-color-space.html">ощутимые результаты</a>.</p>
<p>Некоторые редакторы определяют так называемое &ldquo;степень сжатия&rdquo; jpeg. Это реализуется достаточно просто: все коэффициенты матрицы квантования умножаются на некоторое число. Чем больше число, тем больше коэффициент, тем больше вероятность, что в матрице значений цветов будут нули. Это одновременно уменьшает размер изображения и ухудшает его качество.</p>

</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'><div class='tags'><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>

</svg>
<span class='screen-reader-text'>tags: </span><a class='tag' href='/tags/jpeg/'>jpeg</a></div>

  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/posts/fosdem-2020/'>
        <span aria-hidden='true'><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>

</svg>
 </span>
        <span class='screen-reader-text'>: </span>Fosdem 2020</a>
    </div><div class='next-entry sep-before'>
      <a href='/posts/dslwp-b-images/'>
        <span class='screen-reader-text'>: </span>Изображения с DSLWP-B<span aria-hidden='true'> <svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
  <line x1="4" y1="12" x2="20" y2="12"/>
  <polyline points="14 6 20 12 14 18"/>

</svg>
</span>
      </a>
    </div></div>
</nav>


<section id='comments' class='comments'>
  <div class='container sep-before'>
    <div class='comments-area'><script>
  var remark_config = {
    host: "https://remark42.dernasherbrezon.com", 
    site_id: '9134',
    locale: 'ru',
    components: ['embed'] 
                          
                          
                          
                          
                          
  };

  (function(c) {
    for(var i = 0; i < c.length; i++){
      var d = document, s = d.createElement('script');
      s.src = remark_config.host + '/web/' +c[i] +'.js';
      s.defer = true;
      (d.head || d.body).appendChild(s);
    }
  })(remark_config.components || ['embed']);
</script>
<div id="remark42"></div>
</div>
  </div>
</section>

      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><section class='widget widget-social_menu sep-after'><nav aria-label=''>
    <ul><li>
        <a href='https://github.com/dernasherbrezon' target='_blank' rel='noopener me'>
          <span class='screen-reader-text'></span><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
      <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>

</svg>
</a>
      </li><li>
        <a href='https://twitter.com/dernasherbrezon' target='_blank' rel='noopener me'>
          <span class='screen-reader-text'></span><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
  <title>Twitter icon</title>
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>

</svg>
</a>
      </li><li>
        <a href='mailto:dernasherbrezon@gmail.com' target='_blank' rel='noopener me'>
          <span class='screen-reader-text'></span><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline>
</svg>
</a>
      </li><li>
        <a href='https://t.me/dernasherbrezonChannel' target='_blank' rel='noopener me'>
          <span class='screen-reader-text'></span><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <title>Telegram icon</title><path d="M23.91 3.79L20.3 20.84c-.25 1.21-.98 1.5-2 .94l-5.5-4.07-2.66 2.57c-.3.3-.55.56-1.1.56-.72 0-.6-.27-.84-.95L6.3 13.7l-5.45-1.7c-1.18-.35-1.19-1.16.26-1.75l21.26-8.2c.97-.43 1.9.24 1.53 1.73z"/>
</svg>
</a>
      </li></ul>
  </nav>
</section><div class='copyright'>
  <p><a href="https://creativecommons.org/licenses/by-nc-nd/3.0/">CC BY-NC-ND 3.0</a> &copy; 2017-2021 dernasherbrezon </p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__assets_js_src="/assets/js/"</script>

<script src='/assets/js/main.c3bcf2df.js'></script>

</body>

</html>

