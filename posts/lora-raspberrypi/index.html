<!DOCTYPE html>
<html lang='ru' dir='auto'><head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='Продолжая работать над новой библиотекой sx127x, я решил добавить поддержку Linux и RaspberryPI в частности. Помимо чисто практической надобности, мне хотелось понять насколько отличается программирование под микроконтроллеры от обычных операционных систем.
Я с самого начала спроектировал библиотеку достаточно хорошо, поэтому для миграции под Linux потребовалось совсем немного изменений:
 отказаться от esp_err.h и сделать возвращаемые коды типа int вынести работут с SPI в отдельный заголовок и переопределить для разных платформ  Если первый пункт достаточно простой, то со вторым пришлось повозиться.'>
<meta name='theme-color' content='#ffcd00'>

<meta property='og:title' content='sx127x для RaspberryPI • dernasherbrezon'>
<meta property='og:description' content='Продолжая работать над новой библиотекой sx127x, я решил добавить поддержку Linux и RaspberryPI в частности. Помимо чисто практической надобности, мне хотелось понять насколько отличается программирование под микроконтроллеры от обычных операционных систем.
Я с самого начала спроектировал библиотеку достаточно хорошо, поэтому для миграции под Linux потребовалось совсем немного изменений:
 отказаться от esp_err.h и сделать возвращаемые коды типа int вынести работут с SPI в отдельный заголовок и переопределить для разных платформ  Если первый пункт достаточно простой, то со вторым пришлось повозиться.'>
<meta property='og:url' content='https://dernasherbrezon.com/posts/lora-raspberrypi/'>
<meta property='og:site_name' content='dernasherbrezon'>
<meta property='og:type' content='article'><meta property='article:section' content='posts'><meta property='article:tag' content='c'><meta property='article:tag' content='lora'><meta property='article:tag' content='raspberrypi'><meta property='article:published_time' content='2023-01-15T12:59:18Z'/><meta property='article:modified_time' content='2023-01-15T12:59:18Z'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@dernasherbrezon'>

<meta name="generator" content="Hugo 0.81.0" />

  <title>sx127x для RaspberryPI • dernasherbrezon</title>
  <link rel='canonical' href='https://dernasherbrezon.com/posts/lora-raspberrypi/'>
  
    <link href="https://dernasherbrezon.com/posts/lora-raspberrypi/index.xml" rel="alternate" type="application/rss+xml" title="dernasherbrezon" />
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.ab98e12b.css'><link rel='stylesheet' href='/css/custom.1.css'><style>
:root{--color-accent:#ffcd00;}
</style>

  <meta name="telegram:channel" content="@dernasherbrezonChannel">
<link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
</head>
<body class='page type-posts has-sidebar'>

  <div class='site'><div id='sidebar' class='sidebar'>
  <a class='screen-reader-text' href='#main-menu'></a>

  <div class='container'><section class='widget widget-about sep-after'>
  <header>
    
    <div class='logo'>
      <a href='/'>
        <img src='/img/logo.jpeg'>
      </a>
    </div>
    
    <h2 class='title site-title '>
      <a href='/'>
      dernasherbrezon
      </a>
    </h2>
    <div class='desc'>
    Блог о программировании на Java
    </div>
  </header>

</section>
<section class='widget widget-sidebar_menu sep-after'><nav id='sidebar-menu' class='menu sidebar-menu' aria-label=''>
    <div class='container'>
      <ul><li class='item'>
  <a href='/posts/'>Все записи</a></li><li class='item'>
  <a href='/%D0%BE%D0%B1-%D0%B0%D0%B2%D1%82%D0%BE%D1%80%D0%B5/'>Об авторе</a></li><li class='item'>
  <a href='/%D0%BF%D0%BE%D0%B4%D0%B4%D0%B5%D1%80%D0%B6%D0%B0%D1%82%D1%8C/'>Поддержать</a></li></ul>
    </div>
  </nav>

</section><section class='widget widget-taxonomy_cloud sep-after'>
  <header>
    <h4 class='title widget-title'>Тэги</h4>
  </header>

  <div class='container list-container'>
  <ul class='list taxonomy-cloud'><li>
        <a href='/tags/abbreviated-jpeg/' style='font-size:1.0217391304347827em'>abbreviated jpeg</a>
      </li><li>
        <a href='/tags/acme/' style='font-size:1em'>acme</a>
      </li><li>
        <a href='/tags/api/' style='font-size:1.065217391304348em'>api</a>
      </li><li>
        <a href='/tags/apt/' style='font-size:1.065217391304348em'>apt</a>
      </li><li>
        <a href='/tags/awgn/' style='font-size:1em'>awgn</a>
      </li><li>
        <a href='/tags/bash/' style='font-size:1.0217391304347827em'>bash</a>
      </li><li>
        <a href='/tags/ber/' style='font-size:1.108695652173913em'>ber</a>
      </li><li>
        <a href='/tags/bpsk/' style='font-size:1.0217391304347827em'>bpsk</a>
      </li><li>
        <a href='/tags/c/' style='font-size:1.391304347826087em'>c</a>
      </li><li>
        <a href='/tags/deb/' style='font-size:1.0869565217391304em'>deb</a>
      </li><li>
        <a href='/tags/docker/' style='font-size:1em'>docker</a>
      </li><li>
        <a href='/tags/dsp/' style='font-size:1.108695652173913em'>dsp</a>
      </li><li>
        <a href='/tags/eclipse/' style='font-size:1em'>eclipse</a>
      </li><li>
        <a href='/tags/embedded/' style='font-size:1.108695652173913em'>embedded</a>
      </li><li>
        <a href='/tags/esp32/' style='font-size:1.108695652173913em'>esp32</a>
      </li><li>
        <a href='/tags/flot/' style='font-size:1em'>flot</a>
      </li><li>
        <a href='/tags/fsk/' style='font-size:1.065217391304348em'>fsk</a>
      </li><li>
        <a href='/tags/gc/' style='font-size:1em'>gc</a>
      </li><li>
        <a href='/tags/gdal/' style='font-size:1.0217391304347827em'>gdal</a>
      </li><li>
        <a href='/tags/georeferencing/' style='font-size:1.065217391304348em'>georeferencing</a>
      </li><li>
        <a href='/tags/geotiff/' style='font-size:1.0434782608695652em'>geotiff</a>
      </li><li>
        <a href='/tags/gnuradio/' style='font-size:1.065217391304348em'>gnuradio</a>
      </li><li>
        <a href='/tags/hibernate/' style='font-size:1em'>hibernate</a>
      </li><li>
        <a href='/tags/j2ee/' style='font-size:1.0217391304347827em'>j2ee</a>
      </li><li>
        <a href='/tags/java/' style='font-size:2em'>Java</a>
      </li><li>
        <a href='/tags/javafx/' style='font-size:1em'>javafx</a>
      </li><li>
        <a href='/tags/javascript/' style='font-size:1.0869565217391304em'>javascript</a>
      </li><li>
        <a href='/tags/jetty/' style='font-size:1.0434782608695652em'>jetty</a>
      </li><li>
        <a href='/tags/jmeter/' style='font-size:1em'>jmeter</a>
      </li><li>
        <a href='/tags/jpeg/' style='font-size:1.108695652173913em'>jpeg</a>
      </li><li>
        <a href='/tags/jpoint/' style='font-size:1em'>jpoint</a>
      </li><li>
        <a href='/tags/jquery/' style='font-size:1em'>jquery</a>
      </li><li>
        <a href='/tags/jsp/' style='font-size:1.065217391304348em'>jsp</a>
      </li><li>
        <a href='/tags/jstl/' style='font-size:1.0434782608695652em'>jstl</a>
      </li><li>
        <a href='/tags/junit/' style='font-size:1.0434782608695652em'>junit</a>
      </li><li>
        <a href='/tags/letsencrypt/' style='font-size:1em'>letsencrypt</a>
      </li><li>
        <a href='/tags/log4j/' style='font-size:1em'>log4j</a>
      </li><li>
        <a href='/tags/lora/' style='font-size:1.108695652173913em'>lora</a>
      </li><li>
        <a href='/tags/lrpt/' style='font-size:1.0434782608695652em'>lrpt</a>
      </li><li>
        <a href='/tags/matlab/' style='font-size:1.0217391304347827em'>matlab</a>
      </li><li>
        <a href='/tags/maven/' style='font-size:1.108695652173913em'>maven</a>
      </li><li>
        <a href='/tags/memory/' style='font-size:1.0217391304347827em'>memory</a>
      </li><li>
        <a href='/tags/meteor-m/' style='font-size:1.0869565217391304em'>meteor-m</a>
      </li><li>
        <a href='/tags/mobitex/' style='font-size:1em'>mobitex</a>
      </li><li>
        <a href='/tags/monitoring/' style='font-size:1.108695652173913em'>monitoring</a>
      </li><li>
        <a href='/tags/open-source/' style='font-size:1.0434782608695652em'>open source</a>
      </li><li>
        <a href='/tags/openapi/' style='font-size:1.0217391304347827em'>openapi</a>
      </li><li>
        <a href='/tags/opencl/' style='font-size:1.0434782608695652em'>opencl</a>
      </li><li>
        <a href='/tags/openstack/' style='font-size:1em'>openstack</a>
      </li><li>
        <a href='/tags/openstack-swift/' style='font-size:1em'>openstack swift</a>
      </li><li>
        <a href='/tags/orekit/' style='font-size:1.0217391304347827em'>orekit</a>
      </li><li>
        <a href='/tags/pipe/' style='font-size:1em'>pipe</a>
      </li><li>
        <a href='/tags/plutosdr/' style='font-size:1.0217391304347827em'>plutosdr</a>
      </li><li>
        <a href='/tags/prometheus/' style='font-size:1.0217391304347827em'>prometheus</a>
      </li><li>
        <a href='/tags/r2cloud/' style='font-size:1.065217391304348em'>r2cloud</a>
      </li><li>
        <a href='/tags/r2lora/' style='font-size:1.065217391304348em'>r2lora</a>
      </li><li>
        <a href='/tags/r2weather/' style='font-size:1.0434782608695652em'>r2weather</a>
      </li><li>
        <a href='/tags/radio/' style='font-size:1.2391304347826086em'>Радио</a>
      </li><li>
        <a href='/tags/raspberrypi/' style='font-size:1.391304347826087em'>raspberrypi</a>
      </li><li>
        <a href='/tags/refactoring/' style='font-size:1em'>refactoring</a>
      </li><li>
        <a href='/tags/rest/' style='font-size:1.0217391304347827em'>REST</a>
      </li><li>
        <a href='/tags/rrd/' style='font-size:1.0217391304347827em'>rrd</a>
      </li><li>
        <a href='/tags/rtl_power/' style='font-size:1.0217391304347827em'>rtl_power</a>
      </li><li>
        <a href='/tags/rtlsdr/' style='font-size:1.2391304347826086em'>rtlsdr</a>
      </li><li>
        <a href='/tags/rtlspectrum/' style='font-size:1.0434782608695652em'>rtlSpectrum</a>
      </li><li>
        <a href='/tags/s3/' style='font-size:1em'>s3</a>
      </li><li>
        <a href='/tags/satnogs/' style='font-size:1.0434782608695652em'>satnogs</a>
      </li><li>
        <a href='/tags/sdr-modem/' style='font-size:1.065217391304348em'>sdr-modem</a>
      </li><li>
        <a href='/tags/security/' style='font-size:1.0217391304347827em'>security</a>
      </li><li>
        <a href='/tags/selectel/' style='font-size:1em'>selectel</a>
      </li><li>
        <a href='/tags/simd/' style='font-size:1.065217391304348em'>SIMD</a>
      </li><li>
        <a href='/tags/sonarcube/' style='font-size:1.0434782608695652em'>sonarcube</a>
      </li><li>
        <a href='/tags/spring/' style='font-size:1.0434782608695652em'>spring</a>
      </li><li>
        <a href='/tags/sqnr/' style='font-size:1em'>sqnr</a>
      </li><li>
        <a href='/tags/ssdv/' style='font-size:1.0217391304347827em'>ssdv</a>
      </li><li>
        <a href='/tags/string/' style='font-size:1.0217391304347827em'>String</a>
      </li><li>
        <a href='/tags/systemd/' style='font-size:1em'>systemd</a>
      </li><li>
        <a href='/tags/testing/' style='font-size:1.0434782608695652em'>testing</a>
      </li><li>
        <a href='/tags/travis-ci/' style='font-size:1.0217391304347827em'>travis-ci</a>
      </li><li>
        <a href='/tags/ubuntu/' style='font-size:1.0869565217391304em'>ubuntu</a>
      </li><li>
        <a href='/tags/valgrind/' style='font-size:1.0434782608695652em'>valgrind</a>
      </li><li>
        <a href='/tags/validator/' style='font-size:1em'>validator</a>
      </li><li>
        <a href='/tags/vuejs/' style='font-size:1.0434782608695652em'>vuejs</a>
      </li><li>
        <a href='/tags/yourkit/' style='font-size:1em'>yourkit</a>
      </li><li>
        <a href='/tags/%D0%B0%D0%B4%D0%BC%D0%B8%D0%BD%D0%B8%D1%81%D1%82%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5/' style='font-size:1.2608695652173914em'>администрирование</a>
      </li><li>
        <a href='/tags/%D0%B4%D0%B7%D0%B7/' style='font-size:1.065217391304348em'>ДЗЗ</a>
      </li><li>
        <a href='/tags/%D0%B4%D0%B8%D0%B7%D0%B0%D0%B9%D0%BD/' style='font-size:1.065217391304348em'>дизайн</a>
      </li><li>
        <a href='/tags/%D0%B8%D0%B4%D0%B5%D0%B8/' style='font-size:1em'>идеи</a>
      </li><li>
        <a href='/tags/%D0%BA%D0%BE%D1%81%D0%BC%D0%BE%D0%BD%D0%B0%D0%B2%D1%82%D0%B8%D0%BA%D0%B0/' style='font-size:1.0434782608695652em'>космонавтика</a>
      </li><li>
        <a href='/tags/%D0%BA%D1%83%D0%B1%D1%81%D0%B0%D1%82/' style='font-size:1.0434782608695652em'>кубсат</a>
      </li><li>
        <a href='/tags/%D0%BF%D0%B5%D1%80%D0%B5%D0%B2%D0%BE%D0%B4/' style='font-size:1.0217391304347827em'>перевод</a>
      </li><li>
        <a href='/tags/%D0%BF%D0%BE%D0%B2%D0%BE%D1%80%D0%BE%D1%82%D0%BD%D0%BE%D0%B5-%D1%83%D1%81%D1%82%D1%80%D0%BE%D0%B9%D1%81%D1%82%D0%B2%D0%BE/' style='font-size:1.065217391304348em'>поворотное устройство</a>
      </li><li>
        <a href='/tags/%D0%BF%D1%80%D0%BE%D0%B8%D0%B7%D0%B2%D0%BE%D0%B4%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D0%BE%D1%81%D1%82%D1%8C/' style='font-size:1.3260869565217392em'>производительность</a>
      </li><li>
        <a href='/tags/%D1%80%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B0/' style='font-size:1.065217391304348em'>разработка</a>
      </li><li>
        <a href='/tags/%D1%81%D0%BF%D0%B5%D1%86%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F/' style='font-size:1em'>спецификация</a>
      </li><li>
        <a href='/tags/%D1%81%D0%BF%D1%83%D1%82%D0%BD%D0%B8%D0%BA%D0%B8/' style='font-size:1.391304347826087em'>спутники</a>
      </li><li>
        <a href='/tags/%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5/' style='font-size:1.1739130434782608em'>тестирование</a>
      </li><li>
        <a href='/tags/%D1%84%D0%B8%D0%BB%D1%8C%D1%82%D1%80%D1%8B/' style='font-size:1.0434782608695652em'>фильтры</a>
      </li></ul>
</div>


</section>
</div>

  <div class='sidebar-overlay'></div>
</div><div class='main'><nav id='main-menu' class='menu main-menu' aria-label=''>
  <div class='container'>
    <a class='screen-reader-text' href='#content'></a>

<button id='sidebar-toggler' class='sidebar-toggler' aria-controls='sidebar'>
  <span class='screen-reader-text'></span>
  <span class='open'><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
  <line x1="3" y1="12" x2="21" y2="12" />
  <line x1="3" y1="6" x2="21" y2="6" />
  <line x1="3" y1="18" x2="21" y2="18" />

</svg>
</span>
  <span class='close'><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
  <line x1="18" y1="6" x2="6" y2="18" />
  <line x1="6" y1="6" x2="18" y2="18" />

</svg>
</span>
</button>
    <ul><li class='item'>
        <a href='/posts/'>Все записи</a>
      </li><li class='item'>
        <a href='/%D0%BE%D0%B1-%D0%B0%D0%B2%D1%82%D0%BE%D1%80%D0%B5/'>Об авторе</a>
      </li><li class='item'>
        <a href='/%D0%BF%D0%BE%D0%B4%D0%B4%D0%B5%D1%80%D0%B6%D0%B0%D1%82%D1%8C/'>Поддержать</a>
      </li></ul>
  </div>
</nav><div class='header-widgets'>
        <div class='container'></div>
      </div>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>dernasherbrezon</p><p class='desc site-desc'>Блог о программировании на Java</p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='ru' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>sx127x для RaspberryPI</h1>
      

    </div>
    <div class='entry-meta'>
  <span class='posted-on'><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>

</svg>
<span class='screen-reader-text'> </span>
  <time class='entry-date' datetime='2023-01-15T12:59:18Z'>15 Jan 2023</time>
</span>

  
  

</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  <p>Продолжая работать над новой <a href="https://github.com/dernasherbrezon/sx127x">библиотекой sx127x</a>, я решил добавить поддержку Linux и RaspberryPI в частности. Помимо чисто практической надобности, мне хотелось понять насколько отличается программирование под микроконтроллеры от обычных операционных систем.</p>
<p>Я с самого начала спроектировал библиотеку достаточно хорошо, поэтому для миграции под Linux потребовалось совсем немного изменений:</p>
<ul>
<li>отказаться от esp_err.h и сделать возвращаемые коды типа <code>int</code></li>
<li>вынести работут с SPI в отдельный заголовок и переопределить для разных платформ</li>
</ul>
<p>Если первый пункт достаточно простой, то со вторым пришлось повозиться.</p>
<h2 id="spi-в-linux">SPI в Linux</h2>
<p>В современных версиях ядра Linux (4.x+) есть поддержка SPI. На стороне операционной системы есть драйвер, который создаёт устройства вида <code>/dev/spidevX.X</code> для работы из пользовательского режима. Каждое мастер-устройство может иметь от одного до несколько SPI шин. Каждая шина состоит из нескольких проводов: MOSI, MISO, SCLK, SS. К каждой шине может подключаться до несколько slave устройств.</p>
<p><img src="/img/lora-raspberrypi/3.png" alt=""></p>
<p>В RaspberryPI по-умолчанию включена только одна SPI шина SPI0. У неё адрес <code>/dev/spidev0.X</code>. При желании можно включить и вторую шину в файле <code>/boot/config.txt</code>:</p>
<pre><code>dtoverlay=spi1-3cs
</code></pre><p>К каждой шине RaspberryPI можно подключить до двух slave устройств.</p>
<p><img src="/img/lora-raspberrypi/1.png" alt=""></p>
<p>Таким образом получается, что SPI драйвер создаст 4 файла:</p>
<ul>
<li>/dev/spidev0.0</li>
<li>/dev/spidev0.1</li>
<li>/dev/spidev1.0</li>
<li>/dev/spidev1.1</li>
</ul>
<p>Если в ESP32 при инициализации SPI нужно было явно прописывать какой пин отвечает за какой сигнал, то в RaspberryPI достаточно открыть нужное устройство для работы:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> spi_device_fd <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;/dev/spidev0.0&#34;</span>, O_RDWR);
<span style="color:#66d9ef">if</span> (spi_device_fd <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
    perror(<span style="color:#e6db74">&#34;unable to open device&#34;</span>);
    <span style="color:#66d9ef">return</span> EXIT_FAILURE;
}
</code></pre></div><p>А далее уже конфигурировать, используя ioctl:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> mode <span style="color:#f92672">=</span> SPI_MODE_0; <span style="color:#75715e">// CPOL=0, CPHA=0
</span><span style="color:#75715e"></span>LINUX_ERROR_CHECK(ioctl(spi_device_fd, SPI_IOC_WR_MODE, <span style="color:#f92672">&amp;</span>mode));
</code></pre></div><p>API для отправки и получения данных выглядит очень похоже на ESP32:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">struct</span> spi_ioc_transfer tr[<span style="color:#ae81ff">2</span>];
memset(<span style="color:#f92672">&amp;</span>tr, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(tr));
tr[<span style="color:#ae81ff">0</span>].tx_buf <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)<span style="color:#f92672">&amp;</span>reg;
tr[<span style="color:#ae81ff">0</span>].len <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
tr[<span style="color:#ae81ff">1</span>].rx_buf <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)result;
tr[<span style="color:#ae81ff">1</span>].len <span style="color:#f92672">=</span> data_length;
<span style="color:#66d9ef">int</span> code <span style="color:#f92672">=</span> ioctl(<span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)spi_device, SPI_IOC_MESSAGE(<span style="color:#ae81ff">2</span>), <span style="color:#f92672">&amp;</span>tr);
</code></pre></div><p>Для этого используется структура <code>spi_ioc_transfer</code> и всё тот же ioctl. В примере выше показан полудуплексный режим работы: сначала отправляется команда с типом регистра, а потом читается ответ в переменную <code>result</code> длины <code>data_length</code>. Для полнодуплексного режима нужно было бы использовать всего одно сообщение, в котором были бы заполненны <code>tx_buf</code> и <code>rx_buf</code>. Однако, для управления sx127x достаточно полудуплексного режима.</p>
<h2 id="gpio-в-linux">GPIO в Linux</h2>
<p>В принципе, одного SPI достаточно, чтобы работать с sx127x. Для того, чтобы получить сообщение, нужно было бы периодически вызывать функцию <code>sx127x_handle_interrupt</code>. Она проверяет выставлен ли флаг полученного сообщения и вызывает нужный обработчик. Однако, если сообщения приходят часто или через заранее неизвестные интервалы, то при таком способе можно пропустить пакет. Каждый новый будет перезатирать предыдущий во внутренней памяти чипа. Чтобы этого избежать, нужно использовать прерывания. В sx127x есть целых 6 пинов, которые генерируют различные типы прерываний. Для отправки и получения достаточно подключить только один - DIO0.</p>
<p>Но как обработать его в Linux?</p>
<p>Для этого нужно использовать gpio драйвер. Это стандартный драйвер, который разграничивает доступ пользователей к пинам устройства и позволяет работать нескольким программам независимо.</p>
<p>В RaspberryPI он создаёт устройство <code>/dev/gpiochip0</code>. Его нужно открыть, чтобы начать работу:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> fd <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;/dev/gpiochip0&#34;</span>, O_RDONLY);
<span style="color:#66d9ef">if</span> (fd <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
    perror(<span style="color:#e6db74">&#34;unable to open device&#34;</span>);
    <span style="color:#66d9ef">return</span> EXIT_FAILURE;
}
</code></pre></div><p>Далее зарезервировать один из пинов или &ldquo;линию&rdquo; в терминологии Linux:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">struct</span> gpioevent_request rq;
rq.lineoffset <span style="color:#f92672">=</span> <span style="color:#ae81ff">27</span>;
rq.eventflags <span style="color:#f92672">=</span> GPIOEVENT_EVENT_RISING_EDGE;
<span style="color:#66d9ef">char</span> label[] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;lora_raspberry&#34;</span>;
memcpy(rq.consumer_label, label, <span style="color:#66d9ef">sizeof</span>(label));
rq.handleflags <span style="color:#f92672">=</span> GPIOHANDLE_REQUEST_INPUT;
<span style="color:#66d9ef">int</span> code <span style="color:#f92672">=</span> ioctl(fd, GPIO_GET_LINEEVENT_IOCTL, <span style="color:#f92672">&amp;</span>rq);
</code></pre></div><p>В примере выше я резервирую пин 27 для получения событий. Событие в данном случае это изменение состояния с &ldquo;низкий уровень&rdquo; на &ldquo;высокий уровень&rdquo;. Это именно то, что будет делать чип при генерации прерывания.</p>
<p>После этого необходимо ожидать событие с помощью poll API:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">struct</span> pollfd pfd;
pfd.fd <span style="color:#f92672">=</span> rq.fd;
pfd.events <span style="color:#f92672">=</span> POLLIN;
fprintf(stdout, <span style="color:#e6db74">&#34;waiting for packets...</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>) {
    code <span style="color:#f92672">=</span> poll(<span style="color:#f92672">&amp;</span>pfd, <span style="color:#ae81ff">1</span>, GPIO_POLL_TIMEOUT);
    <span style="color:#66d9ef">if</span> (code <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
        perror(<span style="color:#e6db74">&#34;unable to receive gpio interrupt&#34;</span>);
        <span style="color:#66d9ef">break</span>;
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (pfd.events <span style="color:#f92672">&amp;</span> POLLIN) {
        sx127x_handle_interrupt(device);
    }
}
close(rq.fd);
</code></pre></div><p>Если событие получено, то вызывать функцию-обработчик прерывания <code>sx127x_handle_interrupt</code>.</p>
<h2 id="сборка">Сборка</h2>
<p>Пару слов нужно сказать о сборке проекта. Из-за того, что API для SPI отличается между ESP32 и Linux, мне пришлось вынести весь код, работающий с SPI в отдельный файл <code>sx127x_spi.h</code>. В нём есть 4 метода следующего вида, которые имплементированы по разному для разных платформ:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * @brief Read up to 4 bytes from device via SPI
</span><span style="color:#75715e"> * 
</span><span style="color:#75715e"> * @param reg Register
</span><span style="color:#75715e"> * @param spi_device Pointer to variable to hold the device handle. Can be different on different platforms
</span><span style="color:#75715e"> * @param data_length Number of bytes to read into result
</span><span style="color:#75715e"> * @param result Where the data will be written to
</span><span style="color:#75715e"> * @return 
</span><span style="color:#75715e"> *         - SX127X_ERR_INVALID_ARG   if parameter is invalid
</span><span style="color:#75715e"> *         - SX127X_OK                on success
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">sx127x_spi_read_registers</span>(<span style="color:#66d9ef">int</span> reg, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>spi_device, size_t data_length, uint32_t <span style="color:#f92672">*</span>result);
</code></pre></div><p>Во время сборки под RaspberryPI я компилирую <code>sx127x_linux_spi.c</code>, а для ESP32 - <code>sx127x_esp_spi.c</code>.</p>
<h2 id="тестирование">Тестирование</h2>
<p>Для тестирования я купил модуль RA-02. Он содержит внутри себя чип sx1278. Пришлось немного попаять, чтобы в результате получилось что-то вроде этого:</p>
<p><img src="/img/lora-raspberrypi/2.png" alt=""></p>
<p>В своём тесте я передавал сигнал с ESP32 на другой ESP32 и RaspberryPI. Всё сработало идеально, за исключением расчёта ошибки частоты. sx127x чип может вычислить разницу между частотой на которой было получено сообщение и частотой, на которую был настроен приёмник. В случае с ESP32 он выдавал около -473 Гц, а для RaspberryPI около 4024 Гц. Скорее всего это объясняется тем, что кристаллы-генераторы несущей частоты немного отличаются для двух модулей.</p>

</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'><div class='tags'><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>

</svg>
<span class='screen-reader-text'>tags: </span><a class='tag' href='/tags/c/'>c</a>, <a class='tag' href='/tags/lora/'>lora</a>, <a class='tag' href='/tags/raspberrypi/'>raspberrypi</a></div>

  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/posts/sx127x/'>
        <span aria-hidden='true'><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>

</svg>
 </span>
        <span class='screen-reader-text'>: </span>sx127x</a>
    </div></div>
</nav>


<section id='comments' class='comments'>
  <div class='container sep-before'>
    <div class='comments-area'><script>
  var remark_config = {
    host: "https://remark42.dernasherbrezon.com", 
    site_id: '9134',
    locale: 'ru',
    components: ['embed'] 
                          
                          
                          
                          
                          
  };

  (function(c) {
    for(var i = 0; i < c.length; i++){
      var d = document, s = d.createElement('script');
      s.src = remark_config.host + '/web/' +c[i] +'.js';
      s.defer = true;
      (d.head || d.body).appendChild(s);
    }
  })(remark_config.components || ['embed']);
</script>
<div id="remark42"></div>
</div>
  </div>
</section>

      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><section class='widget widget-social_menu sep-after'><nav aria-label=''>
    <ul><li>
        <a href='https://github.com/dernasherbrezon' target='_blank' rel='noopener me'>
          <span class='screen-reader-text'></span><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
      <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>

</svg>
</a>
      </li><li>
        <a href='https://twitter.com/dernasherbrezon' target='_blank' rel='noopener me'>
          <span class='screen-reader-text'></span><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
  <title>Twitter icon</title>
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>

</svg>
</a>
      </li><li>
        <a href='mailto:dernasherbrezon@gmail.com' target='_blank' rel='noopener me'>
          <span class='screen-reader-text'></span><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline>
</svg>
</a>
      </li><li>
        <a href='https://t.me/dernasherbrezonChannel' target='_blank' rel='noopener me'>
          <span class='screen-reader-text'></span><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <title>Telegram icon</title><path d="M23.91 3.79L20.3 20.84c-.25 1.21-.98 1.5-2 .94l-5.5-4.07-2.66 2.57c-.3.3-.55.56-1.1.56-.72 0-.6-.27-.84-.95L6.3 13.7l-5.45-1.7c-1.18-.35-1.19-1.16.26-1.75l21.26-8.2c.97-.43 1.9.24 1.53 1.73z"/>
</svg>
</a>
      </li></ul>
  </nav>
</section><div class='copyright'>
  <p><a href="https://creativecommons.org/licenses/by-nc-nd/3.0/">CC BY-NC-ND 3.0</a> &copy; 2017-2023 dernasherbrezon </p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__assets_js_src="/assets/js/"</script>

<script src='/assets/js/main.c3bcf2df.js'></script>
</body>

</html>

