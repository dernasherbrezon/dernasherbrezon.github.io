<!DOCTYPE html>
<html lang='en' dir='auto'><head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='Having thoroughly understood how Power Profiler Kit 2 (PPK2) works, I decided to test power consumption under different conditions. In fact, lora-at is not such a simple application. It works with bluetooth and the sx127x chip, processes commands from the UART bus and has a deep sleep mode. So there is a plenty of things to look for.
Measurement methodology Before you start measuring something, you need to decide how it will be measured.'>
<meta name='theme-color' content='#ffcd00'>

<meta property='og:title' content='Power consumption in lora-at • dernasherbrezon'>
<meta property='og:description' content='Having thoroughly understood how Power Profiler Kit 2 (PPK2) works, I decided to test power consumption under different conditions. In fact, lora-at is not such a simple application. It works with bluetooth and the sx127x chip, processes commands from the UART bus and has a deep sleep mode. So there is a plenty of things to look for.
Measurement methodology Before you start measuring something, you need to decide how it will be measured.'>
<meta property='og:url' content='https://dernasherbrezon.com/en/posts/lora-at-power-profiling/'>
<meta property='og:site_name' content='dernasherbrezon'>
<meta property='og:type' content='article'><meta property='article:section' content='posts'><meta property='article:tag' content='lora'><meta property='article:tag' content='lora-at'><meta property='article:tag' content='esp32'><meta property='article:tag' content='esp-idf'><meta property='article:tag' content='PPK2'><meta property='article:published_time' content='2023-11-25T23:28:18&#43;01:00'/><meta property='article:modified_time' content='2023-11-25T23:28:18&#43;01:00'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@dernasherbrezon'>

<meta name="generator" content="Hugo 0.124.0">

  <title>Power consumption in lora-at • dernasherbrezon</title>
  <link rel='canonical' href='https://dernasherbrezon.com/en/posts/lora-at-power-profiling/'>
  
    <link href="https://dernasherbrezon.com/en/posts/lora-at-power-profiling/index.xml" rel="alternate" type="application/rss+xml" title="dernasherbrezon" />
  
  <link rel='alternate' hreflang='en' href='https://dernasherbrezon.com/en/posts/lora-at-power-profiling/'><link rel='alternate' hreflang='ru' href='https://dernasherbrezon.com/posts/lora-at-power-profiling/'><link rel='alternate' hreflang='x-default' href='https://dernasherbrezon.com/posts/lora-at-power-profiling/'>
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.ab98e12b.css'><link rel='stylesheet' href='/css/custom.1.css'><style>
:root{--color-accent:#ffcd00;}
</style>

  <meta name="telegram:channel" content="@dernasherbrezonChannel">
<link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><script src="/js/chart.min.js"></script>
</head>
<body class='page type-posts has-sidebar'>

  <div class='site'><div id='sidebar' class='sidebar'>
  <a class='screen-reader-text' href='#main-menu'>Skip to Main Menu</a>

  <div class='container'><section class='widget widget-about sep-after'>
  <header>
    
    <div class='logo'>
      <a href='/en/'>
        <img src='/img/logo.jpeg'>
      </a>
    </div>
    
    <h2 class='title site-title '>
      <a href='/en/'>
      dernasherbrezon
      </a>
    </h2>
    <div class='desc'>
    Blog about software development
    </div>
  </header>

</section>
<section class='widget widget-taxonomy_cloud sep-after'>
  <header>
    <h4 class='title widget-title'>Tags</h4>
  </header>

  <div class='container list-container'>
  <ul class='list taxonomy-cloud'><li>
        <a href='/en/tags/admin/' style='font-size:1.4285714285714286em'>Admin</a>
      </li><li>
        <a href='/en/tags/apt/' style='font-size:1em'>Apt</a>
      </li><li>
        <a href='/en/tags/bluetooth/' style='font-size:1.1428571428571428em'>Bluetooth</a>
      </li><li>
        <a href='/en/tags/c/' style='font-size:1.5714285714285714em'>C</a>
      </li><li>
        <a href='/en/tags/deb/' style='font-size:1em'>Deb</a>
      </li><li>
        <a href='/en/tags/dsp/' style='font-size:1em'>Dsp</a>
      </li><li>
        <a href='/en/tags/embedded/' style='font-size:1.1428571428571428em'>Embedded</a>
      </li><li>
        <a href='/en/tags/esp-idf/' style='font-size:1.1428571428571428em'>Esp-Idf</a>
      </li><li>
        <a href='/en/tags/esp32/' style='font-size:2em'>Esp32</a>
      </li><li>
        <a href='/en/tags/grafana/' style='font-size:1em'>Grafana</a>
      </li><li>
        <a href='/en/tags/java/' style='font-size:1.2857142857142856em'>Java</a>
      </li><li>
        <a href='/en/tags/lora/' style='font-size:1.8571428571428572em'>Lora</a>
      </li><li>
        <a href='/en/tags/lora-at/' style='font-size:1.2857142857142856em'>Lora-At</a>
      </li><li>
        <a href='/en/tags/maven/' style='font-size:1.1428571428571428em'>Maven</a>
      </li><li>
        <a href='/en/tags/monitoring/' style='font-size:1.1428571428571428em'>Monitoring</a>
      </li><li>
        <a href='/en/tags/peformance/' style='font-size:1em'>Peformance</a>
      </li><li>
        <a href='/en/tags/performance/' style='font-size:1em'>Performance</a>
      </li><li>
        <a href='/en/tags/ppk2/' style='font-size:1.1428571428571428em'>PPK2</a>
      </li><li>
        <a href='/en/tags/prometheus/' style='font-size:1em'>Prometheus</a>
      </li><li>
        <a href='/en/tags/r2cloud/' style='font-size:1em'>R2cloud</a>
      </li><li>
        <a href='/en/tags/r2lora/' style='font-size:1.4285714285714286em'>R2lora</a>
      </li><li>
        <a href='/en/tags/raspberrypi/' style='font-size:1.2857142857142856em'>Raspberrypi</a>
      </li><li>
        <a href='/en/tags/s3/' style='font-size:1em'>S3</a>
      </li><li>
        <a href='/en/tags/sx127x/' style='font-size:1.1428571428571428em'>Sx127x</a>
      </li><li>
        <a href='/en/tags/testing/' style='font-size:1.2857142857142856em'>Testing</a>
      </li><li>
        <a href='/en/tags/ubuntu/' style='font-size:1em'>Ubuntu</a>
      </li></ul>
</div>


</section>
</div>

  <div class='sidebar-overlay'></div>
</div><div class='main'><nav id='main-menu' class='menu main-menu' aria-label='Main Menu'>
  <div class='container'>
    <a class='screen-reader-text' href='#content'>Skip to Content</a>

<button id='sidebar-toggler' class='sidebar-toggler' aria-controls='sidebar'>
  <span class='screen-reader-text'>Toggle Sidebar</span>
  <span class='open'><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
  <line x1="3" y1="12" x2="21" y2="12" />
  <line x1="3" y1="6" x2="21" y2="6" />
  <line x1="3" y1="18" x2="21" y2="18" />

</svg>
</span>
  <span class='close'><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
  <line x1="18" y1="6" x2="6" y2="18" />
  <line x1="6" y1="6" x2="18" y2="18" />

</svg>
</span>
</button>
    <ul></ul>
  </div>
</nav><div class='header-widgets'>
        <div class='container'></div>
      </div>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>dernasherbrezon</p><p class='desc site-desc'>Blog about software development</p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='en' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>Power consumption in lora-at</h1>
      

    </div>
    <div class='entry-meta'>
  <span class='posted-on'><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>

</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='2023-11-25T23:28:18&#43;01:00'>25 Nov 2023</time>
</span>

  
  

</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  <p>Having thoroughly understood how <a href="https://dernasherbrezon.com/en/posts/power-profiler-kit2/">Power Profiler Kit 2 (PPK2)</a> works, I decided to test power consumption under different conditions. In fact, lora-at is not such a simple application. It works with bluetooth and the sx127x chip, processes commands from the UART bus and has a deep sleep mode. So there is a plenty of things to look for.</p>
<h2 id="measurement-methodology">Measurement methodology</h2>
<p>Before you start measuring something, you need to decide how it will be measured.</p>
<p><strong>First</strong>, I&rsquo;m going to <a href="https://dernasherbrezon.com/en/posts/power-profiler-kit2/">utilize PPK2</a> as much as possible. Some tests require dozens of measurements and doing them manually does not make sense. I wrote a small script that allowed me to send various AT commands to the device, and then select data from a .CSV file and group it as needed. I used the built-in logic analyzer to find when the measurement started and when it ended.</p>
<p><strong>Secondly</strong>, some processes are fast and consume a lot of energy, and some are slow and consume little energy. In this case, it is incorrect to compare the average current consumption. Where it makes sense to compare such processes, I compared the magnitude of the charge. It is measured in coulombs. A coulomb (C) is the amount of charge passed through a cross-section of a conductor at a current of 1 A in 1 s. PPK2 integrates current over time and can very quickly display the spent charge over a selected interval. You can really feel the atmosphere of a physics lab.</p>
<p><strong>Thirdly</strong>, there are a lot of parameters that can affect energy consumption. To do this, I fixed some and changed others. This approach allowed me to somehow compare and analyze the results. For example, for all tests I used <a href="https://heltec.org/project/wifi-lora-32/">Heltec LoRa 32 v2</a>, which operated at a frequency of 80 MHz.</p>
<p><strong>Fourth</strong>, PPK2 samples at a speed of 100KHz, which generates a fairly large amount of data. It is impossible to display all these points on a graph, so I took the average over a certain interval. This does not affect the resulting value of the spent charge, but slightly smoothes the graph itself.</p>
<p><strong>Fifthly</strong>, the energy consumption of the entire board is measured, not specific components.</p>
<h2 id="sx127x">sx127x</h2>
<p>It&rsquo;s probably best to start with the most basic one - the sx127x chip. It supports different types of modulation, data reception and transmission, their speed, power amplifiers and much more. I decided to measure only those that could theoretically affect energy consumption. And even after that, there were a decent number of tests.</p>
<h4 id="receiving-data">Receiving data</h4>
<p>To test the receiver, I configured a second board that sends a short message:</p>
<pre tabindex="0"><code>AT+LORATX=CAFE,433200012,125000,9,5,18,10,8,4,0,0,1,0
</code></pre><p>And the board under test receives it using the command:</p>
<pre tabindex="0"><code>AT+LORARX=433200012,125000,9,5,18,10,8,4,0,0,1,0
</code></pre><p>And the same for FSK modulation:</p>
<pre tabindex="0"><code>AT+FSKTX=CAFE,433200012,4800,5000,4,12AD,0,2,1,4,0,0
</code></pre><p>And reception:</p>
<pre tabindex="0"><code>AT+FSKRX=433200012,4800,5000,4,12AD,0,2,1,4,5000,20000
</code></pre><p>The result was the following graph:</p>
































<canvas id="fskVsLora" width="400" height="200"></canvas>
<div class='align-center' style="margin-bottom: 1.5em">
<small>
	<a class="downloadChart" data-canvasid="fskVsLora" download="fskVsLora.png" href="" title="Compare FSK and LoRa">Download</a>
</small>
</div>
<script>

function csvJSON(csv){
  var result = [];
  var headers=csv[0];
  for(var i=1;i<csv.length;i++){
      var obj = {};
      for(var j=0;j<headers.length;j++){
          obj[headers[j]] = parseFloat(csv[i][j]);
      }
      result.push(obj);
  }
  return result; 
}


	
	


var xAxisKey = 'time';
fskVsLoraData.forEach(function(e, index) {
	e.time = '' + e.time;
});var fskVsLoraCtx = document.getElementById('fskVsLora').getContext('2d');
const fskVsLoraChart = new Chart(fskVsLoraCtx, {
    type: 'line',
    data: {
        datasets: [{
        	label: 'LoRa',
            data: fskVsLoraData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'lora2bytes'
            },
            borderColor: '#7fc35e',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#7fc35e',
            fill: true,
            borderWidth: 2,tension: 0.2
        },{
            label: 'FSK',
            data: fskVsLoraData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'fsk2bytes'
            },
            borderColor: '#ffcd00',
            backgroundColor: 'rgba(255, 205, 0, 0.1)',
            pointBackgroundColor: '#ffcd00',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        }]
    },
    options: {
    	stacked: false,
    	elements: {
    		point: {
    		      radius: 0,
    		      hitRadius: 10,
    		      hoverRadius: 4,
    		      hoverBorderWidth: 3
    		}	
    	},
        animation: {
            duration: 0
        },
        interaction: {
            intersect: false,
            mode: 'index',
        },
        scales: {x: {
                title: {
                    display: true,
                    text: 'Time'
                },
                ticks: {
                    
                    callback: function(value, index, ticks) {
                    	
                        return this.getLabelForValue(value) + ' ms';
                    }}
        	},y: {
                beginAtZero: true,
                position: 'left',title: {
                    display: true,
                    text: 'Current'
                },
                ticks: {
                    callback: function(value, index, ticks) {
                        return value + ' mA';
                    }}
            }},
        plugins: {
            title: {
                display: true,
                text: 'Compare FSK and LoRa',
                font: {
                	size: 16
                }
            },
            legend: {
                display: false
            },
            tooltip: {
            	position: 'nearest',
            	callbacks: {title: function(context) {
                        return context[0].label + ' ms';
            		},label: function(context) {
            			let label = context.dataset.label || '';

                        if (label) {
                            label += ': ';
                        }
                        
                        var unit = "mA";if (context.parsed.y !== null) {
                        	label += context.parsed.y + ' ' + unit;
                        }
                        
                        return label;
            		}
            	}
            }
        }
    }
});
</script><noscript>
	<img src="/static/img/lora-at-power-profiling/fskVsLora.png">
</noscript>
<p>It shows that:</p>
<ul>
<li>LoRa processes the message much faster: <strong>13.6</strong>ms versus <strong>19</strong>ms</li>
<li>More energy efficient. Due to the processing speed, the total consumption is <strong>511</strong>µC versus <strong>775</strong>µC</li>
<li>Peak consumption is slightly lower</li>
</ul>
<p>In fact, such a comparison is incorrect. Energy consumption directly depends on the data transfer rate. The higher the speed, the faster the message is processed and the less energy is wasted.</p>
<h4 id="cad-mode">CAD mode</h4>
<p>The sx127x has a special mode called CAD (Channel Activity Detection). It is used to optimize the power consumption of the receiver. The idea is this:</p>
<ul>
<li>the receiver turns on at full power for a certain time</li>
<li>after which it goes into low-power mode and tries to analyze the received signal</li>
<li>if preamble is detected, the chip generates an interrupt and you can switch to normal receiving mode</li>
<li>if preamble is not detected, then the chip waits for some time in low power mode and returns to step 1</li>
</ul>
<p>The diagram looks like this:</p>
<div>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="-0.5 -0.5 460 202"><defs/><g><path d="M 40 40 L 80 40 L 80 0 L 400 0" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 40 120 L 360 120 L 360 80 L 400 80" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 40 200 L 80 200 L 80 160 L 200 160 L 200 180 L 360 180 L 360 200 L 400 200" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 360 180 L 400 180" fill="none" stroke="rgb(0, 0, 0)" stroke-width="2" stroke-miterlimit="10" stroke-dasharray="2 6" pointer-events="stroke"/><path d="M 200 160 L 400 160" fill="none" stroke="rgb(0, 0, 0)" stroke-width="2" stroke-miterlimit="10" stroke-dasharray="2 6" pointer-events="stroke"/><rect x="0" y="160" width="80" height="40" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 180px; margin-left: 1px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><font style="font-size: 10px;">Consumption</font></div></div></div></foreignObject><text x="40" y="184" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">Consumption</text></switch></g><rect x="0" y="80" width="80" height="40" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 100px; margin-left: 1px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><font style="font-size: 10px;">CadDone</font></div></div></div></foreignObject><text x="40" y="104" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">CadDone</text></switch></g><rect x="0" y="0" width="80" height="40" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 20px; margin-left: 1px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><font style="font-size: 10px;">NSS</font></div></div></div></foreignObject><text x="40" y="24" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">NSS</text></switch></g><path d="M 86.37 80 L 353.63 80" fill="none" stroke="#6c8ebf" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 81.12 80 L 88.12 76.5 L 86.37 80 L 88.12 83.5 Z" fill="#6c8ebf" stroke="#6c8ebf" stroke-miterlimit="10" pointer-events="all"/><path d="M 358.88 80 L 351.88 83.5 L 353.63 80 L 351.88 76.5 Z" fill="#6c8ebf" stroke="#6c8ebf" stroke-miterlimit="10" pointer-events="all"/><rect x="80" y="60" width="280" height="20" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 278px; height: 1px; padding-top: 70px; margin-left: 81px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 10px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">CAD duration</div></div></div></foreignObject><text x="220" y="73" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="10px" text-anchor="middle">CAD duration</text></switch></g><path d="M 86.37 180 L 193.63 180" fill="none" stroke="#6c8ebf" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 81.12 180 L 88.12 176.5 L 86.37 180 L 88.12 183.5 Z" fill="#6c8ebf" stroke="#6c8ebf" stroke-miterlimit="10" pointer-events="all"/><path d="M 198.88 180 L 191.88 183.5 L 193.63 180 L 191.88 176.5 Z" fill="#6c8ebf" stroke="#6c8ebf" stroke-miterlimit="10" pointer-events="all"/><rect x="90" y="166" width="100" height="10" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 98px; height: 1px; padding-top: 171px; margin-left: 91px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 10px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">Time in RX mode</div></div></div></foreignObject><text x="140" y="174" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="10px" text-anchor="middle">Time in RX mode</text></switch></g><rect x="400" y="172.5" width="60" height="15" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 58px; height: 1px; padding-top: 180px; margin-left: 401px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><font style="font-size: 10px;">IDDC_L</font></div></div></div></foreignObject><text x="430" y="184" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">IDDC_L</text></switch></g><rect x="400" y="151" width="60" height="15" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 58px; height: 1px; padding-top: 159px; margin-left: 401px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><font style="font-size: 10px;">IDDR_L</font></div></div></div></foreignObject><text x="430" y="162" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">IDDR_L</text></switch></g></g><switch><g requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"/><a transform="translate(0,-5)" xlink:href="https://www.drawio.com/doc/faq/svg-export-text-problems" target="_blank"><text text-anchor="middle" font-size="10px" x="50%" y="100%">Text is not SVG - cannot display</text></a></switch></svg>
</div>
<p>According to the specification, consumption can be reduced by almost half:</p>
<table>
<thead>
  <tr>
    <th>Bandwidth (kHz)</th>
    <th>Full Rx, IDDR_L (mA)</th>
    <th>Processing, IDDC_L (mA)</th>
  </tr>	
</thead>
<tbody>
  <tr>
    <td>7.8 to 41.7</td>
    <td>11</td>
    <td>5.2</td>
  </tr>	
  <tr>
    <td>62.5</td>
    <td>11</td>
    <td>5.6</td>
  </tr>	
  <tr>
    <td>125</td>
    <td>11.5</td>
    <td>6</td>
  </tr>	
  <tr>
    <td>250</td>
    <td>12.4</td>
    <td>6.8</td>
  </tr>	
  <tr>
    <td>500</td>
    <td>13.8</td>
    <td>8.3</td>
  </tr>	
</tbody>
</table>
<p>CAD mode can be started using the command below:</p>
<pre tabindex="0"><code>AT+LORACADRX=433200012,125000,9,5,18,10,8,4,0,0,1,0
</code></pre><p>In the end I managed to get:</p>
































<canvas id="cad" width="400" height="200"></canvas>
<div class='align-center' style="margin-bottom: 1.5em">
<small>
	<a class="downloadChart" data-canvasid="cad" download="cad.png" href="" title="Compare RX and CAD">Download</a>
</small>
</div>
<script>

function csvJSON(csv){
  var result = [];
  var headers=csv[0];
  for(var i=1;i<csv.length;i++){
      var obj = {};
      for(var j=0;j<headers.length;j++){
          obj[headers[j]] = parseFloat(csv[i][j]);
      }
      result.push(obj);
  }
  return result; 
}


	
	


var xAxisKey = 'time';
cadData.forEach(function(e, index) {
	e.time = '' + e.time;
});var cadCtx = document.getElementById('cad').getContext('2d');
const cadChart = new Chart(cadCtx, {
    type: 'line',
    data: {
        datasets: [{
        	label: 'RX mode',
            data: cadData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'normal'
            },
            borderColor: '#7fc35e',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#7fc35e',
            fill: true,
            borderWidth: 2,tension: 0.2
        },{
            label: 'CAD mode',
            data: cadData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'cad'
            },
            borderColor: '#ffcd00',
            backgroundColor: 'rgba(255, 205, 0, 0.1)',
            pointBackgroundColor: '#ffcd00',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        }]
    },
    options: {
    	stacked: false,
    	elements: {
    		point: {
    		      radius: 0,
    		      hitRadius: 10,
    		      hoverRadius: 4,
    		      hoverBorderWidth: 3
    		}	
    	},
        animation: {
            duration: 0
        },
        interaction: {
            intersect: false,
            mode: 'index',
        },
        scales: {x: {
                title: {
                    display: true,
                    text: 'Time'
                },
                ticks: {
                    
                    callback: function(value, index, ticks) {
                    	
                        return this.getLabelForValue(value) + ' ms';
                    }}
        	},y: {
                beginAtZero: true,
                position: 'left',title: {
                    display: true,
                    text: 'Current'
                },
                ticks: {
                    callback: function(value, index, ticks) {
                        return value + ' mA';
                    }}
            }},
        plugins: {
            title: {
                display: true,
                text: 'Compare RX and CAD',
                font: {
                	size: 16
                }
            },
            legend: {
                display: false
            },
            tooltip: {
            	position: 'nearest',
            	callbacks: {title: function(context) {
                        return context[0].label + ' ms';
            		},label: function(context) {
            			let label = context.dataset.label || '';

                        if (label) {
                            label += ': ';
                        }
                        
                        var unit = "mA";if (context.parsed.y !== null) {
                        	label += context.parsed.y + ' ' + unit;
                        }
                        
                        return label;
            		}
            	}
            }
        }
    }
});
</script><noscript>
	<img src="/img/lora-at-power-profiling/cad.png">
</noscript>
<p>Here you can immediately see several interesting things:</p>
<ul>
<li>For some reason, the current consumption in the preamble search mode is slightly higher than in RX mode</li>
<li>The difference between active and passive mode is <strong>~6</strong>mA, which does seem to be true at <strong>125</strong>kHz</li>
<li><strong>~2</strong> ms elapses after exiting CAD mode and before switching back. The ESP32 needs this time to process the interrupt and switch back to CAD mode. Since CAD mode ends up going into STANDBY mode, power consumption is significantly lower. 2ms for interrupt processing is a lot. If the transmission of a message begins at this time, the receiver may miss its beginning. The checksum will not match and the entire message will not be accepted. On the other hand, in practice everything works fine.</li>
</ul>
<p>If we compare power consumption, the CAD mode is still more efficient:</p>
<ul>
<li>Charge spent <strong>1.41</strong>mC versus <strong>1.52</strong>mC in <strong>40</strong>ms</li>
<li>Average current <strong>35.27</strong>mA versus <strong>37.85</strong>mA</li>
</ul>
<h4 id="sending-data">Sending data</h4>
<p>Current consumption during transmit depends on:</p>
<ul>
<li>transmission speed</li>
<li>modulation type</li>
<li>transmitter power</li>
<li>message length</li>
</ul>
<p>To make testing easier, I sent a 255 byte message with a power of 4dbm. At the same time, I changed the transmission speed and modulation type. Here is an example command for testing FSK:</p>
<pre tabindex="0"><code>AT+FSKTX=000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9aaabacadaeafb0b1b2b3b4b5b6b7b8b9babbbcbdbebfc0c1c2c3c4c5c6c7c8c9cacbcccdcecfd0d1d2d3d4d5d6d7d8d9dadbdcdddedfe0e1e2e3e4e5e6e7e8e9eaebecedeeeff0f1f2f3f4f5f6f7f8f9fafbfcfdfe,433200012,1200,5000,4,12AD,0,2,1,4,240,0
</code></pre>































<canvas id="fskBaud" width="400" height="200"></canvas>
<div class='align-center' style="margin-bottom: 1.5em">
<small>
	<a class="downloadChart" data-canvasid="fskBaud" download="fskBaud.png" href="" title="Power consumption for different baud rates in FSK mode">Download</a>
</small>
</div>
<script>

function csvJSON(csv){
  var result = [];
  var headers=csv[0];
  for(var i=1;i<csv.length;i++){
      var obj = {};
      for(var j=0;j<headers.length;j++){
          obj[headers[j]] = parseFloat(csv[i][j]);
      }
      result.push(obj);
  }
  return result; 
}


	
	


var xAxisKey = 'baud';
fskBaudData.forEach(function(e, index) {
	e.baud = '' + e.baud;
});var fskBaudCtx = document.getElementById('fskBaud').getContext('2d');
const fskBaudChart = new Chart(fskBaudCtx, {
    type: 'line',
    data: {
        datasets: [{
        	label: 'Charge',
            data: fskBaudData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'chargemC'
            },
            borderColor: '#7fc35e',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#7fc35e',
            fill: true,
            borderWidth: 2,yAxisID: 'myScale',tension: 0.2
        },{
            label: 'Time',
            data: fskBaudData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'latencyMs'
            },
            borderColor: '#ffcd00',
            backgroundColor: 'rgba(255, 205, 0, 0.1)',
            pointBackgroundColor: '#ffcd00',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        }]
    },
    options: {
    	stacked: false,
    	elements: {
    		point: {
    		      radius: 0,
    		      hitRadius: 10,
    		      hoverRadius: 4,
    		      hoverBorderWidth: 3
    		}	
    	},
        animation: {
            duration: 0
        },
        interaction: {
            intersect: false,
            mode: 'index',
        },
        scales: {x: {
                title: {
                    display: true,
                    text: 'Baud'
                },
                ticks: {
                    
                    callback: function(value, index, ticks) {
                    	
                        return this.getLabelForValue(value) + ' ';
                    }}
        	},y: {
                beginAtZero: true,
                position: 'left',type: 'logarithmic',title: {
                    display: true,
                    text: 'Time'
                },
                ticks: {
                    callback: function(value, index, ticks) {
                        return value + ' ms';
                    }}
            },
        	myScale: {
                display: true,
                axis: 'y',
                position: 'right',type: 'logarithmic',title: {
                    display: true,
                    text: 'Charge'
                },
                ticks: {
                    callback: function(value, index, ticks) {
                        return value + ' mC';
                    }},
                grid: {
                	drawOnChartArea: false
                }
            }},
        plugins: {
            title: {
                display: true,
                text: 'Power consumption for different baud rates in FSK mode',
                font: {
                	size: 16
                }
            },
            legend: {
                display: false
            },
            tooltip: {
            	position: 'nearest',
            	callbacks: {title: function(context) {
                        return context[0].label + ' ';
            		},label: function(context) {
            			let label = context.dataset.label || '';

                        if (label) {
                            label += ': ';
                        }
                        
                        var unit = "ms";if( context.datasetIndex == 0 ) {
                        	unit = "mC";
                        }if (context.parsed.y !== null) {
                        	label += context.parsed.y + ' ' + unit;
                        }
                        
                        return label;
            		}
            	}
            }
        }
    }
});
</script><noscript>
	<img src="/img/lora-at-power-profiling/fskBaud.png">
</noscript>
<p>The graph shows a clear correlation. The higher the transmission speed, the less energy is wasted. By the way, the graph around 76800 baud was not always like this. When I first measured the speed, it turned out to be half that of 38400 baud. And its increase had no effect on consumption at all. After fiddling around a bit, I found a bug in the code. When reading from the UART, uint16_t overflowed and a much lower speed was set. Oops!</p>
<p>When sending data in LoRa mode, everything is much more complicated. The speed can be affected by: bandwidth, spreading factor and coding rate. For example, the latter controls how many bits are used for error correction codes. The larger the number, the more reliable the transmission, but the longer it takes for the data to be transmitted.</p>
<p>I fixed <code>coding rate=4</code> and changed only the bandwidth and spreading factor:</p>
<pre tabindex="0"><code>AT+LORATX=000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9aaabacadaeafb0b1b2b3b4b5b6b7b8b9babbbcbdbebfc0c1c2c3c4c5c6c7c8c9cacbcccdcecfd0d1d2d3d4d5d6d7d8d9dadbdcdddedfe0e1e2e3e4e5e6e7e8e9eaebecedeeeff0f1f2f3f4f5f6f7f8f9fafbfcfdfe,433200012,500000,6,5,18,8,0,1,0,255,4,240,0
</code></pre>































<canvas id="loraBandwidthSf" width="400" height="200"></canvas>
<div class='align-center' style="margin-bottom: 1.5em">
<small>
	<a class="downloadChart" data-canvasid="loraBandwidthSf" download="loraBandwidthSf.png" href="" title="Power consumption in LoRa mode">Download</a>
</small>
</div>
<script>

function csvJSON(csv){
  var result = [];
  var headers=csv[0];
  for(var i=1;i<csv.length;i++){
      var obj = {};
      for(var j=0;j<headers.length;j++){
          obj[headers[j]] = parseFloat(csv[i][j]);
      }
      result.push(obj);
  }
  return result; 
}


	
	


var xAxisKey = 'bandwidth';
loraBandwidthSfData.forEach(function(e, index) {
	e.bandwidth = '' + e.bandwidth;
});var loraBandwidthSfCtx = document.getElementById('loraBandwidthSf').getContext('2d');
const loraBandwidthSfChart = new Chart(loraBandwidthSfCtx, {
    type: 'line',
    data: {
        datasets: [{
        	label: 'sf6',
            data: loraBandwidthSfData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'sf6'
            },
            borderColor: '#7fc35e',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#7fc35e',
            fill: true,
            borderWidth: 2,tension: 0.2
        },{
        	label: 'sf7',
            data: loraBandwidthSfData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'sf7'
            },
            borderColor: '#4161CC',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#4161CC',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        },{
        	label: 'sf8',
            data: loraBandwidthSfData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'sf8'
            },
            borderColor: '#5DD9BE',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#5DD9BE',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        },{
        	label: 'sf9',
            data: loraBandwidthSfData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'sf9'
            },
            borderColor: '#CF8659',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#CF8659',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        },{
        	label: 'sf10',
            data: loraBandwidthSfData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'sf10'
            },
            borderColor: '#800080',
            backgroundColor: 'rgba(229,204,229, 0.1)',
            pointBackgroundColor: '#800080',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        },{
        	label: 'sf11',
            data: loraBandwidthSfData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'sf11'
            },
            borderColor: '#FFC0CB',
            backgroundColor: 'rgba(255,229,234, 0.1)',
            pointBackgroundColor: '#FFC0CB',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        },{
            label: 'sf12',
            data: loraBandwidthSfData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'sf12'
            },
            borderColor: '#ffcd00',
            backgroundColor: 'rgba(255, 205, 0, 0.1)',
            pointBackgroundColor: '#ffcd00',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        }]
    },
    options: {
    	stacked: false,
    	elements: {
    		point: {
    		      radius: 0,
    		      hitRadius: 10,
    		      hoverRadius: 4,
    		      hoverBorderWidth: 3
    		}	
    	},
        animation: {
            duration: 0
        },
        interaction: {
            intersect: false,
            mode: 'index',
        },
        scales: {x: {
                title: {
                    display: true,
                    text: 'Bandwidth'
                },
                ticks: {
                    
                    callback: function(value, index, ticks) {
                    	
                        return this.getLabelForValue(value) + ' Hz';
                    }}
        	},y: {
                beginAtZero: true,
                position: 'left',title: {
                    display: true,
                    text: 'Charge'
                },
                ticks: {
                    callback: function(value, index, ticks) {
                        return value + ' mC';
                    }}
            }},
        plugins: {
            title: {
                display: true,
                text: 'Power consumption in LoRa mode',
                font: {
                	size: 16
                }
            },
            legend: {
                display: false
            },
            tooltip: {
            	position: 'nearest',
            	callbacks: {title: function(context) {
                        return context[0].label + ' Hz';
            		},label: function(context) {
            			let label = context.dataset.label || '';

                        if (label) {
                            label += ': ';
                        }
                        
                        var unit = "mC";if (context.parsed.y !== null) {
                        	label += context.parsed.y + ' ' + unit;
                        }
                        
                        return label;
            		}
            	}
            }
        }
    }
});
</script><noscript>
	<img src="/img/lora-at-power-profiling/loraBandwidthSf.png">
</noscript>
<p>Quick analysis shows:</p>
<ul>
<li>The greater the spreading factor, the longer the message is transmitted and the more energy is wasted</li>
<li>The fastest LoRa data transmission (factor 6 and 500KHz channel width) consumes more energy than the fastest FSK transmission (300Kbaud rate)</li>
</ul>
<p>In the next test I did the opposite: I fixed the data transfer rate and changed the output power from -4 to 20.</p>
<pre tabindex="0"><code>AT+LORATX=CA,433200012,125000,9,5,18,8,0,1,1,0,-4,240,0
AT+LORATX=CA,433200012,125000,9,5,18,8,0,1,1,0,-3,240,0
...
AT+LORATX=CA,433200012,125000,9,5,18,8,0,1,1,0,17,240,1
AT+LORATX=CA,433200012,125000,9,5,18,8,0,1,1,0,20,240,1
</code></pre>































<canvas id="loraPower" width="400" height="200"></canvas>
<div class='align-center' style="margin-bottom: 1.5em">
<small>
	<a class="downloadChart" data-canvasid="loraPower" download="loraPower.png" href="" title="Power consumption under different power levels">Download</a>
</small>
</div>
<script>

function csvJSON(csv){
  var result = [];
  var headers=csv[0];
  for(var i=1;i<csv.length;i++){
      var obj = {};
      for(var j=0;j<headers.length;j++){
          obj[headers[j]] = parseFloat(csv[i][j]);
      }
      result.push(obj);
  }
  return result; 
}


	
	


var xAxisKey = 'level';
loraPowerData.forEach(function(e, index) {
	e.level = '' + e.level;
});var loraPowerCtx = document.getElementById('loraPower').getContext('2d');
const loraPowerChart = new Chart(loraPowerCtx, {
    type: 'line',
    data: {
        datasets: [{
        	label: 'Charge',
            data: loraPowerData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'charge'
            },
            borderColor: '#7fc35e',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#7fc35e',
            fill: true,
            borderWidth: 2,yAxisID: 'myScale',tension: 0.2
        },{
            label: 'Average current',
            data: loraPowerData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'avgCurrent'
            },
            borderColor: '#ffcd00',
            backgroundColor: 'rgba(255, 205, 0, 0.1)',
            pointBackgroundColor: '#ffcd00',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        }]
    },
    options: {
    	stacked: false,
    	elements: {
    		point: {
    		      radius: 0,
    		      hitRadius: 10,
    		      hoverRadius: 4,
    		      hoverBorderWidth: 3
    		}	
    	},
        animation: {
            duration: 0
        },
        interaction: {
            intersect: false,
            mode: 'index',
        },
        scales: {x: {
                title: {
                    display: true,
                    text: 'Level'
                },
                ticks: {
                    
                    callback: function(value, index, ticks) {
                    	
                        return this.getLabelForValue(value) + ' ';
                    }}
        	},y: {
                beginAtZero: true,
                position: 'left',title: {
                    display: true,
                    text: 'Average current'
                },
                ticks: {
                    callback: function(value, index, ticks) {
                        return value + ' mA';
                    }}
            },
        	myScale: {
                display: true,
                axis: 'y',
                position: 'right',title: {
                    display: true,
                    text: 'Charge'
                },
                ticks: {
                    callback: function(value, index, ticks) {
                        return value + ' mC';
                    }},
                grid: {
                	drawOnChartArea: false
                }
            }},
        plugins: {
            title: {
                display: true,
                text: 'Power consumption under different power levels',
                font: {
                	size: 16
                }
            },
            legend: {
                display: false
            },
            tooltip: {
            	position: 'nearest',
            	callbacks: {title: function(context) {
                        return context[0].label + ' ';
            		},label: function(context) {
            			let label = context.dataset.label || '';

                        if (label) {
                            label += ': ';
                        }
                        
                        var unit = "mA";if( context.datasetIndex == 0 ) {
                        	unit = "mC";
                        }if (context.parsed.y !== null) {
                        	label += context.parsed.y + ' ' + unit;
                        }
                        
                        return label;
            		}
            	}
            }
        }
    }
});
</script><noscript>
	<img src="/img/lora-at-power-profiling/loraPower.png">
</noscript>
<p>I wonder why at higher power levels the graphs begin to intersect? I transmitted absolutely the same message with the same parameters. The transmission time was the same. This means that the spent charge should depend linearly on the current. But instead the relationship is nonlinear.</p>
<p>By the way, at 7dbm the current consumption is quite even. But at 10dbm it’s not the case. Is the internal power amplifier noisy?</p>
































<canvas id="txNoise" width="400" height="200"></canvas>
<div class='align-center' style="margin-bottom: 1.5em">
<small>
	<a class="downloadChart" data-canvasid="txNoise" download="txNoise.png" href="" title="7dbm vs 10dbm">Download</a>
</small>
</div>
<script>

function csvJSON(csv){
  var result = [];
  var headers=csv[0];
  for(var i=1;i<csv.length;i++){
      var obj = {};
      for(var j=0;j<headers.length;j++){
          obj[headers[j]] = parseFloat(csv[i][j]);
      }
      result.push(obj);
  }
  return result; 
}


	
	


var xAxisKey = 'time';
txNoiseData.forEach(function(e, index) {
	e.time = '' + e.time;
});var txNoiseCtx = document.getElementById('txNoise').getContext('2d');
const txNoiseChart = new Chart(txNoiseCtx, {
    type: 'line',
    data: {
        datasets: [{
        	label: '10dbm',
            data: txNoiseData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: '10dbm'
            },
            borderColor: '#7fc35e',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#7fc35e',
            fill: true,
            borderWidth: 2,tension: 0.2
        },{
            label: '7dbm',
            data: txNoiseData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: '7dbm'
            },
            borderColor: '#ffcd00',
            backgroundColor: 'rgba(255, 205, 0, 0.1)',
            pointBackgroundColor: '#ffcd00',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        }]
    },
    options: {
    	stacked: false,
    	elements: {
    		point: {
    		      radius: 0,
    		      hitRadius: 10,
    		      hoverRadius: 4,
    		      hoverBorderWidth: 3
    		}	
    	},
        animation: {
            duration: 0
        },
        interaction: {
            intersect: false,
            mode: 'index',
        },
        scales: {x: {
                title: {
                    display: true,
                    text: 'Time'
                },
                ticks: {
                    
                    callback: function(value, index, ticks) {
                    	
                        return this.getLabelForValue(value) + ' ';
                    }}
        	},y: {
                beginAtZero: true,
                position: 'left',title: {
                    display: true,
                    text: 'Current'
                },
                ticks: {
                    callback: function(value, index, ticks) {
                        return value + ' mA';
                    }}
            }},
        plugins: {
            title: {
                display: true,
                text: '7dbm vs 10dbm',
                font: {
                	size: 16
                }
            },
            legend: {
                display: false
            },
            tooltip: {
            	position: 'nearest',
            	callbacks: {title: function(context) {
                        return context[0].label + ' ';
            		},label: function(context) {
            			let label = context.dataset.label || '';

                        if (label) {
                            label += ': ';
                        }
                        
                        var unit = "mA";if (context.parsed.y !== null) {
                        	label += context.parsed.y + ' ' + unit;
                        }
                        
                        return label;
            		}
            	}
            }
        }
    }
});
</script><noscript>
	<img src="/img/lora-at-power-profiling/txNoise.png">
</noscript>
<p>In addition to the different power levels, the chip has three different physical pins that the antenna can connect to: RFO_LF, RFO_HF and PA_BOOST. +20dbm can only be transmitted via PA_BOOST. But if you transmit +7dbm, then does it make a difference which pin to use?</p>
<pre tabindex="0"><code>AT+LORATX=CA,168000012,125000,9,5,18,8,0,1,1,0,7,240,0
AT+LORATX=CA,433200012,125000,9,5,18,8,0,1,1,0,7,240,0
AT+LORATX=CA,433200012,125000,9,5,18,8,0,1,1,0,7,240,1
</code></pre>































<canvas id="txpin" width="400" height="200"></canvas>
<div class='align-center' style="margin-bottom: 1.5em">
<small>
	<a class="downloadChart" data-canvasid="txpin" download="txpin.png" href="" title="Power consumption on different TX pins">Download</a>
</small>
</div>
<script>

function csvJSON(csv){
  var result = [];
  var headers=csv[0];
  for(var i=1;i<csv.length;i++){
      var obj = {};
      for(var j=0;j<headers.length;j++){
          obj[headers[j]] = parseFloat(csv[i][j]);
      }
      result.push(obj);
  }
  return result; 
}


	
	


var xAxisKey = 'time';
txpinData.forEach(function(e, index) {
	e.time = '' + e.time;
});var txpinCtx = document.getElementById('txpin').getContext('2d');
const txpinChart = new Chart(txpinCtx, {
    type: 'line',
    data: {
        datasets: [{
        	label: 'RFO_HF',
            data: txpinData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'hf7dbm'
            },
            borderColor: '#7fc35e',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#7fc35e',
            fill: true,
            borderWidth: 2,tension: 0.2
        },{
        	label: 'PA_BOOST',
            data: txpinData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'boost7dbm'
            },
            borderColor: '#4161CC',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#4161CC',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        },{
            label: 'RFO_LF',
            data: txpinData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'lf7dbm'
            },
            borderColor: '#ffcd00',
            backgroundColor: 'rgba(255, 205, 0, 0.1)',
            pointBackgroundColor: '#ffcd00',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        }]
    },
    options: {
    	stacked: false,
    	elements: {
    		point: {
    		      radius: 0,
    		      hitRadius: 10,
    		      hoverRadius: 4,
    		      hoverBorderWidth: 3
    		}	
    	},
        animation: {
            duration: 0
        },
        interaction: {
            intersect: false,
            mode: 'index',
        },
        scales: {x: {
                title: {
                    display: true,
                    text: 'Time'
                },
                ticks: {
                    
                    callback: function(value, index, ticks) {
                    	
                        return this.getLabelForValue(value) + ' ';
                    }}
        	},y: {
                beginAtZero: true,
                position: 'left',title: {
                    display: true,
                    text: 'Current'
                },
                ticks: {
                    callback: function(value, index, ticks) {
                        return value + ' mA';
                    }}
            }},
        plugins: {
            title: {
                display: true,
                text: 'Power consumption on different TX pins',
                font: {
                	size: 16
                }
            },
            legend: {
                display: false
            },
            tooltip: {
            	position: 'nearest',
            	callbacks: {title: function(context) {
                        return context[0].label + ' ';
            		},label: function(context) {
            			let label = context.dataset.label || '';

                        if (label) {
                            label += ': ';
                        }
                        
                        var unit = "mA";if (context.parsed.y !== null) {
                        	label += context.parsed.y + ' ' + unit;
                        }
                        
                        return label;
            		}
            	}
            }
        }
    }
});
</script><noscript>
	<img src="/img/lora-at-power-profiling/txpin.png">
</noscript>
<p>Yes, there is a difference.</p>
<ul>
<li>If we compare RFO_LF and RFO_HF, we can see that the current consumption at 168 MHz is higher. Apparently, at these frequencies the antenna is <a href="https://en.wikipedia.org/wiki/Standing_wave_ratio">no longer matched</a>.</li>
<li>The current consumption when transmitted through a separate power amplifier and PA_BOOST pin is greater than when transmitted through RFO_HF. Probably the difference goes to powering that same amplifier.</li>
</ul>
<h4 id="over-current-protection">Over current protection</h4>
<p>The chip has over current protection. Datasheet has some references to the battery, chemical components and peak current consumption. At first I didn&rsquo;t understand anything. After reading the theory a little, it became a little more clear. The amplifier is designed for an antenna impedance of <strong>50</strong> Ohms. If the impedance does not match, or has ceased to match (the antenna is rusty), then more and more current will be spent to generate a given power level. This may cause the amplifier to burn out. I compared sending a message: without protection (240mA), with a slight limitation (140mA), with a maximum limitation (45mA).</p>
<pre tabindex="0"><code>AT+LORATX=CA,140200012,125000,9,5,18,8,0,1,1,0,17,240,1
AT+LORATX=CA,140200012,125000,9,5,18,8,0,1,1,0,17,140,1
AT+LORATX=CA,140200012,125000,9,5,18,8,0,1,1,0,17,45,1
</code></pre>































<canvas id="ocp2" width="400" height="200"></canvas>
<div class='align-center' style="margin-bottom: 1.5em">
<small>
	<a class="downloadChart" data-canvasid="ocp2" download="ocp2.png" href="" title="Over current protection">Download</a>
</small>
</div>
<script>

function csvJSON(csv){
  var result = [];
  var headers=csv[0];
  for(var i=1;i<csv.length;i++){
      var obj = {};
      for(var j=0;j<headers.length;j++){
          obj[headers[j]] = parseFloat(csv[i][j]);
      }
      result.push(obj);
  }
  return result; 
}


	
	


var xAxisKey = 'time';
ocp2Data.forEach(function(e, index) {
	e.time = '' + e.time;
});var ocp2Ctx = document.getElementById('ocp2').getContext('2d');
const ocp2Chart = new Chart(ocp2Ctx, {
    type: 'line',
    data: {
        datasets: [{
        	label: '140mA',
            data: ocp2Data,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'ocp140'
            },
            borderColor: '#7fc35e',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#7fc35e',
            fill: true,
            borderWidth: 2,tension: 0.2
        },{
        	label: '45mA',
            data: ocp2Data,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'ocp45'
            },
            borderColor: '#4161CC',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#4161CC',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        },{
            label: '240mA',
            data: ocp2Data,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'ocp240'
            },
            borderColor: '#ffcd00',
            backgroundColor: 'rgba(255, 205, 0, 0.1)',
            pointBackgroundColor: '#ffcd00',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        }]
    },
    options: {
    	stacked: false,
    	elements: {
    		point: {
    		      radius: 0,
    		      hitRadius: 10,
    		      hoverRadius: 4,
    		      hoverBorderWidth: 3
    		}	
    	},
        animation: {
            duration: 0
        },
        interaction: {
            intersect: false,
            mode: 'index',
        },
        scales: {x: {
                title: {
                    display: true,
                    text: 'Time'
                },
                ticks: {
                    
                    callback: function(value, index, ticks) {
                    	
                        return this.getLabelForValue(value) + ' ';
                    }}
        	},y: {
                beginAtZero: true,
                position: 'left',title: {
                    display: true,
                    text: 'Current'
                },
                ticks: {
                    callback: function(value, index, ticks) {
                        return value + ' mA';
                    }}
            }},
        plugins: {
            title: {
                display: true,
                text: 'Over current protection',
                font: {
                	size: 16
                }
            },
            legend: {
                display: false
            },
            tooltip: {
            	position: 'nearest',
            	callbacks: {title: function(context) {
                        return context[0].label + ' ';
            		},label: function(context) {
            			let label = context.dataset.label || '';

                        if (label) {
                            label += ': ';
                        }
                        
                        var unit = "mA";if (context.parsed.y !== null) {
                        	label += context.parsed.y + ' ' + unit;
                        }
                        
                        return label;
            		}
            	}
            }
        }
    }
});
</script><noscript>
	<img src="/img/lora-at-power-profiling/ocp2.png">
</noscript>
<p>The board consumes a constant amount of current regardless of the installed protection. But this does not mean that the protection does not work. It may be necessary to measure the actual transmitted power at the antenna. Unfortunately, I don&rsquo;t have the necessary equipment to test this.</p>
<h2 id="comparison-with-c-version">Comparison with C++ version</h2>
<p>As I already wrote, <a href="https://github.com/dernasherbrezon/lora-at">lora-at</a> was originally implemented in C++ using libraries of different quality levels. My theory was that by rewriting the project in C, I could achieve greater efficiency and simplicity. One of the goals was achieved - assembling the project began to take less time and the size of the firmware was halved. But what about power consumption?</p>
<p>The operation of the sx127x chip does not depend on the selected language, but everything else may theoretically differ.</p>
<h3 id="bluetooth-connection">Bluetooth connection</h3>
<p>One of the main differences between the first version and the second is the work with bluetooth. If the first version used a C++ library on top of Bluedroid, then in the second version I used Nimble. The documentation says that Nimble is a more lightweight implementation of the BLE protocol. But is this really so? And is there a difference in speed? This is very easy to check. To do this I used the command:</p>
<pre tabindex="0"><code>AT+BLUETOOTH=B8:27:EB:6C:7C:F8
</code></pre><p>This command will do the following:</p>
<ul>
<li>will start connecting to the bluetooth server at <code>B8:27:EB:6C:7C:F8</code></li>
<li>will search for the desired GATT service and characteristics</li>
</ul>
































<canvas id="bluetooth2" width="400" height="200"></canvas>
<div class='align-center' style="margin-bottom: 1.5em">
<small>
	<a class="downloadChart" data-canvasid="bluetooth2" download="bluetooth2.png" href="" title="Power consumption when connecting to bluetooth server">Download</a>
</small>
</div>
<script>

function csvJSON(csv){
  var result = [];
  var headers=csv[0];
  for(var i=1;i<csv.length;i++){
      var obj = {};
      for(var j=0;j<headers.length;j++){
          obj[headers[j]] = parseFloat(csv[i][j]);
      }
      result.push(obj);
  }
  return result; 
}


	
	


var xAxisKey = 'time';
bluetooth2Data.forEach(function(e, index) {
	e.time = '' + e.time;
});var bluetooth2Ctx = document.getElementById('bluetooth2').getContext('2d');
const bluetooth2Chart = new Chart(bluetooth2Ctx, {
    type: 'line',
    data: {
        datasets: [{
        	label: 'C\u002b\u002b',
            data: bluetooth2Data,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'blecpp'
            },
            borderColor: '#7fc35e',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#7fc35e',
            fill: true,
            borderWidth: 2,tension: 0.2
        },{
        	label: 'С close to RPi',
            data: bluetooth2Data,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'blec2'
            },
            borderColor: '#4161CC',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#4161CC',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        },{
            label: 'C',
            data: bluetooth2Data,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'blec'
            },
            borderColor: '#ffcd00',
            backgroundColor: 'rgba(255, 205, 0, 0.1)',
            pointBackgroundColor: '#ffcd00',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        }]
    },
    options: {
    	stacked: false,
    	elements: {
    		point: {
    		      radius: 0,
    		      hitRadius: 10,
    		      hoverRadius: 4,
    		      hoverBorderWidth: 3
    		}	
    	},
        animation: {
            duration: 0
        },
        interaction: {
            intersect: false,
            mode: 'index',
        },
        scales: {x: {
                title: {
                    display: true,
                    text: 'Time'
                },
                ticks: {
                    
                    callback: function(value, index, ticks) {
                    	
                        return this.getLabelForValue(value) + ' ms';
                    }}
        	},y: {
                beginAtZero: true,
                position: 'left',title: {
                    display: true,
                    text: 'Current'
                },
                ticks: {
                    callback: function(value, index, ticks) {
                        return value + ' mA';
                    }}
            }},
        plugins: {
            title: {
                display: true,
                text: 'Power consumption when connecting to bluetooth server',
                font: {
                	size: 16
                }
            },
            legend: {
                display: false
            },
            tooltip: {
            	position: 'nearest',
            	callbacks: {title: function(context) {
                        return context[0].label + ' ms';
            		},label: function(context) {
            			let label = context.dataset.label || '';

                        if (label) {
                            label += ': ';
                        }
                        
                        var unit = "mA";if (context.parsed.y !== null) {
                        	label += context.parsed.y + ' ' + unit;
                        }
                        
                        return label;
            		}
            	}
            }
        }
    }
});
</script><noscript>
	<img src="/img/lora-at-power-profiling/bluetooth2.png">
</noscript>
<p>It’s worth noting here that I wasn’t always able to connect to the server! At some point I had to move the board closer to the RaspberryPI. It was then that it was discovered that the closer to the bluetooth server, the faster the connection. Even if I used different versions of the application, the connection time was very different. Which gave a strong scatter in the results. For example, from 3 meters C-code could spend <strong>386.8</strong> mC, and C++ would not connect at all. Or from one meter C++ spent <strong>308.3</strong> mC, and C-code - <strong>150.2</strong> mC. In general, the test turned out so-so.</p>
<h3 id="deep-sleep">Deep sleep</h3>
<p>Deep sleep is a special operating mode in which all peripherals are turned off and the ESP32 operates consuming a minimum amount of energy. In this mode, it is impossible to do anything useful, so deep sleep usually alternates with an active phase. In the active phase, the device performs useful operations, after which it goes back to sleep. The smaller the active phase, the less energy the device will ultimately consume. In lora-at you can configure the deep sleep interval. For example, the command below will set the configuration: after 15 seconds of inactivity, go into deep sleep mode for 15 seconds.</p>
<pre tabindex="0"><code>AT+DSCONFIG=15000,15000
</code></pre><p>During the active phase, lora-at connects to bluetooth server, receives the next power-up schedule and goes to sleep again.</p>
































<canvas id="dsCycle" width="400" height="200"></canvas>
<div class='align-center' style="margin-bottom: 1.5em">
<small>
	<a class="downloadChart" data-canvasid="dsCycle" download="dsCycle.png" href="" title="Active phase">Download</a>
</small>
</div>
<script>

function csvJSON(csv){
  var result = [];
  var headers=csv[0];
  for(var i=1;i<csv.length;i++){
      var obj = {};
      for(var j=0;j<headers.length;j++){
          obj[headers[j]] = parseFloat(csv[i][j]);
      }
      result.push(obj);
  }
  return result; 
}


	
	


var xAxisKey = 'time';
dsCycleData.forEach(function(e, index) {
	e.time = '' + e.time;
});var dsCycleCtx = document.getElementById('dsCycle').getContext('2d');
const dsCycleChart = new Chart(dsCycleCtx, {
    type: 'line',
    data: {
        datasets: [{
        	label: 'С\u002b\u002b version',
            data: dsCycleData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'dscpp'
            },
            borderColor: '#7fc35e',
            backgroundColor: 'rgba(49, 76, 37, 0.1)',
            pointBackgroundColor: '#7fc35e',
            fill: true,
            borderWidth: 2,tension: 0.2
        },{
            label: 'C version',
            data: dsCycleData,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'dsc'
            },
            borderColor: '#ffcd00',
            backgroundColor: 'rgba(255, 205, 0, 0.1)',
            pointBackgroundColor: '#ffcd00',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        }]
    },
    options: {
    	stacked: false,
    	elements: {
    		point: {
    		      radius: 0,
    		      hitRadius: 10,
    		      hoverRadius: 4,
    		      hoverBorderWidth: 3
    		}	
    	},
        animation: {
            duration: 0
        },
        interaction: {
            intersect: false,
            mode: 'index',
        },
        scales: {x: {
                title: {
                    display: true,
                    text: 'Time'
                },
                ticks: {
                    
                    callback: function(value, index, ticks) {
                    	
                        return this.getLabelForValue(value) + ' ';
                    }}
        	},y: {
                beginAtZero: true,
                position: 'left',title: {
                    display: true,
                    text: 'Current'
                },
                ticks: {
                    callback: function(value, index, ticks) {
                        return value + ' mA';
                    }}
            }},
        plugins: {
            title: {
                display: true,
                text: 'Active phase',
                font: {
                	size: 16
                }
            },
            legend: {
                display: false
            },
            tooltip: {
            	position: 'nearest',
            	callbacks: {title: function(context) {
                        return context[0].label + ' ';
            		},label: function(context) {
            			let label = context.dataset.label || '';

                        if (label) {
                            label += ': ';
                        }
                        
                        var unit = "mA";if (context.parsed.y !== null) {
                        	label += context.parsed.y + ' ' + unit;
                        }
                        
                        return label;
            		}
            	}
            }
        }
    }
});
</script><noscript>
	<img src="/img/lora-at-power-profiling/dsCycle.png">
</noscript>
<ul>
<li>Energy consumption strongly depends on the speed of connection to the bluetooth server. Moreover, sometimes it takes 2 seconds, and sometimes 7. Because of such instability, it is difficult to draw any conclusions</li>
<li>nergy consumption varies quite a lot: from <strong>474.6</strong>мКл mC (C++ version) to <strong>179.2</strong>mC (C version)</li>
<li>C++ startup time is slightly less. <strong>~500</strong>ms vs  <strong>~664</strong>ms. However, I have never been able to get less than 7 seconds to connect using the C++ version. Perhaps it missed some bluetooth event and had to wait for a retransmission from the server.</li>
</ul>
<p>Energy consumption in deep sleep mode is <strong>1.7</strong>mA. This is about a million times more than the theoretical minimum of the ESP32. I spent about 2 weeks trying to figure out what the problem was. After all the tricks, I managed to reduce the consumption to <strong>10</strong>µA.</p>
<h3 id="operation-at-low-frequencies">Operation at low frequencies</h3>
<p>ESP32 can operate at both 240MHz and 80MHz. Obviously, this reduces energy consumption by running slower. But does it matter if SPI bus works at 3Mhz?</p>
<table>
<thead>
	<tr>
		<th>Operating mode</th>
		<th>Average current consumption (C)</th>
		<th>Average current consumption (C++)</th>		
	</tr>
</thead>
<tbody>
	<tr>
		<td>240Мгц</td>
		<td>48.27</td>
		<td>73.36</td>
	</tr>
	<tr>
		<td>160Мгц</td>
		<td>35.81</td>
		<td>50.64</td>
	</tr>
	<tr>
		<td>80Мгц</td>
		<td><strong>26.38</strong></td>
		<td>39.44</td>
	</tr>
</tbody>
</table>
<ul>
<li>As expected, the lower the microcontroller frequency, the lower the power consumption</li>
<li>Sometimes I was able to get even lower values, but I couldn&rsquo;t figure out how to reproduce them</li>
</ul>
<p>By the way, the difference between the C and C++ versions is related to how events are processed. In the C version, all processing occurs in separate FreeRTOS tasks. I&rsquo;m not even using the main task:</p>
<pre tabindex="0"><code>I (595) main_task: Returned from app_main()
</code></pre><p>But the C++ version checks events in an infinite loop. If I add a similar cycle to the C version, the energy consumption will be the same:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">uint64_t</span> counter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">uint64_t</span> active <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000000</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> (true) {
</span></span><span style="display:flex;"><span>  counter<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (counter <span style="color:#f92672">==</span> active) {
</span></span><span style="display:flex;"><span>    counter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">vTaskDelay</span>(<span style="color:#a6e22e">pdMS_TO_TICKS</span>(<span style="color:#ae81ff">5000</span>));
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="uart-interrupt-handling">UART interrupt handling</h4>
<p>I enjoyed fiddling with energy consumption so much that I decided to measure completely strange things. For example, I became interested in how much energy is spent processing the received symbol via UART. The greatly enlarged graph looks like this:</p>
































<canvas id="uartSymbol2" width="400" height="200"></canvas>
<div class='align-center' style="margin-bottom: 1.5em">
<small>
	<a class="downloadChart" data-canvasid="uartSymbol2" download="uartSymbol2.png" href="" title="Power consumption of a single char">Download</a>
</small>
</div>
<script>

function csvJSON(csv){
  var result = [];
  var headers=csv[0];
  for(var i=1;i<csv.length;i++){
      var obj = {};
      for(var j=0;j<headers.length;j++){
          obj[headers[j]] = parseFloat(csv[i][j]);
      }
      result.push(obj);
  }
  return result; 
}


	
	


var xAxisKey = 'time';
uartSymbol2Data.forEach(function(e, index) {
	e.time = '' + e.time;
});var uartSymbol2Ctx = document.getElementById('uartSymbol2').getContext('2d');
const uartSymbol2Chart = new Chart(uartSymbol2Ctx, {
    type: 'line',
    data: {
        datasets: [{
            label: 'Current',
            data: uartSymbol2Data,
            parsing: {
                xAxisKey: xAxisKey,
                yAxisKey: 'uartSymbol'
            },
            borderColor: '#ffcd00',
            backgroundColor: 'rgba(255, 205, 0, 0.1)',
            pointBackgroundColor: '#ffcd00',
            fill: true,
            borderWidth: 2,
            tension: 0.2
        }]
    },
    options: {
    	stacked: false,
    	elements: {
    		point: {
    		      radius: 0,
    		      hitRadius: 10,
    		      hoverRadius: 4,
    		      hoverBorderWidth: 3
    		}	
    	},
        animation: {
            duration: 0
        },
        interaction: {
            intersect: false,
            mode: 'index',
        },
        scales: {x: {
                title: {
                    display: true,
                    text: 'Time'
                },
                ticks: {
                    
                    callback: function(value, index, ticks) {
                    	
                        return this.getLabelForValue(value) + ' ms';
                    }}
        	},y: {
                beginAtZero: true,
                position: 'left',title: {
                    display: true,
                    text: 'Current'
                },
                ticks: {
                    callback: function(value, index, ticks) {
                        return value + ' mA';
                    }}
            }},
        plugins: {
            title: {
                display: true,
                text: 'Power consumption of a single char',
                font: {
                	size: 16
                }
            },
            legend: {
                display: false
            },
            tooltip: {
            	position: 'nearest',
            	callbacks: {title: function(context) {
                        return context[0].label + ' ms';
            		},label: function(context) {
            			let label = context.dataset.label || '';

                        if (label) {
                            label += ': ';
                        }
                        
                        var unit = "mA";if (context.parsed.y !== null) {
                        	label += context.parsed.y + ' ' + unit;
                        }
                        
                        return label;
            		}
            	}
            }
        }
    }
});
</script><noscript>
	<img src="/img/lora-at-power-profiling/uartSymbol2.png">
</noscript>
<ul>
<li>Each press causes a jump in current consumption of approximately <strong>10</strong>mA and lasts approximately <strong>1.4</strong>ms</li>
<li>It’s not very clear why there are two jumps</li>
<li>If you put several characters into the buffer at once using CMD+V, this will generate one interrupt and a very similar graph</li>
</ul>
<p>If <strong>37.32</strong> µC are spent in <strong>1.4</strong> ms, and <strong>35.11</strong> µC are spent in idle mode during the same time, then pressing the button costs <strong>2.21</strong> µC.</p>
<h2 id="conclusions">Conclusions</h2>
<ul>
<li>C code is on average more energy efficient by using FreeRTOS tasks rather than an infinite loop</li>
<li>Using the energy consumption graph, you can find bugs in the code</li>
<li>Bluetooth Low Energy is not the most predictable protocol in terms of energy consumption</li>
<li>Even if the deep sleep code is called correctly, this does not guarantee that the device actually consumes little power. We need to measure!</li>
</ul>

</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'><div class='tags'><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>

</svg>
<span class='screen-reader-text'>Tags: </span><a class='tag' href='/en/tags/lora/'>Lora</a>, <a class='tag' href='/en/tags/lora-at/'>Lora-At</a>, <a class='tag' href='/en/tags/esp32/'>Esp32</a>, <a class='tag' href='/en/tags/esp-idf/'>Esp-Idf</a>, <a class='tag' href='/en/tags/ppk2/'>PPK2</a></div>

  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/en/posts/power-profiler-kit2/'>
        <span aria-hidden='true'><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>

</svg>
 Previous</span>
        <span class='screen-reader-text'>Previous post: </span>Power Profiler Kit 2</a>
    </div></div>
</nav>


<section id='comments' class='comments'>
  <div class='container sep-before'>
    <div class='comments-area'><script>
  var remark_config = {
    host: "https://remark42.dernasherbrezon.com", 
    site_id: '9134',
    locale: 'en',
    components: ['embed'] 
                          
                          
                          
                          
                          
  };

  (function(c) {
    for(var i = 0; i < c.length; i++){
      var d = document, s = d.createElement('script');
      s.src = remark_config.host + '/web/' +c[i] +'.js';
      s.defer = true;
      (d.head || d.body).appendChild(s);
    }
  })(remark_config.components || ['embed']);
</script>
<div id="remark42"></div>
</div>
  </div>
</section>

      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><section class='widget widget-social_menu sep-after'><nav aria-label='Social Menu'>
    <ul><li>
        <a href='https://github.com/dernasherbrezon' target='_blank' rel='noopener me'>
          <span class='screen-reader-text'>Open Github account in new tab</span><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
      <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>

</svg>
</a>
      </li><li>
        <a href='https://twitter.com/dernasherbrezon' target='_blank' rel='noopener me'>
          <span class='screen-reader-text'>Open Twitter account in new tab</span><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    
  <title>Twitter icon</title>
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>

</svg>
</a>
      </li><li>
        <a href='mailto:dernasherbrezon@gmail.com' target='_blank' rel='noopener me'>
          <span class='screen-reader-text'>Contact via Email</span><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline>
</svg>
</a>
      </li><li>
        <a href='https://t.me/dernasherbrezonChannel' target='_blank' rel='noopener me'>
          <span class='screen-reader-text'>Open Telegram account in new tab</span><svg class='icon' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <title>Telegram icon</title><path d="M23.91 3.79L20.3 20.84c-.25 1.21-.98 1.5-2 .94l-5.5-4.07-2.66 2.57c-.3.3-.55.56-1.1.56-.72 0-.6-.27-.84-.95L6.3 13.7l-5.45-1.7c-1.18-.35-1.19-1.16.26-1.75l21.26-8.2c.97-.43 1.9.24 1.53 1.73z"/>
</svg>
</a>
      </li></ul>
  </nav>
</section><div class='copyright'>
  <p><a href="https://creativecommons.org/licenses/by-nc-nd/3.0/">CC BY-NC-ND 3.0</a> &copy; 2017-2024 dernasherbrezon </p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__assets_js_src="/assets/js/"</script>

<script src='/assets/js/main.c3bcf2df.js'></script><script>
var downloadLinks = document.getElementsByClassName('downloadChart');
for (var i = 0; i < downloadLinks.length; i++) {
	downloadLinks[i].addEventListener('click', function(event){
		var targetElement = event.target || event.srcElement;
		var canvasId = targetElement.getAttribute('data-canvasid');
		console.log(canvasId);
		var url_base64 = document.getElementById(canvasId).toDataURL("image/png");
		targetElement.href = url_base64;
	});
}
</script>
</body>

</html>

