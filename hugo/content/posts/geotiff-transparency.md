---
title: "Прозрачность в GeoTIFF"
date: 2020-04-30T16:15:18+01:00
cover: /img/geotiff-transparency/1.png
draft: false
tags:
  - geotiff
---

Работа над [r2weather.ru](https://r2weather.ru) идёт полным ходом, а значит появляются и фиксятся различные баги. Один из последних и самых интересных - настройка прозрачности.

После того, как я создал GeoTIFF и нарезал его на тайлы с помощью gdal2tiles у меня получился следующий результат:

![](/img/geotiff-transparency/1.png)

Если присмотреться, то можно увидеть отдельные "выколотые" пикселы там, где находится море. А если взять ночную фотографию, то такие пикселы еще более заметны:

![](/img/geotiff-transparency/2.png)

Это явно ошибка определения прозрачности, так как на оригинальном изображении этой проблемы нет.

## Прозрачность

В GeoTIFF прозрачность можно задать несколькими способами. В одной из [предыдущих статей]({{< ref "/georeferencing-geotiff" >}}) я описал, как задать прозрачность на уровне каждого канала. Для этого нужно добавить следующий параметр:

```xml
<NoDataValue>0.0</NoDataValue>
```

Он фактически говорит, что все пикселы с нулевым значением в данном слое - прозрачны. Но это не всегда так! "0" или чёрный цвет - это не отсутствие цвета. Это такой цвет. В прозрачных png флаг, который определяет прозрачность - это альфа канал. Если значение 0x0, то пиксел полностью прозрачный. Если 0xFF, то - непрозрачный.

При работе с GeoTIFF этим можно воспользоваться. Для этого добавляется дополнительный слой, у которого тип Alpha:

```xml
<VRTRasterBand dataType="Byte" band="4">
	<Description>Alpha</Description>
	<ColorInterp>Alpha</ColorInterp>	
	<SimpleSource>
		<SourceFilename relativeToVRT="1">output.png</SourceFilename>
		<SourceBand>4</SourceBand>	
	</SimpleSource>
</VRTRasterBand>
```

В результате GeoTIFF будет содержать:

```
Band 4 Block=2438x1 Type=Byte, ColorInterp=Alpha
  Description = Alpha
```

Программы, которые работают с GeoTIFF могут использовать этот канал для того, чтобы задавать прозрачность.

## Результат

После добавления прозрачности из альфа-канала, результат gdal2tiles выглядит следующим образом:

![](/img/geotiff-transparency/3.png)

Над Латвией сейчас ночь.